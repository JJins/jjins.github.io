// ==UserScript==
// @name         冰蛙宝鉴
// @namespace    SMTH
// @version      3.0.5
// @description  随时随地通过API接口看你想看！
// @author       bingri[1523812] kaeru[1769499] htys[1545351] mirrorhye[2564936] tobytorn[1617955] Microdust[2587304]
// @match        https://www.torn.com/*.php*
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @connect      *
// @require      https://cdn.staticfile.org/xlsx/0.17.5/xlsx.min.js
// ==/UserScript==


!function(){"use strict";const t=window.unsafeWindow||window;if(!t.BINGWA){t.BINGWA=!0;try{window=t}catch(t){console.error(t)}const Fe=window.jQuery,De=Object.freeze({GM:"gm",PDA:"pda",OTHER:"other"});let i=De.OTHER;try{GM_xmlhttpRequest,i=De.GM}catch{try{PDA_httpGet,i=De.PDA}catch{}}let p=!1;switch(i){case De.GM:case De.OTHER:p=!0;break;case De.PDA:try{PDA_evaluateJavascript,p=!0}catch{}}console.log(`[BW] support eval: ${p}`);const Se=[{name:"foo",title:"阅兵助手",desc:"在部分页面显示阅兵按钮，可以快速获取玩家信息",default:!1},{name:"noAssisting",title:"防打重",desc:"如果已有其他人进入战斗则屏蔽JOIN按钮",default:!1},{name:"mugoo",title:"山贼助手",desc:"在市场列表界面显示用户状态和攻击链接",default:!0},{name:"chatTimestamp",title:"聊天时间戳",desc:"聊天频道显示每条内容已发送时间",default:!0},{name:"chatQuickWithdraw",title:"聊天快捷取钱",desc:"聊天频道内显示快捷取钱按钮",default:!1},{name:"travelFilter",title:"飞花过滤",desc:"在海外市场页面屏蔽不重要物品",default:!0},{name:"jailView",title:"监狱助手",desc:"在监狱页面屏蔽分数大于10000的目标，本帮人员置顶高亮显示",default:!0},{name:"stockexchange_show_abbr",title:"股票助手",desc:"在股票交易市场页面的股票名称前显示缩写",default:!0},{name:"gym_show_ratio",title:"健身房助手",desc:"在健身房页面显示推荐的属性比例",default:!0},{name:"common_modify_header_links",title:"顶部快捷入口",desc:"在页面顶部添加一些常用页面的链接",default:!0},{name:"hide_cloud_while_flying",title:"飞行无云",desc:"在飞行界面隐藏飞机和云彩",default:!0},{name:"withdrawal_helper",title:"取钱助手",desc:"右下角聊天people框高亮显示帮派可取钱名单",default:!0},{name:"bigger_screen_on_laptop",title:"laptop大屏",desc:"飞行中使用笔记本电脑时可以全屏显示",default:!0},{name:"taking_off_reminder",title:"起飞吃药提醒",desc:"起飞前根据CD提醒吃药和OC",default:!0},{name:"bounty_parade",title:"悬赏阅兵",desc:"报纸-悬赏页面显示目标BS",default:!1},{name:"nurse_suggestion",title:"护士建议",desc:"智能提醒出院吃药",default:!0}];Se.forEach(t=>{var e=Kt("BWM_SETTINGS",t.name);null==e&&Yt("BWM_SETTINGS",t.name,String(t.default)),window[t.name]="true"==Kt("BWM_SETTINGS",t.name)});let x=localStorage.getItem("APIKey");const Ae={20465:"SMTH",36134:"Silver Hand",10741:"Trisolary",16335:"November Chopin",16424:"HoYoverse",9356:"Party Animals"},Oe={8836:"Vinerri",2095:"Guerrilla Warfare",11356:"-UGK-",31312:"TORNado",8255:"Scream Silence",26312:"The Avengers",28205:"Invictus",10913:"Unbroken Warriors",8510:"Ara Pacis",5113:"ThugLife",13343:"The Defiant",39756:"Abusement Park",38761:"Shadow Healers",42125:"Octogenarian DirtyBombers",35739:"Kingsmen",14820:"Unbroken Legion",10140:"In Memory of the Fallen",9405:"Lake Of Lerna",30085:"Rampage Total Destruction"},Ce={gray:"#adadad",red:"#ff7373",green:"#8fbc8f",blue:"#65a5d1",purple:"#8d6dd7",yellow:"#f39826",yellowgreen:"#83a000",pink:"#e467b3",salmon:"#F9CDAD",orange:"#FFDEAD"};if(Date.prototype.format=function(t){var e,a={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(e in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),a)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[e]:("00"+a[e]).substr((""+a[e]).length)));return t},fe(),travelFilter&&me(),common_modify_header_links&&ue(),be(),chatQuickWithdraw){xe();const Te=window.location.href;if(0<=Te.indexOf("wdname")&&0<=Te.indexOf("wdmoney")){let a=decodeURI(Te.split("wdname=")[1].split("&")[0]),n=decodeURI(Te.split("wdmoney=")[1]),t=new MutationObserver(function(t,e){0<Fe(".money-wrap").children(".give-block").length&&(ye(a,n),e.disconnect())});t.observe(document.getElementById("faction-controls"),{childList:!0,subtree:!0})}}if(ve(),withdrawal_helper&&we(),hide_cloud_while_flying&&_e(),bigger_screen_on_laptop&&ke(),0<=window.location.href.indexOf("loader.php?sid=racing")&&setInterval(function(){Fe(".bar-tpl-wrap:not([show-value])").each(function(t,e){let a=0,n=0,i=0;i=Fe(e).hasClass("negative")?(a=parseFloat(Fe(e).find(".progress-light-gray")[0].style.width),n=parseFloat(Fe(e).find(".progress-red")[0].style.width),a=parseFloat(a*n/100),a-n):Fe(e).hasClass("positive")?(n=parseFloat(Fe(e).find(".progress-light-gray")[0].style.width),a=parseFloat(Fe(e).find(".progress-light-green")[0].style.width),n=parseFloat(a*n/100),a-n):(n=parseFloat(Fe(e).find(".progress-")[0].style.width),0),Fe(e).css("line-height","17px").css("margin-top","0px").css("width","88px").html("<span style='color: gray'>"+n.toFixed(2)+"</span>"+(0<=i?" + ":" - ")+Math.abs(i).toFixed(2)),Fe(e).css("color",0<=i?"green":"red"),Fe(e).attr("show-value","show-value")})},500),0<=window.location.href.indexOf("shops.php?step=bitsnbobs")&&Fe(".buy-flexslider").find(":input").val("100"),0<=window.location.href.indexOf("factions.php?step=your")){function e(t,e,a){var n=jt(a);let i=Ce.yellowgreen;a<0&&(i=Ce.red),console.log("addDepositorItem"+e),Fe("ul.money-depositors").prepend(`
            <li class='depositor' id='${t}'>
                <div class='clearfix'>
                    <div class='icons'></div>
                    <span class='factionWrap'></span>
                    <div class='user name'>
                        <div class="border-round" style="height:18px; padding:2px 10px; color:white; background-color:${i};"">${e}</div>
                    </div>
                    <div class='amount'>
                        <div class="border-round" style="height:18px; padding:2px 10px; color:white; background-color:${i};"">${n}</div>
                    </div>
                </div>
            </li>`)}function s(){var t=JSON.parse(Fe("#websocketConnectionData").text());return t.playername+" ["+t.userID+"]"}function a(t,e){const a=Fe("ul.money-depositors").children("li.depositor").find("span[title='"+e+"']").parent().siblings("div.amount").children().children().attr("data-value");let n="$"+a;0!=a&&(n=a.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","}).replace(/^[^\$]\S+/,function(t){return"$"+t})),n.includes("-")?t.text("").append(`<span>${e}</span><span class ='t-red right'>${n}</span>`):t.text("").append(`<span>${e}</span><span class ='right'>${n}</span>`)}function n(){const t=Fe("div#money-user-cont").find("li.ui-custom-item");!Fe("input#money-user")||"."!=Fe("input#money-user").val()&&" "!=Fe("input#money-user").val()||(Fe("input#money-user").val(s()).addClass("chosen"),console.log(s()),a(t.children(),s())),0<t.length&&!t.children().text().includes("$")&&!t.hasClass("empty")&&t.each(function(){var t=Fe(this).children().text();a(Fe(this).children(),t)})}function o(){const a=Fe(".money-wrap").children(".give-block"),i="give-money",o="array";function r(){Fe(".button-wrap").remove(),t()}function t(){const n=Kt(i,o);var t=function(){let a=`<div class="button-wrap" style="margin:2px;">
                    <span id="deposit-self" class="border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${Ce.purple};">给自己</span>`;return n.forEach((t,e)=>{a+=(t=t,`<span id="deposit${e}" class="deposit-money-btn border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${Ce.blue};">${t.button_name}</span>`)}),a+=`<span id="deposit-add" class="border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${Ce.green};">+</span>
                    <span id="deposit-all" class="border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${Ce.blue};">全取</span>
                    <span id="deposit-remove" class="border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${Ce.red};">x</span>
                    </div>`,a}();a.children(".info").after(t),a.children(".select-wrap").css("padding-top","1px"),Fe("#deposit-add").click(()=>{0<Fe("#deposit-input").length||(Fe("#deposit-add").html('<span style="display: inline-block;"><input id="deposit-input" type="text" class="border-round"></input>'),Fe("#deposit-input").tornInputMoney({groupMoneyClass:null}),Fe("#deposit-input").focus(),Fe("#deposit-input").blur(()=>{var t=Fe("#deposit-input").val();let e=n;e.push({button_name:`取${Bt(jt("$"+t))}`,"button-value":t}),Yt(i,o,e),r()}))}),Fe("#deposit-remove").click(()=>{Fe("#deposit-remove").hasClass("deposit-removing")?(Fe(".deposit-money-btn").css("background-color",Ce.blue),Fe(".deposit-money-btn").removeClass("deposit-removing"),Fe("#deposit-remove").css("background-color",Ce.red),Fe("#deposit-remove").removeClass("deposit-removing")):(Fe(".deposit-money-btn").css("background-color",Ce.red),Fe(".deposit-money-btn").addClass("deposit-removing"),Fe("#deposit-remove").css("background-color",Ce.salmon),Fe("#deposit-remove").addClass("deposit-removing"))}),Fe("#deposit-self").click(()=>{Fe("input#money-user").val(s()).addClass("chosen")}),n.forEach((t,e)=>{Fe(`#deposit${e}`).click(()=>{if(Fe(`#deposit${e}`).hasClass("deposit-removing")){let t=n;return t.splice(e,1),Yt(i,o,t),void r()}a.children(".inputs-wrap").children(".input-money-group").addClass("success").children("input").attr("value",t["button-value"]),a.children(".inputs-wrap").children(".btn-wrap").children().children().attr("disabled",!1).removeClass("disabled")})}),Fe("#deposit-all").click(()=>{var t;0<=a.children(".select-wrap").children(".result").text().indexOf("]")&&(t=a.children(".select-wrap").children(".result").children(".right").text().replace("$",""),console.log(t),a.children(".inputs-wrap").children(".input-money-group").addClass("success").children("input").attr("value",t),a.children(".inputs-wrap").children(".btn-wrap").children().children().attr("disabled",!1).removeClass("disabled"))})}Kt(i,o)||Yt(i,o,[{button_name:"取1m","button-value":"1,000,000"},{button_name:"取5m","button-value":"5,000,000"},{button_name:"取10m","button-value":"10,000,000"},{button_name:"取25m","button-value":"25,000,000"}]),Fe(".button-wrap").length<1&&t()}function r(){Fe("div.input-money-group").attr("class","input-money-group no-max-value");const t=Fe("ul.money-depositors").children("li.depositor");if(0<Fe("div.give-block").length&&Fe("#faction_balance_li").length<=0&&0<t.length){var e=zt(Fe(".money-wrap").children(".balance-message").children(".sum-of-deposit").text()),i=zt(Fe(".money-wrap").children(".balance-message").children(".faction-balance").text());let a=0,n=0;t.each((t,e)=>{e=parseInt(Fe(e).find("span.money").attr("data-value"));0<e?a+=e:n+=e});var o=parseInt(i)+parseInt(e),r=Math.max(Math.abs(e),Math.abs(i),Math.abs(a),Math.abs(n),Math.abs(o));Fe("#money").children(".balance-message").after(`
                <div id="faction_balance_li" 
                style="width:290px; border:4px solid gray; 
                padding:5px 2px; margin:0px 0px 5px 5px; 
                background-color:#fff; background-image: linear-gradient(rgba(209,73,78,0.2),rgba(209,73,78,0.1));">
            </div>`),l("帮派余额",o,r),l("所有存款总和",e,r),l("帮派公共资金",i,r),l("正存款总和",a,r),l("负存款总和",n,r),l("准备金率",parseFloat(o/a),r)}}function l(e,a,n){let i=jt(a);if(0<=a){var o="#5d9525";let t=100*a/n;"准备金率"==e&&(t=Math.min(100*a,100),i=(100*a).toFixed(2)+"%"),Fe("#faction_balance_li").append(`
                <div style="overflow:hidden; margin:7px; border:1px solid gray;">
                    <div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${ee(22,0,o,"#eee",e)}</div>
                    <div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${ee(22,t,o,"#eee",i)}</div>
                </div>`)}else{o="#c0542f",n=100*a/n+100;Fe("#faction_balance_li").append(`
                <div style="overflow:hidden; margin:7px; border:1px solid gray;">
                    <div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${ee(22,n,"#eee",o,e)}</div>
                    <div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${ee(22,0,o,"#eee",i)}</div>
                </div>`)}}let t=new MutationObserver(function(t,e){console.log("changed"),n(),o(),r()});t.observe(document.getElementById("faction-controls"),{childList:!0,subtree:!0});const Pe=setInterval(d,500);function d(){if(0<Fe("#money-user").length){const t=Fe("#money-user").parent().parent().siblings(".select-wrap").children(".result");0<=Fe("#money-user").val().indexOf("]")&&(Fe("#money-user").val()!=t.attr("userid")||0==t.text().length)&&(t.attr("userid",Fe("#money-user").val()),t.css("display","block"),a(t,Fe("#money-user").val()))}}}if(jailView&&0<=window.location.href.indexOf("jailview.php")){const Ne="3.0.5",Ee="bingwa_bust",ze=60;class t{constructor(t){this.refresh_callback=t;t=Ut(Ee);t&&t.version===Ne?(this.info=t.info,this.conf=t.conf):(this.info={timestamp:0},this.conf={hidden:!1,prob_min:null,prob_max:null,order:"ASC",friend:"PIN",quick_bust:"ON"}),this.refreshInfo()}getBustSkill(){return this.info.level*(1+this.info.faction_perk/100)*(1+this.info.edu_perk/100)}getBustProb(t){let e=this.info.penalty;return this.info.job_perk&&(e/=2),276.536-(.73643*t+5309.59*e)/this.getBustSkill()}save(){Vt(Ee,{info:this.info,conf:this.conf,version:Ne})}refreshInfo(){var t=Math.floor((new Date).getTime()/1e3),e=this.info.error?5:ze;t-this.info.timestamp<e||(this.info={timestamp:t,error:"loading"},this.save(),new Promise(async()=>{await this.fetchInfo(),this.save(),this.refresh_callback&&this.refresh_callback()}))}increasePenalty(){"penalty"in this.info&&(this.info.penalty+=1,this.save())}async fetchInfo(){var t=Math.floor((new Date).getTime()/1e3),e=`https://api.torn.com/user/?selections=basic,perks,log&log=5360&to=${t+10}&key=${x}`;const a=await fetch(e);if(a.ok){const n=await a.json();if("error"in n)this.info={timestamp:t,error:n.error.error};else{this.info={timestamp:t},this.info.level=n.level;const i=n.faction_perks.find(t=>t.match(/Increase bust success chance/));this.info.faction_perk=i?parseInt(i.match(/\d+/)[0]):0,this.info.job_perk=0<=n.job_perks.indexOf("+ Easier to bust more people at once");const o=n.education_perks.find(t=>t.match(/Busting skill/));this.info.edu_perk=o?parseInt(o.match(/\d+/)[0]):0,this.info.penalty=0;for(const r of Object.values(n.log))t-r.timestamp<=259200&&(this.info.penalty+=1/(1+(t-r.timestamp)/36e3))}}else this.info={timestamp:t,error:a.statusText}}}const je=new t(u),Re=new MutationObserver(async function(t){let e=!1;for(const a of t)for(const n of a.addedNodes)"LI"===n.tagName?e=f(n)||e:Fe(n).text().match(/You busted .* out of jail/)&&(e=!0,je.increasePenalty());e&&u()});function c(t){const e=t.find("a.faction").attr("href");return e?e.substring(30):0}function h(t){t=t.find("span.level").text().match(/\d+/g);return t?parseInt(t[0]):0}function g(t){t=t.find("span.time").text().match(/\d+/g),t=t||[0];return t[1]?60*parseInt(t[0])+parseInt(t[1]):parseInt(t[0])}function f(t){if(Fe(t).find("b.bust-score").attr("bust-score"))return!1;var e=(g(Fe(t))+180)*h(Fe(t));if(0==e)return!1;e=`<b class="bust-score t-red" style="margin-left: 0em" bust-score=${e}></b>`;return Fe(t).find("span.reason").append(e),Fe(t).removeClass("gray"),!0}function m(){const t=Fe("ul.user-info-list-wrap").children("li");t.each(function(){if(0!==Fe(this).find("b.bust-score").length){var e=parseFloat(Fe(this).find("b.bust-score").attr("bust-prob"));let t=!1;e&&(null!==je.conf.prob_min&&e<je.conf.prob_min&&(t=!0),null!==je.conf.prob_max&&e>je.conf.prob_max&&(t=!0));e=c(Fe(this))in Ae;"PIN"===je.conf.friend&&e&&(t=!1),t?(Fe(this).hide(),Fe(this).attr("hidden",!0)):(Fe(this).show(),Fe(this).removeAttr("hidden")),je.conf.friend&&e?Fe(this).css("background-color","rgba(110, 160, 55, 0.15)"):Fe(this).css("background-color","");const a=Fe(this).children("a.bust");"ON"===je.conf.quick_bust?a.attr("href",a.attr("href").replace(/\bbreakout\b/,"breakout1")):a.attr("href",a.attr("href").replace(/\bbreakout1\b/,"breakout"))}}),je.conf.order&&(t.sort(function(t,e){var a=parseInt(Fe(t).find("b.bust-score").attr("bust-score")),n=parseInt(Fe(e).find("b.bust-score").attr("bust-score")),t=c(Fe(t))in Ae,e=c(Fe(e))in Ae;return"PIN"===je.conf.friend&&t!=e?Number(e)-Number(t):"ASC"===je.conf.order?a-n:n-a}),t.detach().appendTo("ul.user-info-list-wrap"))}function u(){const n=je.info,t=Fe(".info-msg-cont").first();var e;t.css("background","var(--default-bg-panel-color)"),t.css("font-size","12px"),t.html(`
                    <div id="bust-info" style="display: flex; flex-wrap: wrap; gap: 10px 20px; padding: 10px;"></div>
                    <div id="bust-conf" class="small-select-menu-wrap">
                        <hr />
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px 20px; padding: 10px;">
                            <label style="width: 10em; display: flex; gap: 4px">
                                <b style="margin: auto 0">最低成功率</b>
                                <input id="bust-conf-prob-min" type="text" inputmode="numeric" maxlength="3" placeholder="-"
                                    style="width: 3em; flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; padding: 2px; text-align: center;">
                            </label>
                            <label style="width: 10em; display: flex; gap: 4px">
                                <b style="margin: auto 0">最高成功率</b>
                                <input id="bust-conf-prob-max" type="text" inputmode="numeric" maxlength="3" placeholder="-"
                                    style="width: 3em; flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; padding: 2px; text-align: center;">
                            </label>
                            <label style="width: 10em; display: flex; gap: 4px">
                                <b style="margin: auto 0">排序</b>
                                <div class="select-wrap dropdown-new dropdown-default" style="flex-grow: 1">
                                    <select id="bust-conf-order">
                                        <option value="ASC">由易到难</option>
                                        <option value="DESC">由难到易</option>
                                        <option value="">系统顺序</option>
                                    </select>
                                    <div id="bust-conf-order-list" class="select-list dropdown-content"></div>
                                </div>
                            </label>
                            <label style="width: 10em; display: flex; gap: 4px">
                                <b style="margin: auto 0">友军</b>
                                <div class="select-wrap dropdown-new dropdown-default" style="flex-grow: 1">
                                    <select id="bust-conf-friend">
                                        <option value="PIN">高亮置顶</option>
                                        <option value="HIGHLIGHT">高亮</option>
                                        <option value="">不高亮</option>
                                    </select>
                                    <div id="bust-conf-friend-list" class="select-list dropdown-content"></div>
                                </div>
                            </label>
                            <label style="width: 10em; display: flex; gap: 4px">
                                <b style="margin: auto 0">快速 Bust</b>
                                <div class="select-wrap dropdown-new dropdown-default" style="flex-grow: 1">
                                    <select id="bust-conf-quick-bust">
                                        <option value="ON">开启</option>
                                        <option value="">关闭</option>
                                    </select>
                                    <div id="bust-conf-quick-bust-list" class="select-list dropdown-content"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                `),null!==je.conf.prob_min&&Fe("#bust-conf-prob-min").val(je.conf.prob_min),null!==je.conf.prob_max&&Fe("#bust-conf-prob-max").val(je.conf.prob_max),Fe("#bust-conf-order").val(je.conf.order),Fe("#bust-conf-friend").val(je.conf.friend),Fe("#bust-conf-quick-bust").val(je.conf.quick_bust),ae(Fe("#bust-conf-prob-min"),t=>/^\d*$/.test(t)),ae(Fe("#bust-conf-prob-max"),t=>/^\d*$/.test(t)),Fe("#bust-conf select").each(function(){Fe(this).selectmenu({appendTo:`#${Fe(this).attr("id")}-list`,open:function(){Fe(this).closest(".select-wrap").addClass("s-open")},close:function(){Fe(this).closest(".select-wrap").removeClass("s-open")}})}),Fe("#bust-conf input").change(y),Fe("#bust-conf select").change(y),"loading"===n.error?Fe("#bust-info").html("<span>正在读取 Bust 历史，请稍等。若 5 秒内未出结果，请刷新页面重试。</span>"):"Access level of this key is not high enough"===n.error?Fe("#bust-info").html(`
                        <span class="t-red">权限不足，无法读取 Bust 惩罚！</span>
                        <a href="/preferences.php#tab=api">请使用 Full Access 类型的 API Key</a>
                    `):n.error?Fe("#bust-info").html(`<span class="t-red">出错啦！${n.error}</span>`):(e=n.job_perk?"惩罚效果减半":"无",Fe("#bust-info").html(`
                        <span style="width: 10em"><b>Bust 惩罚</b>: ${n.penalty.toFixed(2)}</span>
                        <span style="width: 10em" title><b>Bust 技能</b>: ${je.getBustSkill().toFixed(2)}</span>
                        <span style="width: 10em"><b>工作特技</b>: ${e}</span>
                    `),Fe("#bust-info").tooltip({tooltipClass:"white-tooltip",content:function(){var t=50===n.faction_perk?"50%":`<span class="t-red">${n.faction_perk}%</span>`,e=65===n.edu_perk?"65%":`<span class="t-red">${n.edu_perk}%</span>`;return`个人等级: ${n.level}<br>帮派加成: ${t}<br>教育加成: ${e}`}})),Fe("#bust-info").append('<a id="bust-info-toggle-conf" style="margin-left: auto" href="javascript: void">显示选项</a>'),b(je.conf.hidden),Fe("#bust-info-toggle-conf").click(function(){je.conf.hidden=!je.conf.hidden,je.save(),b(je.conf.hidden)}),Fe("b.bust-score").each(function(){var e=Fe(this).attr("bust-score");if(e){let t="t-red";if(n.error)Fe(this).text(` ${e}`),Fe(this).removeAttr("bust-prob");else{const a=je.getBustProb(e);t=120<=a?"t-gray-9":100<=a?"t-green":80<=a?"t-yellow":0<=a?"t-red":"t-red bg-red active",Fe(this).html(` ${e}&nbsp;&nbsp;${a.toFixed(1)}%`),Fe(this).attr("bust-prob",a.toFixed(1))}Fe(this).attr("class",`bust-score ${t}`)}}),m()}function b(t){t?(Fe("#bust-info-toggle-conf").text("显示选项"),Fe("#bust-conf").hide()):(Fe("#bust-info-toggle-conf").text("隐藏选项"),Fe("#bust-conf").show())}function y(){var t=Fe("#bust-conf-prob-min").val();je.conf.prob_min=t?parseInt(t):null;t=Fe("#bust-conf-prob-max").val();je.conf.prob_max=t?parseInt(t):null,je.conf.order=Fe("#bust-conf-order").val(),je.conf.friend=Fe("#bust-conf-friend").val(),je.conf.quick_bust=Fe("#bust-conf-quick-bust").val(),je.save(),m()}Re.observe(document.getElementsByClassName("userlist-wrapper")[0],{childList:!0,characterData:!0,subtree:!0})}if(gym_show_ratio&&0<=window.location.href.indexOf("gym.php")){const Be={0:{name:"balanced",description:"平衡比例",str:100,def:100,spd:100,dex:100},1:{name:"hank-str",description:"Hank比例-Str最高",str:100,def:80,spd:28,dex:80},2:{name:"hank-def",description:"Hank比例-Def最高",str:80,def:100,spd:80,dex:28},3:{name:"hank-spd",description:"Hank比例-Spd最高",str:28,def:80,spd:100,dex:80},4:{name:"hank-dex",description:"Hank比例-Dex最高",str:80,def:28,spd:80,dex:100},5:{name:"baldr-str",description:"Baldr比例-Str最高",str:100,def:72,spd:80,dex:72},6:{name:"baldr-def",description:"Baldr比例-Def最高",str:72,def:100,spd:72,dex:80},7:{name:"baldr-spd",description:"Baldr比例-Spd最高",str:80,def:72,spd:100,dex:72},8:{name:"baldr-dex",description:"Baldr比例-Dex最高",str:72,def:80,spd:72,dex:100}},We={1:{name:"Premier Fitness",stage:1,cost:10,energy:5,strength:20,speed:20,defense:20,dexterity:20,note:""},2:{name:"Average Joes",stage:1,cost:100,energy:5,strength:24,speed:24,defense:27,dexterity:24,note:""},3:{name:"Woody's Workout Club",stage:1,cost:250,energy:5,strength:27,speed:32,defense:30,dexterity:27,note:""},4:{name:"Beach Bods",stage:1,cost:500,energy:5,strength:32,speed:32,defense:32,dexterity:0,note:""},5:{name:"Silver Gym",stage:1,cost:1e3,energy:5,strength:34,speed:36,defense:34,dexterity:32,note:""},6:{name:"Pour Femme",stage:1,cost:2500,energy:5,strength:34,speed:36,defense:36,dexterity:38,note:""},7:{name:"Davies Den",stage:1,cost:5e3,energy:5,strength:37,speed:0,defense:37,dexterity:37,note:""},8:{name:"Global Gym",stage:1,cost:1e4,energy:5,strength:40,speed:40,defense:40,dexterity:40,note:""},9:{name:"Knuckle Heads",stage:2,cost:5e4,energy:10,strength:48,speed:44,defense:40,dexterity:42,note:""},10:{name:"Pioneer Fitness",stage:2,cost:1e5,energy:10,strength:44,speed:46,defense:48,dexterity:44,note:""},11:{name:"Anabolic Anomalies",stage:2,cost:25e4,energy:10,strength:50,speed:46,defense:52,dexterity:46,note:""},12:{name:"Core",stage:2,cost:5e5,energy:10,strength:50,speed:52,defense:50,dexterity:50,note:""},13:{name:"Racing Fitness",stage:2,cost:1e6,energy:10,strength:50,speed:54,defense:48,dexterity:52,note:""},14:{name:"Complete Cardio",stage:2,cost:2e6,energy:10,strength:55,speed:57,defense:55,dexterity:52,note:""},15:{name:"Legs, Bums and Tums",stage:2,cost:3e6,energy:10,strength:0,speed:55,defense:55,dexterity:57,note:""},16:{name:"Deep Burn",stage:2,cost:5e6,energy:10,strength:60,speed:60,defense:60,dexterity:60,note:""},17:{name:"Apollo Gym",stage:3,cost:75e5,energy:10,strength:60,speed:62,defense:64,dexterity:62,note:""},18:{name:"Gun Shop",stage:3,cost:1e7,energy:10,strength:65,speed:64,defense:62,dexterity:62,note:""},19:{name:"Force Training",stage:3,cost:15e6,energy:10,strength:64,speed:65,defense:64,dexterity:68,note:""},20:{name:"Cha Cha's",stage:3,cost:2e7,energy:10,strength:64,speed:64,defense:68,dexterity:70,note:""},21:{name:"Atlas",stage:3,cost:3e7,energy:10,strength:70,speed:64,defense:64,dexterity:65,note:""},22:{name:"Last Round",stage:3,cost:5e7,energy:10,strength:68,speed:65,defense:70,dexterity:65,note:""},23:{name:"The Edge",stage:3,cost:75e6,energy:10,strength:68,speed:70,defense:70,dexterity:68,note:""},24:{name:"George's",stage:3,cost:1e8,energy:10,strength:73,speed:73,defense:73,dexterity:73,note:""},25:{name:"Balboas Gym",stage:4,cost:5e7,energy:25,strength:0,speed:0,defense:75,dexterity:75,note:"Requirements must be maintained to preserve access to this gym"},26:{name:"Frontline Fitness",stage:4,cost:5e7,energy:25,strength:75,speed:75,defense:0,dexterity:0,note:"Requirements must be maintained to preserve access to this gym"},27:{name:"Gym 3000",stage:4,cost:1e8,energy:50,strength:80,speed:0,defense:0,dexterity:0,note:"Requirements must be maintained to preserve access to this gym"},28:{name:"Mr. Isoyamas",stage:4,cost:1e8,energy:50,strength:0,speed:0,defense:80,dexterity:0,note:"Requirements must be maintained to preserve access to this gym"},29:{name:"Total Rebound",stage:4,cost:1e8,energy:50,strength:0,speed:80,defense:0,dexterity:0,note:"Requirements must be maintained to preserve access to this gym"},30:{name:"Elites",stage:4,cost:1e8,energy:50,strength:0,speed:0,defense:0,dexterity:80,note:"Requirements must be maintained to preserve access to this gym"},31:{name:"The Sports Science Lab",stage:4,cost:5e8,energy:25,strength:90,speed:90,defense:90,dexterity:90,note:"The use of drugs may result in the loss of membership without refunds"},32:{name:"Unknown",stage:4,cost:2147483647,energy:10,strength:100,speed:100,defense:100,dexterity:100,note:"Membership by invite only"},33:{name:"The Jail Gym",stage:0,cost:0,energy:5,strength:34,speed:34,defense:46,dexterity:0,note:""}};for(var v in Fe("#gymroot").children().append(`
    <div>
        <div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">锻炼比例推荐
        </div>
        <div class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">
            <div class="select-wrap" style="margin:5px; float:left">
                <select id="gym-ratio" style="height:24px">
                </select>
            </div>
            <div class="select-wrap" style="margin:5px 1px; float:left">
                <p id="gym-ratio-info" style="height:12px; padding:6px 1px;">
                </p>
            </div>
        </div>
        <div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">按照当前健身房效果一枪25E超过多少钱可以放弃GYM吃SE
        </div>
        <div class="cont-gray bottom-rounded content" style="margin-bottom:10px;padding:4px;">
            <table id="se-table" style="">
            <tr><td>Strength</td><td class="value">$0</td></tr>
            <tr><td>Defense</td><td class="value">$0</td></tr>
            <tr><td>Speed</td><td class="value">$0</td></tr>
            <tr><td>Dexterity</td><td class="value">$0</td></tr>
            </table>
        </div>
    </div>`),Fe("#se-table").find("td").attr("style","font-size: 18px; border: 4px solid darkgray; padding:6px; text-align:center;"),Be)Fe("#gym-ratio").append(`<option value="${v}">${Be[v].description}</option>`);function w(t,e,a,n){const i=Fe("[class^='gymContent___']").children("[class^='properties___']").children("li");var o=Fe("#strength-val").text().split(",").join(""),r=Fe("#defense-val").text().split(",").join(""),s=Fe("#speed-val").text().split(",").join(""),l=Fe("#dexterity-val").text().split(",").join(""),d=Math.max(o/t,r/e,s/a,l/n),t=Math.abs(d*t-o)<=1?o:parseInt(d*t),e=Math.abs(d*e-r)<=1?r:parseInt(d*e),a=Math.abs(d*a-s)<=1?s:parseInt(d*a),n=Math.abs(d*n-l)<=1?l:parseInt(d*n);const c=[t,e,a,n],p=[t-o,e-r,a-s,n-l];let h=0;Fe(".gym-goal").remove(),i.each(function(){const t=Fe(this).children("[class^='propertyContent___']").children("[class^=description___]").children("p:first");0==t.children(".gym-perks").length?t.html(`<span class="t-red gym-goal" title="目标:${zt(c[h])}">还差:${Rt(p[h])} </span>`):t.prepend(`<span class="t-red gym-goal" title="目标:${zt(c[h])}">还差:${Rt(p[h])} </span>`),h++})}function _(){return new Promise((d,a)=>{var t=`https://api.torn.com/user/?selections=perks&key=${x}`;fetch(t).then(t=>t.ok?t.json():void console.log("---探测失败---"),t=>{console.log("---网络异常---")}).then(t=>{if(null!=t)if("error"in t)a(t.error);else{let a=[{},{},{},{}];for(var e in t){const l=t[e];var n,i,o,r=e.split("_")[0];for(let t=0;t<l.length;t++)0<=l[t].search(/strength gym gains/i)?(n=parseInt(/\d+%/.exec(l[t])[0].replace("%","")),a[0][r]=a[0].hasOwnProperty(r)?a[0][r]+n:n):0<=l[t].search(/defense gym gains/i)?(i=parseInt(/\d+%/.exec(l[t])[0].replace("%","")),a[1][r]=a[1].hasOwnProperty(r)?a[1][r]+i:i):0<=l[t].search(/speed gym gains/i)?(i=parseInt(/\d+%/.exec(l[t])[0].replace("%","")),a[2][r]=a[2].hasOwnProperty(r)?a[2][r]+i:i):0<=l[t].search(/dexterity gym gains/i)?(o=parseInt(/\d+%/.exec(l[t])[0].replace("%","")),a[3][r]=a[3].hasOwnProperty(r)?a[3][r]+o:o):0<=l[t].search(/gym gains/i)&&(o=parseInt(/\d+%/.exec(l[t])[0].replace("%","")),a[0][r]=a[0].hasOwnProperty(r)?a[0][r]+o:o,a[1][r]=a[1].hasOwnProperty(r)?a[1][r]+o:o,a[2][r]=a[2].hasOwnProperty(r)?a[2][r]+o:o,a[3][r]=a[3].hasOwnProperty(r)?a[3][r]+o:o)}for(let e=0;e<a.length;e++){let t=1;for(var s in a[e])t*=(a[e][s]+100)/100;a[e].total=t}d(a),console.log("perks API fetched")}else a()}).catch(t=>a(t))})}const Le=setInterval(k,2e3);function k(){const e=Fe("[class^='gymContent___']").children("[class^='properties___']").children("li");"1"==e.first().attr("hasdone")||0<e.length&&(e.first().attr("hasdone","1"),_().then(function(i){console.log(i);var t=We[$()];const o=[(t.strength/10).toFixed(1),(t.defense/10).toFixed(1),(t.speed/10).toFixed(1),(t.dexterity/10).toFixed(1)];console.log(o);let r=0;e.each(function(){var t,e=(100*(i[r].total-1)).toFixed(2),a=(i[r].total*o[r]).toFixed(3);let n="<strong>健身房系数:</strong> +"+o[r];for(t in n+="<br><strong>系数外总加成:</strong> +"+e+"%",i[r])"total"!=t&&(n+="<br><strong>"+t+":</strong> +"+i[r][t]+"%");Fe(this).children("[class^='propertyContent___']").children("[class^=description___]").children("p:first").append(`<span class="t-green gym-perks" title="${n}">实际系数: ${a} </span>`);a=I(Fe(this).children("[class^='propertyTitle___']").children("[class^='propertyValue___']").text().split(",").join(""),45e7,a,5025,25);Fe("#se-table").children().children(":eq("+r+")").children(".value").text(jt(parseInt(a))),r++})}).catch(t=>console.log("getGymPerks "+t)))}function $(){for(let t=1;t<32;t++){const e=Fe("#gym-"+t).attr("class");if(void 0===e)return 33;if(0<=e.indexOf("active"))return t}}function I(t,e,a,n,i){let o=5e7;t<5e7&&(o=t);return e/(.01*t)*(a*i*((3.480061091e-7*Math.log(n+250)+3091619094e-15)*o+682775184551527e-19*(n+250)-.0301431777))}const Ge=Kt("gym-ratio","ratio_number");if(null!==Ge&&void 0!==Ge){Fe("#gym-ratio").children("[value="+Ge+"]").attr("selected","true"),Fe("#gym-ratio-info").text(`Str : Def : Spd : Dex = ${Be[Ge].str} : ${Be[Ge].def} : ${Be[Ge].spd} : ${Be[Ge].dex}`);const qe=setInterval(()=>{0<Fe("[class^='gymContent___']").length&&w(Be[Ge].str,Be[Ge].def,Be[Ge].spd,Be[Ge].dex)},2e3)}Fe("#gym-ratio").change(function(){console.log("ratio changed");var t=Fe("#gym-ratio").val();Yt("gym-ratio","ratio_number",t),Fe("#gym-ratio-info").text(`Str : Def : Spd : Dex = ${Be[t].str} : ${Be[t].def} : ${Be[t].spd} : ${Be[t].dex}`),w(Be[t].str,Be[t].def,Be[t].spd,Be[t].dex)})}if(noAssisting&&0<=window.location.href.indexOf("loader.php?sid=attack&user2ID")){let e=Math.floor(30*Math.random()+1),a=300;const He=setInterval(F,100),Xe=setInterval(D,100);function F(){const t=Fe("[class^='btn_']");t.text().includes("Start fight")&&(t.prop("hidden",!0),t.parent().parent().children(":first").text("Wait ("+(e/10).toFixed(1)+")s To Start fight"),0==e&&(clearInterval(He),t.parent().parent().children(":first").text(""),t.removeAttr("hidden")),e--)}function D(){const t=Fe("[class^='btn_']");t.text().includes("Join fight")&&(t.prop("hidden",!0),t.parent().parent().children(":first").text("Wait ("+(a/10).toFixed(1)+")s To Join fight 已有其他人进入此战斗"),0==a&&(clearInterval(Xe),t.parent().parent().children(":first").text(""),t.removeAttr("hidden")),a--)}}if(0<=window.location.href.indexOf("loader.php?sid=attack&user2ID")){let i=100;const Je=setInterval(S,500);function S(){var t,e,a,n;0<Fe("[class^=level]").length&&0<Fe("#log-header").length&&(n=Fe("[class^=level]").attr("style").replace("height: ","").replace("%",""),(t=parseFloat(n))>i||(e=66<=(i=t)?"green":"red",a=66<=t?"高":"低",Fe("#stealth-value").remove(),n=Fe("#log-header").children(":first").attr("class"),Fe("#log-header").children(":first").after(`
            <span id="stealth-value" class="${n}">隐身几率:&nbsp;
                <span class="t-${e}">${a}</span>
                &nbsp;Stealth:&nbsp;
                <span class="t-${e}">${t}%</span>
            </span>`)))}}if(0<=window.location.href.indexOf("loader.php?sid=attack&user2ID")){const Ue=setInterval(A,500);function A(){0<Fe("[class^=labelsContainer]").length&&Fe("[class^=titleContainer]").empty(),0<Fe("[class^=modal___]").length&&Fe("#upper-layer").length<1?O(Fe("[class^=modal___]"),"upper-layer"):0<Fe("[class^=playerWindow___]").length&&Fe("#lower-layer").length<1&&O(Fe("[class^=playerWindow___]"),"lower-layer")}const Ke=window.location.href.substr(51);function O(t,i){t.last().append(`
                <div id="${i}" style="width:200px; height:16px; position: absolute; right: 1px; top: 2px; z-index: 1; color: white ;background-color: ${Ce.blue}; border: 2px solid darkgray; padding-top: 3px; margin: 5px; text-align: center;">
                    <span>当前Chain状态读取中...</span>
                </div>
            `);t=`https://api.torn.com/faction/?selections=chain&key=${x}`;fetch(t).then(t=>t.json()).then(e=>{if("chain"in e){var a=parseInt(e.chain.timeout/60),n=e.chain.timeout%60,a="0"+a,n=9<n?n:"0"+n;let t=Ce.blue;100<=e.chain.max&&e.chain.max-e.chain.current<=20&&(t=Ce.red),Fe("#"+i).css("background-color",t).text(`当前Chain: ${e.chain.current}/${e.chain.max} 超时: ${a}:${n}`),console.log(i)}else"error"in e&&Fe("#"+i).text("当前Chain状态读取失败")}).catch(t=>console.log("fetch error",t))}Fe("[class^=titleContainer]").empty(),Fe("[class^=titleContainer]").append(`<span id="online-status" class="border-round" style="color:white;background-color:${Ce.red};padding:5px;font-size:18px;" title="在线状态"></span>`),Fe("[class^=titleContainer]").append(`<span id="last-action" class="border-round" style="color:white;background-color:${Ce.red};padding:5px;font-size:18px;" title="离线时间"></span>`),Fe("[class^=titleContainer]").append(`<span id="refresh-btn" class="border-round" style="cursor:pointer;color:white;background-color:${Ce.blue};padding:5px;font-size:18px;">刷新</span>`),Fe("#refresh-btn").click(()=>{location.reload()}),ne(Ke,function(t){var e;null!=t&&"last_action"in t&&("Online"==(e=t.last_action.status)?Fe("#online-status").css("background-color",Ce.green):"Idle"==e?Fe("#online-status").css("background-color",Ce.yellow):Fe("#online-status").css("background-color",Ce.gray),Fe("#online-status").text(e),Fe("#last-action").text(t.last_action_details))},function(t){Fe("#online-status").text("蛙蛙探测 "+Ke+" 失败 "+t)})}if(nurse_suggestion&&0<=window.location.href.indexOf("item.php")&&$e(".tutorial-cont"),0<=window.location.href.indexOf("factions.php?step=your")){let t=new MutationObserver(function(t,e){console.log("changed"),$e("#faction-armoury-tabs")});t.observe(document.getElementById("faction-armoury"),{childList:!0,subtree:!0})}if(taking_off_reminder&&0<=window.location.href.indexOf("travelagency.php")&&(0<Fe("#icon86-sidebar").length&&(Fe("#tab-menu4").after(`<div><div id='oc-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:NavajoWhite;text-align:center;'>OC准备就绪 点击前往执行</div></div>`),Fe("#oc-btn").click(function(){Fe(this).text("蛙蛙正在前往……"),window.location.href="https://www.torn.com/factions.php?step=your#/tab=crimes"})),0<Fe("#icon49-sidebar").length?Fe("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#c0542f;text-align:center;'>DRUG CD 小于10分钟 先不要飞了哦</div></div>`):0<Fe("#icon50-sidebar").length?Fe("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#DAA520;text-align:center;'>DRUG CD 不足1小时 先不要飞了哦</div></div>`):0<Fe("#icon51-sidebar").length?Fe("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#5d9525;text-align:center;'>DRUG CD 为1-2小时之间 可尽情飞翔</div></div>`):0<Fe("#icon52-sidebar").length?Fe("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#5d9525;text-align:center;'>DRUG CD 为2-5小时之间 可尽情飞翔</div></div>`):0<Fe("#icon53-sidebar").length?Fe("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#5d9525;text-align:center;'>DRUG CD 大于5小时 可尽情飞翔</div></div>`):Fe("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#5d9525;text-align:center;'>DRUG CD 为零 是不是忘吃药了</div></div>`)),0<=window.location.href.indexOf("factions.php?step=your")){const Ve=setInterval(C,3e3);function C(){Fe("div.title").children("div.id").text("BS");const t=Fe("li.enemy").children("div.id");0<t.length&&t.each(function(t,e){const a=Fe(this).siblings("span").children("div.member").children("a.user.name"),n=a?a.attr("href"):void 0;var i=n?n.substr(18):void 0;i&&((i=Kt("battlestats",i))?Fe(this).text(P(i)):Fe(this).text("nil"))});const e=Fe("li[class^='enemy enemy___']").parent(),a=Fe("li[class^='enemy enemy___']").children("div.attack").children();0<a.length&&a.each(function(){if("1"!=Fe(this).attr("detected")){const e=Fe(this).parent().siblings("div.member").children().children("[class^=userWrap___]").children(),a=e?e.attr("href"):void 0;var t=a?a.substr(18):void 0;console.log(t),t&&((t=Kt("battlestats",t))?(Fe(this).text(P(t)),Fe(this).attr("bs",t)):Fe(this).attr("bs",0))}Fe(this).attr("detected","1")}),0<e.length&&"1"!=e.attr("hasdone")&&(e.attr("hasdone","1"),T(e.siblings().children("div[class^='attack left attack___']"),M))}function M(t){return Fe(t).find("[bs]").attr("bs")}function T(t,a){const e=t.parent().siblings(),n=t.parent().siblings().children();t.click(function(){"decend"==Fe(this).attr("sort")?(n.sort(function(t,e){return a(t)-a(e)}),n.detach().appendTo(e),Fe(this).attr("sort","ascend")):(n.sort(function(t,e){return a(e)-a(t)}),n.detach().appendTo(e),Fe(this).attr("sort","decend"))})}function P(t){return 1e15<=t?"max":1e13<=t?parseInt(t/1e12)+"t":1e12<=t?(t/1e12).toFixed(1)+"t":1e10<=t?parseInt(t/1e9)+"b":1e9<=t?(t/1e9).toFixed(1)+"b":1e7<=t?parseInt(t/1e6)+"m":1e6<=t?(t/1e6).toFixed(1)+"m":1e4<=t?parseInt(t/1e3)+"k":1e3<=t?(t/1e3).toFixed(1)+"k":t}}if(0<=window.location.href.indexOf("page.php?sid=log")){const Ye=setInterval(N,1e3);function N(){const t=Fe(".panel > div[class^=title]");0!==t.length&&(clearInterval(Ye),t.prepend('<button id="log-export-btn" class="torn-btn" style="margin:5px;">导出所选日志</button>'),Fe("#log-export-btn").click(async function(){const t=new Proxy(new URLSearchParams(window.location.search),{get:(t,e)=>t.get(e)});var a=t.cat?t.cat.split(","):[];const n=t.log&&0===a.length?t.log.split(","):[];if(0!==a.length||0!==n.length){alert("注意：\n* 请勿同时使用其他频繁请求 API 的功能（例如：冰蛙目标、阅兵、犯罪经验）\n* 导出需要很长时间，请耐心等待\n* 若要取消，请刷新或关闭页面\n");try{Fe(this).prop("disabled",!0),Fe(this).text("正在导出，请耐心等待");var e=await(await fetch(`https://api.torn.com/user/?selections=basic&key=${x}`)).json();if("error"in e)throw new Error(e.error.error);const s=Math.max(Math.ceil(n.length/10),1),l=[];for(let e=0;e<s;e++){var i=t=>{Fe(this).text(`正在导出，请耐心等待 (第 ${e+1}/${s} 批 ${new Date(1e3*t).format("yyyy-MM-dd")})`)};for await(const d of se(a,n.slice(10*e,10*(e+1)),t.from,t.to,i))l.push(d)}l.sort((t,e)=>e.timestamp-t.timestamp);var o={user_id:e.player_id,user_name:e.name,timestamp:Math.floor((new Date).getTime()/1e3),categories:a,types:n,logs:l},r=`data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(o))}`;Fe(this).replaceWith(`<a download="torn-log-${o.user_id}-${o.timestamp}.json" href="${r}"
                            class="torn-btn" style="color: #333; margin:5px; display:inline-block;">导出完毕，点击保存</a>`)}catch(t){console.trace(t),"Access level of this key is not high enough"===t.message?Fe(this).replaceWith('<a href="/preferences.php#tab=api">权限不足！请使用 Full Access 类型的 API Key</a>'):(Fe(this).text("出错啦！请刷新重试"),alert(`出错啦！${t}`))}}else alert("请选择日志类型")}))}}if(0<=window.location.href.indexOf("preferences.php")){const Ze=setInterval(E,500);function E(){var t=Fe("[class^=api___]"),e=Fe("#name").attr("aria-expanded"),a=Fe("#name").attr("aria-hidden");if(0<t.length&&"false"==e&&"false"==a){Fe("#bingwa-apikey-setting").length<1&&Fe(".content-title").after(`
                <div id="bingwa-apikey-setting">
                    <div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">冰蛙APIKey设置</div>
                    <div id="bingwa-apikey-setting-wrapper" class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">
                        <div style="margin:5px;padding:5px;">你拥有的APIKey个数为 <span id="apikey-number" style="padding:3px;color:${Ce.yellowgreen};font-size:18px;"></span> 个</div>
                        <div style="margin:5px;padding:5px;">冰蛙当前使用的APIKey为 <span id="apikey-current" style="padding:3px;color:${Ce.red};font-size:18px;"></span></div>
                        <div id= "apikey-wrapper"style="margin:5px;padding:5px;"></div>
                    </div>
                </div>`);const n=Fe("[class^=keyRow]");Fe("#apikey-number").text(`${n.length}`),Fe("#apikey-current").text(`${window.localStorage.getItem("APIKey")}`),Fe("#apikey-wrapper").empty(),0<n.length&&n.each(function(){var t=Fe(this).children("[class^=key]").val(),e=Fe(this).children("[class^=blockTablet]").children("[class^=type]").val();Fe("#"+t).length<1&&(t==window.localStorage.getItem("APIKey")?Fe("#apikey-wrapper").append(`
                                <div id="${t}" style="">
                                    <button class="torn-btn" style="margin:5px;" disabled>已使用</button>
                                    <span style="padding:3px;color:white;background-color:${Ce.purple};font-size:12px;">${e}</span>
                                    <span style="padding:3px;color:white;background-color:${Ce.purple};font-size:16px;">${t}</span>
                                </div>`):(Fe("#apikey-wrapper").append(`
                                <div id="${t}" style="">
                                    <button class="torn-btn" style="margin:5px;">未使用</button>
                                    <span style="padding:3px;color:white;background-color:${Ce.gray};font-size:12px;">${e}</span>
                                    <span style="padding:3px;color:white;background-color:${Ce.gray};font-size:16px;">${t}</span>
                                </div>`),Fe(".torn-btn").click(function(){window.localStorage.setItem("APIKey",Fe(this).parent().attr("id"))})))})}else Fe("#bingwa-apikey-setting").remove()}}else if(null==x||""==x)alert("宝鉴需要一个有效的APIKey，将前往设置页面，待载入后选择你的APIKey。"),window.location.href="https://www.torn.com/preferences.php#tab=api";else{const Qe=Fe("#sidebarroot").find("[class^='status-icons___']"),ta=Fe("#top-page-links-list").children("a");if(0<ta.length||0<Qe.length){console.log("当前页面有按钮，可以宝鉴");let n={user:["ammo","attacks","attacksfull","bars","basic","battlestats","bazaar","cooldowns","crimes","discord","display","education","events","gym","hof","honors","icons","inventory","jobpoints","log","medals","merits","messages","missions","money","networth","newevents","newmessages","notifications","perks","personalstats","profile","properties","receivedevents","refills","reports","revives","revivesfull","skills","stocks","timestamp","travel","weaponexp","workstats"],property:["property","timestamp"],faction:["applications","armor","armorynews","attacknews","attacks","attacksfull","basic","boosters","cesium","chain","chainreport","chains","contributors","crimenews","crimes","currency","donations","drugs","fundsnews","mainnews","medical","membershipnews","positions","reports","revives","revivesfull","stats","temporary","territory","territorynews","timestamp","upgrades","weapons"],company:["applications","companies","detailed","employees","news","newsfull","profile","stock","timestamp"],market:["bazaar","itemmarket","pointsmarket","timestamp"],torn:["bank","cards","chainreport","companies","competition","education","factiontree","gyms","honors","items","logcategories","logtypes","medals","organisedcrimes","pawnshop","pokertables","properties","rackets","raids","rankedwarreport","rankedwars","stats","stocks","territory","territorywars","timestamp"],key:["info"]},l="",d="",c="";const aa='<li class="a_click_view_api_info icon6___XChW2" title="冰蛙宝鉴 呱" style="cursor: pointer; background-image:url(/images/v2/editor/emoticons.svg); background-position: -470px -42px;"></li>';Qe.prepend(aa);const na='<a role="button" style="cursor: pointer" aria-labelledby="events" class="a_click_view_api_info events t-clear h c-pointer  m-icon line-h24 right last"><span class="icon-wrap svg-icon-wrap"><span class="link-icon-svg events "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17"><defs><style>.cls-1{opacity:0.35;}.cls-2{fill:#fff;}.cls-3{fill:#777;}</style></defs><g id="Ð¡Ð»Ð¾Ð¹_2" data-name="Ð¡Ð»Ð¾Ð¹ 2"><g id="icons"><g class="cls-1"><path class="cls-2" d="M8,1a8,8,0,1,0,8,8A8,8,0,0,0,8,1ZM6.47,3.87H9.53l-.77,7.18H7.24ZM8,14.55A1.15,1.15,0,1,1,9.15,13.4,1.14,1.14,0,0,1,8,14.55Z"></path></g><path class="cls-3" d="M8,0a8,8,0,1,0,8,8A8,8,0,0,0,8,0ZM6.47,2.87H9.53l-.77,7.18H7.24ZM8,13.55A1.15,1.15,0,1,1,9.15,12.4,1.14,1.14,0,0,1,8,13.55Z"></path></g></g></svg></span></span><span id="a_click_view_api_info_text">宝鉴</span></a>';ta.last().after(na),Fe(".a_click_view_api_info").click(function(){if(Fe("#bwm").length<1){var t=`
                <div id="bwm">
                    <div id="bwm-nav">
                        <ul style="list-style-type: none;margin: 10px 0px;padding: 0;overflow: hidden;background-color: #333;">
                            <li style="float: left">
                                <a id="bwm-version" role="button" style="cursor: pointer;display: block;color: black;background-color: #4CAF50;text-align: center;padding: 14px 16px;text-decoration: none;" >版本记录</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-api" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >查看API</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-company" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >我的公司</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-faction" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >帮派详情</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-target" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >冰蛙目标</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-chatlog" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >聊天记录</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-warroom" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >世界局势</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-revive" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >复活助手</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-rankedwar" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >近期RW</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-crimeexp" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >犯罪经验</a>
                            </li>
                            ${i!=De.other?`
                            <li style="float: left">
                            <a id="bwm-extcenter" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >插件</a>
                            </li>`:""}
                            <li style="float: left">
                                <a id="bwm-settings" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >设置</a>
                            </li>
                            <li style="float: right">
                                <a id="bwm-return" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >返回</a>
                            </li>
                        </ul>
                    </div>
                </div>`;Fe("#mainContainer").prepend(t);function s(t){const e=Fe("#bwm-nav [id^=bwm-]");e.attr("style","cursor: pointer; display: block; color: white; text-align: center; padding: 14px 16px; text-decoration: none;"),Fe(t).attr("style","cursor: pointer; display: block; color: black; background-color: #4CAF50; text-align: center; padding: 14px 16px; text-decoration: none;")}function e(){var t=Ie();return`
                    <div id="version_container" style="width: inherit">
                        <div style="text-align:center; margin-bottom: 10px;">
                            <a role="button" style="cursor: pointer; font-size: large; color: #777;">冰蛙当前版本为 ${t[0]}</a>
                        </div>
                        <div style="text-align:center;">
                            <textarea  style="height:800px;width:100%;background-color: lightgray; font-family:\'Lucida Console\', Monaco, monospace; font-size: 0.8rem;line-height: 1.3;" readonly="readonly">${t[1]}</textarea>
                        </div>
                    </div>`}window.localStorage.setItem("BINGWA_TARGET_FLAG",""),Fe("#bwm").append(e()),Fe("#bwm-version").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(e()),s("#bwm-version")}),Fe("#bwm-api").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(function(){let t="";for(var e in n)t+='<a role="button" style="cursor: pointer; font-size: large; color: #777;" class="a_click_api_type">'+e+"</a>&nbsp;&nbsp;";t+='<br /><br /><input type="text" id="api_input_id" name="api_input_id" placeholder="ID (当前用户不用填)" size="25" style="font-size: larger; padding: 3px;" />&nbsp;&nbsp;<input type="text" id="api_input_from_time" name="api_input_from_time" placeholder="From (Eg: 2019/10/25 23:00:00)" size="29" style="font-size: larger; padding: 3px;" />&nbsp;&nbsp;<input type="text" id="api_input_to_time" name="api_input_to_time" placeholder="To (Eg: 2019/10/26 08:00:00)" size="28" style="font-size: larger; padding: 3px;" />';let a='<div id="api_container"><div id="api_types_container" style="text-align:center; margin-bottom: 10px;">'+t+'</div><div id="api_fields_container" style="text-align:center; margin-bottom: 10px;"></div><div id="api_result_header" style="text-align:center; margin-bottom: 3px; font-size: large;"></div><div style="text-align:center;"><textarea id="api_result_container" rows="40" style="width:100%; background-color: lightgray; font-family:\'Lucida Console\', Monaco, monospace; font-size: 0.8rem;line-height: 1.3;" readonly="readonly" /><br /><a id="api_result_download_csv" role="button" style="cursor: pointer; font-size: large; color: #777;">导出为CSV文件</a>';return foo?a+='&nbsp;&nbsp;&nbsp;&nbsp;<a id="a_faction_parade" role="button" style="cursor: pointer; font-size: large; color: #777;">帮派大阅兵</a><a id="a_faction_parade_download" role="button" style="display:none">帮派大阅兵下载</a>&nbsp;&nbsp;&nbsp;&nbsp;<a id="a_faction_attacks" role="button" style="cursor: pointer; font-size: large; color: #777;">帮战统计</a><a id="a_faction_attacks_download" role="button" style="display:none">帮战统计下载</a></div></div>':a+="</div></div>",a}()),s("#bwm-api"),Fe(".a_click_api_type").click(function(){Fe("#api_fields_container").empty(),l=Fe(this).text(),console.log("click: "+l);var t,e=n[l].sort();for(t in e){var a=e[t];Fe("#api_fields_container").append('<a role="button" style="cursor: pointer; font-size: large; color: #777;" class="a_click_api_field">'+a+"</a>&nbsp;&nbsp;"),t%10==8&&Fe("#api_fields_container").append("<br />")}Fe(".a_click_api_field").click(function(){Fe("#api_result_container").val("");var t=Fe(this).text(),e=Fe("#api_input_id").val(),a=Fe("#api_input_from_time").val(),n=new Date(a).getTime()/1e3,i=Fe("#api_input_to_time").val(),o=new Date(i).getTime()/1e3;let r=`https://api.torn.com/${l}/${e}?selections=${t}&key=${x}&from=${n}&to=${o}`;(isNaN(n)||isNaN(o))&&(r=`https://api.torn.com/${l}/${e}?selections=${t}&key=${x}`),console.log(`Request: ${r}`),c=l+" - "+e+" - "+t+" - "+a+" - "+i,Fe("#api_result_header").text(`探测中: ${c}`),Fe("#api_result_download_csv").removeAttr("href"),Fe("#api_result_download_csv").removeAttr("download"),d="",fetch(r).then(t=>t.ok?t.json():void Fe("#api_result_header").text(`探测失败: ${c}`),t=>{Fe("#api_result_header").text(`网络异常: ${c}`)}).then(t=>{console.log(`Response: ${r}`),console.log(t),void 0!==t&&(Fe("#api_result_header").text(`探测完成: ${c}`),d=t,Fe("#api_result_container").val(JSON.stringify(t,null,4)))})})}),Fe("#api_result_download_csv").click(function(){var t;null==d||""==d||null==c||""==c||"object"!=typeof d||d.length<1?alert("没有可导出的数据"):null!=(t=qt(d))?(t=Jt(t),Fe(this).attr("href","data:text/csv;charset=utf-8,\ufeff"+t),Fe(this).attr("download",c+".csv")):alert("没找到有效的数据集")}),Fe("#a_faction_parade").click(function(){Fe("#api_result_container").val("");const l=Fe("#api_input_id").val();de("开始帮派大阅兵，将拉取帮派成员列表，然后逐个查询该成员的详细信息，再使用蛙蛙探测器增加分析结果，最后导出为csv文件。"),de("请注意："),de("1、此功能会调用很多次API接口，所以不要太频繁使用。"),de("2、为了避免太频繁被封接口，每次查询做了延时，所以运行时间较久，请耐心等待。"),de("3、如果想中途放弃，请直接关掉本网页窗口。");let a=`https://api.torn.com/faction/${l}?selections=basic&key=${x}`;Fe("#api_result_header").text(`帮派大阅兵 ${l}`),console.log(`Request: ${a}`),de("\n开始获取帮派成员列表"),fetch(a).then(t=>t.ok?t.json():void de("阅兵失败"),t=>{de("阅兵失败，网络异常")}).then(t=>{console.log(`Response: ${a}`),console.log(t);const n=Object.keys(t.members),e=n.length;de(`获取帮派成员列表完成，共有 ${e} 个成员`);let i=new Array,o=0;function r(){const e=n[o];let a=t.members[e];a.userId=e,i.push(a),ne(e,function(t){de(`蛙蛙探测 userId: ${e} 成功`),Object.assign(a,t),s()},function(t){de(`蛙蛙探测 userId: ${e} 失败`),s()})}function s(){if(o<e-1)++o,setTimeout(r,1e3);else{de("蛙蛙探测完成"),de("\n开始转换为csv格式...");var a=Jt(i);const n=Fe("#a_faction_parade_download");n.attr("href","data:text/csv;charset=utf-8,\ufeff"+a);let t=new Date;n.attr("download",`FactionParade_${l}_${t.format("yyyyMMdd_hhmm")}.csv`),de("转换为csv格式完成"),de("\n开始下载");let e=document.createEvent("MouseEvents");e.initEvent("click",!0,!0),document.getElementById("a_faction_parade_download").dispatchEvent(e)}}de("\n开始启动蛙蛙探测..."),r()})}),Fe("#a_faction_attacks").click(function(){var t=Fe("#api_input_from_time").val();const d=new Date(t);let c=d.getTime()/1e3;var e=Fe("#api_input_to_time").val();const p=new Date(e),h=p.getTime()/1e3;if(isNaN(c)||isNaN(c))alert("此功能必须输入起止时间（你的电脑本地时间，不要转为TCT）");else{Fe("#api_result_container").val(""),de("开始帮战统计，将自动切分时间段，拉取帮派attacks记录（每次最多100条），然后拼接，最后导出为csv文件。"),de("请注意："),de("1、此功能需要帮派API权限。"),de("2、此功能会调用很多次API接口，所以不要太频繁使用。"),de("3、每30秒才访问一次（因为测试发现数据有缓存），所以运行时间较久，请耐心等待。"),de("4、如果想中途放弃，请直接关掉本网页窗口。"),de(`\n开始时间：${t} 时间戳 ${c} ，结束时间：${e} 时间戳 ${h} \n`);let l=new Object;!function r(){const s=`https://api.torn.com/faction/?selections=attacks&key=${x}&from=${c}&to=${h}`;console.log(`Request: ${s}`),Fe("#api_result_header").text("帮战统计"),fetch(s).then(t=>t.ok?t.json():(de("抓取失败，将1秒后重试"),void setTimeout(r,1e3)),t=>{de("抓取失败，将1秒后重试"),setTimeout(r,1e3)}).then(t=>{function e(){de("\n攻击记录抓取完成，开始转换为csv格式...");var t=Jt(Lt(l));const e=Fe("#a_faction_attacks_download");e.attr("href","data:text/csv;charset=utf-8,\ufeff"+t),e.attr("download",`FactionAttacks_${d.format("yyyyMMddhhmmss")}_${p.format("yyyyMMddhhmmss")}.csv`),de("转换为csv格式完成"),de("\n开始下载");let a=document.createEvent("MouseEvents");a.initEvent("click",!0,!0),document.getElementById("a_faction_attacks_download").dispatchEvent(a)}console.log(`Response: ${s}`),console.log(t),Object.assign(l,t.attacks);var a=Lt(t.attacks);if(0<a.length){var n=a[0].timestamp_started;const i=new Date(1e3*n);t=a[a.length-1].timestamp_started;const o=new Date(1e3*t);de(`抓取 ${c} - ${h} 有 ${a.length} 条，第一条 ${n} ${i.format("yyyy/MM/dd hh:mm:ss")}，最后一条 ${t} ${o.format("yyyy/MM/dd hh:mm:ss")}，累计 ${Object.keys(l).length} 条`),t<c||t>h?1<a.length?(de("抓取的数据没有更新，准备重试"),setTimeout(r,1e4)):(de("系统会莫名其妙的卡在最后一条，直接完成"),e()):(c=t+2,setTimeout(r,30500))}else e()})}()}})}),Fe("#bwm-company").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                    <div id="mycompany_container" style="width: inherit">
                        <div id="mycompany-head" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                            <span id="companyname" role="button" style="font-size: large; color:#777;" >我的公司</span>
                        </div>
                        <div id="tips-view-company" style="text-align:center; margin-bottom: 3px; font-size: 4px;"></div>
                        <div id="mycompany-content" style="min-height:400px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>
                    </div>`),s("#bwm-company");var t=ge();console.log("userId "+t),$t(t).then(function(t){console.log(t);t=t[3];"Employee"==t?rt(Fe("#mycompany-content")):"Director"==t&&st(Fe("#mycompany-content"))}).catch(t=>console.log("userId2otherIds "+t))}),Fe("#bwm-faction").click(function(){function r(){var t=window.localStorage.getItem("faction_compare_history");if(null!=t){var e,a=JSON.parse(t);for(e in a)Fe("#bwm_faction_history").append(`
                                <div class="wrapper-history" style="width:135px;float:left;border:1px solid darkgray;margin:5px 10px;">
                                    <div class="head-history" style="background-color:black;color:white;padding:5px;overflow:hidden;">
                                        <div class="id-history" style="width:30%;float:left;margin-left:50%;position:relative;left:-15%;">${e}</div>
                                        <div style="float:right;cursor:pointer;background-color:white;color:black;padding:0px 2px;">
                                            <a class="delete-history" role="button" >X</a>
                                        </div>
                                    </div>
                                    <div class="content-history" style="background-color:white;padding:5px;">
                                        <a style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" class="user faction" href="/factions.php?step=profile&amp;ID=${e}" target="_blank">${a[e]}</a>
                                    </div>
                                </div>`);Fe(".delete-history").click(function(){var t=Fe(this).parent().parent().children(".id-history").text();Zt("faction_compare_history",t),Fe(this).parent().parent().parent().remove(),console.log("删除成功: "+t)}),Fe(".head-history").click(function(){const t=Fe(this).siblings(".content-history");var e;"selected"==t.attr("selected")?(t.css("background-color","white"),t.removeAttr("selected"),Fe("#faction-input-id").val("")):(Fe(".content-history").css("background-color","white"),Fe(".content-history").removeAttr("selected"),t.css("background-color","navajowhite"),t.attr("selected","selected"),e=Fe(this).children(".id-history").text(),Fe("#faction-input-id").val(e))})}}Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                    <div id="bwm_faction_container" style="width: inherit">
                        <div id="bwm_faction_header" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                            <input type="text" id="faction-input-id" name="faction-input-id" placeholder="帮派 ID" size="10" style="font-size: larger; padding: 5px; margin: 5px;" />
                            <button id="faction-load-btn" class="torn-btn" style="margin:5px;">读取帮派</button>
                            <button id="faction-parade-start-btn" class="torn-btn" style="margin:5px;">开始阅兵</button>
                            <button id="faction-parade-stop-btn" class="torn-btn" style="margin:5px;" disabled>停止阅兵</button>
                        </div>
                        <div id="bmw_faction_tips" style="text-align:center; margin-bottom: 3px; font-size: 4px;"></div>
                        <div id="bwm_faction_history" style="margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden;"></div>
                        <div id="bmw_faction_wrapper" style="min-height:700px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>
                    </div>`),s("#bwm-faction"),r();let t=window.localStorage.getItem("MY_FACTION_ID");void 0!==t&&null!==t||(t="20465"),Fe("#faction-load-btn").click(function(){Fe("#faction-input-id").val()||Fe("#faction-input-id").val(t),function(i,t){t.empty(),t.append(`
                        <div id="name-faction" style="font-size: 20px; margin: 4px;"><img id="tag-faction" style="margin-right: 4px;"><span></span></div>
                        <div id="rank-faction" style="margin: 2px;"></div>
                        <div id="detail-faction" style="margin: 2px;"></div>
                        <div id="table-faction">
                            <table class="table-faction-table" style="margin:auto;background-color:white;font-size:12px;">
                                <tr class="head">
                                    <th class="table-online">Online</th>
                                    <th class="table-level">Lvl</th>
                                    <th>Name</th>
                                    <th>ID</th>
                                    <th class="table-last">Last</th>
                                    <th class="table-status">Status</th>
                                    <th class="table-position">Position</th>
                                    <th class="table-days">Days</th>
                                    <th>Attack</th>
                                    <th class="table-bs">BS</th>
                                    <th class="table-revivable">Revivable</th>
                                    <th>Description</th>
                                </tr>
                            </table>
                        </div>`),Fe("#table-faction").find(".table-faction-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),t=`https://api.torn.com/faction/${i}?selections=basic&key=${x}`;const o=Fe("#bmw_faction_tips");o.text("---探测中 "+i+"---"),fetch(t).then(t=>t.ok?t.json():void o.text("---探测失败 "+i+"---"),t=>{o.text("---网络异常 "+i+"---")}).then(t=>{console.log("API fetched: "+i),null!=t&&o.text("---探测完成 "+i+"---"),Fe("#name-faction").children("span").text(`${t.name} - ${i}`),Fe("#tag-faction").attr("src",`https://factiontags.torn.com/${t.tag_image}`),Fe("#rank-faction").text(`Rank: ${t.rank.name} - ${t.rank.division}`),Yt("faction_compare_history",i,t.name),Fe("#bwm_faction_history").empty(),r(),Fe(".id-history").each(function(){Fe(this).text()==i&&Fe(this).parent().parent().children(".content-history").css("background-color","NavajoWhite")});var e=Object.keys(t.members).length;const a=t.respect;var n=a.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","});Fe("#detail-faction").text(`Members: ${e} | Resp: ${n} | Best Chain: ${t.best_chain}`),Fe.each(t.members,function(t,e){var a=t,n=Z(a),i=et(e.last_action.timestamp),o=e.status.state,r=e.status.description,s=e.status.until,t=e.status.color,o=at(r,o,s),s=tt(a);let l="white";"Leader"!=e.position&&"Co-leader"!=e.position||(l="NavajoWhite");let d="grey",c=1;"Online"==e.last_action.status?(d="DarkSeaGreen",c=3):"Idle"==e.last_action.status&&(d="Orange",c=2);e=`
                                    <tr class="content">
                                        <td class="table-online" code="${c}" style="border: 1px solid darkgray;padding:5px;color:white;background-color:${d}">${e.last_action.status}</td>
                                        <td class="table-level" style="border: 1px solid darkgray;padding:5px;">${e.level}</td>
                                        <td style="border: 1px solid darkgray;padding:5px;"><a class="user name" href="/profiles.php?XID=${a}" target="_blank">${e.name}</a></td>
                                        <td style="border: 1px solid darkgray;padding:5px;text-align:right;">${a}</td>
                                        <td class="table-last" style="border: 1px solid darkgray;padding:5px;" last-action-minutes="${i[0]}">${i[1]}</td>
                                        <td class="table-status t-${t}" style="border: 1px solid darkgray;padding:5px;" hospital-minutes="${o[1]}">${o[0]}</td>
                                        <td class="table-position" style="border:1px solid darkgray;padding:5px;background-color:${l}">${e.position}</td>
                                        <td class="table-days" style="border: 1px solid darkgray;padding:5px;">${e.days_in_faction}</td>
                                        <td style="border: 1px solid darkgray;padding:5px;"><a style="color:#006699;text-decoration:none;" href="/loader.php?sid=attack&user2ID=${a}" target="_blank">Attack</a></td>
                                        <td class="table-bs" style="border: 1px solid darkgray;padding:5px;" estimate-bs="${n[0]}">${n[2]}</td>
                                        <td class="table-revivable" style="border: 1px solid darkgray;padding:5px;">${s}</td>
                                        <td style="border: 1px solid darkgray;padding:5px;">${e.status.details}</td>
                                    </tr>`;Fe("#table-faction").children(".table-faction-table").children().append(e)})}).catch(t=>console.log("fetch error",t))}(Fe("#faction-input-id").val(),Fe("#bmw_faction_wrapper")),te(Fe("th.table-bs"),Y),te(Fe("th.table-last"),K),te(Fe("th.table-status"),V),te(Fe("th.table-online"),H),te(Fe("th.table-level"),q),te(Fe("th.table-position"),J),te(Fe("th.table-days"),U),te(Fe("th.table-revivable"),X)});let i=!0;Fe("#faction-parade-start-btn").click(function(){i=!0,Fe("#faction-load-btn").prop("disabled",!0),Fe("#faction-parade-start-btn").prop("disabled",!0),Fe("#faction-parade-stop-btn").removeAttr("disabled"),Fe("tr.head").attr("style","pointer-events: none;");const t=Fe(".table-faction-table").children().children("tr.content").first();t.length<=0?(Fe("#bmw_faction_tips").text("未找到用户列表"),Fe("#faction-load-btn").removeAttr("disabled"),Fe("#faction-parade-start-btn").removeAttr("disabled"),Fe("#faction-parade-stop-btn").prop("disabled",!0),Fe("tr.head").removeAttr("style")):(Fe("#bmw_faction_tips").text("阅兵开始"),setTimeout(()=>{!function e(a){if("1"==a.attr("detected"))Fe("#bmw_faction_tips").text("用户已完成"),setTimeout(()=>{e(a.next())},0);else if(a.length<=0||0==i)Fe("#bmw_faction_tips").text("阅兵已结束"),Fe("#faction-load-btn").removeAttr("disabled"),Fe("#faction-parade-start-btn").removeAttr("disabled"),Fe("#faction-parade-stop-btn").prop("disabled",!0),Fe("tr.head").removeAttr("style");else{a.attr("detected","1");const n=a.find("a.user.name").attr("href").replace(/[^0-9|-]/gi,"");Fe("#bmw_faction_tips").text("正在阅兵: "+n),ne(n,function(t){a.children("td.table-bs").text(Rt(t.estimate_bs)),a.children("td.table-bs").attr("estimate-bs",t.estimate_bs),Yt("battlestats",n,t.estimate_bs),a.children("td.table-revivable").text(t.revivable),Yt("revivable",n,t.revivable),setTimeout(()=>{e(a.next())},1e3)},function(t){Fe("#bmw_faction_tips").text("蛙蛙探测 "+n+" 失败 "+t),setTimeout(()=>{e(a.next())},1e3)})}}(t)},1e3))}),Fe("#faction-parade-stop-btn").click(function(){i=!1})}),Fe("#bwm-target").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                    <div id="bwm_target_container" style="width: inherit">
                        <div id="bwm_target_header" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                            <button id="target-load-excel" class="torn-btn" style="margin:5px;">加载本地excel文件</button>
                            <button id="target-clear-cache" class="torn-btn" style="margin:5px;" disabled>清除缓存</button>
                        </div>
                        <input type="file" id="file" style="display: none;" accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>
                        <div id="bmw_target_tips" style="text-align:center; margin-bottom: 3px; font-size: 4px;">请按以下模板来导入表格 仅限xlsx或csv格式</div>
                        <div id="bmw_target_wrapper" style="min-height:700px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;">
                            <table style="margin: auto;">
                                <tr>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: white;"></th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">A</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">B</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">C</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">D</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">E</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">F</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">G</th>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">1</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">Name</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">ID</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">STR</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">DEF</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">SPD</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">DEX</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">TOTAL</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">2</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">GoodLuck</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">2356929</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">800,000,000</td>
                                </tr>
                            </table>
                        </div>

                    </div>`),s("#bwm-target");var t=window.localStorage.getItem("BINGWA_TARGET");let o=t?JSON.parse(t):{};function e(t,e){function a(t,e){"off"==e?t.parent().addClass("hide"):"on"==e&&t.parent().removeClass("hide")}Fe("."+{Online:"target-online",Idle:"target-online",Offline:"target-online","在城内":"target-status","在城外":"target-status","住院时间<=5m":"target-status","住院时间>5m":"target-status","FF>=2.0":"target-fairfight","FF<2.0":"target-fairfight"}[t]).each(function(){Fe(this).text()==t?a(Fe(this),e):"在城内"==t?"town"==Fe(this).attr("hospital-location")&&a(Fe(this),e):"在城外"==t?"oversea"==Fe(this).attr("hospital-location")&&a(Fe(this),e):"住院时间<=5m"==t?Fe(this).attr("hospital-seconds")<=300&&a(Fe(this),e):"住院时间>5m"==t?300<Fe(this).attr("hospital-seconds")&&a(Fe(this),e):"FF>=2.0"==t?2<=Fe(this).text()&&a(Fe(this),e):"FF<2.0"==t&&Fe(this).text()<2&&a(Fe(this),e)})}function n(t){0==t.length||"ID"in(t=Object.values(t)[0])&&(t=t.ID,console.log(t),$t(t).then(function(t){console.log("arr "+t),function e(a,n){window.localStorage.setItem("BINGWA_TARGET_FLAG","refreshing");var t=`https://api.torn.com/faction/${a}?selections=basic&key=${x}`;const i=Fe("#bmw_target_tips");i.text("---第 "+n+" 次刷新---频率每3秒一次---");fetch(t).then(t=>t.ok?t.json():void i.text("---探测失败 "+a+"---"),t=>{i.text("---网络异常 "+a+"---")}).then(t=>{console.log("faction api refreshed"),Fe.each(t.members,function(t,f){Fe(".target-id").each(function(){if(t==Fe(this).text()){var n=f.last_action.status;let t=Ce.yellow;"Online"==n?t=Ce.yellowgreen:"Offline"==n&&(t=Ce.gray),Fe(this).siblings(".target-online").css({"background-color":t,color:"white"}).text(n);var i=et(f.last_action.timestamp);Fe(this).siblings(".target-last").attr("last-action-minutes",i[0]).text(i[1]);var o,r=f.status.description,s=f.status.state,l=f.status.until,d=at(r,s,l);let e=Ce.green;"red"==f.status.color?(o=Math.min(d[1]/600,.8)+.2,e="rgba(255, 115, 115, "+o+")"):"blue"==f.status.color&&(e=Ce.blue),Fe(this).siblings(".target-status").attr("hospital-seconds",d[1]).attr("hospital-location",d[2]).css({"background-color":e,color:"white"}).text(d[0]),Fe(this).siblings(".target-level").text(f.level);var c=Fe(this).siblings(".target-fairfight").text();if(c!=isNaN){const g=.25*c*(Math.log(f.level)+1);Fe(this).siblings(".target-flatrespect").text(g.toFixed(2))}let a=[];const h=Fe("#filters").find("[status='on']");h.each(function(){a.push(Fe(this).text())});var p=m(a,n,d[2],d[1],c);0==p?Fe(this).parent().addClass("hide"):1==p&&Fe(this).parent().removeClass("hide")}})}),0<o.length&&0<Fe(".target-id").length?setTimeout(()=>{e(a,n+1)},3e3):(window.localStorage.setItem("BINGWA_TARGET_FLAG",""),console.log("faction api refreshing ended"))}).catch(t=>console.log("fetch error",t))}(t[0],1)}).catch(t=>console.log("startRefreshing "+t)))}function i(){var t=`https://api.torn.com/user/?selections=battlestats&key=${x}`;const e=Fe("#bmw_target_tips");e.text("---BS探测中---"),fetch(t).then(t=>t.ok?t.json():void e.text("---BS探测失败---"),t=>{e.text("---BS网络异常---")}).then(t=>{if(null!=t)if("error"in t)e.text(t.error);else{const o=Math.sqrt(t.strength)+Math.sqrt(t.defense)+Math.sqrt(t.speed)+Math.sqrt(t.dexterity);console.log("My score:"+o),Fe(".target-fairfight").each(function(){var t=zt(Fe(this).siblings(".target-str").text()),e=zt(Fe(this).siblings(".target-def").text()),a=zt(Fe(this).siblings(".target-spd").text()),n=zt(Fe(this).siblings(".target-dex").text());let i=((Math.sqrt(t)+Math.sqrt(e)+Math.sqrt(a)+Math.sqrt(n))/o*8/3+1).toFixed(2);3<=i&&(i=3..toFixed(2)),Fe(this).text(i)})}else e.text("error")}).catch(t=>console.log("fetch error",t))}function m(t,e,a,n,i){let o=1,r=1,s=1,l=1;return o=t.includes(e)?1:0,r=t.includes("在城内")&&"town"==a||t.includes("在城外")&&"oversea"==a?1:0,s=t.includes("住院时间<=5m")&&n<=300||t.includes("住院时间>5m")&&300<n?1:0,l=t.includes("FF>=2.0")&&2<=i||t.includes("FF<2.0")&&i<2?1:0,o*r*s*l}function r(t){let e=`
                        <div id="filters" style="overflow:hidden;">
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #83a000; color: white; font-weight: bold;">Online</div>
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #F39826; color: white; font-weight: bold;">Idle</div>
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #ADADAD; color: white; font-weight: bold;">Offline</div>
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #8FBC8F; color: white; font-weight: bold;">在城内</div>
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #65A5D1; color: white; font-weight: bold;">在城外</div>
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #8FBC8F; color: white; font-weight: bold;">住院时间<=5m</div>
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #FF7373; color: white; font-weight: bold;">住院时间>5m</div>
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #8FBC8F; color: white; font-weight: bold;">FF>=2.0</div>
                            <div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #FF7373; color: white; font-weight: bold;">FF<2.0</div>
                        </div>
                        <table style="margin: auto;">
                            <tr>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Online</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Lvl</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Name</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">ID</th>
                                <th class="head-last" style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">Last</th>
                                <th class="head-status" style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">Status</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;" title="Fair fight 系数">FF</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;" title="基础面子系数">FR</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">Attack</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">TOTAL</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">Hint</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #458994; color: white; font-weight: bold; text-align: center;">STR</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #458994; color: white; font-weight: bold; text-align: center;">DEF</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #458994; color: white; font-weight: bold; text-align: center;">SPD</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #458994; color: white; font-weight: bold; text-align: center;">DEX</th>
                            </tr>
                        `;for(var a in t){var n=function(t,e,a){let n="",i=["#FFF5F7","#FFF5F7","#FFF5F7","#FFF5F7"];return e+a<.33*t?(n="玻璃",i[0]="#FE9B9A",i[2]="#FE9B9A"):.15*t<e-a?(n="def党",i[1]="#FE9B9A"):.15*t<a-e?(n="dex党",i[3]="#FE9B9A"):.67*t<e+a&&(n="乌龟",i[1]="#FE9B9A",i[3]="#FE9B9A"),[n].concat(i)}(t[a].TOTAL,t[a].DEF,t[a].DEX);e+=`
                            <tr>
                                <td class="target-online" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-level" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-name" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;">
                                    <a class="user name" href="/profiles.php?XID=${t[a].ID}" target="_blank">${t[a].Name}</a>
                                </td>
                                <td class="target-id" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: right;">${t[a].ID||""}</td>
                                <td class="target-last" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-status" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-fairfight" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-flatrespect" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-attack" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;">
                                    <a href="/loader.php?sid=attack&user2ID=${t[a].ID}" style="color: #006699; text-decoration: none;" target="_blank">Attack</a>
                                </td>
                                <td class="target-total" style="border: 1px solid darkgray; padding: 5px; background-color: #FFD8A9; color: black; text-align: center;">${zt(t[a].TOTAL)||0}</td>
                                <td class="target-total" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;">${n[0]}</td>
                                <td class="target-str" style="border: 1px solid darkgray; padding: 5px; background-color: ${n[1]}; color: black; text-align: center;">${zt(t[a].STR)||0}</td>
                                <td class="target-def" style="border: 1px solid darkgray; padding: 5px; background-color: ${n[2]}; color: black; text-align: center;">${zt(t[a].DEF)||0}</td>
                                <td class="target-spd" style="border: 1px solid darkgray; padding: 5px; background-color: ${n[3]}; color: black; text-align: center;">${zt(t[a].SPD)||0}</td>
                                <td class="target-dex" style="border: 1px solid darkgray; padding: 5px; background-color: ${n[4]}; color: black; text-align: center;">${zt(t[a].DEX)||0}</td>
                            </tr>
                            `}return e+="</table>",e}0<o.length&&(Fe("#target-load-excel").prop("disabled",!0),Fe("#file").prop("disabled",!0),Fe("#target-clear-cache").removeAttr("disabled"),Fe("#bmw_target_tips").text("加载成功"),Fe("#bmw_target_wrapper").html(r(o)),i(),"refreshing"!=window.localStorage.getItem("BINGWA_TARGET_FLAG")&&n(o)),Fe(".filter-button").click(function(){"on"==Fe(this).attr("status")?(Fe(this).css({border:"6px solid #CFCFCF","font-weight":"normal"}).attr("status","off"),e(Fe(this).text(),"off")):(Fe(this).css({border:"6px double #CFCFCF","font-weight":"bold"}).attr("status","on"),e(Fe(this).text(),"on"))}),Fe("#target-load-excel").click(function(){"undefined"==typeof XLSX?alert("暂时无法读取excel文件，请稍后再试"):document.getElementById("file").click()}),Fe("#file").change(function(a){var t,e=a.target.files;0!=e.length&&(t=e[0],(e=/\.(xlsx|csv)$/g.exec(t.name))?function(t,o,r){const e=new FileReader;e.onload=function(t){var e,a=t.target.result;let n;function i(t){return"string"==typeof t?zt(t):t}"xlsx"===o?n=(e=a,t=XLSX.read(e,{type:"binary"}),e=t.SheetNames,e=t.Sheets[e[0]],XLSX.utils.sheet_to_json(e)):"csv"===o&&(n=function(t,e){function a(t){let e=0,a="";for(const n of t)'"'===n&&0===e?e=1:'"'===n&&1==e&&(e=0),","===n&&0===e?a+="|":'"'!==n&&(a+=n);return a.split("|")}const n=t.split(/\r?\n/),i=a(n[0]),o=[];for(let t=1;t<n.length-1;t++){var r=a(n[t]);const l={};for(const d in i){var s=i[d];e[s]?l[s]=e[s].call(null,r[d]):l[s]=r[d]}o.push(l)}return o}(a,{STR:i,DEF:i,SPD:i,DEX:i,TOTAL:i})),r&&r(n)},e.readAsBinaryString(t)}(t,e[1],function(t){if(0<t.length)if(t[0].hasOwnProperty("Name"))if(t[0].hasOwnProperty("ID"))if(t[0].hasOwnProperty("STR"))if(t[0].hasOwnProperty("SPD"))if(t[0].hasOwnProperty("DEF"))if(t[0].hasOwnProperty("DEX"))if(t[0].hasOwnProperty("TOTAL")){for(var e in t)t[e].Name&&"string"!=typeof t[e].Name&&(t[e].Name=t[e].Name.toString());Fe("#target-load-excel").prop("disabled",!0),Fe("#file").prop("disabled",!0),Fe("#target-clear-cache").removeAttr("disabled"),console.log(t),a.target.value="",Fe("#bmw_target_tips").text("加载成功"),Fe("#bmw_target_wrapper").html(r(t)),window.localStorage.setItem("BINGWA_TARGET",JSON.stringify(t)),i(),"refreshing"!=window.localStorage.getItem("BINGWA_TARGET_FLAG")&&n(t)}else alert("表格中没有TOTAL，修改表格并刷新网页后再试");else alert("表格中没有DEX，修改表格并刷新网页后再试");else alert("表格中没有DEF，修改表格并刷新网页后再试");else alert("表格中没有SPD，修改表格并刷新网页后再试");else alert("表格中没有STR，修改表格并刷新网页后再试");else alert("表格中没有ID，修改表格并刷新网页后再试");else alert("表格中没有Name，修改表格并刷新网页后再试");else alert("表格中没有数据，修改表格并刷新网页后再试")}):alert("仅支持读取xlsx或csv格式！"))}),Fe("#target-clear-cache").click(function(){1==confirm("确定清除缓存吗？")?(Fe("#target-load-excel").removeAttr("disabled"),Fe("#file").removeAttr("disabled"),Fe("#target-clear-cache").prop("disabled",!0),Fe("#bmw_target_wrapper").empty(),Fe("#bmw_target_tips").text("无数据"),window.localStorage.removeItem("BINGWA_TARGET"),o={}):console.log("clear cancelled")})}),Fe("#bwm-settings").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(function(){let e="";return Se.forEach(t=>{e+=`
                        <tr style="height: 32px;">
                            <td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">${t.title}</td>
                            <td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">${t.desc}</td>
                            <td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">
                                <select id="bwm_settings_${t.name}">
                                    <option value="false">关闭</option>
                                    <option value="true">打开</option>
                                </select>
                            </td>
                        </tr>
                    `}),`
                    <div id="bwm_settings_container" style="width: inherit">
                        <div id="bwm_settings_header" style="text-align:center; margin-bottom: 10px;">
                            <table style="margin: auto">
                                <tr>
                                    <td style="padding: 10px;">
                                        <span class="border-round" style="font-size: large; color: #333; background-color:#ccc; padding:5px;border:3px solid #333;">设置</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div id="bwm_settings_table" style="text-align:center; margin-bottom: 10px;">
                            <table style="border:1px solid darkgray; padding: 5px; margin: auto">
                                <tr style="height: 32px;">
                                    <th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能名称</th>
                                    <th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能描述</th>
                                    <th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能状态</th>
                                </tr>
                                ${e}
                            </table>
                        </div>
                    </div>
                `}()),s("#bwm-settings"),Se.forEach(t=>{Fe(`#bwm_settings_${t.name}`).val(Kt("BWM_SETTINGS",t.name)),Fe(`#bwm_settings_${t.name}`).change(function(){Yt("BWM_SETTINGS",t.name,Fe(this).val())}),window[t.name]="true"==Kt("BWM_SETTINGS",t.name)})}),Fe("#bwm-chatlog").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                    <div id="chatlog_container" style="width: inherit">
                        <div id="chatlog_header" style="margin: 10px 0px; border: 1px solid darkgray; text-align: center;">
                            <span style="font-size: large;">聊天记录</span>
                        </div>
                        <div id="chatlog" style="min-height:400px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>
                    </div>`),s("#bwm-chatlog");const t=function(){var t=window.localStorage.getItem("CHAT_LAST_MESSAGE");if(null!=t){var o=JSON.parse(t);let i=[];for(const d in o){const c=o[d];let t="",e="";0<=c.indexOf("|||")?(t=c.split("|||")[0],e=c.split("|||")[1]):t=c;var r=ce(t),s=new Date(1e3*r).toLocaleString(),l=parseInt((new Date).getTime()/1e3)-r;let a="",n="";l<3600?(a=parseInt(l/60)+"m",n="#5d9525"):3600<=l&&l<86400?(a=parseInt(l/3600)+"h",n="#DAA520"):86400<=l&&l<3024e3?(a=parseInt(l/86400)+"d",n="#c0542f"):3024e3<=l&&(a=parseInt(l/86400)+"d",n="#777"),i.push({chat_ts:r,chat_beijing:s,username:d,diff_ts_format:a,diff_ts_color:n,last_message:e})}return i}}();if(void 0!==t){var e=t.sort(function(t,e){return e.chat_ts-t.chat_ts});let a=`
                                <table id="chatlog-table" style=" background-color: white; font-size:12px; margin: auto;">
                                <tr class=chatlog-table-head">
                                    <th class="chatlog-time">最后聊天时间</th>
                                    <th class="chatlog-name">玩家</th>
                                    <th class="chatlog-last">距今</th>
                                    <th class="chatlog-message">最后5条消息</th>
                                </tr>`;Fe.each(e,function(t,e){a+=`
                                    <tr class=chatlog-table-content">
                                        <td class="chatlog-time">${e.chat_beijing}</td>
                                        <td class="chatlog-name">${e.username}</td>
                                        <td class="chatlog-last" style="color:white;background-color:${e.diff_ts_color}">${e.diff_ts_format}</td>
                                        <td class="chatlog-message">${e.last_message}</td>
                                    </tr>`}),a+="</table>",Fe("#chatlog").append(a),Fe("#chatlog-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),Fe("#chatlog-table").find("td").css({border:"1px solid darkgray",padding:"5px","text-align":"center"})}}),Fe("#bwm-mug").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                    <div id="mug_container" style="width: inherit">
                        <div id="mug-head" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                            <input type="text" id="mug-watchlist-id-input" placeholder="肥羊 ID" size="10" style="font-size: larger; padding: 5px; margin: 5px;" />
                            <button id="mug-watchlist-add-input" class="torn-btn" style="margin: 5px;">加入监视</button>
                        </div>
                        <div id="mug-watchlist" style="margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden;"></div>
                        <div id="mug-loglist" style="min-height:400px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>
                    </div>`),s("#bwm-mug");let o={};function a(){var t=window.localStorage.getItem("muglog-watchlist");if(null!=t){var a,n=JSON.parse(t);let e=`
                        <table id="mug-watchlist-table" style=" background-color: white; font-size:12px; margin:auto;"><tr class="mug-watchlist-table-head"><th>Victim ID</th><th>Victim Name</th><th>Total Mugged</th><th>删除</th></tr>`;for(a in n){let t="$0";a in o&&(t=jt(o[a].amount)),e+=`
                                <tr class="mug-watchlist-table-content">
                                    <td class="mug-watchlsit-victimid">${a}</td>
                                    <td><a class="user name" href="/profiles.php?XID=${a}" target="_blank">${n[a].name}</a></td>
                                    <td>${t}</td>
                                    <td><a class="mug-watchlist-delete" role="button" style="cursor: pointer; color: darkblue;">删除</a></td>
                                </tr>`}e+="</table>",Fe("#mug-watchlist").append(e),Fe("#mug-watchlist-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),Fe("#mug-watchlist-table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;")}Fe(".mug-watchlist-delete").click(function(){var t=Fe(this).parent().parent().children(".mug-watchlsit-victimid").text();Zt("muglog-watchlist",t),Fe(this).parent().parent().remove(),console.log("删除成功 "+t)})}!function(){var e=window.localStorage.getItem("muglog");if(null!=e){var a,n=JSON.parse(e);let t="</table>";for(a in n){var i=n[a].victim_id;i in o?o[i].amount+=jt(n[a].money_mugged):o[i]={name:n[a].victim_name,amount:jt(n[a].money_mugged)},t=`
                                <tr class="mug-loglist-table-content">
                                    <td class="mug-loglist-ts">${a}</td>
                                    <td class="mug-loglist-time">${n[a].timestring}</td>
                                    <td class="mug-loglist-victimid">${n[a].victim_id}</td>
                                    <td class="mug-loglist-victimname"><a class="user name" href="/profiles.php?XID=${n[a].victim_id}" target="_blank">${n[a].victim_name}</a></td>
                                    <td class="mug-loglist-amount" title="${n[a].timestring}">${n[a].money_mugged}</td>
                                    <td><a class="mug-loglist-watch" role="button" style="cursor: pointer; color: darkblue;">监视</a></td>
                                    <td><a class="mug-loglist-delete" role="button" style="cursor: pointer; color: darkblue;">删除</a></td>
                                </tr>`+t}t=`
                            <table id="mug-loglist-table" style=" background-color: white; font-size:12px; margin: auto;">
                                <tr class="mug-loglist-table-head">
                                    <th class="mug-loglist-ts">Timestamp</th>
                                    <th class="mug-loglist-time">Time</th>
                                    <th class="mug-loglist-victimid">Victim ID</th>
                                    <th class="mug-loglist-victimname">Victim Name</th>
                                    <th class="mug-loglist-amount">Money Mugged</th>
                                    <th>监视</th><th>删除</th>
                                </tr>`+t,Fe("#mug-loglist").append(t)}Fe("#mug-loglist-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),Fe("#mug-loglist-table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),Fe("#mug_container")[0].clientWidth<400&&(Fe(".mug-loglist-ts").hide(),Fe(".mug-loglist-victimid").hide(),Fe(".mug-loglist-time").hide())}(),a(),Fe(".mug-loglist-delete").click(function(){var t=Fe(this).parent().parent().children(".mug-loglist-ts").text();Zt("muglog",t),Fe(this).parent().parent().remove(),console.log("删除成功 "+t)}),Fe(".mug-loglist-watch").click(function(){var t=Fe(this).parent().parent().children(".mug-loglist-victimid").text();Yt("muglog-watchlist",t,{name:Fe(this).parent().parent().children(".mug-loglist-victimname").text()}),Fe("#mug-watchlist-table").remove(),a(),console.log("监视成功 "+t)}),Fe("#mug-watchlist-add-input").click(function(){const e=Fe("#mug-watchlist-id-input").val();var t;isNaN(e)||0==e||""==e?alert("无效ID"):(t=`https://api.torn.com/user/${e}?selections=profile&key=${x}`,fetch(t).then(t=>t.json()).then(t=>{if(console.log("API fetched"),null!=t.error&&6==t.error.code)throw alert("无效ID "+e),new Error("Incorrect ID");Yt("muglog-watchlist",e,{name:t.name}),Fe("#mug-watchlist-table").remove(),a(),alert("监视成功 "+t.name+"["+e+"]"),console.log("监视成功 "+t.name+"["+e+"]")}).catch(t=>console.log("fetch error: ",t.message)))})}),Fe("#bwm-return").click(function(){Fe("#bwm").slideUp("slow",function(){Fe("#bwm").remove()})}),Fe("#bwm-warroom").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                    <div id="bwm_warroom_container" style="width:inherit;">
                        <div id="bwm_warroom_header" style="margin:10px 0px; border:1px solid darkgray;text-align:center;">
                            <span id="bwm_warroom_counter" style="margin:5px;padding:5px;"></span>
                            <span style="font-size: large;">WAR ROOM</span>
                            <button class="torn-btn" id="warroom-btn" style="margin:5px;padding:5px;">更多详情</button>
                        </div>
                        <div id="bwm_warroom_filter" style="margin:10px 0px; border:1px solid darkgray; padding: 5px; text-align:center;">
                        </div>
                        <div id="bwm_warroom_wrapper" style="margin:10px 0px; overflow:hidden;">
                        </div>
                    </div>`),s("#bwm-warroom");let e=[];!function(){const t=`https://api.torn.com/torn/?selections=territorywars&key=${x}`,e=Fe("#bwm_warroom_filter");e.text("---探测中---"),fetch(t).then(t=>t.ok?t.json():void e.text("---探测失败---"),t=>{e.text("---网络异常---")}).then(t=>{null!=t&&e.text("---探测完成---"),Fe("#bwm_warroom_counter").text("(当前存在 "+Object.keys(t.territorywars).length+" 场战斗)"),Fe.each(t.territorywars,function(t,e){var a=function(t,e){let a=Math.abs(parseInt((new Date).getTime()/1e3)-t);e=parseInt(100*a/e);let n="";86400<=a&&(n+=parseInt(a/86400)+"天",a%=86400);3600<=a&&(n+=parseInt(a/3600)+"时",a%=3600);60<=a&&(n+=parseInt(a/60)+"分",a%=60);return n+=a+"秒",[n,e]}(e.started,259200);Fe("#bwm_warroom_wrapper").append(`
                                    <div class="ttwar" style="width:279px; float:left; border:1px solid darkgray; padding: 5px 2px;margin:5px 2px;background-color:white;background-image: linear-gradient(rgba(192,84,47,0.8),rgba(192,84,47,0.5));">
                                        <div class="ttwar-title" style="overflow:hidden;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><button class="torn-btn">${t}</button></div>
                                            <div style="width:100px; float:left; text-align:center; margin:11px 3px;"><b>进攻方</b></div>
                                            <div style="width:100px; float:left; text-align:center; margin:11px 3px;"><b>防守方</b></div>
                                        </div>
                                        <div class="ttwar-faction" style="overflow:hidden;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>帮派ID</b></div>
                                            <div class="factionid" style="width:100px; float:left; text-align:center; margin:5px 3px;"><a href="/factions.php?step=profile&ID=${e.assaulting_faction}">${e.assaulting_faction}</a></div>
                                            <div class="factionid" style="width:100px; float:left; text-align:center; margin:5px 3px;"><a href="/factions.php?step=profile&ID=${e.defending_faction}">${e.defending_faction}</a></div>
                                        </div>
                                        <div class="ttwar-factionname" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>帮派名称</b></div>
                                            <div class="faction-${e.assaulting_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px; overflow:hidden; text-overflow:ellipsis;     white-space:nowrap;"></div> 
                                            <div class="faction-${e.defending_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px; overflow:hidden; text-overflow:ellipsis;  white-space:nowrap;"></div>  
                                        </div>
                                        <div class="ttwar-factiontag" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>帮派缩写</b></div>
                                            <div class="faction-${e.assaulting_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                            <div class="faction-${e.defending_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                        </div>
                                        <div class="ttwar-factionresp" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>帮派声望</b></div>
                                            <div class="faction-${e.assaulting_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                            <div class="faction-${e.defending_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                        </div>
                                        <div class="ttwar-hospitalcount" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>医院人数</b></div>
                                            <div class="faction-${e.assaulting_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                            <div class="faction-${e.defending_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                        </div>
                                        <div class="ttwar-score" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>当前分数</b></div>
                                            <div class="territory-${t}" style="width:206px; float:left; text-align:center; margin:5px 3px;"></div>
                                        </div>
                                        <div class="ttwar-score-pbar" style="overflow:hidden; display:none;">
                                            <div class="faction-${e.assaulting_faction}" style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>分数进度</b></div>
                                            <div class="territory-${t}" style="width:212px; height:16px; margin:3px; float:left; text-align:center; overflow:hidden; background-color:#ddd;"></div>
                                        </div>
                                        <div class="ttwar-time" style="overflow:hidden;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>时间已过</b></div>
                                            <div style="width:206px; float:left; text-align:center; margin:5px 3px;">${a[0]}</div>
                                        </div>
                                        <div class="ttwar-time-pbar" style="overflow:hidden;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>时间进度</b></div>
                                            <div style="width:212px; height:16px; margin:3px; float:left; text-align:center; overflow:hidden; background-color:#ddd;">${ee(16,a[1],"#5580a0","white",a[1]+"%")}</div>
                                        </div>
                                    </div>`)})}).catch(t=>console.log("fetch error: ",t.message))}(),Fe("#warroom-btn").click(function(){Fe(".factionid").each(function(){var t=Fe(this).text();-1==e.indexOf(t)&&e.push(t)}),90<e.length&&(e=e.slice(0,90)),Fe.each(e,function(t,e){!function(t,e){const a=`https://api.torn.com/faction/${t}?selections=basic&key=${x}`,n=Fe("#bwm_warroom_filter");n.text("---探测中---"),fetch(a).then(t=>t.ok?t.json():void n.text("---探测失败---"),t=>{n.text("---网络异常---")}).then(t=>{null!=t&&n.text("---探测完成---");let a=0;Fe.each(t.members,function(t,e){"Hospital"==e.status.state&&(a+=1)}),t.hospital_count=a,e(t)}).catch(t=>console.log("fetch error: ",t.message))}(e,function(o){console.log("api fetched"),Fe.each(o.territory_wars,function(t,e){var a=e.territory,n=e.score+" / "+e.required_score;Fe(".ttwar-score").children(".territory-"+a).text(n);n=parseInt(100*e.score/e.required_score),e=ee(16,n,"#499360","white",n+"%");Fe(".ttwar-score-pbar").children(".territory-"+a).html(e);n=(o.hospital_count/500).toFixed(2);const i=Fe(".territory-"+a).parent().parent().css("background-image");e=i.split(",")[3].replace(")",""),n=Number(e)+Number(n);Fe(".territory-"+a).parent().parent().css("background-image","linear-gradient(rgba(192,84,47,"+n+"),rgba(192,84,47,0.5))")}),Fe(".ttwar-factionname").children(".faction-"+e).text(o.name),Fe(".ttwar-factiontag").children(".faction-"+e).text(o.tag),Fe(".ttwar-factionresp").children(".faction-"+e).text(zt(o.respect)),Fe(".ttwar-hospitalcount").children(".faction-"+e).text(o.hospital_count)})}),Fe("[class*='ttwar'][style*='none']").attr("style","overflow:hidden"),Fe(this).attr("disabled","true")})}),Fe("#bwm-revive").click(function(){Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                    <div id="bwm_revive_container" style="width: inherit">
                        <div id="bwm_revive_header" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                                <input type="text" id="faction-input-id" name="faction-input-id" placeholder="多个帮派ID可以使用逗号分隔" size="30" style="font-size: larger; padding: 5px; margin: 5px;" />
                                <button id="revive-start-btn" class="torn-btn" style="margin:5px;">开始复活</button>
                                <button id="revive-stop-btn" class="torn-btn" style="margin:5px;" disabled>停止复活</button>
                        </div>
                        <div id="bwm_revive_filter" style="margin:10px 0px; border:1px solid darkgray; text-align:center; overflow: hidden;">
                            <div style="display: inline; margin:0px 15px;">
                                <span>每次刷新间隔</span>
                                <select id="bwm_revive_delay" style="padding:1px 0px;margin:8px 3px;">
                                    <option value="1" selected>1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                </select>
                                <span>秒</span>
                            </div>
                            <div style="display: inline; margin:0px 15px;">
                                <span>只显示Online</span>
                                <select id="bwm_revive_online_only" style="padding:1px 0px;margin:8px 3px;">
                                    <option value="false" selected>否</option>
                                    <option value="true">是</option>
                                </select>
                            </div>
                            <div style="display: inline; margin:0px 15px;">
                                <span>只显示Hospitalized</span>
                                <select id="bwm_revive_hosp_only" style="padding:1px 0px;margin:8px 3px;">
                                    <option value="false" selected>否</option>
                                    <option value="true">是</option>
                                </select>
                            </div>
                            <div style="display: inline; margin:0px 15px;">
                                <span>只显示在城内</span>
                                <select id="bwm_revive_town_only" style="padding:1px 0px;margin:8px 3px;">
                                    <option value="false">否</option>
                                    <option value="true" selected>是</option>
                                </select>
                            </div>
                        </div>
                        <div id="bmw_revive_tips" style="text-align:center; margin-bottom: 3px; font-size: 4px;"></div>
                        <div id="bmw_revive_wrapper" style="min-height:700px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden;">
                        </div>
                    </div>`),s("#bwm-revive");let d=!0,c=0,b=1;Fe("#revive-start-btn").click(function(){Fe("#bmw_revive_wrapper").empty(),Fe("#revive-start-btn").prop("disabled",!0),Fe("#revive-stop-btn").removeAttr("disabled"),Fe("#faction-input-id").prop("disabled",!0),Fe("#bwm_revive_delay").prop("disabled",!0),Fe("#bwm_revive_online_only").prop("disabled",!0),Fe("#bwm_revive_hosp_only").prop("disabled",!0),Fe("#bwm_revive_town_only").prop("disabled",!0),Fe("#bmw_revive_tips").text("即将开始刷新......"),d=!0,b=1;const t=Fe("#faction-input-id").val().trim().split(/,|，/).map(function(t,e,a){return t.trim()}),s=t.length||1;let e=new Array(s).fill(null);const l=1e3*Fe("#bwm_revive_delay").val();let f="";"true"==Fe("#bwm_revive_online_only").val()&&(f="Online");let m="";"true"==Fe("#bwm_revive_hosp_only").val()&&(m="Hospitalized");let u="";"true"==Fe("#bwm_revive_town_only").val()&&(u="town"),c=setTimeout(()=>{!function e(a,n,i){if(0==d||0==Fe("#bmw_revive_wrapper").length)Fe("#bmw_revive_wrapper").children(":last").remove(),Fe("#bmw_revive_wrapper").append(`<div style="overflow: hidden;"><div class="border-round" style="float: left; width:200px; padding: 2px 4px; margin: 2px 4px; background-color: ${Ce.purple}; color: white;">刷新结束 本次共完成了 ${b-1} 次刷新</div></div>`);else{const h=a[i];let t=0;i<a.length-1&&(t=i+1);const g=n[i];var o=`https://api.torn.com/faction/${h}?selections=basic&key=${x}`;const r=Fe("#bmw_revive_tips");r.text("---探测中 "+h+"---"),fetch(o).then(t=>t.ok?t.json():void r.text("---探测失败 "+h+"---"),t=>{r.text("---网络异常 "+h+"---")}).then(p=>{console.log(`faction: ${h} | delay: ${l/1e3}s | online: ${Fe("#bwm_revive_online_only").val()} | hosp: ${Fe("#bwm_revive_hosp_only").val()} | town: ${Fe("#bwm_revive_town_only").val()}`),n[i]=p,Fe("#bmw_revive_wrapper").children(":last").remove(),Fe.each(p.members,function(t,e){const a=e.last_action.status;let n=Ce.yellow;"Online"==a?n=Ce.green:"Offline"==a&&(n=Ce.gray);var i=et(e.last_action.timestamp),o=e.status.description;const r=e.status.details,s=e.status.state;var l=e.status.until,d=e.status.color;const c=at(o,s,l);var i=`
                                            <div style="overflow: hidden;">
                                                <div class="border-round" style="float: left; width:80px; padding: 2px 4px; margin: 2px 4px; background-color: ${Ce.purple}; color: white;">第${b}次刷新</div>
                                                <div class="border-round" style="float: left; width:35px; padding: 2px 4px; margin: 2px 4px; background-color: ${n}; color: white;">${a}</div>
                                                <div class="border-round" style="float: left; width:35px; padding: 2px 4px; margin: 2px 4px; background-color: ${Ce.pink};">
                                                    <a href="/factions.php?step=profile&ID=${h}" style="text-decoration: none; color: white;" target="_blank">${p.tag}</a>
                                                </div>                       
                                                <div class="border-round" style="float: left; width:90px; padding: 2px 4px; margin: 2px 4px; background-color: ${Ce.blue};">
                                                    <a href="/profiles.php?XID=${t}" style="text-decoration: none; color: white;" target="_blank">${e.name}</a>
                                                </div>                        
                                                <div class="border-round" style="float: left; width:100px; padding: 2px 4px; margin: 2px 4px; background-color: ${Ce.green}; color: white;">上次在线 ${i[1]}</div>                     
                                                <div class="border-round" style="float: left; width:100px; padding: 2px 4px; margin: 2px 4px; background-color: ${Ce.red}; color: white;">入院时间 ${c[0]}</div>                     
                                                <div class="border-round" style="float: left; width:300px; padding: 2px 4px; margin: 2px 4px; color:#ccc;background-color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${r}</div>
                                            </div>`;0==s.indexOf("Hospital")&&(0!=a.indexOf(f)||0!=r.indexOf(m)||0!=c[2].indexOf(u)||null!=g&&g.members[t].status.until==l||Fe("#bmw_revive_wrapper").append(i))}),b+=1,Fe("#bmw_revive_wrapper").append(`<div style="overflow: hidden;"><div class="border-round" style="float: left; width:80px; padding: 2px 4px; margin: 2px 4px; background-color: ${Ce.purple}; color: white;">第${b}次刷新</div></div>`),c=setTimeout(()=>{e(a,n,t)},l*s)}).catch(t=>console.log("fetch error",t))}}(t,e,0)},l*s)}),Fe("#revive-stop-btn").click(function(){d=!1,clearTimeout(c),Fe("#revive-stop-btn").prop("disabled",!0),setTimeout(()=>{Fe("#revive-start-btn").removeAttr("disabled"),Fe("#faction-input-id").removeAttr("disabled"),Fe("#bwm_revive_delay").removeAttr("disabled"),Fe("#bwm_revive_online_only").removeAttr("disabled"),Fe("#bwm_revive_hosp_only").removeAttr("disabled"),Fe("#bwm_revive_town_only").removeAttr("disabled"),Fe("#bmw_revive_wrapper").children(":last").remove(),Fe("#bmw_revive_wrapper").append(`<div style="overflow: hidden;"><div class="border-round" style="float: left; width:200px; padding: 2px 4px; margin: 2px 4px; background-color: ${Ce.purple}; color: white;">刷新结束 本次共完成了 ${b-1} 次刷新</div></div>`)},1e3)})}),Fe("#bwm-rankedwar").click(function(){function h(t){t=Math.abs(parseInt((new Date).getTime()/1e3)-t);let e="";return e=86400<=t?parseInt(t/86400)+"天"+parseInt(t%86400/3600)+"小时":3600<=t?parseInt(t/3600)+"小时":60<=t?parseInt(t/60)+"分钟":t+"秒",e}Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                    <div id="bwm_rw_container" style="width:inherit;">
                        <div id="bwm_rw_header" style="margin: 10px 0px; border: 1px solid darkgray; text-align: center;">
                            <span style="font-size: large;">RANKED WAR</span>
                        </div>
                        <div id="bwm_rw_filter" style="margin:10px 0px; padding: 5px; text-align: center;">
                        </div>
                        <div id="bwm_rw_wrapper" style="margin:10px 0px; text-align: center; overflow: hidden; overflow-x: auto;">
                        </div>
                    </div>`),s("#bwm-rankedwar"),function(){const t=`https://api.torn.com/torn/?selections=rankedwars&key=${x}`,e=Fe("#bwm_rw_filter");e.text("---探测中---"),fetch(t).then(t=>t.ok?t.json():void e.text("---探测失败---"),t=>{e.text("---网络异常---")}).then(t=>{null!=t&&("error"in t?e.text(`--- API错误 --- code: ${t.error.code} error: ${t.error.error}`):"rankedwars"in t&&(e.text("---探测成功---"),Fe("#bwm_rw_wrapper").append(`
                                    <table class="rankedwar-records" style="width: 100%; margin: auto;">
                                        <tr class="head">
                                            <th class="war">ID</th>
                                            <th class="team">获胜 / 领先方</th>
                                            <th class="team">分数</th>
                                            <th class="team">分数</th>
                                            <th class="team">失败 / 落后方</th>
                                            <th class="war">分差 / 目标</th>
                                            <th class="war">进度</th>
                                            <th class="war">状态</th>
                                            <th class="war">描述</th>
                                        </tr>
                                    </table>`),Fe(".rankedwar-records").find("th.war").attr("style","border: 1px solid #333;padding: 5px;background-color: #757947;color: white;font-weight: bold;text-align:center;"),Fe(".rankedwar-records").find("th.team").attr("style","border: 1px solid #333;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;"),Fe.each(t.rankedwars,function(t,e){var a=parseInt((new Date).getTime()/1e3);const n=Object.keys(e.factions),i=e.war.winner;let o=0,r=0,s="",l="",d="";var c=e.factions[n[0]].score,p=e.factions[n[1]].score;r=0<=n.indexOf(i.toString())?(s="已结束",l=`结束于 ${h(e.war.end)}前`,d="over",n[0]==i.toString()?(o=n[0],n[1]):(o=n[1],n[0])):a>=e.war.start?(s="战斗中",l=`战斗已持续${h(e.war.start)}`,d="warring",p<=c?(o=n[0],n[1]):(o=n[1],n[0])):(s="未开始",l=`即将开始于${h(e.war.start)}后`,d="notyet",o=n[0],n[1]);c=Math.abs(c-p),p=parseInt(100*c/e.war.target);Fe(".rankedwar-records").children().append(`
                                        <tr class="content">
                                            <td class="${d}"><a class="war-id" href="/war.php?step=rankreport&rankID=${t}" target="_blank">${t}</a></td>
                                            <td><a class="faction winning" href="/factions.php?step=profile&ID=${o}" target="_blank">${e.factions[o].name}</a></td>
                                            <td class="${d} score">${zt(e.factions[o].score)}</td>
                                            <td class="${d} score">${zt(e.factions[r].score)}</td>
                                            <td><a class="faction losing" href="/factions.php?step=profile&ID=${r}" target="_blank">${e.factions[r].name}</a></td>
                                            <td class="${d} score">${zt(c)} / ${zt(e.war.target)}</td>
                                            <td class="${d}">${p}%</td>
                                            <td class="${d}">${s}</td>
                                            <td class="${d}">${l}</td>
                                        </tr>
                                        `)}),Fe(".rankedwar-records").find("td").attr("style","border: 1px solid #333; padding: 5px; text-align: center; color: white; text-decoration: none;"),Fe(".rankedwar-records").find("a.faction").attr("style","color: white; text-decoration: none;"),Fe(".rankedwar-records").find("a.war-id").attr("style","color: #333; text-decoration: none;"),Fe(".rankedwar-records").find("td.over").css("background-color","#FFF5F7").css("color","#333"),Fe(".rankedwar-records").find("td.warring").css("background-color",Ce.yellow),Fe(".rankedwar-records").find("td.notyet").css("background-color",Ce.blue),Fe(".rankedwar-records").find("a.winning").parent().css("background-color",Ce.green),Fe(".rankedwar-records").find("a.losing").parent().css("background-color",Ce.red),Fe(".rankedwar-records").find("td.score").css("font-size","large")))})}()}),Fe("#bwm-crimeexp").click(function(){function d(t,e){Fe("#crimeexp-status").text(t),Fe("#crimeexp-status").css("color",e?"red":"")}Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                        <div style="width: inherit">
                            <div style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                                <button id="crimeexp-start-btn" class="torn-btn" style="margin:5px;">读取日志 (很慢, 请耐心等待)</button>
                            </div>
                            <div style="min-height: 300px; margin:10px 0px; border:1px solid darkgray; text-align:center; overflow:hidden; overflow-x: auto;">
                                <table id="crimeexp-table" style="margin: 5px auto; background-color: white; font-size: 12px; text-align: right;">
                                </table>
                                <div id="crimeexp-status" style="text-align: center; margin: 5px;"></div>
                            </div>
                            <div style="margin:10px 0px; padding: 10px; font-size: 100%; line-height: 1.6; color: #333; border:1px solid darkgray; overflow:hidden; overflow-x: auto;">
                                <p style="font-size: larger"><b>帮助冰蛙改进犯罪经验算法</b></p>
                                <p>1. <a href="/page.php?sid=log&log=5700,5710,5705,5715,5735,5725,5720,5730,6791,5360,5362,8965,6531,8842,8843,6253,6720,6722,6723,6243,6260,6262,6275,5100,4955">点这里跳转至日志页面</a></p>
                                <p>2. 点击日志页面的 "<b>导出所选日志</b>" 按钮，并耐心等待，完成后再次点击该按钮，将数据保存至文件</p>
                                <p>3. 将导出的文件通过 QQ 发送给 tobytorn [1617955]</p>
                                <br />
                                <p style="font-size: larger"><b>这份日志里包含了哪些数据？</b></p>
                                <p title="日志类型: 5700, 5710, 5705, 5715, 5735, 5725, 5720, 5730">* 犯罪记录</p>
                                <p title="日志类型: 6791">* OC 记录</p>
                                <p title="日志类型: 5360, 5362">* Bust 记录</p>
                                <p title="日志类型: 8965">* 复活节彩蛋活动中黑蛋拾取记录</p>
                                <p title="日志类型: 6531">* 工作特技获取犯罪经验记录</p>
                                <p title="日志类型: 8842, 8843">* Nerve Bar 上限变化记录</p>
                                <p title="日志类型: 6253, 6720, 6722, 6723">* 帮派进出记录</p>
                                <p title="日志类型: 6243, 6260, 6262, 6275">* 公司进出记录</p>
                                <p title="日志类型: 5100, 4955">* Merit 使用及重置</p>
                            </div>
                        </div>`),s("#bwm-crimeexp"),Fe("#crimeexp-start-btn").click(async function(){Fe("#crimeexp-start-btn").prop("disabled",!0),Fe("#crimeexp-table").html(`<tbody>
                                    <tr><th>当前 NNB</th><td id="crimeexp-curr-nnb">-</td></tr>
                                    <tr><th>当前经验</th><td id="crimeexp-curr-ce">-</td></tr>
                                    <tr><th>当前时间</th><td id="crimeexp-curr-time">-</td></tr>
                                    <tr><th>上次<span class="crimeexp-last-upgrade-type">升级</span>时间</th><td id="crimeexp-last-upgrade-time">-</td></tr>
                                    <tr><th>升级进度</th><td id="crimeexp-upgrade-progress">-</td></tr>
                                    <tr title="最近三日平均, OC 除外"><th>每日经验</th><td id="crimeexp-daily-ce">-</td></tr>
                                    <tr><th>预估<span class="crimeexp-next-upgrade-type">升级</span>天数</th><td id="crimeexp-upgrade-est">-</td></tr>
                                </tbody>`),Fe("#crimeexp-table").tooltip({tooltipClass:"white-tooltip"}),Fe("#crimeexp-table th").attr("style","border: 1px solid darkgray; padding: 5px; font-weight: bold;"),Fe("#crimeexp-table td").attr("style","border: 1px solid darkgray; padding: 5px; min-width: 6em");try{var e=Math.floor((new Date).getTime()/1e3);Fe("#crimeexp-curr-time").text(new Date(1e3*e).format("yyyy-MM-dd")),d("正在读取当前 NNB");var a=await async function(){var t=await(await fetch(`https://api.torn.com/user/?selections=perks&key=${x}`)).json();if("error"in t)throw new Error(t.error.error);var e=Object.values(t).flat().filter(t=>t.match(/[Mm]aximum nerve/)).map(t=>parseInt(t.match(/\d+/)[0])).reduce((t,e)=>t+e,0),t=await(await fetch(`https://api.torn.com/user/?selections=bars&key=${x}`)).json();if("error"in t)throw new Error(t.error.error);t=t.nerve.maximum;return t-e}();Fe("#crimeexp-curr-nnb").text(a);var n,i,o=await async function(t){const e=await le([],[8842,8843],null,null,t);return e.map(t=>({timestamp:t.timestamp,diff:t.data.maximum_nerve_after-t.data.maximum_nerve_before})).filter(t=>5===Math.abs(t.diff))}(t=>{d(`正在读取 NNB 变化日志 (${new Date(1e3*t).format("yyyy-MM-dd")})`)}),r=await async function(a,t,e){const n=new Set([5720,5725,5730,5735]),i=[],o=se([],[5700,5705,5710,5715,5720,5725,5730,5735,6791],null,t,e);for await(const l of o){let t="unknown";if(6791===l.log)t={1:"OC-Blackmail",2:"OC-Kidnapping",3:"OC-Bomb",4:"OC-PR",5:"OC-MT",6:"OC-CL",7:"OC-PH",8:"OC-PA"}[l.data.crime];else{const d=[1,7,17,29,34,39,47,53,58,62,69,72,74,77,81,83,85];var r=d.findIndex(t=>t>l.data.crime)+1,s=l.data.crime-d[r-2]+1;t=`${r}-${s}`}let e="unknown";5700===l.log?e="fail":5705===l.log?e="jail":5710===l.log?e="hospital":5715===l.log?e="money_loss":n.has(l.log)?e="success":6791===l.log&&(e="success"===l.data.result?"success":"fail");s={timestamp:l.timestamp,crime_name:t,result:e};if(i.push(s),Math.abs(l.timestamp-a[0].timestamp)<=2){s=p(s);if(0<s&&0<a[0].diff||s<0&&a[0].diff<0)break}for(;0<a.length&&l.timestamp<a[0].timestamp-1;)a.shift();if(0===a.length)break}return i}(o,e,t=>{d(`正在读取犯罪日志 (${new Date(1e3*t).format("yyyy-MM-dd")})`)});if(0===o.length)return void d("糟糕！找不到最近一次 NNB 变化的时间，无法计算当前经验",!0);Fe("#crimeexp-last-upgrade-time").text(new Date(1e3*o[0].timestamp).format("yyyy-MM-dd"));let t=c[a];o[0].diff<0&&(t=c[a+5],Fe(".crimeexp-last-upgrade-type").text("降级"),Fe(".crimeexp-last-upgrade-type").css("color","red"));const{ce:s,daily_ce:l}=function(t,e,a){let n=t,i=0;for(const o of e){let t=p(o);t<0&&(t=o.timestamp<=1603152e3?-.01*n:Math.max(t,-.01*n)),n+=t,o.timestamp>=a-259200&&!o.crime_name.startsWith("OC")&&(i+=t)}return{ce:n,daily_ce:i/3}}(t,r,e);Fe("#crimeexp-curr-ce").text(Math.floor(s)),a<60&&(n=(s-c[a])/(c[a+5]-c[a]),i=c[a+5]-s,Fe("#crimeexp-upgrade-progress").text(`${Math.floor(100*n)}%`),Fe("#crimeexp-upgrade-progress").attr("title",`还差 ${Math.floor(i)} 经验`)),Fe("#crimeexp-daily-ce").text(l.toFixed(1)),0<=l?a<60&&Fe("#crimeexp-upgrade-est").text(Math.floor((c[a+5]-s)/l)):(Fe("#crimeexp-daily-ce").css("color","red"),10<a&&(Fe(".crimeexp-next-upgrade-type").text("降级"),Fe(".crimeexp-next-upgrade-type").css("color","red"),Fe("#crimeexp-upgrade-est").text(Math.floor((c[a]-s)/l)))),d("完成！")}catch(t){console.trace(t),"Access level of this key is not high enough"===t.message?(d("权限不足！",!0),Fe("#crimeexp-status").append('<a href="/preferences.php#tab=api">请使用 Full Access 类型的 API Key</a>')):d(`出错啦！${t}`,!0)}finally{Fe("#crimeexp-start-btn").prop("disabled",!1)}});const c={10:0,15:150,20:500,25:900,30:1500,35:2300,40:3500,45:5e3,50:6666,55:1e4,60:15e3};function p(t){let e=0;const{crime_name:a,result:n}=t;return e=a.startsWith("OC")?{"OC-PR":4,"OC-MT":12,"OC-CL":73,"OC-PH":144,"OC-PA":652}[a]||0:a.startsWith("2-")?.025:a.startsWith("3-")?.05:a.startsWith("4-")?.111:(e={"7-2":.333,"8-1":.2,"8-2":.3,"8-3":.3,"8-4":.3,"8-5":.2,"8-6":.3,"9-5":.5,"10-4":.666,"11-5":1,"11-6":1,"12-1":.666,"12-2":.3,"12-3":.3,"13-1":.6,"13-2":.7,"14-1":.6,"14-2":.8,"14-3":.7,"15-1":1.7,"15-2":2,"15-3":1.9,"15-4":1.9,"16-1":1.7,"16-2":2.6,"17-1":2.8,"17-2":2.9,"18-1":.7,"18-2":1.9}[a],void 0===e?.2:e),"success"===n?e:"jail"===n||"hospital"===n&&a.startsWith("15-")?-20*e:0}}),Fe("#bwm-extcenter").click(function(){function l(t){console.log(t),Fe("#extcenter-status").prepend(`<span style="display:block; margin:2px">${t}</span>`)}function d(t){console.log(t),Fe("#extcenter-status").prepend(`<span style="display:block; color:red; margin:2px">${t}</span>`)}function c(){function o(e,a){for(let t=0;t<e.length;t++)if(a===e[t].name)return t;return-1}let r=Kt("extcenter","installedSpecs")||[],s=Kt("extcenter","specs")??[],a="";r.forEach(t=>{var e=o(s,t.name);0<=e&&t.version!==s[e].version?a+=`<tr><td class="extcenter-name">${s[e].name}</td>
                                        <td>${s[e].author}</td><td>${t.version}(<span style="color:red">${s[e].version}</span>)</td>
                                        <td${s[e].detail?` title="${s[e].detail}"`:""}>${s[e].description}</td>
                                        <td><button class="extcenter-update-source" spec="${s[e].name}" style="margin:5px;">更新</button></td>
                                        </tr>`:a+=`<tr><td class="extcenter-name">${t.name}</td>
                                    <td>${t.author}</td><td>${t.version}</td>
                                    <td${t.detail?` title="${t.detail}"`:""}>${t.description}</td>
                                    <td><button class="extcenter-uninstall" spec="${t.name}" style="margin:5px;">卸载</button></td>
                                    </tr>`}),s.forEach(t=>{0<=o(r,t.name)||(a+=`<tr><td class="extcenter-name">${t.name}</td>
                                    <td>${t.author}</td><td>${t.version}</td>
                                    <td${t.detail?` title="${t.detail}"`:""}>${t.description}</td>
                                    <td><button class="extcenter-install" spec="${t.name}" style="margin:5px;">安装</button></td>
                                    </tr>`)}),Fe("#extcenter-table").html(a),Fe("#extcenter-table td").attr("style","border: 1px solid darkgray;padding: 5px"),Fe(".extcenter-install").attr("style",`background-color: ${Ce.blue}; color: white; border-radius:5px; cursor:pointer; padding:3px;`),Fe(".extcenter-update-source").attr("style",`background-color: ${Ce.green}; color: white; border-radius:5px; cursor:pointer; padding:3px;`),Fe(".extcenter-uninstall").attr("style",`background-color: ${Ce.orange}; color: #002152; border-radius:5px; cursor:pointer; padding:3px;`),Fe("#extcenter-table .extcenter-name").css("font-weight","bold"),Fe("#extcenter-table .extcenter-desc").css("min-width","200px"),Fe(".extcenter-install").click(async function(){try{var t=s[o(s,Fe(this).attr("spec"))],e=`https://gitee.com/ameto_kasao/BWExtensions/raw/master/extensions/${t.file}?${(new Date).getTime()}`;l(`${t.name} - ${t.version} 开始下载`);var a=await oe(e);if(console.log(a),l(`${t.name} - ${t.version} 下载完成`),!p)return await navigator.clipboard.writeText(a),void l(`${t.name} - ${t.version} 源代码已复制到粘贴板, 请手动添加`);t.match&&!window.location.href.match(new RegExp(t.match))?l(`${t.name} - ${t.version} 在下次进入指定页面时会自动加载`):l(ie(t.name,t.version,a)?`${t.name} - ${t.version} 加载成功`:`${t.name} - ${t.version} 已经加载`),Yt("extcenter-source",t.name,a),r.push(t),Yt("extcenter","installedSpecs",r),c()}catch(t){d(t)}}),Fe(".extcenter-update-source").click(async function(){try{var t=o(r,Fe(this).attr("spec")),e=r[t],a=s[o(s,Fe(this).attr("spec"))],n=`https://gitee.com/ameto_kasao/BWExtensions/raw/master/extensions/${a.file}?${(new Date).getTime()}`;l(`${a.name} - ${a.version} 开始下载`);var i=await oe(n);console.log(i),l(`${a.name} - ${e.version} => ${a.version} 更新完成, 刷新后加载`),Yt("extcenter-source",a.name,i),r[t]=a,Yt("extcenter","installedSpecs",r),c()}catch(t){d(t)}}),Fe(".extcenter-uninstall").click(async function(){try{var t=o(r,Fe(this).attr("spec")),e=r[t];r.splice(t,1),Zt("extcenter-source",e.name),Yt("extcenter","installedSpecs",r),c(),l(`${e.name} - ${e.version} 已删除`)}catch(t){d(t)}})}Fe("#bwm").children(":last").remove(),Fe("#bwm").append(`
                        <div style="width: inherit">
                            <div style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                                <button id="extcenter-update" class="torn-btn" style="margin:5px;">检查更新</button>
                                <button id="extcenter-clear" class="torn-btn" style="margin:5px;">清除缓存</button>
                                <a href="https://github.com/mirrorsysu/BWExtensions"><button id="extcenter-submit-code" class="torn-btn" style="margin:5px; float:right;">提交代码</button></a>
                            </div>
                            <div style="height:400px; margin:10px 0px; border:1px solid darkgray; text-align:center; overflow:hidden;">
                                <div style="height:300px; overflow:auto;">    
                                    <table id="extcenter-table" style="width:95%; margin: 5px auto; background-color: white; text-align: center;"></table>
                                </div>
                                <div id="extcenter-status" style="border-top:1px solid darkgray; text-align:center; margin:5px; padding:5px; max-height:100px; overflow:auto"></div>
                            </div>
                        </div>`),s("#bwm-extcenter"),c(),Fe("#extcenter-update").click(function(){l("开始更新"),oe(`https://gitee.com/ameto_kasao/BWExtensions/raw/master/specs_escape.json?${(new Date).getTime()}`).then(t=>{t=decodeURI(t),console.log(t),l("更新完成");try{Yt("extcenter","specs",JSON.parse(t)),c()}catch(t){d(t)}}).catch(t=>{d(t)})}),Fe("#extcenter-clear").click(function(){l("开始清理缓存"),Qt("extcenter"),l("已清除 extcenter"),Qt("extcenter-source"),l("已清除 extcenter-source"),c()})})}})}if(0<=window.location.href.indexOf("profiles.php")){const Ye=setInterval(z,500);function z(){const c=Fe("div.profile-buttons div.profile-container div.empty-block");if(0<c.length){c.hasClass("profile-container-description")||c.addClass("profile-container-description"),clearInterval(Ye),c.css({height:"75","padding-top":"5px","overflow-x":"auto"}),c.siblings(".buttons-wrap").css("padding","0px"),c.html("蛙蛙探测器工作中...");const t=Fe(".basic-information").find(".info-table").children(":first").children(".user-info-value").children().text();console.log(`user: ${t}`);const e=t?t.split("[")[0].trim():"",a=t?t.split("[")[1].replace("]","").trim():"",n=`/loader.php?sid=attack&user2ID=${a}`;Fe(".profile-status").children().children(".title-black").empty().append(`
                    <span class="border-round" style="color:white;background-color:#DAA520;padding:3px;text-shadow:none;">
                        <a href="${n}" style="color: white; text-decoration: none;">攻击</a></span>`);const i=pe(e);i?Fe(".profile-status").children().children(".title-black").append(`
                    <span class="border-round" style="color:white;background-color:${i[0]};padding:3px;margin-left:5px;">上次唠嗑: ${i[1]}</span>`):console.log("没唠过");const o=he(a);if(console.log("mug_display_arr "+o),o){const r=o.split(",")[0],s=o.split(",")[1],l=o.split(",")[2];Fe(".profile-status").children().children(".title-black").append(`
                    <span class="border-round" style="color:white;background-color:${r};padding:3px;margin-left:5px;">上次mug: ${l} - ${s}</span>`)}else console.log("没mug过");ne(a,function(t){let e=parseInt(100*t.life.current/t.life.maximum);const a=t.life.current+"/"+t.life.maximum+" ("+e+"%)";let n="";n=e<=66?`
                        <div style="height:20px; overflow:hidden;">
                            ${ee(20,e,"#c0542f","#FFF5F7",a)}
                        </div>`:(100<e&&(e=100),`
                        <div style="height:20px; overflow:hidden;">
                            ${ee(20,e,"#5d9525","#FFF5F7",a)}
                        </div>`),c.html(`
                        <table style="width:100%; background-color: #FFF5F7;">
                            <tr>
                                <td class="bw-bs">战力</td>
                                <td colspan="3">${t.estimate_bs_display}</td>
                                <td class="bw-stat">XAN</td>
                                <td>${t.personalstats.xantaken||0}</td>
                                <td class="bw-other">活跃天数</td>
                                <td>${parseInt(t.estimate_active_days)||0}</td>
                            </tr>
                            <tr>
                                <td class="bw-bs">血量</td>
                                <td class="bw-hp" colspan="3">${n}</td>
                                <td class="bw-stat">LSD</td>
                                <td>${t.personalstats.lsdtaken||0}</td>
                                <td class="bw-other">估算WS</td>
                                <td>${Rt(t.estimate_ws)||0}</td>
                            </tr>
                            <tr>
                                <td class="bw-nw">资产</td>
                                <td>${Rt(t.personalstats.networth)}</td>
                                <td class="bw-nw">估算NNB</td>
                                <td>${t.estimate_nnb||10}</td>
                                <td class="bw-stat">SE</td>
                                <td>${t.personalstats.statenhancersused||0}</td>
                                <td colspan="2"><a class="t-blue" role="button" id="a_click_start_wawa" style="cursor: pointer">更多&gt;&gt;</a></td>
                            </tr>
                        </table>
                    `),c.find("td").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;"),c.find(".bw-bs").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #033649;color: white;font-weight: bold;"),c.find(".bw-nw").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #757947;color: white;font-weight: bold;"),c.find(".bw-other").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #725334;color: white;font-weight: bold;"),c.find(".bw-stat").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #458994;color: white;font-weight: bold;"),c.find(".bw-hp").attr("style","border: 2px solid darkgray; text-align:center;"),Fe("div.user-information-section:contains('Last action')").next().children("span").text(t.last_action_details);const i=Fe("div.profile-buttons.profile-action").html(),o=`
                <div>
                    <div class="title-black top-round">蛙蛙探测器&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <a class="t-white" role="button" id="a_click_start_wawa_back" style="cursor: pointer">返回</a>
                    </div>
                    <div class="cont bottom-round ">
                        <div class="profile-container basic-info bottom-round">
                            <table style="width:100%; min-height: 320px;">
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">估算战力</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.estimate_bs_display}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">Xanax数量</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.xantaken||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">SE数量</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.statenhancersused||0}</span></td>
                                </tr>
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">攻击胜率</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${Rt(t.attackWinRatio)||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">防守胜率</td>
                                    <td style="vertical-align:middle"><span class="bold">${Rt(t.defendWinRatio)||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">防守胜场</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.defendswon||0}</span></td>
                                </tr>
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">能量续满</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.refills||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">LSD数量</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.lsdtaken||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">DP占比</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${Rt(t.donator_percent)}</span></td>
                                </tr>
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">活跃天数</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.estimate_active_days}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">日均嗑药</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.average_drugs}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">Booster</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${Rt(t.personalstats.boostersused)}</span></td>
                                </tr>
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">估算ACE</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.estimate_ace}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">估算NNB</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.estimate_nnb}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">总资产</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${Rt(t.personalstats.networth)}</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>`,r=function(){Fe("div.profile-buttons.profile-action").html(o),Fe("div.profile-status").hide(),Fe("#a_click_start_wawa_back").click(function(){Fe("div.profile-buttons.profile-action").html(i),Fe("div.profile-status").show(),Fe("#a_click_start_wawa").click(r)})};Fe("#a_click_start_wawa").click(r);let s=0;s+=t.enemies/10,s-=t.friends/20,s+=t.personalstats.moneymugged/2e8,s+=t.personalstats.bountiesreceived/50,s=parseInt(s);let l="",d="";d=s<=0?(l="大善人",Ce.yellowgreen):s<=10?(l="好人",Ce.blue):s<=100?(l="坏人",Ce.yellow):(l="大恶人",Ce.red),Fe("div.basic-information").find("ul.info-table").children("li:eq(9)").children("div.user-info-value").append(`
                &nbsp;<span class="border-round" style="padding:2px;background-color:${d};color:white;" title="0分及以下：大善人<br>1-10分：好人<br>11-100分：坏人<br>100分以上：大恶人">${l}</span>
                &nbsp;<span title="每有10个敌人加1分<br>每有20个朋友减1分<br>每mug200m加1分<br>每收到50次悬赏加1分"><b>坏比指数: ${s}</b></span>
                `)},function(t){c.html(t)})}}}function j(n,t){let i=!0;if(Fe("#parade_filter").length<=0){Fe(n).before('<div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">阅兵</div><div id="parade_filter" class="cont-gray bottom-rounded content" style="overflow:hidden"><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Level" checked="checked">Level</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="BS" checked="checked">BS</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Mugged" checked="checked">Mugged</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Rehab" checked="checked">Rehab</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Rank" checked="checked">Rank</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Job" checked="checked">Job</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Networth" checked="checked">Networth</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Bazaar">Bazaar</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Defendslost">Defendslost</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Property">Property</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Elimination">Elimination</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Signup">Signup</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Last" checked="checked">Last</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Status" checked="checked">Status</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Life">Life</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="input-wrap" style="margin:5px 10px;"><label for="nw">Bazaar价值 大于 </label><input id="parade_bazaar_value" type="text" style="margin:1px 5px; width:50px" value="10">M</div><div class="btn-wrap" style="margin:5px 10px;"><span class="btn"><button id="parade_start" class="torn-btn" style="margin:1px 5px;">开始阅兵</button></span><span class="btn"><button id="parade_stop" class="torn-btn" style="margin:1px 5px;">暂停阅兵</button></span></div></div></div>'),Fe("#parade_stop").prop("disabled",!0);const a=Kt("parade_option","checkbox_vals");var e=Kt("parade_option","text_vals");null!=a&&null!=a&&(Fe("#parade_bazaar_value").val(e),Fe("#parade_filter input:checkbox").removeAttr("checked"),Fe("#parade_filter input:checkbox").each(function(t,e){0<=a.indexOf(Fe(this).val())&&Fe(this).attr("checked","checked")}))}Fe("#parade_start").click(function(){i=!0;let e=Fe(t).children("li").first();if(e.length<=0)alert("未找到用户列表");else{const h=Fe("#parade_bazaar_value").val().replace(/[^\d]/g,"");let c=[];Fe("#parade_filter input:checkbox:checked").each(function(t,e){c.push(Fe(this).val())}),console.log(c),Fe("#parade_filter input[type='checkbox']").prop("disabled",!0),Fe("#parade_filter input[type='text']").prop("disabled",!0),Fe(this).prop("disabled",!0),Fe("#parade_stop").removeAttr("disabled"),Fe("#parade_filter").css("background-color",Ce.blue);let t={};if(t.checkbox_vals=c,t.text_vals=h,window.localStorage.setItem("parade_option",JSON.stringify(t)),Fe("#search_parade_table").length<1){let e='<p id="search_parade_progress">阅兵进度</p><table id="search_parade_table" style="width:100%;background-color: white;font-size:12px;"><tr><th>Name</th>';for(let t=0;t<c.length;t++)e+=`<th>${c[t]}</th>`;e+="<th>Attack</th></tr></table>",Fe(n).before(e),Fe("#search_parade_table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;")}function a(){if("1"==e.attr("detected"))console.log("user detected"),p(0);else{e.attr("detected","1");const d=e.find("a[href^='/profiles.php?XID=']").attr("href").replace(/[^0-9|-]/gi,"");Fe("#search_parade_progress").text(`正在阅兵：${d}`),ne(d,function(t){let n="Closed",i=0,o=0;if(t.basicicons.icon35){n="Opened";const e=t.bazaar;null!=e&&e.map(function(t,e,a){i+=t.quantity*t.market_price,o+=t.quantity*t.price})}if("Federal"==t.status.state||"Fallen"==t.status.state)console.log("被封/去世，跳过"),Fe("#search_parade_progress").text(`阅兵：${d} 被封/去世，跳过`),p(1e3);else if(h&&i<1e6*h)console.log("太穷，跳过"),Fe("#search_parade_progress").text(`阅兵：${d} 太穷，跳过`),Yt("battlestats",d,t.estimate_bs),p(1e3);else{let e={};e.Level=t.level,e.BS=Rt(t.estimate_bs),e.Mugged=Rt(t.personalstats.moneymugged),e.Rehab=Rt(t.personalstats.rehabcost||0),e.Rank=t.rank_title,e.Networth=Rt(t.personalstats.networth),e.Defendslost=t.personalstats.defendslost,e.Property=t.property,e.Signup=t.signup,e.Last=t.last_action_brief,e.Status=t.status.state,e.Elimination=null==t.competition?"":t.competition.team;const l=t.job.company_type;var r,s=t.job.position;0==l?e.Job=s:null!=(r=Kt("APICache_companies","companies"))&&null!=r?(e.Job=r[l.toString()].name,e.Job+="Director"==s?"(D)":"(E)"):e.Job=l,e.Life=parseInt(t.life.current/t.life.maximum*100)+"%",e.Bazaar='<span class="t-red">Closed</span>',"Opened"==n&&(e.Bazaar=`<a href="/bazaar.php?userId=${d}"><span class="t-green">${Rt(i)}</span><span class="t-red">/${Rt(o)}</span></a>`);let a=`<tr><td><a class="user name" href="/profiles.php?XID=${d}" target="_blank">${t.name}</a></td>`;for(let t=0;t<c.length;t++)a+=`<td>${e[c[t]]}</td>`;a+=`<td><a class="t-blue c-pointer h attack-act" href="/loader2.php?sid=getInAttack&user2ID=${d}" target="_blank">Attack</a></td></tr>`,console.log(`蛙蛙探测 userId ${d} 成功: ${a}`),Fe("#search_parade_table").append(a),Fe("#search_parade_table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),Yt("battlestats",d,t.estimate_bs),p(1e3)}},function(t){console.log(`蛙蛙探测 userId: ${d} 失败`),p(1e3)})}}function p(t){e=Fe(e.nextAll(e[0].tagName)[0]),0<e.length&&1==i?(console.log(i),setTimeout(a,t)):(console.log("阅兵完成"),Fe("#search_parade_progress").text("阅兵完成"),Fe("#parade_filter input[type='checkbox']").removeAttr("disabled"),Fe("#parade_filter input[type='text']").removeAttr("disabled"),Fe("#parade_start").removeAttr("disabled"),Fe("#parade_stop").prop("disabled",!0),Fe("#parade_start").text("继续阅兵"),Fe("#parade_filter").css("background-color","#f2f2f2"))}console.log("阅兵开始"),a()}}),Fe("#parade_stop").click(function(){i=!1,console.log("阅兵暂停"),Fe("#search_parade_progress").text("阅兵暂停"),Fe("#parade_filter input[type='checkbox']").removeAttr("disabled"),Fe("#parade_filter input[type='text']").removeAttr("disabled"),Fe("#parade_start").removeAttr("disabled"),Fe("#parade_filter").css("background-color","#f2f2f2")})}if(foo&&0<=window.location.href.indexOf("page.php?sid=UserList")){j("div.userlist-wrapper","ul.user-info-list-wrap");const ia=setInterval(R,500);function R(){const t=Fe(".user-info-list-wrap").find(".user-icons");0<t.length&&t.each(function(){if("1"!=Fe(this).attr("hasdone")){Fe(this).attr("hasdone","1");const e=Fe(this).parent().siblings().children("a.user.name").find("[title]").attr("title");if(e){var t=pe(e.split("[")[0].trim());if(t){const a=Fe(this).children(".icons-wrap");a.width(a.width()-70),Fe(this).children(".icons-wrap").after(`
                                    <span class= "border-round" title="<strong>上次唠嗑: </strong>${t[1]}" style="float:left;width:44px;height:22px;padding:2px;margin:0px 3px;background-color:${t[0]};text-align:center;">
                                        <span style="font-size:18px;display:inline-block;vertical-align:middle;color:white;padding:3px;">${t[1]}</span>
                                    </span>`)}}}})}}if(foo&&0<=window.location.href.indexOf("index.php?page=people")){j("div.travel-people","ul.users-list");let i={};const oa=window.localStorage.getItem("muglog-watchlist");function c(t){const e=t.find("a.faction").attr("href");return e?e.substring(30):0}null!==oa&&void 0!==oa&&(i=JSON.parse(oa));const Ye=setInterval(z,1e3);function z(){const t=Fe("ul.users-list").children("li");0<t.length&&t.each(function(t,e){if("1"!=Fe(this).attr("oversea")){const a=c(Fe(this)),n=Fe(this).find("a.name").attr("href").substring(18).trim();a in Oe&&Fe(this).css("background-color","NavajoWhite"),a in Ae&&Fe(this).css("background-color","DarkSeaGreen"),n in i&&Fe(this).css("background-color",Ce.purple),Fe(this).attr("oversea","1")}})}}const ea={Mexico:{name:"墨西",time:18},Cayman:{name:"开曼",time:25},Canada:{name:"加拿",time:29},Hawaii:{name:"夏威",time:94},Argentina:{name:"阿根",time:117},United:{name:"英国",time:111},Switzerland:{name:"瑞士",time:123},Japan:{name:"日本",time:158},China:{name:"中国",time:169},UAE:{name:"迪拜",time:190},South:{name:"南非",time:208}};function B(t){return Fe(t).find("div.days").attr("last-action-minutes")}function W(t){return Fe(t).find("div.status").attr("sort_score")}function L(t){return Fe(t).find("div.position").attr("estimate-bs")}function G(t){return Fe(t).find("div.lvl").text()}function q(t){return Fe(t).find("td.table-level").text()}function H(t){return Fe(t).find("td.table-online").attr("code")}function X(t){return Fe(t).find("td.table-revivable").text()}function J(t){return Fe(t).find("td.table-position").text()}function U(t){return Fe(t).find("td.table-days").text()}function K(t){return Fe(t).find("td.table-last").attr("last-action-minutes")}function V(t){return Fe(t).find("td.table-status").attr("hospital-minutes")}function Y(t){return Fe(t).find("td.table-bs").attr("estimate-bs")}function Z(t){let e=Kt("battlestats",t),a="",n="";return null!=e&&null!=e?(a=zt(e),n=Rt(e)):e=0,[e,a,n]}function Q(t){let e=Kt("networths",t),a="";return null!=e&&null!=e?a=Rt(e):e=0,e,a,1}function tt(t){t=Kt("revivable",t);let e=null!=t&&null!=t?t:"unknown";return e}function et(t){const e=new Date;t=parseInt(parseInt(e.getTime()/1e3)-t);let a="";return a=60<=t&&t<3600?parseInt(t/60)+"m":3600<=t&&t<86400?parseInt(t/3600)+"h":86400<=t?parseInt(t/86400)+"d":t+"s",[t,a]}function at(i,o,r){let s=0,l="town";const d=new Date;i=i.split(" ");if("Abroad"==o)o="="+ea[i[1]].name,s=0-ea[i[1]].time,l="oversea";else if("Traveling"==o)1<i.length?"Traveling"==i[0]?(o=">"+ea[i[2]].name,s=0-ea[i[2]].time):"Returning"==i[0]&&(o="<"+ea[i[4]].name,s=0-ea[i[4]].time):(o="剧院",s=-1),l="oversea";else if("Hospital"==o){let t=parseInt(r-parseInt(d.getTime()/1e3));t<0&&(t=0);let e=parseInt(t/3600);e=e<10?"0"+e:e;let a=parseInt(t%3600/60);a=a<10?"0"+a:a;let n=t%60;n=n<10?"0"+n:n,l="hospital"==i[1]?(o=e+":"+a+":"+n,"town"):(o="海"+e+":"+a+":"+n,"oversea"),s=t}return[o,s,l]}function nt(t){Fe("li.days").text("Last"),Fe("li.position").text("BattleStats");let o=200;0<Fe("li.position").length&&(o=window.getComputedStyle(Fe("li.position")[0]).width.replace(/px$/g,""),console.log(o));var e=`https://api.torn.com/faction/${t}?selections=basic&key=${x}`;fetch(e).then(t=>t.json()).then(i=>{console.log("facPageEnhanced "+t),Fe("li.table-row").each(function(){var t=Fe(Fe(this).find("[class^=userWrap]")).children().attr("href").substring(18),e=Z(t);100<Number(o)?Fe(Fe(this).find("div.position")).attr("estimate-bs",e[0]).children(":first").text(e[1]):Fe(Fe(this).find("div.position")).attr("estimate-bs",e[0]).children(":first").text(e[2]);var a=et(i.members[t].last_action.timestamp);Fe(Fe(this).find("div.days")).attr("last-action-minutes",a[0]).text(a[1]);var n=i.members[t].status.state,e=i.members[t].status.description,a=i.members[t].status.until,t=i.members[t].status.color,a=at(e,n,a);Fe(Fe(this).find("div.status")).attr("sort_score",a[1]).html(`<span class="t-${t}">${a[0]}</span>`)})}).catch(t=>console.log("fetch error",t))}function it(t,e,a){let n=[0,0,0];var i=Kt("APICache_companies","companies");function o(t){return t[0]+t[1]<t[2]?2:t[0]>t[1]?0:1}function r(t){return 0<(t[0]-t[1])*(t[1]-t[2])?1:0<(t[0]-t[2])*(t[2]-t[1])?2:0}function s(t,e){return e/t<=1?e/t:1+(e-t)/t*.5}function l(t,e){if(0==t)return"";t=1.2*e/t;return t<1?"eff-red":t<2?"eff-yellow":"eff-green"}"unassigned"!=e&&null!=i&&null!=i&&(c=i[t].positions[e].man_required,p=i[t].positions[e].int_required,h=i[t].positions[e].end_required,n=[c,p,h]);var d,e=n[o(n)],c=a[o(n)],p=n[r(n)],h=a[r(n)];const g=.67*s(e,c)+.33*s(p,h),f=(d=g)<1?"eff-red":d<1.5?"eff-yellow":"eff-green",m=l(n[0],a[0]),u=l(n[1],a[1]),b=l(n[2],a[2]);p=Math.floor(Math.min(45,c/e*45*1.2)+Math.floor(Math.min(45,h/p*45*1.2)+Math.floor(Math.max(0,5*Math.log2(1.2*c/e)))+Math.floor(Math.max(0,5*Math.log2(1.2*h/p)))));return[g,f,m,u,b].concat(n).concat(p)}function ot(t){let e=0;t=Kt("EMPLOYEE_RANK",t);return null!=t&&null!=t&&(e=t),e}function rt(t){var e=`https://api.torn.com/company/?selections=profile,employees&key=${x}`;const a=Fe("#tips-view-company");a.text("---探测中---"),fetch(e).then(t=>t.ok?t.json():void a.text("---探测失败---"),t=>{a.text("---网络异常---")}).then(c=>{if(a.text("---探测完成---"),"error"in c)a.text(`---错误代码：${c.error.code} 错误：${c.error.error}---`);else if("company_employees"in c){Fe("#companyname").text(c.company.name),t.prepend(`
                    <table class="company-effectiveness" style="background-color: #FFF5F7;font-size:12px;margin:auto;">
                        <tr class="head">
                            <th class="employee-basic table-position">岗位</th>
                            <th class="employee-basic table-days">天</th>
                            <th class="employee-ws table-man">MAN</th>
                            <th class="employee-ws table-int">INT</th>
                            <th class="employee-ws table-end">END</th>
                            <th class="employee-effectiveness table-ws" title="Working Stats">属</th>
                            <th class="employee-effectiveness table-ep" title="Effectiveness Prediction">估</th>
                            <th class="employee-basic table-last">登</th>
                            <th class="employee-basic table-username">名字</th>
                            <th class="employee-effectiveness table-settled" title="Settled In">天</th>
                            <th class="employee-effectiveness table-merits" title="Merits">点</th>
                            <th class="employee-effectiveness table-education" title="Director Education">课</th>
                            <th class="employee-effectiveness table-management" title="Management">理</th>
                            <th class="employee-effectiveness table-addiction" title="Addiction">药</th>
                            <th class="employee-effectiveness table-total" title="Total">总</th>
                            <th class="employee-status table-tornstats">参</th>
                        </tr>
                    </table>`);const p=t.children(".company-effectiveness");p.find("th.employee-basic").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),p.find("th.employee-ws").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;"),p.find("th.employee-effectiveness").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #757947;color: white;font-weight: bold;text-align:center;"),p.find("th.employee-status").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #725334;color: white;font-weight: bold;text-align:center;");let a=[];Fe.each(c.company_employees,function(t,e){e.userid=t,e.position_rank=ot(t),a.push(e)}),a.sort(function(t,e){return t.position_rank-e.position_rank});const h={0:"",1:"eff-yellow",3:"eff-red"};Fe.each(a,function(t,e){var a=et(e.last_action.timestamp),n=172800<=a[0]?3:86400<=a[0]?1:0,i=e.effectiveness.addiction||0,o=i<=-10?3:i<=-5?1:0,r=e.effectiveness.merits||0,s=r<=2?3:r<=4?1:0,l=n+o+s,d=3<=l?3:1<=l?1:0,l=it(c.company.company_type,e.position,[e.manual_labor,e.intelligence,e.endurance]);p.children().append(`
                        <tr class="content">
                            <td class="table-position tleft" position-value="${e.position_rank}">${e.position}</td>
                            <td class="table-days">${e.days_in_company}</td>
                            <td class="table-man tright ${l[2]}" man="${e.manual_labor}" title="MAN Required: ${zt(l[5])}">${kt(e.manual_labor)}</td>
                            <td class="table-int tright ${l[3]}" int="${e.intelligence}" title="INT Required: ${zt(l[6])}">${kt(e.intelligence)}</td>
                            <td class="table-end tright ${l[4]}" end="${e.endurance}" title="END Required: ${zt(l[7])}">${kt(e.endurance)}</td>
                            <td class="table-ws">${e.effectiveness.working_stats||0}</td>
                            <td class="table-ep">${l[8]}</td>
                            <td class="table-last ${h[n]}" last-action-minutes="${a[0]}">${a[1]}</td>
                            <td class="table-username ${h[d]}"><a class="user name" href="/profiles.php?XID=${e.userid}" target="_blank">${e.name}</a></td>
                            <td class="table-settled">${e.effectiveness.settled_in||0}</td>
                            <td class="table-merits ${h[s]}">${r}</td>
                            <td class="table-education">${e.effectiveness.director_education||0}</td>
                            <td class="table-management">${e.effectiveness.management||0}</td>
                            <td class="table-addiction ${h[o]}">${i}</td>
                            <td class="table-total"><b>${e.effectiveness.total||0}</b></td>
                            <td class="table-tornstats tright ${l[1]}" effectiveness="${l[0]}"><span>${(100*l[0]).toFixed(0)}%</span></td>
                        </tr>`)}),p.find("th").css("cursor","pointer"),p.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),p.find("td.tright").css("text-align","right"),p.find("td.tleft").css("text-align","left"),p.find("td.eff-green").css("background-color","#D0E9C6"),p.find("td.eff-yellow").css("background-color","#FAF2CC"),p.find("td.eff-red").css("background-color","#EBCCCC"),te(p.find("th.table-position"),lt),te(p.find("th.table-days"),dt),te(p.find("th.table-man"),ct),te(p.find("th.table-int"),pt),te(p.find("th.table-end"),ht),te(p.find("th.table-ws"),gt),te(p.find("th.table-settled"),ft),te(p.find("th.table-merits"),mt),te(p.find("th.table-education"),ut),te(p.find("th.table-management"),bt),te(p.find("th.table-addiction"),xt),te(p.find("th.table-total"),vt),te(p.find("th.table-last"),K),te(p.find("th.table-tornstats"),_t)}}).catch(t=>console.log("fetch error",t))}function st(M){let T=Ut("company-history-items"),P=0;T&&(P=Object.keys(T).length);const t=new Date,N=new Date(new Date(t.setDate(t.getDate()-1)).setHours(t.getHours()-2)).format("yyyy-MM-dd"),E=Kt("company-history-items",N);const z=Kt("company-history-items",new Date(t.setDate(t.getDate()-1)).format("yyyy-MM-dd"));if(null===M){if(P<=0)return void console.log("没有历史数据，跳过自动获取公司产量数据");if(E)return void console.log("本次产量数据已存过，跳过自动获取公司产量数据");console.log("本次产量数据还没存过，将自动获取公司产量数据")}var e=`https://api.torn.com/company/?selections=profile,employees,stock,detailed,news&key=${x}`;const j=Fe("#tips-view-company");j.text("---探测中---"),fetch(e).then(t=>t.ok?t.json():void j.text("---探测失败---"),t=>{j.text("---网络异常---")}).then(g=>{console.log(g);var t=g.company_detailed.trains_available,{rating:e,company_type:a}=g.company;let n=0;var i=Kt("APICache_companies","companies");if(i&&i[a]&&i[a].positions)for(const O in g.company_employees){var o=g.company_employees[O];"Trainer"===i[a].positions[o.position].special_ability&&n++}var r=t+e+3*n;let s=`${t}(当前)+${e}(星级)`;if(0<n&&(s+=`+0~${3*n}(Trainer)`),20<r&&Fe("#bingwa-top-warn").append(`
                            <div class="info-msg border-round">
                                <i class="info-icon"></i>
                                <div class="delimiter">
                                <div class="msg right-round" tabindex="0" role="alert">
                                    trains即将溢出。
                                    ${s}
                                </div>
                                </div>
                            </div>`),M){if(null!=g.error&&7==g.error.code)throw j.text("---员工无权限查看---"),new Error("not a director");null!=g&&j.text("---探测完成---"),Fe("#companyname").text(g.company.name),M.append(`
                    <table class="company-effectiveness" style="width:100%;background-color: #FFF5F7;font-size:12px;">
                        <tr class="head">
                            <th class="employee-basic table-position">岗位</th>
                            <th class="employee-basic table-days">天</th>
                            <th class="employee-ws table-man">MAN</th>
                            <th class="employee-ws table-int">INT</th>
                            <th class="employee-ws table-end">END</th>
                            <th class="employee-effectiveness table-ws" title="Working Stats">属</th>
                            <th class="employee-effectiveness table-ep" title="Effectiveness Prediction">估</th>
                            <th class="employee-basic table-last">登</th>
                            <th class="employee-basic table-username">名字</th>
                            <th class="employee-effectiveness table-settled" title="Settled In">天</th>
                            <th class="employee-effectiveness table-merits" title="Merits">点</th>
                            <th class="employee-effectiveness table-education" title="Director Education">课</th>
                            <th class="employee-effectiveness table-management" title="Management">理</th>
                            <th class="employee-effectiveness table-addiction" title="Addiction">药</th>
                            <th class="employee-effectiveness table-inactivity" title="Inactivity">离</th>
                            <th class="employee-effectiveness table-total" title="Total">总</th>
                            <th class="employee-effectiveness table-wage" title="Wage">薪</th>
                            <th class="employee-status table-tornstats">参</th>
                        </tr>
                    </table><br /><br />
                    <table class="company-history" style="width:100%;background-color: #FFF5F7;font-size:12px;">
                        <tr class="head">
                            <th colspan=2>生产日期</th>
                            <th>收入</th>
                            <th>工资</th>
                            <th>广告费</th>
                            <th>利润</th>
                            <th>总效率</th>
                            <th>产量</th>
                            <th>销量</th>
                            <th>库存</th>
                            <th>单价</th>
                            <th>成本</th>
                            <th>记录时间</th>
                        </tr>
                    </table>`);const $=M.find(".company-effectiveness");$.find("th.employee-basic").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),$.find("th.employee-ws").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;"),$.find("th.employee-effectiveness").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #757947;color: white;font-weight: bold;text-align:center;"),$.find("th.employee-status").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #725334;color: white;font-weight: bold;text-align:center;")}let l='<br /><table class="company-stock" style="width:100%;background-color: #FFF5F7;font-size:12px;"><tr class="head"><th>库存种类</th>';Fe.each(g.company_stock,function(t,e){l+=`<th>${t}</th>`}),l+='</tr><tr class="content"><td class="stock-title">单价</td>',Fe.each(g.company_stock,function(t,e){l+=`<td class="stock-content">${zt(e.price)}</td>`}),l+='</tr><tr class="content"><td class="stock-title">SOLD WORTH</td>',Fe.each(g.company_stock,function(t,e){l+=`<td class="stock-content">${zt(e.sold_worth)}</td>`}),l+='</tr><tr class="content"><td class="stock-title">SOLD AMOUNT</td>',Fe.each(g.company_stock,function(t,e){l+=`<td class="stock-content">${zt(e.sold_amount)}</td>`}),l+="</tr></table>",Fe(".company-effectiveness").after(l),Fe(".company-stock").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),Fe(".company-stock").find("td.stock-content").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),Fe(".company-stock").find("td.stock-title").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;");let d=[];Fe.each(g.company_employees,function(t,e){e.userid=t,e.position_rank=ot(t),d.push(e)}),d.sort(function(t,e){return t.position_rank-e.position_rank});const f={0:"",1:"eff-yellow",3:"eff-red"};let m=0,u=0;Fe.each(d,function(t,e){if(m+=e.wage||0,u+=e.effectiveness.total||0,null===M)return!0;var a=et(e.last_action.timestamp),n=172800<=a[0]?3:86400<=a[0]?1:0,i=e.effectiveness.addiction||0,o=i<=-10?3:i<=-5?1:0,r=e.effectiveness.inactivity||0,s=r<0?3:0,l=e.effectiveness.merits||0,d=l<=2?3:l<=4?1:0,c=n+o+d,p=3<=c?3:1<=c?1:0,c=it(g.company.company_type,e.position,[e.manual_labor,e.intelligence,e.endurance]),c=`
                    <tr class="content">
                        <td class="table-position tleft" position-value="${e.position_rank}">${e.position}</td>
                        <td class="table-days">${e.days_in_company}</td>
                        <td class="table-man tright ${c[2]}" man="${e.manual_labor}" title="MAN Required: ${zt(c[5])}">${kt(e.manual_labor)}</td>
                        <td class="table-int tright ${c[3]}" int="${e.intelligence}" title="INT Required: ${zt(c[6])}">${kt(e.intelligence)}</td>
                        <td class="table-end tright ${c[4]}" end="${e.endurance}" title="END Required: ${zt(c[7])}">${kt(e.endurance)}</td>
                        <td class="table-ws">${e.effectiveness.working_stats||0}</td>
                        <td class="table-ep">${c[8]}</td>
                        <td class="table-last ${f[n]}" last-action-minutes="${a[0]}">${a[1]}</td>
                        <td class="table-username ${f[p]}"><a class="user name" href="/profiles.php?XID=${e.userid}" target="_blank">${e.name}</a></td>
                        <td class="table-settled">${e.effectiveness.settled_in||0}</td>
                        <td class="table-merits ${f[d]}">${l}</td>
                        <td class="table-education">${e.effectiveness.director_education||0}</td>
                        <td class="table-management">${e.effectiveness.management||0}</td>
                        <td class="table-addiction ${f[o]}">${i}</td>
                        <td class="table-inactivity ${f[s]}">${r}</td>
                        <td class="table-total"><b>${e.effectiveness.total||0}</b></td>
                        <td class="table-wage" wage="${e.wage}"><b>$${zt(e.wage||0)}</b></td>
                        <td class="table-tornstats tright ${c[1]}" effectiveness="${c[0]}"><span>${(100*c[0]).toFixed(0)}%</span></td>
                    </tr>`;const h=M.find(".company-effectiveness");h.children().append(c)});var c=parseInt(g.company.daily_income||0),t=parseInt(g.company_detailed.advertising_budget||0);let p=0,h=0,b=0,x=0,y=0;Fe.each(g.company_stock,function(t,e){p+=e.sold_amount*e.cost,h+=e.sold_amount,b+=e.in_stock,x+=e.sold_worth}),0<h&&(y=parseInt(x/h));let v=b;z?(console.log("有上一次的产量数据"),console.log(z),v=z.Stock||b):console.log("没有上一次的产量数据，本次的产量将设置为与销量相等");e=b+h-v,r=c-m-t-p,e={Date:N,Income:c,Wages:m,Ad:t,Profit:r,Effectiveness:u,Produced:e,Sold:h,Stock:b,Price:y,Cost:p,RecordTime:(new Date).format("MM-dd hh:mm:ss")};console.log(e);let w=!1;var _,k=g.news;for(_ in k){const C=k[_];if(0<=C.news.indexOf("report"))if(new Date(1e3*(C.timestamp-86400)).format("yyyy-MM-dd")==N){w=!0;break}}if(E||!w?console.log("本次产量数据已存过，不再覆盖"):(console.log("本次产量数据未保存，现在保存"),Yt("company-history-items",N,e),T=Ut("company-history-items")),console.log(T),null===M)return!0;const $=M.find(".company-effectiveness");$.find("th").css("cursor","pointer"),$.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),$.find("td.tright").css("text-align","right"),$.find("td.tleft").css("text-align","left"),$.find("td.eff-green").css("background-color","#D0E9C6"),$.find("td.eff-yellow").css("background-color","#FAF2CC"),$.find("td.eff-red").css("background-color","#EBCCCC"),te($.find("th.table-position"),lt),te($.find("th.table-days"),dt),te($.find("th.table-man"),ct),te($.find("th.table-int"),pt),te($.find("th.table-end"),ht),te($.find("th.table-ws"),gt),te($.find("th.table-si"),ft),te($.find("th.table-me"),mt),te($.find("th.table-de"),ut),te($.find("th.table-ma"),bt),te($.find("th.table-ad"),xt),te($.find("th.table-ia"),yt),te($.find("th.table-to"),vt),te($.find("th.table-wg"),wt),te($.find("th.table-last"),K),te($.find("th.table-tornstats"),_t),$.after(`<br /><b>实时人数：${Object.keys(g.company_employees).length}，总工资：$${zt(e.Wages)}，广告费：$${zt(e.Ad)}，周销售：$${zt(g.company.weekly_income)}</b><br />`);let I={Income:0,Wages:0,Ad:0,Profit:0,Effectiveness:0,Produced:0,Sold:0,Stock:0,Price:0,Cost:0};const F=M.find(".company-history");let D=0,S=0,A=0;Fe.each(T,function(t,e){var a=parseInt(((new Date).getTime()-new Date(t).getTime())/864e5);if(31<a)return console.log(`删除过期数据：${t}`),Zt("company-history-items",t),delete T[t],!0;A++;t=`
                    <tr class="content">
                        <td>${A}</td>
                        <td>${t}</td>
                        <td>$${zt(e.Income)}</td>
                        <td>$${zt(e.Wages)}</td>
                        <td>$${zt(e.Ad)}</td>
                        <td>$${zt(e.Profit)}</td>
                        <td>${zt(e.Effectiveness)}</td>
                        <td>${zt(e.Produced)}</td>
                        <td>${zt(e.Sold)}</td>
                        <td>${zt(e.Stock)}</td>
                        <td>$${zt(e.Price)}</td>
                        <td>$${zt(e.Cost)}</td>
                        <td>${e.RecordTime||"-"}</td>
                    </tr>`;F.children().append(t),I.Income+=parseInt(e.Income),I.Wages+=parseInt(e.Wages),I.Ad+=parseInt(e.Ad),I.Profit+=parseInt(e.Profit),I.Effectiveness+=parseInt(e.Effectiveness),I.Produced+=parseInt(e.Produced),I.Sold+=parseInt(e.Sold),I.Stock+=parseInt(e.Stock),I.Price+=parseInt(e.Price),I.Cost+=parseInt(e.Cost||0),a<=7&&(D+=parseInt(e.Profit),S++)}),P=Object.keys(T).length;e=`
                <tr class="content">
                    <td colspan=2><b>平均值</b></td>
                    <td>$${zt((I.Income/P).toFixed(0))}</td>
                    <td>$${zt((I.Wages/P).toFixed(0))}</td>
                    <td>$${zt((I.Ad/P).toFixed(0))}</td>
                    <td>$${zt((I.Profit/P).toFixed(0))}</td>
                    <td>${zt((I.Effectiveness/P).toFixed(0))}</td>
                    <td>${zt((I.Produced/P).toFixed(0))}</td>
                    <td>${zt((I.Sold/P).toFixed(0))}</td>
                    <td>${zt((I.Stock/P).toFixed(0))}</td>
                    <td>$${zt((I.Price/P).toFixed(0))}</td>
                    <td>$${zt((I.Cost/P).toFixed(0))}</td>
                    <td>${(new Date).format("MM-dd hh:mm:ss")}</td>
                </tr>`;F.children().append(e),F.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),F.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),F.after(`<br /><b>共 ${P} 天数据，总利润：$${zt(I.Profit)}，近一周(${S}天)利润：$${zt(D)}</b>`)}).catch(t=>console.log("fetch error: ",t.message))}function lt(t){return Fe(t).find("td.table-position").attr("position-value")}function dt(t){return Fe(t).find("td.table-days").text()}function ct(t){return Fe(t).find("td.table-man").attr("man")}function pt(t){return Fe(t).find("td.table-int").attr("int")}function ht(t){return Fe(t).find("td.table-end").attr("end")}function gt(t){return Fe(t).find("td.table-ws").text()}function ft(t){return Fe(t).find("td.table-settled").text()}function mt(t){return Fe(t).find("td.table-merits").text()}function ut(t){return Fe(t).find("td.table-education").text()}function bt(t){return Fe(t).find("td.table-management").text()}function xt(t){return Fe(t).find("td.table-addiction").text()}function yt(t){return Fe(t).find("td.table-inactivity").text()}function vt(t){return Fe(t).find("td.table-total").text()}function wt(t){return Fe(t).find("td.table-wage").attr("wage")}function _t(t){return Fe(t).find("td.table-tornstats").attr("effectiveness")}function kt(t){return t<1e4?t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","}):parseInt(t/1e3)+"k"}function $t(n){return new Promise((e,a)=>{var t=`https://api.torn.com/user/${n}?selections=profile&key=${x}`;fetch(t).then(t=>t.ok?t.json():void console.log("---探测失败 "+n+"---"),t=>{console.log("---网络异常 "+n+"---")}).then(t=>{null!=t?"error"in t?a(t.error):(console.log(`userId2otherIds: ${n} => (${t.faction.faction_id} - ${t.faction.position}) (${t.job.company_id} - ${t.job.position})`),e([t.faction.faction_id,t.faction.position,t.job.company_id,t.job.position])):a()}).catch(t=>a(t))})}function It(o){return new Promise((e,n)=>{const i=Fe("#mainContainer").find("div:contains('unavailable')").last();i.text("蛙蛙探测器工作中...");var t=`https://api.torn.com/faction/${o}?selections=basic,chain&key=${x}`;fetch(t).then(t=>t.ok?t.json():void i.text("---探测失败 "+o+"---"),t=>{i.text("---网络异常 "+o+"---")}).then(t=>{if(null!=t)if("error"in t)n(t.error);else{Fe("#skip-to-content").text(`帮派: ${t.name}`),i.html(`<b>声望:</b> ${zt(t.respect)}&nbsp;&nbsp;&nbsp;&nbsp;<b>天数:</b> ${zt(t.age)}&nbsp;&nbsp;&nbsp;&nbsp;<b>最大连击:</b> ${zt(t.best_chain)}&nbsp;&nbsp;&nbsp;&nbsp;<b>成员数:</b> ${Object.keys(t.members).length}`),0<t.chain.current&&i.append(`</br /></br /><b>正在连击:</b> ${zt(t.chain.current)}/${zt(t.chain.max)}&nbsp;&nbsp;&nbsp;&nbsp;<b>开始时间:</b> ${new Date(1e3*t.chain.start).format("yyyy-MM-dd hh:mm:ss")}&nbsp;&nbsp;&nbsp;&nbsp;<b>连击超时:</b> ${t.chain.timeout}(秒)&nbsp;&nbsp;&nbsp;&nbsp;<b>声望系数:</b> ${t.chain.modifier}&nbsp;&nbsp;&nbsp;&nbsp;<b>冷却时间:</b> ${t.chain.cooldown}`),t.territory_wars&&0<Object.keys(t.territory_wars).length&&(i.append("</br />"),Fe.each(t.territory_wars,function(t,e){e.assaulting_faction==o?i.append(`</br /><b>正在进攻地盘:</b> ${e.territory}&nbsp;&nbsp;&nbsp;&nbsp;<b>防守方:</b> <a href='/factions.php?step=profile&ID=${e.defending_faction}' target='_blank'>${e.defending_faction}</a>`):i.append(`</br /><b>正在防守地盘:</b> ${e.territory}&nbsp;&nbsp;&nbsp;&nbsp;<b>进攻方:</b> <a href='/factions.php?step=profile&ID=${e.assaulting_faction}' target='_blank'>${e.assaulting_faction}</a>`),i.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>推墙进度:</b> ${zt(e.score)}/${zt(e.required_score)}&nbsp;&nbsp;&nbsp;&nbsp;<b>最迟结束时间:</b> ${new Date(1e3*e.end_time).format("yyyy-MM-dd hh:mm:ss")}`)})),t.peace&&0<Object.keys(t.peace).length&&(i.append("</br />"),Fe.each(t.peace,function(t,e){i.append(`</br /><b>和平条约:</b> <a href='/factions.php?step=profile&ID=${t}' target='_blank'>${t}</a>&nbsp;&nbsp;&nbsp;&nbsp;<b>到期时间:</b> ${new Date(1e3*e).format("yyyy-MM-dd hh:mm:ss")}`)})),t.raid_wars&&0<Object.keys(t.raid_wars).length&&(i.append("</br />"),Fe.each(t.raid_wars,function(t,e){e.raiding_faction==o?i.append(`</br /><b>正在突击:</b> <a href='/factions.php?step=profile&ID=${e.defending_faction}' target='_blank'>${e.defending_faction}</a>`):i.append(`</br /><b>正在被</b> <a href='/factions.php?step=profile&ID=${e.raiding_faction}' target='_blank'>${e.raiding_faction}</a> 突击`),i.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>突击进度(攻/守):</b> ${e.raider_score}/${e.defender_score}&nbsp;&nbsp;&nbsp;&nbsp;<b>开始时间:</b> ${new Date(1e3*e.start_time).format("yyyy-MM-dd hh:mm:ss")}`)})),Fe(".content-wrapper").last().append(`
                        <table id="faction-members" style="width:100%;background-color: #FFF5F7;font-size:12px;">
                            <tr class="head">
                                <th>名字</th>
                                <th>天数</th>
                                <th>上次活动</th>
                                <th>状态</th>
                                <th>角色</th>
                            </tr>
                        </table>`);const a=Fe("#faction-members");Fe.each(t.members,function(t,e){e=`
                            <tr class="content">
                                <td><a href='/profiles.php?XID=${t}' target='_blank'>${e.name}</a></td>
                                <td>${e.days_in_faction}</td>
                                <td>${e.last_action.relative}</td>
                                <td>${e.status.description}</td>
                                <td>${e.position}</td>
                            </tr>`;a.children().append(e)}),a.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),a.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),e()}else n()}).catch(t=>i.text(t))})}function Ft(a){return new Promise((t,i)=>{const o=Fe("#mainContainer").find("div:contains('unavailable')").last();o.text("蛙蛙探测器工作中...");var e=`https://api.torn.com/company/${a}?selections=profile&key=${x}`;fetch(e).then(t=>t.ok?t.json():void o.text("---探测失败 "+a+"---"),t=>{o.text("---网络异常 "+a+"---")}).then(e=>{if(null!=e)if("error"in e)i(e.error);else{var a,t={1:"Hair Salon",2:"Law Firm",3:"Flower Shop",4:"Car Dealership",5:"Clothing Store",6:"Gun Shop",7:"Game Shop",8:"Candle Shop",9:"Toy Shop",10:"Adult Novelties",11:"Cyber Cafe",12:"Grocery Store",13:"Theater",14:"Sweet Shop",15:"Cruise Line",16:"Television Network",18:"Zoo",19:"Firework Stand",20:"Property Broker",21:"Furniture Store",22:"Gas Station",23:"Music Store",24:"Nightclub",25:"Pub",26:"Gents Strip Club",27:"Restaurant",28:"Oil Rig",29:"Fitness Center",30:"Mechanic Shop",31:"Amusement Park",32:"Lingerie Store",33:"Meat Warehouse",34:"Farm",35:"Software Corporation",36:"Ladies Strip Club",37:"Private Security Firm",38:"Mining Corporation",39:"Detective Agency",40:"Logistics Management"};if(Fe("#skip-to-content").html(`公司: ${e.company.name}`),o.html(`<b>类型:</b> ${t[e.company.company_type]}&nbsp;&nbsp;&nbsp;&nbsp;<b>星级:</b> ${e.company.rating}&nbsp;&nbsp;&nbsp;&nbsp;<b>员工数:</b> ${e.company.employees_hired}/${e.company.employees_capacity}&nbsp;&nbsp;&nbsp;&nbsp;<b>日销售:</b> $${zt(e.company.daily_income)}&nbsp;&nbsp;&nbsp;&nbsp;<b>周销售:</b> $${zt(e.company.weekly_income)}&nbsp;&nbsp;&nbsp;&nbsp;<b>天数:</b> ${zt(e.company.days_old)}`),28==e.company.company_type){o.append("&nbsp;&nbsp;&nbsp;&nbsp;<b>估算单价x销量:</b>");for(let t=200;120<=t;--t)e.company.daily_income%t==0&&(a=parseInt(e.company.daily_income/t),o.append(` ${t}x${zt(a)}`))}else 16==e.company.company_type&&(t=parseInt(e.company.daily_income/e.company.daily_customers),o.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>单价x销量:</b> ${zt(t)}x${zt(e.company.daily_customers)}`));Fe(".content-wrapper").last().append(`
                            <table id="company-members" style="width:100%;background-color: #FFF5F7;font-size:12px;">
                                <tr class="head">
                                    <th>名字</th>
                                    <th>天数</th>
                                    <th>上次活动</th>
                                    <th>状态</th>
                                    <th>职位</th>
                                </tr>
                        </table>`);const n=Fe("#company-members");Fe.each(e.company.employees,function(t,e){e=`
                            <tr class="content">
                                <td><a href='/profiles.php?XID=${t}' target='_blank'>${e.name}</a></td>
                                <td>${e.days_in_company}</td>
                                <td>${e.last_action.relative}</td>
                                <td>${e.status.description}</td>
                                <td>${e.position}</td>
                            </tr>`;n.children().append(e)}),n.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),n.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;")}else i()}).catch(t=>o.text(t))})}if(0<=window.location.href.indexOf("factions.php?step=your")){const ra=Fe("[href^='/forums.php#!p=forums&f=999&b=1&a=']").attr("href");let t=0;if(null!=ra&&(t=ra.substring(34),window.localStorage.setItem("MY_FACTION_ID",t)),foo){let e=setInterval(Dt,1e3),a=0;function Dt(){if(console.log("faction other"),0<=window.location.href.indexOf("factions.php?step=your#/tab=info")&&0<Fe("li.position").length){clearInterval(e),a=setInterval(St,1e3),console.log("li position"),j("div.f-war-list","ul.table-body");const t=Fe("div[data-faction]").attr("data-faction");nt(t)}}function St(){console.log("faction info"),window.location.href.indexOf("factions.php?step=your#/tab=info")<0&&(clearInterval(a),e=setInterval(Dt,1e3))}}}if(0<=window.location.href.indexOf("factions.php?step=profile&")){const sa=Fe("#mainContainer").find("div:contains('unavailable')").last();if(0<sa.length){if(0<=window.location.href.indexOf("profile&ID=")){const fID=/profile&ID=(\d+)/.exec(window.location.href)[1];console.log("fID "+fID),It(fID).catch(t=>console.log("factionPageRedraw "+t))}else if(0<=window.location.href.indexOf("profile&userID=")){const Ke=/userID=(\d+)/.exec(window.location.href)[1];console.log("userId "+Ke),$t(Ke).then(function(t){console.log(t),It(t[0]).catch(t=>console.log("factionPageRedraw "+t))}).catch(t=>console.log("userId2otherIds "+t))}}else if(foo){const la=setInterval(Dt,1e3);function Dt(){if(0<Fe("li.position").length){clearInterval(la),console.log("li position"),j("div.f-war-list","ul.table-body");const t=Fe("div[data-faction]").attr("data-faction");nt(t)}}}}if(0<=window.location.href.indexOf("p=corpinfo&")){const sa=Fe("#mainContainer").find("div:contains('unavailable')").last();if(0<sa.length){if(0<=window.location.href.indexOf("corpinfo&ID=")){const da=/corpinfo&ID=(\d+)/.exec(window.location.href)[1];console.log("companyID "+da),new Promise(function(t,e){setTimeout(function(){console.log("2 Seconds"),t()},2e3)}).then(function(){Ft(da).catch(t=>console.log("companyPageRedraw "+t))}).catch(t=>console.log("companyPageRedraw "+t))}else if(0<=window.location.href.indexOf("corpinfo&userID=")){const Ke=/userID=(\d+)/.exec(window.location.href)[1];console.log("userId "+Ke),$t(Ke).then(function(a){return new Promise(function(t,e){setTimeout(function(){console.log("2 Seconds"),t(a)},2e3)})}).then(function(t){console.log(t),Ft(t[2]).catch(t=>console.log("companyPageRedraw "+t))}).catch(t=>console.log("userId2otherIds "+t))}}else{let t=setInterval(z,500);function z(){if(0<=Fe("div.company-details").children("div.title-black").text().indexOf("Oil Rig")){clearInterval(t);const e=Fe("div.company-details").find("li:contains('Daily income')").text().replace(/[^\d]/g,"");for(let t=250;120<=t;--t)if(e%t==0){const a=parseInt(e/t);Fe("div.company-details").children("div.title-black").append(`<span class="m-hide"> - 估算单价: ${t}，估算销量: ${zt(a)} </span>`)}}}}}if("https://www.torn.com/competition.php"==window.location.href||"https://www.torn.com/competition.php#/p=main"==window.location.href){const sa=Fe("#mainContainer").find("div:contains('access')").last();if(0<sa.length){sa.text("蛙蛙探测器工作中...");const ca=`https://api.torn.com/torn/?selections=competition&key=${x}`;fetch(ca).then(t=>t.ok?t.json():void sa.text("---探测失败 ---"),t=>{sa.text("---网络异常 ---")}).then(t=>{Fe(".content-wrapper").last().append(`
                        <table id="elim-teams" style="margin-top:10px;width:100%;background-color: #FFF5F7;font-size:12px;">
                            <tr class="head">
                                <th>排名</th>
                                <th>队伍</th>
                                <th>状态</th>
                                <th>分数</th>
                                <th>生命</th>
                                <th>参与人数</th>
                                <th>攻击胜利</th>
                                <th>被攻击</th>
                            </tr>
                        </table>`);const e=Fe("#elim-teams"),a=t.competition.teams;a.forEach(function(t){t=`
                        <tr class="content">
                            <td>${t.position}</td>
                            <td>${t.name}</td>
                            <td>${t.status}</td>
                            <td>${t.score}</td>
                            <td>${t.lives}</td>
                            <td>${t.participants}</td>
                            <td>${t.wins}</td>
                            <td>${t.losses}</td>
                        </tr>`;e.children().append(t)}),e.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),e.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;")}).catch(t=>sa.text(t))}}if(0<=window.location.href.indexOf("competition.php")){const pa=setInterval(At,500);function At(){Fe(".description").next().remove(),Fe(".description").remove();const t=Fe("#e-showAvailable-targets").parent();if(0<t.length&&"1"!=t.attr("hasdone")){t.after(`
                        <div id="elim-parade">
                            <div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">Elimination Parade
                            </div>
                            <div class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">
                                <div class="button-wrap" style="margin:5px; float:left">
                                    <button id="elim-parade-start-btn" class="torn-btn" style="margin:5px;">开始阅兵</button>
                                    <button id="elim-parade-stop-btn"class="torn-btn" style="margin:5px;">暂停阅兵</button>
                                    <p id="elim-parade-status" style="height:12px; padding:6px 1px;"></p>
                                </div>
                            </div>
                        </div>`),t.attr("hasdone","1");const e=Fe("#competition-wrap").children(".team-list-wrap").children(".competition-list").children("li");e.each(function(){var t=Z(Fe(this).find("a.user.name").attr("href").replace(/[^0-9|-]/gi,""));0!=t[0]&&Fe(this).children("ul.list-cols").children("li.attack").children("a").text(t[2])});let i=!0;Fe("#elim-parade-start-btn").click(function(){i=!0,Fe("#elim-parade-start-btn").prop("disabled",!0),Fe("#elim-parade-stop-btn").removeAttr("disabled");const t=e.first();t.length<=0?(Fe("#elim-parade-status").text("未找到用户列表"),Fe("#elim-parade-start-btn").removeAttr("disabled")):(Fe("#elim-parade-status").text("阅兵开始"),setTimeout(()=>{!function e(a){if("1"==a.attr("detected"))Fe("#elim-parade-status").text("用户已完成"),setTimeout(()=>{e(a.next())},0);else if(a.length<=0||0==i)Fe("#elim-parade-status").text("阅兵已结束"),Fe("#elim-parade-start-btn").removeAttr("disabled"),Fe("#elim-parade-stop-btn").prop("disabled",!0);else{a.attr("detected","1");const n=a.find("a.user.name").attr("href").replace(/[^0-9|-]/gi,"");Fe("#elim-parade-status").text("正在阅兵: "+n),ne(n,function(t){a.children("ul.list-cols").children("li.attack").children("a").text(Rt(t.estimate_bs)),Yt("battlestats",n,t.estimate_bs),Yt("networths",n,t.personalstats.networth),setTimeout(()=>{e(a.next())},1e3)},function(t){Fe("#elim-parade-status").text("蛙蛙探测 "+n+" 失败 "+t),setTimeout(()=>{e(a.next())},1e3)})}}(t)},1e3))}),Fe("#elim-parade-stop-btn").click(function(){i=!1})}}}if(bounty_parade&&window.location.href.indexOf("bounties.php#!p=main")){const ha=setInterval(Ot,2e3);function Ot(){const t=Fe("ul.bounties-list").children(),e=t.first();e.length<=0?Fe("div.bounties-total").text("未找到用户列表"):"1"==e.attr("detected")||(Fe("div.bounties-total").text("阅兵开始"),setTimeout(()=>{!function e(a){a.attr("detected","1");const n=a.find("div.status");if(0<n.children(".t-red").length)Fe("div.bounties-total").text("本条已阅兵完毕"),setTimeout(()=>{e(a.next())},0);else if(null==a.attr("data-id"))Fe("div.bounties-total").text("本页阅兵结束");else{const i=a.find("div.target").children("a"),o=i.attr("href").replace(/[^0-9]/gi,"");var t=i.text();Fe("div.bounties-total").text("正在阅兵: "+o+" "+t),ne(o,function(t){n.children(".t-green").text(Rt(t.estimate_bs)),Yt("battlestats",o,t.estimate_bs),setTimeout(()=>{e(a.next())},0)},function(t){Fe("div.bounties-total").text("蛙蛙探测 "+o+" 失败 "+t),setTimeout(()=>{e(a.next())},0)})}}(e)},0))}}if(mugoo&&0<=window.location.href.indexOf("imarket.php")){let d=window.location.href,c=setInterval(z,500),f=0;const ga=["Donator Pack","Xanax","Erotic DVD","Drug Pack","Feathery Hotel Coupon","Anti Tank","Large Suitcase","Wind Proof Lighter","Six Pack of Energy Drink","Sierra Cosworth"],fa=["Tribulus Omanense","Peony","African Violet","Cherry Blossom","Heather","Ceibo Flower","Edelweiss"],ma=["Camel Plushie","Lion Plushie","Panda Plushie","Monkey Plushie","Chamois Plushie","Red Fox Plushie","Nessie Plushie"],ua=["Can of X-MASS","Can of Taurine Elite","Can of Rockstar Rudolph","Can of Red Cow","Can of Munster","Can of Santa Shooters"];function z(){const t=Fe(".guns-list.cont-gray");if(t&&0<t.length){clearInterval(c),clearInterval(f),d=window.location.href,f=setInterval(Ct,500);const a=Fe(".msg.right-round");a.html(`
                <div id="important" style="margin:6px 0px; overflow:hidden;"><div style="float:left; padding:2px; margin:3px; background-color:${Ce.gray}; color:white;">重要</div></div>
                <div id="flower" style="margin:6px 0px; overflow:hidden;"><div style="float:left; padding:2px; margin:3px; background-color:${Ce.gray}; color:white;">花花</div></div>
                <div id="plushie" style="margin:6px 0px; overflow:hidden;"><div style="float:left; padding:2px; margin:3px; background-color:${Ce.gray}; color:white;">玩偶</div></div>
                <div id="can" style="margin:6px 0px; overflow:hidden;"><div style="float:left; padding:2px; margin:3px; background-color:${Ce.gray}; color:white;">能饮</div></div>
            `);for(let t=0;t<ga.length;t++){const o=ga[t].split(" ")[0];Fe("#important").append(`<div class="border-round header-link" style="float:left; cursor:pointer; padding:2px; margin:3px; background-color:${Ce.yellowgreen}; color:white;" name="${ga[t]}">${o}</div>`)}for(let t=0;t<fa.length;t++){const r=fa[t].split(" ")[0];Fe("#flower").append(`<div class="border-round header-link" style="float:left; cursor:pointer; padding:2px; margin:3px; background-color:${Ce.pink}; color:white;" name="${fa[t]}">${r}</div>`)}for(let t=0;t<ma.length;t++){const s=ma[t].replace(/ Plushie/g,"");Fe("#plushie").append(`<div class="border-round header-link" style="float:left; cursor:pointer; padding:2px; margin:3px; background-color:${Ce.blue}; color:white;" name="${ma[t]}">${s}</div>`)}for(let t=0;t<ua.length;t++){const l=ua[t].replace(/Can of /g,"");Fe("#can").append(`<div class="border-round header-link" style="float:left; cursor:pointer; padding:2px; margin:3px; background-color:${Ce.yellow}; color:white;" name="${ua[t]}">${l}</div>`)}Fe(".header-link").click(function(){const t=Fe(this).attr("name"),e="/imarket.php#/p=shop&step=shop&type=&searchname="+t.replace(/ /g,"+");console.log(e),window.location.href=e});let I=Fe(".items").children(":first").find("[itemid]").attr("itemid");I=I||t.children(":first").find("img.torn-item.item-plate").attr("src").replace(/[^\d]/g,"");const n=t.children(":first").find(".name.t-gray-6").text();if(0<=ga.indexOf(n)||0<=fa.indexOf(n)||0<=ma.indexOf(n)||0<=ua.indexOf(n)){let d={};const p=Kt("bazaar_cache",n);let c=0;const h=Fe(".desc.t-blue-cont.t-overflow");if(h.each(function(t,e){const a=Fe(this).find(".price.t-gray-6"),n=Fe(this).find(".user.t-overflow").children("a"),i=n.attr("href"),o=i?i.replace(/[^\d]/g,""):0,r=a.text().split("(")[0].trim(),s=jt(r),l=a.text().split("(")[1].replace(/\)/g,"").trim();d[o]={price:s,price_formal:r,amount:l},s>c&&(c=s)}),!Fe.isEmptyObject(p))for(var e in p)if(null==d[e]&&p[e].price>=c){const g=`
                                <li>
                                    <span class="item-desc">
                                        <span class="item">
                                            <img class="img___3jDmV" src="/images/items/${I}/large.png?v=1528808940574" alt="${n}">
                                            <a class="item-hover" href="/bazaar.php?userID=${e}"></a>
                                        </span>
                                        <span class="desc t-blue-cont t-overflow">
                                            <span class="user t-overflow">
                                                <a href="/bazaar.php?userID=${e}">Pampa's bazaar</a>
                                            </span>
                                            <span class="name t-gray-6">${n}</span>
                                            <span class="price t-gray-6"> ${p[e].price_formal}
                                                <span class="stock t-gray-9">(${p[e].amount})</span>
                                            </span>
                                        </span>
                                    </span>
                                </li>`;t.children(":last").before(g)}Mt(I,n,d,p)}const i=Fe(".desc.t-blue-cont.t-overflow");i.each(function(t,e){const v=Fe(this).find(".price.t-gray-6"),w=Fe(this).find(".user.t-overflow").children("a"),a=w.attr("href"),_=a?a.replace(/[^\d]/g,""):0;v.prev().remove();const n=v.text().split("(")[0].trim(),k=jt(n),$=v.text().split("(")[1].replace(/\)/g,"").trim();ne(_,function(t){const e=et(t.last_action.timestamp),a=t.status.color,n=at(t.status.description,t.status.state,t.status.until),i=t.job.company_type,o=t.basicicons.icon72,r=t.last_action.status,s=t.bazaar,l=t.faction.faction_id;let d={};if(s.map(function(t,e,a){d[t.ID]={name:t.name,quantity:t.quantity,price:t.price}}),!(I in d))return v.parent().parent().parent().remove(),!0;{const x=d[I].quantity,y=d[I].price;x==$&&y==k||v.html(`${jt(y)} <span class="stock t-gray-9">(${x})</span>`)}l in Ae&&w.parent().parent().css("background-color",Ce.green);let c="";c="Online"==r?'<span title="<b>Online</b>" style="width:16px;height:16px;margin:0px 2px;vertical-align:bottom; display:inline-block; background-position:0px 0; background-image:url(/images/v2/svg_icons/sprites/user_status_icons_sprite.svg)"></span>':"Offline"==r?'<span title="<b>Offline</b>" style="width:16px;height:16px;margin:0px 2px;vertical-align:bottom; display:inline-block; background-position:-18px 0;   background-image:url(/images/v2/svg_icons/sprites/user_status_icons_sprite.svg)"></span>':'<span title="<b>Idle</b>" style="width:16px;height:16px;margin:0px 2px;vertical-align:bottom; display:inline-block; background-position:-1098px 0;  background-image:url(/images/v2/svg_icons/sprites/user_status_icons_sprite.svg)"></span>';let p="打",h=Ce.purple;5==i&&(p="衣",h=Ce.gray),null!=o&&(p="新",h=Ce.gray),w.text("");const g=`${c}<a href="/profiles.php?XID=${_}">${t.name}</a>`,f=`<a class= "border-round" style="padding:1px 2px;background-color:${h};color:white;" href="/loader.php?sid=attack&user2ID=${_}">${p}</a>`;w.before(f),w.after(g);let m=0;null!=s&&s.map(function(t,e,a){m+=t.quantity*t.market_price}),v.parent().siblings(".item").css("margin","2px 10px"),v.parent().siblings(".item").append(`<div style="font-size: 13px; line-height: 17px; text-align: center;"><span class="border-round" style="background-color: ${Ce.purple}; color: white; padding: 1px 3px;">全店 ${Rt(m)}</span></div>`);let u="";"blue"==a&&(u=Ce.blue),"green"==a&&(u=Ce.green),"red"==a&&(u=Ce.red);let b=`
                        <span class="left" style="">
                            <span class= "border-round" style="padding: 1px 3px; background-color: ${u}; color: white;" title="Status: ${t.status.description}">${n[0]}</span>
                            <span style="padding: 1px 3px;" title="Last Action: ${t.last_action.relative}">${e[1]}</span>
                            <span style="padding: 1px 3px;" title="BattleStats: ${Rt(t.estimate_bs)}">${Rt(t.estimate_bs)}</span>
                        </span>`;v.after(b)})})}}function Ct(){d!=window.location.href&&(clearInterval(c),clearInterval(f),d=window.location.href,c=setInterval(z,500))}function Mt(o,r,s,l){var t=`https://api.torn.com/market/${o}?selections=bazaar&key=${x}`;fetch(t).then(t=>t.json()).then(t=>{console.log(o+" bazaar API fetched");var e=t.bazaar;let a={};for(let t=0;t<e.length;t++){if(!Fe.isEmptyObject(l))for(var n in l)l[n].apiid==e[t].ID&&(a[n]={apiid:e[t].ID,price:e[t].cost,price_formal:jt(e[t].cost),amount:e[t].quantity});if(!Fe.isEmptyObject(s))for(var i in s)s[i].price==e[t].cost&&s[i].amount==e[t].quantity&&(a[i]={apiid:e[t].ID,price:e[t].cost,price_formal:jt(e[t].cost),amount:e[t].quantity})}Yt("bazaar_cache",r,a)}).catch(t=>console.log("fetch error",t))}}if(mugoo&&0<=window.location.href.indexOf("pmarket.php")){const Ye=setInterval(z,500);function z(){const t=Fe(".users-point-sell").children("li");if(t&&0<t.length){clearInterval(Ye);let r=[];Fe("li.total-price").attr("id","total-price");const e=document.getElementById("total-price"),s=window.getComputedStyle(e).width.replace(/px$/g,"");t.each(function(t,e){const c=Fe(this).find(".total-price"),a=Fe(this).find(".user.name").attr("href"),n=a?a.replace(/[^\d]/g,""):0,i=Fe(this).find(".user.faction").attr("href"),o=i?i.replace(/[^\d]/g,""):0;o in Ae&&Fe(this).css("background-color",Ce.green),-1==r.indexOf(n)&&(r.push(n),Number(s)<200&&c.text(""),ne(n,function(t){const e=et(t.last_action.timestamp),a=t.status.color,n=at(t.status.description,t.status.state,t.status.until),i=t.job.company_type,o=t.basicicons.icon72;let r="打",s=Ce.purple;5==i&&(r="衣",s=Ce.gray),null!=o&&(r="新",s=Ce.gray);let l="";"blue"==a&&(l=Ce.blue),"green"==a&&(l=Ce.green),"red"==a&&(l=Ce.red);let d="<span class='left'>";d+=`<span style="padding:1px;margin:1px;background-color:${s};color:white;">${r}</span>`,d+=`<span style="padding:1px;margin:1px;background-color:${l};color:white;" title="Status: ${t.status.description}">${n[0]}</span>`,d+=`<span style="padding:1px;margin:1px;background-color:${Ce.gray};color:white;" title="Last Action: ${t.last_action.relative}">${e[1]}</span>`,d+=`<span style="padding:1px;margin:1px;background-color:${Ce.blue};color:white;" title="BattleStats: ${Rt(t.estimate_bs)}">${Rt(t.estimate_bs)}</span></span>`,c.prepend(d)}))})}}}if(mugoo&&0<=window.location.href.indexOf("bazaar.php")){let f={};const sa=Fe("#mainContainer").find("div:contains('unavailable')").last();if(0<sa.length){const ba=window.location.href.replace(/[^\d]/g,"");sa.text("蛙蛙探测器工作中...");const ca=`https://api.torn.com/user/${ba}?selections=basic,bazaar&key=${x}`;fetch(ca).then(t=>t.ok?t.json():void sa.text("---探测失败 "+fID+"---"),t=>{sa.text("---网络异常 "+fID+"---")}).then(a=>{if(sa.html(`蛙蛙探测成功^_^ [ <a class="t-blue" href="/profiles.php?XID=${a.player_id}">${a.name}</a>的小店 ]`),null==a.bazaar)sa.html(`货物卖光了:( [ <a class="t-blue" href="/profiles.php?XID=${a.player_id}">${a.name}</a>的小店 ]`),console.log("no item in bazaar");else{Fe(".content-wrapper").last().append('<div class="bazaar-wrapper" style="margin-top:10px;"><div class="bazaar-content" style="width:inherit; overflow:hidden; background-color:white;"></div></div>');for(let e=0;e<a.bazaar.length;e++){var n=((a.bazaar[e].price-a.bazaar[e].market_price)/a.bazaar[e].market_price*100).toFixed(2);let t="";t=0<n?`&nbsp;&nbsp;<span class="change up"><i class="arrow-change-icon" role="img" aria-label="stock price is up"></i><span class="t-green">${n}%</span></span>`:`&nbsp;&nbsp;<span class="change down"><i class="arrow-change-icon" role="img" aria-label="stock price is down"></i><span class="t-red">${n}%</span></span>`,Fe(".bazaar-content").append(`
                            <div class="item-wrapper" style="width:288px; float:left; overflow:hidden;">
                                <div style="width:100px; height:50px; margin:7px; padding:3px; float:left; border:1px solid darkgray;">
                                    <img src="/images/items/${a.bazaar[e].ID}/large.png">
                                </div>
                                <div class="item-description" style="width:150px; margin:7px; float:left; border:1px solid darkgray;overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                    <p class="item-name" style="margin:5px">${a.bazaar[e].name}</p>
                                    <p class="item-price" style="margin:5px">${jt(a.bazaar[e].price)}${t}</p>
                                    <p class="item-quantity" style="margin:5px">(${a.bazaar[e].quantity} in stock)
                                        <span class="t-blue">&nbsp;&nbsp;${Rt(a.bazaar[e].price*a.bazaar[e].quantity)}</span>
                                    </p>
                                </div>
                            </div>`)}}}).catch(t=>sa.text(t))}else{Tt();const Ye=setInterval(z,500)}function Tt(){var e=Kt("ITEMS","last-updated");if(null!=e&&null!=e){var a=new Date;let t=new Date(e);t.setDate(t.getDate()+1),t<a&&Pt()}else Pt()}function Pt(){var t=`https://api.torn.com/torn/?selections=items&key=${x}`;fetch(t).then(t=>t.json()).then(t=>{console.log("API fetched");let e={};const a=new Date;for(var n in e["last-updated"]=a.toString(),t.items)e[n]=t.items[n].market_value;window.localStorage.setItem("ITEMS",JSON.stringify(e))}).catch(t=>console.log("fetch error",t))}function z(){const g=Fe("[class*='messageContent___']");if("1"!=g.attr("hasdone")){g.attr("hasdone","1"),Fe("#sum").remove();let t='<div id="sum">',e=0;for(var a in f)t+=" (<span class='t-green'> "+f[a].name+" "+f[a].total_formal+" </span>) ",e+=f[a].total;t+="<span class='t-red'><b> Total Selected: "+Rt(e)+" </b></span></div>",g.append(t)}const t=Kt("ITEMS","last-updated"),e=Fe("[class^='rowItems___']").children();t&&e&&0<e.length&&e.each(function(t,e){const a=Fe(this).find("[class^='name___']").text(),n=Fe(this).find("[class^='price___']");let i=0;""!=n.text()&&(i=n.text().replace(/[^\d]/g,""));const o=Fe(this).find("img").attr("src");let r=0,s=0;null!=o&&(s=o.split("/")[3],0<s&&(r=Kt("ITEMS",s)));const l=Fe(this).find("[class^='amount___']");let d=0;if(""!=l.text()&&(d=l.text().replace(/[^\d]/g,"")),0<r&&0<i&&0<d&&"1"!=Fe(this).attr("hasdone")){Fe(this).attr("hasdone","1");const c=((i-r)/r*100).toFixed(1),p=Rt(i*d);l.append(`&nbsp;&nbsp;<span><span class="t-blue">${p}</span></span>`),0<=c?n.append(`&nbsp;&nbsp;<span class="change up"><i class="arrow-change-icon" role="img" aria-label="stock price is up"></i><span class="t-green">${c}%</span></span>`):n.append(`&nbsp;&nbsp;<span class="change down"><i class="arrow-change-icon" role="img" aria-label="stock price is down"></i><span class="t-red">${c}%</span></span>`);const h=Fe(this).find("[class^='description___']");null!=f[s]&&h.css("background-color","NavajoWhite"),h.click(function(){Fe(this).attr("selected")?(delete f[s],Fe(this).removeAttr("selected"),g.removeAttr("hasdone"),Fe(this).css("background-color","")):(f[s]={name:a,price:i,amount:d,total:i*d,total_formal:Rt(i*d)},Fe(this).attr("selected","selected"),g.removeAttr("hasdone"),Fe(this).css("background-color","NavajoWhite"))})}})}}if(mugoo&&0<=window.location.href.indexOf("imarket.php")){const Ye=setInterval(z,500);function z(){const i=Fe(".buy-item-info").find(".private-bazaar");0<i.length&&i.each(function(t,e){if("1"!=Fe(this).attr("hasdone")){Fe(this).attr("hasdone","1");const a=Fe(this).find('[href^="bazaar"]').attr("href").replace(/[^\d]/g,""),n=Fe(this);ne(a,function(t){n.attr("user_id",a),n.attr("user_name",t.name),n.attr("user_level",t.level),n.attr("user_bs",Rt(t.estimate_bs)),n.attr("user_last",t.last_action.relative),n.attr("user_stat",t.status.description),n.attr("user_job_type",t.job.company_type),n.attr("newbie",t.basicicons.icon72)})}});const t=Fe(".buy-item-info-wrap").find(".private-bazaar");0<t.length&&t.each(function(t,e){if("1"!=Fe(this).attr("hasdone")){const c=Fe(this).find('[href^="bazaar"]').attr("href").replace(/[^\d]/g,""),a=Fe(this).find(".user.faction").attr("href"),n=a?a.replace(/[^\d]/g,""):0;n in Ae&&Fe(this).css("background-color",Ce.green);const p=Fe(this);i.each(function(t,e){if(Fe(this).attr("user_id")==c){console.log(Fe(this).attr("user_name"));const a=Fe(this).attr("user_name"),n=Fe(this).attr("user_level"),i=Fe(this).attr("user_bs"),o=Fe(this).attr("user_last"),r=Fe(this).attr("user_stat"),s=Fe(this).attr("user_job_type"),l=Fe(this).attr("newbie");let t="打";5==s?t="衣":null!=l&&(t="新");const d=`
                                <li class="private-bazaar wawa-bazaar" hasdone="1">
                                    <ul class="item t-blue-cont h">
                                        <li class="item-name">
                                            <div class="item-t right t-gray-9">${r}</div>
                                            <div class="name-t icons left">
                                                <span class="t-gray-9">Lv:${n}</span>
                                            <a class="user name" href="/profiles.php?XID=${c} ">
                                                <span title="${a} [${c}]"><b>BS: ${i}</b><span></span></span>
                                            </a>
                                            </div>
                                            <div class="name-t name-mobile left">
                                                <span class="t-gray-9 italic">sold by</span>
                                                <a class="t-blue" href="profiles.php?XID=${c}">BS: ${i}</a>
                                            </div>
                                            <div class="clear"></div>
                                        </li>
                                        <li class="cost">
                                            <span class="t-gray-9" title="${r}">${o}</span>
                                        </li>
                                        <li class="view">
                                            <a href="/loader.php?sid=attack&user2ID=${c}"><b>${t}</b></a>
                                        </li>
                                        <li class="clear"></li>
                                    </ul>
                                </li>`;return p.after(d),p.attr("hasdone","1"),!1}})}})}}if(0<=window.location.href.indexOf("loader.php?sid=attack&user2ID")){const xa=window.location.href.match(/loader\.php\?sid=attack\&user2ID=(\d+)/)[1],Ye=setInterval(z,300);function z(){const t=Fe("[class^='btn___']");if(0<t.length){const e=t[0];if(Fe(e).text().includes("CONTINUE")){const a=Fe(e).parent().parent().children(":first").text().split(" ");clearInterval(Ye),console.log(a);const n=a[2],i=a[1],o=new Date,r=parseInt(o.getTime()/1e3),s=o.format("yyyy-MM-dd hh:mm:ss");if("mugged"==i){let t=a[5];console.log(t),"wallet"==t&&(t="$0");const l={timestring:s,victim_id:xa,victim_name:n,money_mugged:t};Yt("muglog",r,l)}}}}}if(0<=window.location.href.indexOf("companies.php")){Fe(".info-msg-cont").after("<div id='effectiveness-wrap' style='margin-top:10px; overflow-x: auto;'></div>"),Fe(".info-msg-cont").after('<div id="bingwa-top-warn" class="info-msg-cont red border-round m-top10">');const Ke=ge();console.log("userId "+Ke),$t(Ke).then(function(t){console.log(t);t=t[3];"Employee"==t?rt(Fe("#effectiveness-wrap")):"Director"==t&&st(Fe("#effectiveness-wrap"))}).catch(t=>console.log("userId2otherIds "+t));const ya=setInterval(Nt,1e3);function Nt(){const t=Fe(".employee-list-wrap").children("ul.employee-list").children("li");if(0<t.length){clearInterval(ya);let n={},i=0;t.each(function(t,e){var a=Fe(this).attr("data-user");n[a]=i,i+=1}),window.localStorage.setItem("EMPLOYEE_RANK",JSON.stringify(n))}}}else st(null);if(0<=window.location.href.indexOf("joblist.php")){const va=setInterval(Et,500);function Et(){const t=Fe("ul.rank-list");if(0<t.length&&"1"!=t.attr("hasdone")){t.attr("hasdone","1");t.after(`
                <div id="company_parade">
                    <div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">公司阅兵</div>
                    <div class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">
                        <button id="company_parade_start_btn" class="torn-btn" style="margin:5px;">开始阅兵</button>
                        <button id="company_parade_stop_btn" class="torn-btn" style="margin:5px;">暂停阅兵</button>
                        <span id="company_parade_tip" style="margin:5px;"></span>
                    </div>
                </div>`);let a=!0;Fe("#company_parade_start_btn").click(function(){a=!0,Fe("#company_parade_start_btn").prop("disabled",!0),Fe("#company_parade_stop_btn").removeAttr("disabled");const t=Fe("ul.company-list").children().first();t.length<=0?(Fe("#company_parade_tip").text("未找到公司列表"),Fe("#company_parade_start_btn").removeAttr("disabled"),Fe("#company_parade_stop_btn").prop("disabled",!0)):(Fe("#company_parade_tip").text("阅兵开始"),Fe("#company_parade_table").length<=0&&(Fe("#company_parade").after(`
                            <div id="company_parade_table">
                                <table style="margin:auto;background-color:white;font-size:12px;">
                                    <tr class="head">
                                        <th>星级</th>
                                        <th>名称</th>
                                        <th>老板</th>
                                        <th>天数</th>
                                        <th>员工数</th>
                                        <th title="24h未上线">不活跃</th>
                                        <th title="入职不到10天">新员工</th>
                                        <th>日收入</th>
                                        <th>日单价</th>
                                        <th>周收入</th>
                                        <th>周单价</th>
                                    </tr>
                                </table>
                            </div>`),Fe("#company_parade_table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;")),setTimeout(()=>{!function d(c){if("1"==c.attr("detected"))Fe("#company_parade_tip").text("公司已完成"),setTimeout(()=>{d(c.next())},0);else if(c.length<=0||0==a)Fe("#company_parade_tip").text("阅兵已结束"),Fe("#company_parade_start_btn").removeAttr("disabled"),Fe("#company_parade_stop_btn").prop("disabled",!0);else{c.attr("detected","1");const e=c.children().children("li.view").children().attr("href"),p=e?e.replace(/[^\d]/g,""):0,h=c.children().children("li.company").text();var t=`https://api.torn.com/company/${p}?selections=profile&key=${x}`;Fe("#company_parade_tip").text(`正在阅兵：${p} ${h}`),fetch(t).then(t=>t.json()).then(a=>{if("company"in a){var n=a.company.director,i=a.company.employees[n].name;let t=0,e=0;var o,r=parseInt((new Date).getTime()/1e3);for(o in a.company.employees){var s=a.company.employees[o].last_action.timestamp;86400<=r-s&&(t+=1);var l=a.company.employees[o].days_in_company;l<10&&(e+=1)}Fe("#company_parade_table").children().append(`
                                    <tr class="content">
                                        <td>${a.company.rating}</td>
                                        <td><a href="#!p=corpinfo&ID=${p}" target="_blank">${a.company.name}</a></td>
                                        <td><a class="user name" href="/profiles.php?XID=${n}" target="_blank">${i}</a></td>
                                        <td>${a.company.days_old}</td>
                                        <td>${a.company.employees_hired}/${a.company.employees_capacity}</td>
                                        <td>${t}</td>
                                        <td>${e}</td>
                                        <td>${Rt(a.company.daily_income)}</td>
                                        <td>${Rt(a.company.daily_income/a.company.daily_customers)}</td>
                                        <td>${Rt(a.company.weekly_income)}</td>
                                        <td>${Rt(a.company.weekly_income/a.company.weekly_customers)}</td>
                                    </tr>`),Fe("#company_parade_table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),setTimeout(()=>{d(c.next())},1e3)}else"error"in a&&Fe("#company_parade_tip").text(`蛙蛙探测失败：${p} ${h} ${a.error.error}`)}).catch(t=>console.log(t))}}(t)},1e3))}),Fe("#company_parade_stop_btn").click(function(){a=!1})}}}}const Me=Kt("extcenter","installedSpecs")||[];function zt(t){return 0<=t.toString().indexOf(",")?Number(t.replace(/,/g,"")):Number.isNaN(Number(t))?0:t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","})}function jt(t){return 0<=t.toString().indexOf("$")?Number(t.replace(/\$|,/g,"")):Number.isNaN(Number(t))?0:t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","}).replace(/^[^\$]\S+/,function(t){return"$"+t})}function Rt(t){return t<0?"-"+Rt(-t):0==t?"0":t<=1?(100*t).toFixed(2)+"%":t<1e3?""+parseInt(t):1e3<=t&&t<1e6?(t/1e3).toFixed(2)+"k":1e6<=t&&t<1e9?(t/1e6).toFixed(2)+"m":1e9<=t&&t<1e12?(t/1e9).toFixed(2)+"b":1e12<=t&&t<1e15?(t/1e12).toFixed(2)+"t":1e15<=t?"MAX":void 0}function Bt(t){return t<0?"-"+Bt(-t):0==t?"0":t<=1?parseFloat((100*t).toFixed(2))+"%":t<1e3?""+parseInt(t):1e3<=t&&t<1e6?parseFloat((t/1e3).toFixed(2))+"k":1e6<=t&&t<1e9?parseFloat((t/1e6).toFixed(2))+"m":1e9<=t&&t<1e12?parseFloat((t/1e9).toFixed(2))+"b":1e12<=t&&t<1e15?parseFloat((t/1e12).toFixed(2))+"t":1e15<=t?"MAX":"error"}function Wt(t){return(t/86400).toFixed(2),1}function Lt(t){return"[object Array]"===Object.prototype.toString.call(t)?t:"[object Object]"===Object.prototype.toString.call(t)?Object.values(t):null}function Gt(t){return"[object Array]"===Object.prototype.toString.call(t)&&(!(t.length<=1)&&("[object Object]"===Object.prototype.toString.call(t[0])&&0<Object.keys(t[0]).length))}function qt(t){var e=Lt(t);if(null==e||e.length<=0)return null;if(Gt(e))return e;for(let t=0;t<e.length;++t){var a=qt(e[t]);if(null!=a)return console.log(`在第 ${t} 个节点发现有效数据集`),a}return null}function Ht(t,e){var a=t[e];if("object"==typeof a){for(var n in a){var i=a[n];"object"==typeof i?Xt(a,n):t[n+"_"+e]=i}delete t[e]}}function Xt(t){for(var e in t)Ht(t,e)}function Jt(e){var t=e[0];Xt(t);let a=Object.keys(t);console.log(`item_keys: ${a}`);for(let t=1;t<e.length;++t){var n=e[t];Xt(n);var i=Object.keys(n);for(let t=0;t<i.length;t++){var o=i[t];console.log(`add item_key: ${o}`),-1==a.indexOf(o)&&a.push(o)}}let r=a.sort().join(",");for(let t=0;t<e.length;++t){r+="\n";var s=e[t];Xt(s);for(let e=0;e<a.length;++e){let t=s[a[e]]+"";"object"==typeof t&&(t=JSON.stringify(t)),t='"'+t.replace(/<[^>]+>/g,"").trim().replace(/\"/g,'""')+'"',0<e&&(r+=","),r+=t}}return encodeURIComponent(r)}function Ut(t){if(void 0!==window.localStorage)return null===window.localStorage.getItem(t)?null:JSON.parse(window.localStorage.getItem(t))}function Kt(t,e){t=Ut(t);if(void 0!==t)return null===t?null:void 0!==t[e]?t[e]:void 0}function Vt(t,e){void 0===window.localStorage||window.localStorage.setItem(t,JSON.stringify(e))}function Yt(e,a,n){if(void 0!==window.localStorage)if(null===window.localStorage.getItem(e)){let t={};t[a]=n,window.localStorage.setItem(e,JSON.stringify(t))}else{let t=JSON.parse(window.localStorage.getItem(e));t[a]=n,window.localStorage.setItem(e,JSON.stringify(t))}}function Zt(t,e){if(void 0!==window.localStorage&&null!==window.localStorage.getItem(t)){const a=JSON.parse(window.localStorage.getItem(t));void 0===a[e]||(delete a[e],window.localStorage.setItem(t,JSON.stringify(a)))}}function Qt(t){void 0===window.localStorage||null===window.localStorage.getItem(t)||window.localStorage.removeItem(t)}function te(i,o){i.click(function(){const t=Fe(this).siblings();t.each(function(){var t=Fe(this).text().replace(/[↑↓]/,"");Fe(this).text(t)});var e=Fe(this).text().replace(/[↑↓]/,"");let a="",n="";n="TH"==i[0].tagName?(a=i.parent().siblings(),i.parent().parent()):(a=i.parent().next().children(),i.parent().next()),"descend"==Fe(this).attr("sort")?(a.sort(function(t,e){const a=o(t);e=o(e);return isNaN(a)?a.localeCompare(e):a-e}),a.detach().appendTo(n),Fe(this).attr("sort","ascend").text(e+"↑")):(a.sort(function(t,e){t=o(t);const a=o(e);return isNaN(t)?a.localeCompare(t):a-t}),a.detach().appendTo(n),Fe(this).attr("sort","descend").text(e+"↓"))})}function ee(t,e,a,n,i){return`
        <div style="position:relative; top:0; width:100%; height:${t-4}px; color:${a}; background-color:${n}; padding:2px 0px; text-align:center;">${i}</div>
        <div style="position:relative; top:-${t}px; width:100%; left:${e-100}%; height:${t-4}px; padding:2px 0px; z-index:2; overflow:hidden;">
            <div style="position:absolute; top:0; width:100%; left:${100-e}%; height:${t-4}px; color:${n}; background-color:${a}; padding:2px 0px; text-align:center;">${i}</div>
        </div>`}function ae(t,e){return Fe(t).on("input keydown keyup mousedown mouseup select contextmenu drop focusout",function(t){e(this.value)?this.oldValue=this.value:this.hasOwnProperty("oldValue")?this.value=this.oldValue:this.value=""})}function ne(t,mt,e){let a=`https://api.torn.com/user/${t}?selections=profile,crimes,personalstats,bazaar&key=${x}`;console.log(`Request: ${a}`),fetch(a).then(t=>t.ok?t.json():void e("蛙蛙探测失败，请刷新重试"),t=>{e("蛙蛙探测失败，网络异常，请刷新重试")}).then(h=>{if(console.log(`Response: ${a}`),console.log(h),null!=h)if(h.hasOwnProperty("error"))e(`蛙蛙探测失败：${JSON.stringify(h,null,4)}`);else{var g=h.personalstats,f=g.defendslost||0,m=g.defendsstalemated||0,u=g.defendswon||0,b=g.attackswon||0,x=g.attacksdraw||0,y=g.attackslost||0,v=g.cantaken||0,w=g.exttaken||0,_=g.kettaken||0,k=g.lsdtaken||0,$=g.opitaken||0,I=g.pcptaken||0,F=g.shrtaken||0,D=g.spetaken||0,S=g.victaken||0,A=g.xantaken||0,O=h.age||1,C=g.trainsreceived||0,M=w+k+A,T=((h.xan_lsd_ecs=M)/O).toFixed(2);h.average_drugs=T;var P=g.refills||0,N=g.statenhancersused||0,E=g.useractivity||0,z=g.traveltime||0,j=(g.logins,g.dumpsearches||0),R=g.energydrinkused||0,B=g.boostersused||0,M=g.revives||0,T=b+x+y,x=g.daysbeendonator||0,y=Math.min(O,parseInt((new Date-new Date("2011/11/22"))/864e5));const tt=Math.min(x/y,1);h.donator_percent=tt.toFixed(2);const et=480+240*tt;const at=611255/et;console.log(`统计DP时间 ${x}d，最多 ${y}d，DP比例：${Rt(tt)}，一天完整能量：${et.toFixed(2)}，实现CAP需要活跃：${at.toFixed(2)}天`);y=h.last_action.timestamp||0;let t=parseInt((new Date).getTime()/1e3)-y,e="";86400<t&&(e+=parseInt(t/86400)+"天",t%=86400),3600<t&&(e+=parseInt(t/3600)+"时",t%=3600),60<t&&(e+=parseInt(t/60)+"分",t%=60),e+=t+"秒",h.last_action_details=e;const nt=h.last_action.relative;h.last_action_brief=nt.replace(" minute ago","m").replace(" minutes ago","m").replace(" hours ago","h").replace(" hour ago","h").replace(" days ago","d").replace(" day ago","d");let a=0;nt.includes("d")&&(a=parseInt(nt.replace(/[^0-9|-]/gi,"")));const it=Math.max(1,21*(O-a)/24);console.log(`年龄${O}天，上次登录${a}天前，最大活跃天数${it.toFixed(2)}`);const ot=E/86400,rt=z/86400,st=3*ot+rt;console.log(`ched_active_days: 3*${ot.toFixed(2)}(activity) + ${rt.toFixed(2)}(travel) = ${st.toFixed(2)}`);const lt=(75*v+210*w+52.5*_+425*k+215*$+430*I+209.5*F+301*D+300*S+420*A)/1440;console.log(`drug_active_days: ${lt.toFixed(2)}`);v=h.criminalrecord.other||0,w=h.criminalrecord.selling_illegal_products||0,_=h.criminalrecord.theft||0,$=h.criminalrecord.drug_deals||0,I=h.criminalrecord.computer_crimes||0,F=h.criminalrecord.murder||0,D=h.criminalrecord.fraud_crimes||0,S=h.criminalrecord.auto_theft||0;let n=.11*_+.5*I+.66*F+D+.66*S+.05*$;n<0&&(n=0),h.estimate_ace=parseInt(n),12862<n?h.estimate_nnb=60:9171<n?h.estimate_nnb=55:5950<n?h.estimate_nnb=50:4324<n?h.estimate_nnb=45:2750<n?h.estimate_nnb=40:1198<n?h.estimate_nnb=35:450<n?h.estimate_nnb=30:250<n?h.estimate_nnb=25:100<n?h.estimate_nnb=20:50<n?h.estimate_nnb=15:h.estimate_nnb=10;let i=5*(2*v+3*w+5*_+8*$/.8+9*I/.75+10*F/.75+11*D/.95+12*S/.7)/1440;i<at&&(W=Math.min(at/i,3),console.log(`新手 crime_active_days 补偿系数：${W}`),i*=W),console.log(`crime_active_days: ${i.toFixed(2)}`);var W=Math.min(it,Math.max(st,lt,i)).toFixed(2);console.log(`估算活跃天数: ${W}`),h.estimate_active_days=W;O=parseInt(75*C+30*W+70*O);console.log(`估算WS: ${O}`),h.estimate_ws=O;const dt=parseInt(et*W);console.log(`估算的自然恢复能量: ${dt}`);W=parseInt(150*P),P=250*A+50*k,R=20*R,B=150*B;const ct=W+P+R+B;console.log(`物品能量：${W}(refill) + ${P}(drug) + ${R}(can) + ${B}(FHC) = ${ct}`);B=25*T,M=25*M,j=5*j;const pt=B+M+j;console.log(`消耗能量：${B}(attack) + ${M}(revive) + ${j}(dump) = ${pt}`);let o=dt+ct-pt;o<0&&(o=0),console.log(`总锻炼能量：${dt}(自然) + ${ct}(物品) - ${pt}(消耗) = ${o}`),h.total_energy=o.toFixed(0),h.nature_energy=dt.toFixed(0),h.item_energy=ct.toFixed(0),h.expend_energy=pt.toFixed(0);let r=40;var L=[2,2.8,3.2,3.2,3.6,3.8,3.7,4,4.8,4.8,5.2,5.2,5.4,5.8,5.8,6,6.4,6.6,6.8,7,7,7,7,7.3],G=[200,500,1e3,2e3,2750,3e3,3500,4e3,6e3,7e3,8e3,11e3,12420,18e3,18100,24140,31260,36610,46640,56520,67775,84535,106305,Number.MAX_SAFE_INTEGER];let s=0,l=o,d=G[0];for(;0<l&&r<2e8;){var q=Math.min(G[s],l,d,1e3),H=L[s];const ht=1.122*1.02*H*q*((348e-9*Math.log(4750)+31e-7)*r/4+.32433-.0301431777);r+=ht,l-=q,d-=q,l<=0?console.log(`能量已用光，最近这次在系数为 ${H} 的健身房锻炼了 ${q} 能量，属性 +${ht.toFixed(2)} 变为 ${r.toFixed(2)}`):2e8<=r?console.log(`已达到CAP，最近这次在系数为 ${H} 的健身房锻炼了 ${q} 能量，属性 +${ht.toFixed(2)} 变为 ${r.toFixed(2)}，剩余 ${l} 能量`):s<L.length-1&&d<=0&&(console.log(`要换健身房了，最近这次在系数为 ${H} 的健身房锻炼了 ${q} 能量，属性 +${ht.toFixed(2)} 变为 ${r.toFixed(2)}，剩余 ${l} 能量`),++s,d=G[s])}if(0<l)if(console.log(`实现CAP消耗的能量：${o-l}`),A<k&&A<=100){const gt=3240*l;r+=gt,console.log(`LSD青年，剩余能量还能再 +${gt.toFixed(2)} 属性，变为 ${r.toFixed(2)}`)}else{const ft=2510*l;r+=ft,console.log(`普通青年，剩余能量还能再 +${ft.toFixed(2)} 属性，变为 ${r.toFixed(2)}`)}else console.log("未达CAP");0<N&&(r=.5*r+.5*r*(1+.9*(Math.pow(1.01,.5*N)-1)),console.log(`再用上 +${N} 个SE，属性变为 ${r.toFixed(2)}`)),r=parseInt(r);let c=Rt(r);console.log(`估算bs为：${c}`);var X,J=[2,6,11,26,31,50,71,100],U=[100,5e3,1e4,2e4,3e4,5e4],K=[5e6,5e7,5e8,5e9,5e10],k=[2e3,2e4,2e5,2e6,2e7,2e8],A=[2500,25e3,25e4,25e5,35e6,25e7],V={"Absolute beginner":1,Beginner:2,Inexperienced:3,Rookie:4,Novice:5,"Below average":6,Average:7,Reasonable:8,"Above average":9,Competent:10,"Highly competent":11,Veteran:12,Distinguished:13,"Highly distinguished":14,Professional:15,Star:16,Master:17,Outstanding:18,Celebrity:19,Supreme:20,Idolised:21,Champion:22,Heroic:23,Legendary:24,Elite:25,Invincible:26};let p=0;for(X in V)if(0==h.rank.indexOf(X)){p=V[X],h.rank_value=p,h.rank_name=X;break}N=h.rank.split(" ");if(h.rank_title=N[N.length-1],console.log(`Rank: value = #${p}, name = ${h.rank_name}, title = ${h.rank_title}, full = ${h.rank}`),0<p&&r<Number.MAX_SAFE_INTEGER){--p;var Y=h.level||0;for(let t=0;t<J.length;++t)Y>=J[t]&&--p;console.log(`Rank 减掉 level trigger 还剩下 ${p}`);var Z=h.criminalrecord.total||0;for(let t=0;t<U.length;++t)Z>=U[t]&&--p;console.log(`Rank 减掉 crimes trigger 还剩下 ${p}`);var Q=g.networth||0;for(let t=0;t<K.length;++t)Q>=K[t]&&--p;console.log(`Rank 减掉 networth trigger 还剩下 ${p}`);let t=0,e=Number.MAX_SAFE_INTEGER;p<=0?e=A[0]:p>=k.length?t=k[k.length-1]:(t=k[p-1],e=A[p]),console.log(`根据Rank推算bs区间：[${t}, ${e})`),r<t?(c=`${c} ~ ${Rt(t)}`,console.log(`估算总bs小于按Rank推算的下限值：${Rt(t)}`)):r>e?(c=`${Rt(e)} ~ ${c}`,console.log(`估算总bs高于按Rank推算的上限值：${Rt(e)}`)):console.log("估算总bs符合按Rank推算的区间")}h.estimate_bs=r,h.estimate_bs_display=c,h.attackWinRatio=b/T,h.defendWinRatio=(u+m)/(u+m+f),mt(h)}})}function ie(t,e,a){let n=`extcenter_${t}`;return!window[n]&&((i==De.PDA?PDA_evaluateJavascript:eval)(a),window[n]=!0,!0)}Me.forEach(t=>{try{var e;t.match&&!window.location.href.match(new RegExp(t.match))?console.log(`${t.name} - ${t.version} 不在指定页面`):(e=Kt("extcenter-source",t.name),ie(t.name,t.version,e)?console.log(`${t.name} - ${t.version} 加载成功`):console.log(`${t.name} - ${t.version} 已经加载`))}catch(t){console.log(t)}});async function oe(t){switch(console.log(`[cors] get ${t}`),i){case De.GM:return new Promise((e,a)=>{GM_xmlhttpRequest({method:"get",url:t,ontimeout:t=>a(`timeout: ${t}`),onload:t=>e(t.response),onerror:t=>a(`error: ${t}`)})});case De.PDA:return new Promise((e,a)=>{PDA_httpGet(`${t}`).then(t=>{e(t.responseText)}).catch(t=>{a(`error: ${t}`)})});case De.OTHER:default:return new Promise((t,e)=>{e("error：当前不支持Cors操作")})}}async function re(t,e,a,n){let i=`https://api.torn.com/user/?selections=log&key=${x}`;0<t.length&&(i+=`&cat=${t.join(",")}`),0<e.length&&(i+=`&log=${e.join(",")}`),a&&(i+=`&from=${a}`),n&&(i+=`&to=${n}`);const o=await fetch(i);if(!o.ok)throw new Error(o.statusText);n=await o.json();if("error"in n)throw new Error(n.error.error);return null===n.log?[]:Object.values(n.log).sort((t,e)=>e.timestamp-t.timestamp)}async function*se(t,e,a,n,i){for(n=n||Math.floor((new Date).getTime()/1e3);;){i&&i(n);var o=await re(t,e,a,n);if(0===o.length)break;var r=o[o.length-1].timestamp;if(o[0].timestamp==r){for(const s of o)yield s;break}for(const l of o){if(l.timestamp<=r)break;yield l}n=r+1,await new Promise(t=>setTimeout(t,1e3))}}async function le(t,e,a,n,i){const o=[];for await(const r of se(t,e,a,n,i))o.push(r);return o}function de(t){Fe("#api_result_container").val(Fe("#api_result_container").val()+"\n"+t)}function ce(t){var e=t.split("-")[0].trim();const a=t.split("-")[1].replace("TCT","").trim();var n="20"+a.split("/")[2].trim(),i=a.split("/")[1].trim(),t=a.split("/")[0].trim();const o=new Date(n+"/"+i+"/"+t+" "+e);return o.setHours(o.getHours()-(new Date).getTimezoneOffset()/60),parseInt(o.getTime()/1e3)}function pe(n){const i=Kt("CHAT_LAST_MESSAGE",n);if(i){let t="";t=0<=i.indexOf("|||")?i.split("|||")[0]:i;n=ce(t),n=parseInt((new Date).getTime()/1e3)-n;let e="",a="";return n<3600?(e=parseInt(n/60)+"m",a="#5d9525"):3600<=n&&n<86400?(e=parseInt(n/3600)+"h",a="#DAA520"):86400<=n&&n<3024e3?(e=parseInt(n/86400)+"d",a="#c0542f"):3024e3<=n&&(e=parseInt(n/86400)+"d",a="#777"),[a,e]}}function he(t){var e=window.localStorage.getItem("muglog");if(e){var e=JSON.parse(e),n=Object.entries(e);for(let a=n.length-1;0<=a;a--)if(n[a][1].victim_id==t){var i=n[a][0],o="$"+Rt(jt(n[a][1].money_mugged)),i=parseInt((new Date).getTime()/1e3)-i;let t="",e="";return i<3600?(t=parseInt(i/60)+"m ago",e="#5d9525"):3600<=i&&i<86400?(t=parseInt(i/3600)+"h ago",e="#DAA520"):86400<=i&&(t=parseInt(i/86400)+"d ago",e="#c0542f"),e+","+t+","+o}}}function ge(){return Fe("script[uid]").attr("uid")}function fe(){function n(){var t=`https://api.torn.com/torn/?selections=companies&key=${x}`;fetch(t).then(t=>t.json()).then(e=>{const a=new Date;if("companies"in e){let t={};for(var n in t["last-updated"]=a.toString(),t.companies={},e.companies)t.companies[n]={name:e.companies[n].name,positions:e.companies[n].positions};window.localStorage.setItem("APICache_companies",JSON.stringify(t))}else"error"in e&&Yt("APICache_companies","last-updated",a.toString())}).catch(t=>console.log("fetch error",t))}!function(){var e=Kt("APICache_companies","last-updated");if(null!=e&&null!=e){var a=new Date;let t=new Date(e);t.setDate(t.getDate()+1),t<a&&n()}else n()}()}function me(){const r={186:"绵羊",187:"泰迪熊",215:"猫咪",258:"美洲豹",261:"貂熊",266:"尼斯湖水怪",268:"赤狐",269:"猴子",273:"岩羚羊",274:"大熊猫",281:"狮子",384:"骆驼",618:"黄貂鱼",260:"大丽花",263:"番红花",264:"兰花",267:"帚石楠",271:"木棉花",272:"雪绒花",276:"牡丹花",277:"樱花",282:"非洲堇",385:"蒺藜花",617:"香蕉兰",256:"催泪弹",226:"烟雾弹",222:"闪光弹",616:"鳟鱼"},t=Fe(".travel-agency-market ul.users-list li");const s=[260,263,264,267,271,272,276,277,282,385,617].concat([186,187,215,258,261,266,268,269,273,274,281,384,618]).concat([206,616,222,226,256]);if(0<t.length&&"filtered"!=t.attr("filtered")){let o=parseInt(Fe("div.delimiter div.msg:contains(You have purchased) span.bold").last().text());var e=parseInt(Fe(Fe("div.delimiter div.msg:contains(You have purchased) span.bold").get(-2)).text());o-=e,(isNaN(o)||o<=0)&&(o=1),t.each((t,e)=>{var a=parseInt(Fe(e).find("div.details").attr("itemid"));if(isNaN(a)||!(0<a))return!1;if(s.indexOf(a)<0)Fe(e).addClass("hide");else{const n=Fe(e).find("input#item-"+a)[0];if(n.value=o,n.dispatchEvent(new Event("blur")),r[a]){a=r[a];const i=Fe(e).find("span.name");i.html(i.html()+"<span style='float:right;padding-right:10px;'>"+a+"</span>")}}}),t.attr("filtered","filtered")}Fe("#show_more").length<1&&(Fe(".travel-agency-market").after("<div><div id='show_more' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;background-color:#c0542f;text-align:center;'>点击显示全部</div></div>"),Fe("#show_more").click(function(){Fe(this).parent().remove(),t.removeClass("hide")}))}function ue(){const n={"中文Wiki":"<a href='https://torn.huijiwiki.com/' target='_blank'>",YATA:"<a href='https://yata.yt/' target='_blank'>",NGA:"<a href='https://nga.178.com/thread.php?stid=30081562' target='_blank'>","赛车":"<a href='/loader.php?sid=racing'>","啤酒":"<a href='/shops.php?step=bitsnbobs'>","飞行":"<a href='/travelagency.php'>","库存":"<a href='https://yata.yt/bazaar/abroad/' target='_blank'>","市场":"<a href='/imarket.php'>","点市":"<a href='/pmarket.php'>","股市":"<a href='/page.php?sid=stocks'>","巴扎":"<a href='/bazaar.php'>"};setInterval(function(){const t=Fe("ul.menu-items");if("1"!=t.attr("hasdone")){if(0<t.siblings().length)for(var e in n)t.append('<li class="menu-item-link">'+n[e]+e+"</a></li>");else for(var a in t.attr("style","width:295px; margin-top:6px; line-height:16px;"),t.children(":last").remove(),t.children(":last").remove(),t.children(":last").remove(),n)t.append('<li class="menu-item-link">'+n[a]+a+"</a></li>");t.attr("hasdone","1")}},1e3)}function be(){chatTimestamp&&setInterval(function(){const t=new Date,r=parseInt(t.getTime()/1e3),e=Fe("[class*='chat-active_']").children("[class*='chat-box-content_']").children("[class*='viewport_']").children().children("[class*='message_']");e.each(function(t,e){const a=Fe(this).attr("name");var n=a.split("-")[0],n=r-n;let i="",o="";n<3600?(i=parseInt(n/60)+"m",o="#5d9525"):3600<=n&&n<86400?(i=parseInt(n/3600)+"h",o="#DAA520"):86400<=n&&(i=parseInt(n/86400)+"d",o="#c0542f"),Fe(this).children(".fac-ts").remove(),Fe(this).prepend('<span class="fac-ts border-round" style="margin:0px 2px; padding:1px 4px; color:white; background-color:'+o+'">'+i+"</span>")})},1e3);setInterval(function(){const t=Fe("[class*='chat-last-message-label_']");t.each(function(t,e){const a=Fe(this).parent().parent().parent().parent().attr("class");if(0<=a.indexOf("_offline_")||0<=a.indexOf("_online_")||0<=a.indexOf("_away_")){var n=Fe(this).parent().parent().parent().siblings("[class*='chat-box-head_']").children().attr("title"),i=Fe(this).children("span").text();const o=function t(e,a,n){return 0<a?(n+="["+e.children("[class!='fac-ts border-round']").text()+"]",t(e.prev(),a-1,n)):n}(Fe(this).prev(),5,"");Yt("CHAT_LAST_MESSAGE",n,i+"|||"+o.substring(0,125))}})},5e3)}function xe(){setInterval(function(){const t=Fe("[class*='chat-active_']").children("[class*='chat-box-content_']").children("[class*='viewport_']").children().children("[class*='message_'][fac-wdcheck!='true']");t.each(function(t,e){Fe(this).attr("fac-wdcheck","true");const a=Fe(this).text().match(/取.*?([\.0-9]+)([k|m|b]?)/i);if(a){var n=a[1],i=a[2].toLowerCase();let t=1;"k"==i?t=1e3:"m"==i?t=1e6:"b"==i&&(t=1e9);const o=zt(parseInt(parseFloat(n)*t)),r=Fe(this).children("a").text(),s=Fe(this).children("a").attr("href");n=s.substr(s.indexOf("XID=")+4);const l=`${r.substr(0,r.length-2)} [${n}]`;Fe(this).append(`<span class="fac-wd border-round" style="background-color:${Ce.green}; color: white; cursor: pointer; float: right; padding: 0 3px 0 3px">取钱</span>`),Fe(this).children("span[class*='fac-wd']").click(function(){console.log(`${l} ${o}`);const t=window.location.href;t.indexOf("#/tab=controls")<0||0<=t.indexOf("option")&&t.indexOf("give-to-user")<0?(window.location.href=`https://www.torn.com/factions.php?step=your#/tab=controls&option=give-to-user&wdname=${encodeURI(l)}&wdmoney=${encodeURI(o)}`,0<=t.indexOf("factions.php")&&setTimeout(()=>{location.reload()},500)):ye(l,o)})}})},1e3)}function ye(t,e){const a=Fe(".money-wrap").children(".give-block");Fe("input#money-user").val(t).addClass("chosen"),a.children(".inputs-wrap").children(".input-money-group").addClass("success").children("input").attr("value",e),a.children(".inputs-wrap").children(".btn-wrap").children().children().attr("disabled",!1).removeClass("disabled")}function ve(){setInterval(function(){if(0<Fe("#profile-mini-root").children().children("[class^=profile-mini-_userImageWrapper]").length&&!Fe("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").attr("hasdone")){Fe("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").attr("hasdone","1");const t=Fe("#profile-mini-root").children().children("[class^=profile-mini-_userImageWrapper]").children("a"),e=t?t.attr("href"):void 0,a=e?e.substr(20):void 0;a&&ne(a,function(t){Yt("battlestats",a,t.estimate_bs),Fe("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").append(`
                        <div id="bingwa-estimate-bs" style="width:165px; height:16px; position: absolute; left: 1px; top: 2px; z-index: 1; color: white ;background-color: ${Ce.blue}; border: 2px solid darkgray; padding-top: 3px; margin: 5px; text-align: center;">
                            <span>估算战力: ${t.estimate_bs_display}</span>
                        </div>
                    `);let e=parseInt(100*t.life.current/t.life.maximum);t="血量: "+t.life.current+"/"+t.life.maximum+" ("+e+"%)";e<=66?Fe("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").append(`
                        <div id="hp-bar" style="width:165px; height:16px; overflow:hidden; position: absolute; left: 1px; top: 28px; z-index: 1; color: white ;background-color: #eee; border: 2px solid darkgray; padding: 0px; margin: 5px; text-align: center;">
                            ${ee(16,e,"#c0542f","#eee",t)}
                        </div>
                        `):(100<e&&(e=100),Fe("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").append(`
                        <div id="hp-bar" style="width:165px; height:16px; overflow:hidden; position: absolute; left: 1px; top: 28px; z-index: 1; color: white ;background-color: #eee; border: 2px solid darkgray; padding: 0px; margin: 5px; text-align: center;">
                            ${ee(16,e,"#5d9525","#eee",t)}
                        </div>
                        `))})}},500)}function we(){const r={20465:["Leader","Co-leader","WEIYUAN","CHANGWEI"],36134:["Leader","Co-leader","Paladin","Minister"],16335:["Leader","Co-leader","Karajan","Haydn","Chopin","Schubert"],9356:["Leader","Co-leader","Lion","Tiger","Wolf"],10741:["Leader","Co-leader","General","Marshal"]};setInterval(function(){const t=Fe("[class*='type-list_']");if(0<t.length){const e=t.children("li:eq(3)").attr("class");if(0<=e.indexOf("active")){const a=Fe("[class*='people-list_']");"1"!=a.attr("hasDone")&&(a.attr("hasDone","1"),function(i){var t=`https://api.torn.com/faction/?selections=basic&key=${x}`;fetch(t).then(t=>t.json()).then(t=>{if("members"in t){let o=[];for(const n in t.members){var e=t.members[n].position,a=t.members[n].status.state;0<=r[t.ID].indexOf(e)&&"Okay"==a&&o.push(n)}i.each(function(t,e){const a=Fe(this).attr("class"),n=Fe(this).children("a").attr("href");var i=n?n.substring(18):0;0<=o.indexOf(i)&&0<=a.indexOf("online")&&(Fe(this).children("a").append("<span style='color:white'><b> 可取钱 在城内</b></span>"),Fe(this).css("background-color","Darkseagreen"))})}else"error"in t&&console.log(t.error.error)}).catch(t=>console.log("fetch error",t))}(a.children("li")))}}},3e3)}function _e(){0<Fe("#plane").length&&(Fe("#clouds-1").remove(),Fe("#clouds-2").remove(),Fe("#clouds-3").remove(),Fe("#plane").children().remove())}function ke(){0<Fe(".computer-wrap").length&&(Fe(".computer-navigation").insertBefore(".computer-wrap"),Fe("#computer-content-wrapper").insertBefore(".computer-wrap"),Fe(".computer-wrap").css("visibility","hidden"),Fe(".computer-navigation").attr("style","position: unset; margin-bottom: 10px;"),Fe("#computer-content-wrapper").removeClass("left"),Fe("#computer-content-wrapper").css("margin","auto"))}function $e(t){0<Fe("#icon15-sidebar").length&&Fe("#nurse").length<1&&(Fe(t).before(`
            <div style="margin-bottom:5px;">
                <div id='nurse' style='color:#333;width:inherit;margin:auto;padding:10px;border:5px solid gray;background-color:#ccc;text-align:center;'>
                    <div id='nurse-eff' style='font-size:12px;padding:2px;'></div>
                    <div id='nurse-cd' style='font-size:24px;padding:2px;'>小护士竭诚为你服务</div>    
                    <div id='nurse-item' style='font-size:12px;padding:2px;'></div>
                    <div id='nurse-suggestion' style='font-size:24px;padding:2px;'></div>
                    <div id='nurse-item-life' style='font-size:12px;padding:2px;'></div>
                    <div id='nurse-suggestion-life' style='font-size:24px;padding:2px;'></div>
                </div>
            </div>`),t=`https://api.torn.com/user/?selections=profile,cooldowns,perks&key=${x}`,fetch(t).then(t=>t.ok?t.json():void Fe("#nurse-cd").text("--- 小护士探测失败 ---"),t=>{Fe("#nurse-cd").text("--- 小护士网络异常 ---")}).then(f=>{if(null!=f)if("error"in f)Fe("#nurse-cd").text(`--- API错误 --- code: ${f.error.code} error: ${f.error.error}`);else if("basicicons"in f&&"icon15"in f.basicicons){function m(t){let e=parseInt(t/3600);e=e<10?"0"+e:e;let a=parseInt(t/60)%60;a=a<10?"0"+a:a;let n=t%60;return n=n<10?"0"+n:n,e+":"+a+":"+n}var u=f.states.hospital_timestamp,b=u?u-parseInt((new Date).getTime()/1e3):0,x=m(b),y=parseInt(b/60),v=100-(f.life.current||0)/(f.life.maximum||7500)*100,w=m(f.cooldowns.medical||0);let a=!1,t=0,e=0,n=0;if("education_perks"in f){const A=f.education_perks;0<=A.indexOf("+ Withdraw and deliver blood")&&(a=!0),0<=A.indexOf("+ 20% Medical item effectiveness")&&(t=20),0<=A.indexOf("+ 10% Medical item effectiveness")&&(t=10)}if("faction_perks"in f){const O=f.faction_perks;O.forEach(function(t){0<=t.indexOf("medical item effectiveness")&&(e=t.replace("+ Gain","").replace("% medical item effectiveness","").trim()),0<=t.indexOf("minutes of maximum medical cooldown")&&(n=t.replace("+ Adds","").replace("minutes of maximum medical cooldown","").trim())})}let i=6+parseInt(n/60);i=i<10?"0"+i:i;let o=n%60;o=o<10?"0"+o:o;var _=i+":"+o+":00";const S=parseInt(t)+parseInt(e)+100;console.log(S);let r=0,s=0,l=0,d=0;console.log(y);var k=function t(e){return a&&e>.7*S?(r+=1,t(e-1.2*S)):e>.4*S?(s+=1,t(e-.7*S)):e>.2*S?(l+=1,t(e-.4*S)):0<e?(d+=1,t(e-.2*S)):e}(y);console.log(k);var $=0==r?"":"大血包*"+r,I=0==s?"":"吗啡*"+s,F=0==l?"":"小蓝包*"+l,D=0==d?"":"小红包*"+d,u=30*r+20*s+15*l+10*d;let c=0,p=0,h=0,g=0;b=function t(e){return a&&e>.15*S?(c+=1,t(e-.3*S)):e>.1*S?(p+=1,t(e-.15*S)):e>.05*S?(h+=1,t(e-.1*S)):0<e?(g+=1,t(e-.05*S)):e}(v);console.log(b);f=0==c?"":"大血包*"+c,y=0==p?"":"吗啡*"+p,k=0==h?"":"小蓝包*"+h,v=0==g?"":"小红包*"+g,b=30*c+20*p+15*h+10*g;Fe("#nurse-cd").text(`住院时间 ${x} 医疗冷却 ${w}/${_}`),Fe("#nurse-eff").text(`抽血: ${a} 教育加成: +${t}% 帮派加成: +${e}%`),Fe("#nurse-item").text(`大血包: -${parseInt(1.2*S)}分钟 吗啡: -${parseInt(.7*S)}分钟 小蓝包: -${parseInt(.4*S)}分钟 小红包: -${parseInt(.2*S)}分钟`),Fe("#nurse-suggestion").text(`【出院模式】 ${$} ${I} ${F} ${D} (冷却 +${u}分钟)`),Fe("#nurse-item-life").text(`大血包: 回血+${parseInt(.3*S)}% 吗啡: 回血+${parseInt(.15*S)}% 小蓝包: 回血+${parseInt(.1*S)}% 小红包: 回血+${parseInt(.05*S)}%`),Fe("#nurse-suggestion-life").text(`【满血模式】 ${f} ${y} ${k} ${v} (冷却 +${b}分钟)`)}}).catch(t=>Fe("#nurse-cd").text(t)))}function Ie(){var e,a={"3.0.5":{date:"2022.07.01",notes:["新功能: 监狱bust - 完全重做并新增估算bust成功率 by toby","新功能: gym页面 - 界面微调并新增检测何时可吃SE by htys"]},"3.0.4":{date:"2022.06.23",notes:["新功能: 冰蛙目标 - 加入过滤功能 by htys","修改: 冰蛙目标 - 当cdn不可用时增加了错误提示 by htys","修改: 从友方帮派中移除LND by htys"]},"3.0.3":{date:"2022.06.10",notes:["新功能: 聊天记录(代替抢劫历史) by htys","新功能: 帮派详情 - 新增显示能否被复活(需要阅兵) by htys","修改: 犯罪经验 - 修正犯罪惩罚公式 by toby","修改: 犯罪经验 - 删除犯罪经验的保存数据按钮 by toby","修改: 插件中心添加对PDA 2.8.0的支持 by mirror","修改: 聊天时间戳外观微调 by htys","修复: 修复最后唠嗑时间不显示的问题 by microdust"]},"3.0.2":{date:"2022.05.13",notes:["新功能: 插件中心 by mirror","新功能: 查询bust惩罚 by toby","修改: 犯罪经验 - 日志页面增加导出按钮 by toby","修改: 犯罪经验 - 增加犯罪经验数据收集说明 by toby","修改: 冰蛙目标支持导入csv格式文件 by microdust","修复: gym页面加成数字不显示的问题 by htys","修复: home页面perks显示错位的问题 by htys","修复: market search页面有时会不显示bazaar的问题 by htys"]},"3.0.1":{date:"2022.04.29",notes:["修改: 公司效率估算公式 by microdust","修改: 聊天框取钱跳转优化 by mirror","修改: 放宽对 NNB 升降级事件的时间要求 by toby","修复: 阅兵 by mirror","修复: 替换空值合并运算符 by toby"]},"3.0.0":{date:"2022.04.07",notes:["新功能: 犯罪经验 by toby"]},"2.9.9":{date:"2022.04.05",notes:["新功能: 灵活配置快捷取钱按钮 by mirror","新功能: 聊天栏添加取钱按钮 by mirror","修改: 公司数据拉取时机 by mirror","修复: 修复在高级搜索界面时，打开honerbar的时候上次唠嗑不显示的问题 by mirror"]},"2.9.8":{date:"2022.03.31",notes:["修改: 冰蛙目标页面 - 添加bs提示","修改: 友好帮派增加pta新帮","修复: 唠嗑时间在转换时区时有多余空格的bug"]},"2.9.7":{date:"2022.02.27",notes:["新功能: attack页面 - 显示chain进度，防止bonus打偏","修改: 公司页面 - 新增效率估算","修改: 冰蛙目标页面 - 若出院时间小于10分钟，则根据出院时间逐渐降低背景色透明度","修改: 搜索页面 - 若与目标超过35天未有聊天行为，则最近唠嗑显示为灰色","修复: 无法阅兵的bug"]},"2.9.6":{date:"2022.02.22",notes:["新功能: profile页面和mini profile页面显示血条"]},"2.9.5":{date:"2022.02.15",notes:["新功能: 冰蛙目标，自动刷新的目标监视利器","新功能: 帮派详情增加level和id显示","修复: 小护士调整小数保留位数"]},"2.9.4":{date:"2022.01.24",notes:["修复: 部分顶部链接","修复: miniBS显示位置","修复: PTA取钱功能","修复: 帮派页面显示阅兵、BS、离线时间和住院时间，取消排序功能"]},"2.9.3":{date:"2022.01.08",notes:["新功能：近期RW显示服务器近期RW的记录"]},"2.9.2":{date:"2022.01.04",notes:["新功能：帮派取钱现在在更加明显的位置提示余额，并且新增加了全取按钮","新功能：侧边栏现在有冰蛙图标了","修复：修复了飞行时读取不到自己id导致的公司页面无法显示问题","修复：帮派详情页面增加了显示内容（帮派图标和rank等级）"]},"2.9.1":{date:"2021.12.30",notes:["修复：修正了某些API的匹配格式，使得小护士可以正常运行","修复：更新了profile页面的攻击链接，现在玩家在医院可以读取完整的战斗页面了","修复：为一部分表格增加横向拖动条，使其在超出手机屏幕宽度时也可以显示完整内容（感谢Woohoo）","修复：微调了profile页面BS显示相关内容"]},"2.9.0":{date:"2021.12.28",notes:["新功能：小护士现在可以分别按照【出院模式】和【满血模式】提供建议","新功能：profile页面新增估算WS","新功能：针对公司老板新增显示公司货物库存","修复：修复了mini profile上估算bs重复显示的问题","修复：修复了小护士有时获取不到住院时间的问题","修复：修复了帮派余额和准备金率显示错误的问题","修复：profile连续活跃天数重新修改为冰蛙活跃天数","修复：修改了某些配色以解决深色模式下看不清的问题","修复：现在飞行无云功能不再显示飞机图片了","修复：针对非东8区用户修改了唠嗑时间显示不正确的问题","修复：更新了key->info和rankedwarreport等API条目"]},"2.8.9":{date:"2021.12.09",notes:["新功能：自己帮派的Ranked War界面会显示敌人bs(需提前对该帮派阅兵)，并且可以按bs排序","修复：小护士读取不到API时的报错","修复：faction和company重绘读取不到API时的报错"]},"2.8.8":{date:"2021.11.24",notes:["修复：使用API重绘faction和company页面时匹配不同url","修复：一个神奇的bug"]},"2.8.7":{date:"2021.11.23",notes:["新功能：在个人profile页面显示上次聊天时间和上次mug时间金额","新功能：在高级搜索页面显示上次聊天时间"]},"2.8.6":{date:"2021.11.19",notes:["新功能：mini profile显示冰蛙估算战力","新功能：帮派仓库增加快捷取钱按钮","修改：使用帮派药品出院时也可以获得小护士建议了"]},"2.8.5":{date:"2021.11.08",notes:["新功能：战斗页面增加显示目标在线状态","修改：冰蛙APIKey读取页面UI","修改：阅兵可以按bazaar金额筛选目标，增加bazaar链接","修改：在飞行入院或入狱时也可以在company.php页面查看效率表格了"]},"2.8.4":{date:"2021.11.01",notes:["新功能：战斗页面增加量化显示stealth隐身概率","新功能：item页面增加小护士智能出院建议","新功能：在自己帮派的战斗中，会显示墙上敌人的bs(需提前对该帮派阅兵)","修复PDA会重复载入冰蛙的bug(感谢Woohoo-)"]},"2.8.3.1":{date:"2021.10.25",notes:["公司管理中增加显示本周销售额（实时数据）和近一周利润（缓存数据）","公司管理表格改为显示到公司页面的下方"]},"2.8.3":{date:"2021.10.23",notes:["起飞页面增加吃药cd和oc提醒功能","bounty页面增加自动阅兵功能，默认关闭需在设置中手动开启","个人页面的冰蛙检测增加显示活跃天数，删除ECS数量","在个人页面enemy数量右侧增加显示坏比指数","points市场目标提示现在可以显示新人和衣服店了"]},"2.8.2":{date:"2021.10.08",notes:["启用更精确的计算监狱分数公式并且显示分数提高到25000","修复阅兵bug"]},"2.8.1":{date:"2021.09.30",notes:["取消大乱斗功能","取消oc提醒功能"]},"2.8.0":{date:"2021.09.11",notes:["新增大乱斗阅兵","优化了大乱斗界面"]},"2.7.9":{date:"2021.09.09",notes:["新增了API条目","更新了顶部快捷链接","阅兵可以显示大乱斗所在队伍","在海外也可以查看大乱斗"]},"2.7.8":{date:"2021.08.18",notes:["阅兵可以显示目标bazaar内全部物品价值总和"]},"2.7.7":{date:"2021.06.20",notes:["公司排行页面可以进行公司阅兵了","增加新的快捷打劫链接","不再显示已售空的额外的bazaar","buymug时加入自己人防误伤提醒","OC即将开始时进入飞行界面将获得更加明显的提示","隐藏laptop边框","飞行时不显示云和飞机"]},"2.7.6":{date:"2021.05.29",notes:["不是老板也能查看我的公司表格了","新增帮派取钱助手"]},"2.7.5.2":{date:"2021.05.29",notes:["聊天框时间戳不显示秒","Jail界面增加显示更多按钮","海外库存界面增加显示更多按钮"]},"2.7.5.1":{date:"2021.05.27",notes:["修复聊天框时间戳"]},"2.7.5":{date:"2021.04.12",notes:["顶部链接、健身房、赛车界面UI微调"]},"2.7.4":{date:"2021.04.01",notes:["飞行时查看的公司页面增加TV和油厂的单价估算"]},"2.7.3":{date:"2021.03.30",notes:["我的公司页面UI微调"]},"2.7.2":{date:"2021.03.23",notes:["添加顶部链接和健身房的开关","在股票交易市场页面显示股票缩写"]},"2.7.1":{date:"2021.03.10",notes:["我的公司页面新增显示各员工工资和当前公司实时数据，修复保存31天显示32天的bug","飞行中的帮派信息页区分显示正在被突击和主动突击别人"]},"2.7.0":{date:"2021.02.14",notes:["修改imarket search页面，增加显示目标bazaar内全部物品价值总和","新增功能复活助手"]},"2.6.9":{date:"2021.02.11",notes:["帮派对比功能重做以显示更多数据","加入更多设置选项","index页面加入一键显示全部perks"]},"2.6.8":{date:"2021.02.02",notes:["新增世界局势功能，显示所有正在进行的地盘战，按战况激烈程度染色"]},"2.6.7":{date:"2021.01.24",notes:["在飞行/医院/监狱中也可以查看自己/他人Bazaar中物品"]},"2.6.6.3":{date:"2021.01.22",notes:["解决gym页面与torntools兼容问题"]},"2.6.6.2":{date:"2021.01.19",notes:["修改一些可能存在的bug","Gym页面提供Hank和Baldr属性比例参考","监视列表可以自由添加玩家ID，被监视的目标在海外被高亮（橙色）显示"]},"2.6.6.1":{date:"2021.01.19",notes:["查看个人profile页面的Last action显示为x天x时x分x秒"]},"2.6.6":{date:"2021.01.14",notes:["我的公司及飞行中看帮派、公司功能汉化。","飞行中看帮派信息增加chain、地盘战、raid战的信息。","产量数据支持多种库存的公司。"]},"2.6.5.1":{date:"2021.01.13",notes:["对使用过【我的公司】功能的，每天进游戏时自动检查抓取昨晚的公司运营数据。"]},"2.6.5":{date:"2021.01.11",notes:["公司效率表格微调：增加inactivy，调整列顺序","新增公司历史数据表格","飞行时也能看帮派和公司页面"]},"2.6.4.1":{date:"2021.01.05",notes:["优化公司效率表格显示，并且海外可查看"]},"2.6.4":{date:"2021.01.04",notes:["公司页面显示效率表格","聊天框显示时间戳"]},"2.6.3":{date:"2020.12.28",notes:["顶部增加简易导航条，从api.torn.com更新了API条目","优化阅兵功能，增加暂停和继续按钮","优化帮派对比功能，增加历史记录和高亮显示leader","增加抢劫历史功能，可以从历史记录中选择目标加入监视列表"]},"2.6.2":{date:"2020.11.11",notes:["修复顶部链接导致页面排版错乱的问题","payday功能只向leader和coleader提供"]},"2.6.1":{date:"2020.10.22",notes:["美化排版：pmarket、imarket(search)、imarket页面在显示bs时不再影响原始布局","市场显示超过3个bazaar：imarket(search)页面显示bazaar数量不再局限于3个","bazaar页面简易计算器：可以通过点击选中物品，页面顶部显示选中物品的总价值"]},"2.6.0":{date:"2020.09.28",notes:["itemmarket/pointmarket/bazaar界面增加3个mug相关脚本（感谢Mirror），使用mugoo=true开启","revivehelper重命名为facPageEnhanced，显示内容优化，使用foo=true开启","阅兵模块优化，增加阅兵内容选项，所有阅兵相关功能都使用foo=true开启","监狱置顶标记友帮成员，无视分数","海外people界面用颜色标记友帮和敌帮成员"]},"2.5.9":{date:"2020.09.16",notes:["修复飞花增强功能失效的bug"]},"2.5.8":{date:"2020.11.11",notes:["回滚上版本第一条，因为networth会变化，持续7天才触发rank","蛙蛙探测显示更多页面里的锻炼总能量换成Booster数量"]},"2.5.7":{date:"2020.08.14",notes:["当rank反推的bs上限低于估算值时，忽略估算值，使用rank反推的上下限区间","修复蛙蛙探测显示更多页面排版问题","帮派页面Revive增强功能默认关闭，需要时请将代码头部 reviveHelper 设为 true 手动开启"]},"2.5.6":{date:"2020.08.01",notes:["飞行中也可以方便的查看帮派成员状态，以及支持包括自己帮在内的最多3个帮派横向对比"]},"2.5.5.1":{date:"2020.07.30",notes:["修复一些取款小bug，给自己取款时，输入.或者?(英文标点)可自动替换为本人名字，减少输入时间"]},"2.5.5":{date:"2020.07.30",notes:["屏蔽全取按钮，选择取款目标时显示目标额度"]},"2.5.4":{date:"2020.07.27",notes:["增加帮派成员界面一系列功能：阅兵，显示bs、上次登录时间、旅行状态和住院时间，高亮标记住院成员，排序等"]},"2.5.3":{date:"2020.07.07",notes:["增加防打重功能，开关noAssisting = true"]},"2.5.2":{date:"2020.06.17",notes:["修复顶部链接导致页面排版错乱的问题"]},"2.5.1":{date:"2020.06.15",notes:["修复阅兵转换为csv有时丢失某些列的问题"]},"2.5.0":{date:"2020.06.05",notes:["搜索及海外用户列表阅兵功能优化：过滤5b以下，显示mugged, rehabcost, rank, job"]},"2.4.9":{date:"2020.06.05",notes:["飞行中也可以方便的查看帮派成员状态，以及支持包括自己帮在内的最多3个帮派横向对比"]},"2.4.8":{date:"2020.06.04",notes:["jailview 按 jailscore 排序，并优化体验","更新看库存的链接","用户搜索页面增加阅兵功能"]},"2.4.7":{date:"2020.04.26",notes:["左上角菜单中新增常用链接：市场","jailview页面增强：显示各目标的 分钟数*级别；过滤大于1万的；bust不需要二次确认（类似DN的quick bust功能）"]},"2.4.6":{date:"2020.04.26",notes:["左上角菜单中新增常用链接：赛车/啤酒/飞行/库存"]}};let n="",i=0,o="";for(e in a){o+=a[e].date+" --v"+e+"\n";for(let t=0;t<a[e].notes.length;t++)o+="    "+a[e].notes[t]+"\n";o+="\n";let t=e.split(".");t.splice(1,0,"."),t.join(""),parseFloat(t)>i&&(i=t,n=e)}return[n,o]}}}();
