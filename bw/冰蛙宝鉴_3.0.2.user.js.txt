// ==UserScript==
// @name         冰蛙宝鉴
// @namespace    SMTH
// @version      3.0.2
// @description  随时随地通过API接口看你想看！
// @author       bingri[1523812] kaeru[1769499] htys[1545351] mirrorhye[2564936] tobytorn[1617955] Microdust[2587304]
// @match        https://www.torn.com/*.php*
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @connect      *
// @require      https://cdn.staticfile.org/xlsx/0.17.5/xlsx.min.js
// ==/UserScript==


!function(){"use strict";const __win_bingwa=window.unsafeWindow||window;if(!__win_bingwa.BINGWA){__win_bingwa.BINGWA=!0;try{window=__win_bingwa}catch(err){console.error(err)}const $=window.jQuery,UserScriptEngineEnums=Object.freeze({GM:"gm",PDA:"pda",OTHER:"other"});let userScriptEngine=UserScriptEngineEnums.OTHER;try{GM_xmlhttpRequest,userScriptEngine=UserScriptEngineEnums.GM}catch{try{PDA_httpGet,userScriptEngine=UserScriptEngineEnums.PDA}catch{}}const settings=[{name:"foo",title:"阅兵助手",desc:"在部分页面显示阅兵按钮，可以快速获取玩家信息",default:!1},{name:"noAssisting",title:"防打重",desc:"如果已有其他人进入战斗则屏蔽JOIN按钮",default:!1},{name:"mugoo",title:"山贼助手",desc:"在市场列表界面显示用户状态和攻击链接",default:!0},{name:"chatTimestamp",title:"聊天时间戳",desc:"聊天频道显示每条内容已发送时间",default:!0},{name:"chatQuickWithdraw",title:"聊天快捷取钱",desc:"聊天频道内显示快捷取钱按钮",default:!1},{name:"travelFilter",title:"飞花过滤",desc:"在海外市场页面屏蔽不重要物品",default:!0},{name:"jailView",title:"监狱助手",desc:"在监狱页面屏蔽分数大于10000的目标，本帮人员置顶高亮显示",default:!0},{name:"stockexchange_show_abbr",title:"股票助手",desc:"在股票交易市场页面的股票名称前显示缩写",default:!0},{name:"gym_show_ratio",title:"健身房助手",desc:"在健身房页面显示推荐的属性比例",default:!0},{name:"common_modify_header_links",title:"顶部快捷入口",desc:"在页面顶部添加一些常用页面的链接",default:!0},{name:"hide_cloud_while_flying",title:"飞行无云",desc:"在飞行界面隐藏飞机和云彩",default:!0},{name:"withdrawal_helper",title:"取钱助手",desc:"右下角聊天people框高亮显示帮派可取钱名单",default:!0},{name:"bigger_screen_on_laptop",title:"laptop大屏",desc:"飞行中使用笔记本电脑时可以全屏显示",default:!0},{name:"taking_off_reminder",title:"起飞吃药提醒",desc:"起飞前根据CD提醒吃药和OC",default:!0},{name:"bounty_parade",title:"悬赏阅兵",desc:"报纸-悬赏页面显示目标BS",default:!1},{name:"nurse_suggestion",title:"护士建议",desc:"智能提醒出院吃药",default:!0}];settings.forEach(t=>{var e=getLocalStorage("BWM_SETTINGS",t.name);null==e&&updateLocalStorage("BWM_SETTINGS",t.name,String(t.default)),window[t.name]="true"==getLocalStorage("BWM_SETTINGS",t.name)});let APIKey=localStorage.getItem("APIKey");const friendly_faction={20465:"SMTH",36134:"Silver Hand",10741:"Trisolary",16335:"November Chopin",7074:"Legends Never Die",16424:"HoYoverse",9356:"Party Animals"},enemy_faction={8836:"Vinerri",2095:"Guerrilla Warfare",11356:"-UGK-",31312:"TORNado",8255:"Scream Silence",26312:"The Avengers",28205:"Invictus",10913:"Unbroken Warriors",8510:"Ara Pacis",5113:"ThugLife",13343:"The Defiant",39756:"Abusement Park",38761:"Shadow Healers",42125:"Octogenarian DirtyBombers",35739:"Kingsmen",14820:"Unbroken Legion",10140:"In Memory of the Fallen",9405:"Lake Of Lerna",30085:"Rampage Total Destruction"},bingwa_color_pool={gray:"#adadad",red:"#ff7373",green:"#8fbc8f",blue:"#65a5d1",purple:"#8d6dd7",yellow:"#f39826",yellowgreen:"#83a000",pink:"#e467b3",salmon:"#F9CDAD",orange:"#FFDEAD"};if(Date.prototype.format=function(t){var e,a={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(e in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),a)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[e]:("00"+a[e]).substr((""+a[e]).length)));return t},APICache(),travelFilter&&filterTravelItems(),common_modify_header_links&&headerLinks(),chatTimestamp&&factionChatEnhanced(),chatQuickWithdraw){chatQuickWithdrawEnhance();const href=window.location.href;if(0<=href.indexOf("wdname")&&0<=href.indexOf("wdmoney")){let username=decodeURI(href.split("wdname=")[1].split("&")[0]),money=decodeURI(href.split("wdmoney=")[1]),observer_controls=new MutationObserver(function(t,e){0<$(".money-wrap").children(".give-block").length&&(withdraw_giveMoney(username,money),e.disconnect())});observer_controls.observe(document.getElementById("faction-controls"),{childList:!0,subtree:!0})}}if(miniProfileBattleStats(),withdrawal_helper&&withdrawalHelper(),hide_cloud_while_flying&&cloudFilter(),bigger_screen_on_laptop&&laptopScreen(),0<=window.location.href.indexOf("loader.php?sid=racing")&&setInterval(function(){$(".bar-tpl-wrap:not([show-value])").each(function(t,e){let a=0,n=0,o=0;o=$(e).hasClass("negative")?(a=parseFloat($(e).find(".progress-light-gray")[0].style.width),n=parseFloat($(e).find(".progress-red")[0].style.width),a=parseFloat(a*n/100),a-n):$(e).hasClass("positive")?(n=parseFloat($(e).find(".progress-light-gray")[0].style.width),a=parseFloat($(e).find(".progress-light-green")[0].style.width),n=parseFloat(a*n/100),a-n):(n=parseFloat($(e).find(".progress-")[0].style.width),0),$(e).css("line-height","17px").css("margin-top","0px").css("width","88px").html("<span style='color: gray'>"+n.toFixed(2)+"</span>"+(0<=o?" + ":" - ")+Math.abs(o).toFixed(2)),$(e).css("color",0<=o?"green":"red"),$(e).attr("show-value","show-value")})},500),0<=window.location.href.indexOf("shops.php?step=bitsnbobs")&&$(".buy-flexslider").find(":input").val("100"),0<=window.location.href.indexOf("factions.php?step=your")){function addDepositorItem(t,e,a){var n=formatMoney(a);let o=bingwa_color_pool.yellowgreen;a<0&&(o=bingwa_color_pool.red),console.log("addDepositorItem"+e),$("ul.money-depositors").prepend(`
            <li class='depositor' id='${t}'>
                <div class='clearfix'>
                    <div class='icons'></div>
                    <span class='factionWrap'></span>
                    <div class='user name'>
                        <div class="border-round" style="height:18px; padding:2px 10px; color:white; background-color:${o};"">${e}</div>
                    </div>
                    <div class='amount'>
                        <div class="border-round" style="height:18px; padding:2px 10px; color:white; background-color:${o};"">${n}</div>
                    </div>
                </div>
            </li>`)}function getMyNameId(){var t=JSON.parse($("#websocketConnectionData").text());return t.playername+" ["+t.userID+"]"}function showBalance(t,e){const a=$("ul.money-depositors").children("li.depositor").find("span[title='"+e+"']").parent().siblings("div.amount").children().children().attr("data-value");let n="$"+a;0!=a&&(n=a.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","}).replace(/^[^\$]\S+/,function(t){return"$"+t})),n.includes("-")?t.text("").append(`<span>${e}</span><span class ='t-red right'>${n}</span>`):t.text("").append(`<span>${e}</span><span class ='right'>${n}</span>`)}function addBalanceAfterName(){const t=$("div#money-user-cont").find("li.ui-custom-item");!$("input#money-user")||"."!=$("input#money-user").val()&&" "!=$("input#money-user").val()||($("input#money-user").val(getMyNameId()).addClass("chosen"),console.log(getMyNameId()),showBalance(t.children(),getMyNameId())),0<t.length&&!t.children().text().includes("$")&&!t.hasClass("empty")&&t.each(function(){var t=$(this).children().text();showBalance($(this).children(),t)})}function addWithdrawalButton(){const a=$(".money-wrap").children(".give-block"),o="give-money",i="array";function r(){$(".button-wrap").remove(),t()}function t(){const n=getLocalStorage(o,i);var t=function(){let a=`<div class="button-wrap" style="margin:2px;">
                    <span id="deposit-self" class="border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${bingwa_color_pool.purple};">给自己</span>`;return n.forEach((t,e)=>{a+=(t=t,`<span id="deposit${e}" class="deposit-money-btn border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${bingwa_color_pool.blue};">${t.button_name}</span>`)}),a+=`<span id="deposit-add" class="border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${bingwa_color_pool.green};">+</span>
                    <span id="deposit-all" class="border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${bingwa_color_pool.blue};">全取</span>
                    <span id="deposit-remove" class="border-round" style="display:inline-block; cursor:pointer; margin:2px; padding:3px; color:white; background-color:${bingwa_color_pool.red};">x</span>
                    </div>`,a}();a.children(".info").after(t),a.children(".select-wrap").css("padding-top","1px"),$("#deposit-add").click(()=>{0<$("#deposit-input").length||($("#deposit-add").html('<span style="display: inline-block;"><input id="deposit-input" type="text" class="border-round"></input>'),$("#deposit-input").tornInputMoney({groupMoneyClass:null}),$("#deposit-input").focus(),$("#deposit-input").blur(()=>{var t=$("#deposit-input").val();let e=n;e.push({button_name:`取${formatNumber2(formatMoney("$"+t))}`,"button-value":t}),updateLocalStorage(o,i,e),r()}))}),$("#deposit-remove").click(()=>{$("#deposit-remove").hasClass("deposit-removing")?($(".deposit-money-btn").css("background-color",bingwa_color_pool.blue),$(".deposit-money-btn").removeClass("deposit-removing"),$("#deposit-remove").css("background-color",bingwa_color_pool.red),$("#deposit-remove").removeClass("deposit-removing")):($(".deposit-money-btn").css("background-color",bingwa_color_pool.red),$(".deposit-money-btn").addClass("deposit-removing"),$("#deposit-remove").css("background-color",bingwa_color_pool.salmon),$("#deposit-remove").addClass("deposit-removing"))}),$("#deposit-self").click(()=>{$("input#money-user").val(getMyNameId()).addClass("chosen")}),n.forEach((t,e)=>{$(`#deposit${e}`).click(()=>{if($(`#deposit${e}`).hasClass("deposit-removing")){let t=n;return t.splice(e,1),updateLocalStorage(o,i,t),void r()}a.children(".inputs-wrap").children(".input-money-group").addClass("success").children("input").attr("value",t["button-value"]),a.children(".inputs-wrap").children(".btn-wrap").children().children().attr("disabled",!1).removeClass("disabled")})}),$("#deposit-all").click(()=>{var t;0<=a.children(".select-wrap").children(".result").text().indexOf("]")&&(t=a.children(".select-wrap").children(".result").children(".right").text().replace("$",""),console.log(t),a.children(".inputs-wrap").children(".input-money-group").addClass("success").children("input").attr("value",t),a.children(".inputs-wrap").children(".btn-wrap").children().children().attr("disabled",!1).removeClass("disabled"))})}getLocalStorage(o,i)||updateLocalStorage(o,i,[{button_name:"取1m","button-value":"1,000,000"},{button_name:"取5m","button-value":"5,000,000"},{button_name:"取10m","button-value":"10,000,000"},{button_name:"取25m","button-value":"25,000,000"}]),$(".button-wrap").length<1&&t()}function addFactionBalance(){$("div.input-money-group").attr("class","input-money-group no-max-value");const t=$("ul.money-depositors").children("li.depositor");if(0<$("div.give-block").length&&$("#faction_balance_li").length<=0&&0<t.length){var e=toThousands($(".money-wrap").children(".balance-message").children(".sum-of-deposit").text()),o=toThousands($(".money-wrap").children(".balance-message").children(".faction-balance").text());let a=0,n=0;t.each((t,e)=>{e=parseInt($(e).find("span.money").attr("data-value"));0<e?a+=e:n+=e});var i=parseInt(o)+parseInt(e),r=Math.max(Math.abs(e),Math.abs(o),Math.abs(a),Math.abs(n),Math.abs(i));$("#money").children(".balance-message").after(`
                <div id="faction_balance_li" 
                style="width:290px; border:4px solid gray; 
                padding:5px 2px; margin:0px 0px 5px 5px; 
                background-color:#fff; background-image: linear-gradient(rgba(209,73,78,0.2),rgba(209,73,78,0.1));">
            </div>`),appendBar("帮派余额",i,r),appendBar("所有存款总和",e,r),appendBar("帮派公共资金",o,r),appendBar("正存款总和",a,r),appendBar("负存款总和",n,r),appendBar("准备金率",parseFloat(i/a),r)}}function appendBar(e,a,n){let o=formatMoney(a);if(0<=a){var i="#5d9525";let t=100*a/n;"准备金率"==e&&(t=Math.min(100*a,100),o=(100*a).toFixed(2)+"%"),$("#faction_balance_li").append(`
                <div style="overflow:hidden; margin:7px; border:1px solid gray;">
                    <div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${percentHtml(22,0,i,"#eee",e)}</div>
                    <div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${percentHtml(22,t,i,"#eee",o)}</div>
                </div>`)}else{i="#c0542f",n=100*a/n+100;$("#faction_balance_li").append(`
                <div style="overflow:hidden; margin:7px; border:1px solid gray;">
                    <div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${percentHtml(22,n,"#eee",i,e)}</div>
                    <div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${percentHtml(22,0,i,"#eee",o)}</div>
                </div>`)}}let observer_controls=new MutationObserver(function(t,e){console.log("changed"),addBalanceAfterName(),addWithdrawalButton(),addFactionBalance()});observer_controls.observe(document.getElementById("faction-controls"),{childList:!0,subtree:!0});const moneyuserInterval=setInterval(updateMoneyuser,500);function updateMoneyuser(){if(0<$("#money-user").length){const t=$("#money-user").parent().parent().siblings(".select-wrap").children(".result");0<=$("#money-user").val().indexOf("]")&&($("#money-user").val()!=t.attr("userid")||0==t.text().length)&&(t.attr("userid",$("#money-user").val()),t.css("display","block"),showBalance(t,$("#money-user").val()))}}}if(jailView&&0<=window.location.href.indexOf("jailview.php")){const intervalJail=setInterval(updateJailUI,1e3),intervalBustDebuff=setInterval(updateBustDebuff,1e3);let hide=!0;function getFactionID(t){const e=t.find("a.faction").attr("href");return e?e.substring(30):0}function getJailLevel(t){t=t.find("span.level").text().match(/\d+/g);return t?parseInt(t[0]):0}function getJailTime(t){t=t.find("span.time").text().match(/\d+/g),t=t||[0];return t[1]?60*parseInt(t[0])+parseInt(t[1]):parseInt(t[0])}function getSortScore(t){return $(t).find("b.bustscore").attr("sortscore")}function updateJailUI(){const t=$("ul.user-info-list-wrap").children("li");0<t.length&&(t.each(function(t,e){if("1"!=$(this).attr("hasDone")){var a=(getJailTime($(this))+180)*getJailLevel($(this)),n=getFactionID($(this))in friendly_faction?1:a;$(this).find("span.reason").append(`&nbsp;&nbsp;<b class="bustscore t-red" sortscore=${n}>${a}</b>`);const o=$(this).children("a.bust").attr("href");null!=o&&o.indexOf("breakout1")<0&&$(this).children("a.bust").attr("href",o+"1"),$(this).removeClass("gray"),1==n?$(this).css("background-color","#5d9525"):2e4<n&&hide&&$(this).addClass("hide"),$(this).attr("hasDone","1")}}),t.sort(function(t,e){return getSortScore(t)-getSortScore(e)}),t.detach().appendTo("ul.user-info-list-wrap")),$("#show_more").length<1&&hide&&($(".userlist-wrapper").after("<div><div id='show_more' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;color:#ccc;background-color:#c0542f;text-align:center;'>点击显示全部</div></div>"),$("#show_more").click(function(){hide=!1,$(this).parent().remove(),$("ul.user-info-list-wrap").children("li").removeClass("hide")}))}function updateBustDebuff(){const t=$(".info-msg .msg");0!==t.length&&(clearInterval(intervalBustDebuff),t.html(`<button id="bust-debuff-btn" class="torn-btn">查询 Bust 惩罚</button>
                    <span id="bust-debuff" style="margin: 10px"></span>`),$("#bust-debuff-btn").click(async function(){$(this).prop("disabled",!0),$("#bust-debuff").text("查询中");try{var e=Math.floor((new Date).getTime()/1e3),a=await fetchLog([],[5360]);let t=0;for(const o of a){if(o.timestamp<e-259200)break;t+=Math.pow(2,(o.timestamp-e)/36e3)}var n=t<1?"t-green":t<4?"t-yellow":"t-red";$("#bust-debuff").html(`
                            <span class="${n}"><b>${t.toFixed(2)}</b></span>
                            <span title="每次成功 bust 都会降低接下来的 bust 成功率，这个副作用会随时间缓慢衰减，每 10 小时减少一半。左边这个数字表示<b>过去所有 bust 对现在的累计副作用</b>。这个数字越大，则现在 bust 能力越低。它与 bust 实际成功率的关系尚不明确，请凭经验谨慎作案。">(这是什么意思?)</span>
                        `),$("#bust-debuff").tooltip({tooltipClass:"white-tooltip"})}catch(t){console.trace(t),"Access level of this key is not high enough"===t.message?$("#bust-debuff").html('权限不足！<a href="/preferences.php#tab=api">请使用 Full Access 类型的 API Key</a>'):$("#bust-debuff").text(`出错啦！${t}`)}finally{$(this).prop("disabled",!1)}}))}}if(gym_show_ratio&&0<=window.location.href.indexOf("gym.php")){const ratio_dict={0:{name:"balanced",description:"平衡比例",str:100,def:100,spd:100,dex:100},1:{name:"hank-str",description:"Hank比例-Str最高",str:100,def:80,spd:28,dex:80},2:{name:"hank-def",description:"Hank比例-Def最高",str:80,def:100,spd:80,dex:28},3:{name:"hank-spd",description:"Hank比例-Spd最高",str:28,def:80,spd:100,dex:80},4:{name:"hank-dex",description:"Hank比例-Dex最高",str:80,def:28,spd:80,dex:100},5:{name:"baldr-str",description:"Baldr比例-Str最高",str:100,def:72,spd:80,dex:72},6:{name:"baldr-def",description:"Baldr比例-Def最高",str:72,def:100,spd:72,dex:80},7:{name:"baldr-spd",description:"Baldr比例-Spd最高",str:80,def:72,spd:100,dex:72},8:{name:"baldr-dex",description:"Baldr比例-Dex最高",str:72,def:80,spd:72,dex:100}};function setGymGoal(t,e,a,n){const o=$("[class^='gymContent___']").children("[class^='properties___']").children("li");var i=$("#strength-val").text().split(",").join(""),r=$("#defense-val").text().split(",").join(""),s=$("#speed-val").text().split(",").join(""),l=$("#dexterity-val").text().split(",").join(""),d=Math.max(i/t,r/e,s/a,l/n),t=Math.abs(d*t-i)<=1?i:parseInt(d*t),e=Math.abs(d*e-r)<=1?r:parseInt(d*e),a=Math.abs(d*a-s)<=1?s:parseInt(d*a),n=Math.abs(d*n-l)<=1?l:parseInt(d*n);const c=[t,e,a,n],p=[t-i,e-r,a-s,n-l];let g=0;$(".gym-goal").remove(),o.each(function(){const t=$(this).children("[class^='propertyContent___']").children("[class^=description___]").children("p:first");0==t.children(".gym-perks").length?t.html(`<span class="t-red gym-goal" title="目标:${toThousands(c[g])}">还差:${formatNumber(p[g])} </span>`):t.prepend(`<span class="t-red gym-goal" title="目标:${toThousands(c[g])}">还差:${formatNumber(p[g])} </span>`),g++})}function getGymPerks(){var t=`https://api.torn.com/user/?selections=perks&key=${APIKey}`;fetch(t).then(t=>t.json()).then(t=>{console.log("perks API fetched");let a=[{total:0},{total:0},{total:0},{total:0}];if(1<Object.keys(t).length)for(var e in t){const d=t[e];var n,o,i,r=e.split("_")[0];for(let t=0;t<d.length;t++)0<=d[t].search(/strength gym gains/i)?(n=parseInt(/\d+%/.exec(d[t])[0].replace("%","")),a[0][r]=a[0].hasOwnProperty(r)?a[0][r]+n:n,a[0].total+=n):0<=d[t].search(/defense gym gains/i)?(o=parseInt(/\d+%/.exec(d[t])[0].replace("%","")),a[1][r]=a[1].hasOwnProperty(r)?a[1][r]+o:o,a[1].total+=o):0<=d[t].search(/speed gym gains/i)?(o=parseInt(/\d+%/.exec(d[t])[0].replace("%","")),a[2][r]=a[2].hasOwnProperty(r)?a[2][r]+o:o,a[2].total+=o):0<=d[t].search(/dexterity gym gains/i)?(i=parseInt(/\d+%/.exec(d[t])[0].replace("%","")),a[3][r]=a[3].hasOwnProperty(r)?a[3][r]+i:i,a[3].total+=i):0<=d[t].search(/gym gains/i)&&(i=parseInt(/\d+%/.exec(d[t])[0].replace("%","")),a[0][r]=a[0].hasOwnProperty(r)?a[0][r]+i:i,a[0].total+=i,a[1][r]=a[1].hasOwnProperty(r)?a[1][r]+i:i,a[1].total+=i,a[2][r]=a[2].hasOwnProperty(r)?a[2][r]+i:i,a[2].total+=i,a[3][r]=a[3].hasOwnProperty(r)?a[3][r]+i:i,a[3].total+=i)}const s=$("[class^='gymContent___']").children("[class^='properties___']").children("li");let l=0;s.each(function(){let t="<b>总加成:</b> +"+a[l].total+"%";for(var e in a[l])"total"!=e&&(t+="<br><b>"+e+":</b> +"+a[l][e]+"%");$(this).children("[class^='propertyContent___']").children("[class^=description___]").children("p:first").append(`<span class="t-green gym-perks" title="${t}">锻炼加成:+${a[l].total}% </span>`),l++})}).catch(t=>console.log("fetch error",t))}for(var i in $("#gymroot").children().append(`
    <div>
        <div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">锻炼比例推荐
        </div>
        <div class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">
            <div class="select-wrap" style="margin:5px; float:left">
                <select id="gym-ratio" style="height:24px">
                </select>
            </div>
            <div class="select-wrap" style="margin:5px 1px; float:left">
                <p id="gym-ratio-info" style="height:12px; padding:6px 1px;">
                </p>
            </div>
        </div>
    </div>
`),ratio_dict)$("#gym-ratio").append(`<option value="${i}">${ratio_dict[i].description}</option>`);const gym_ratio_ls=getLocalStorage("gym-ratio","ratio_number");if(null!==gym_ratio_ls&&void 0!==gym_ratio_ls){$("#gym-ratio").children("[value="+gym_ratio_ls+"]").attr("selected","true"),$("#gym-ratio-info").text(`Str : Def : Spd : Dex = ${ratio_dict[gym_ratio_ls].str} : ${ratio_dict[gym_ratio_ls].def} : ${ratio_dict[gym_ratio_ls].spd} : ${ratio_dict[gym_ratio_ls].dex}`);const tempInterval=setInterval(()=>{console.log("interval started"),0<$("[class^='gymContent___']").length&&(console.log("interval ended"),clearInterval(tempInterval),setGymGoal(ratio_dict[gym_ratio_ls].str,ratio_dict[gym_ratio_ls].def,ratio_dict[gym_ratio_ls].spd,ratio_dict[gym_ratio_ls].dex),getGymPerks())},500)}if($("#gym-ratio").change(function(){console.log("ratio changed");var t=$("#gym-ratio").val();updateLocalStorage("gym-ratio","ratio_number",t),$("#gym-ratio-info").text(`Str : Def : Spd : Dex = ${ratio_dict[t].str} : ${ratio_dict[t].def} : ${ratio_dict[t].spd} : ${ratio_dict[t].dex}`),setGymGoal(ratio_dict[t].str,ratio_dict[t].def,ratio_dict[t].spd,ratio_dict[t].dex)}),0<$(".gym___3sIk3").length){let observer_gym=new MutationObserver(function(t,e){console.log("observer");const a=$("[class^='gymDetails___']").find("[class^='progressBar___']");a.each(function(){let t=$(this).attr("aria-label").split(" ")[2];"not"==t&&(t=0),$(this).find("[class^='exerciseName___']").text(t+"/10")}),null!==gym_ratio_ls&&void 0!==gym_ratio_ls&&(setGymGoal(ratio_dict[gym_ratio_ls].str,ratio_dict[gym_ratio_ls].def,ratio_dict[gym_ratio_ls].spd,ratio_dict[gym_ratio_ls].dex),getGymPerks())});observer_gym.observe(document.getElementsByClassName("gym___3sIk3")[0],{childList:!0})}}if(noAssisting&&0<=window.location.href.indexOf("loader.php?sid=attack&user2ID")){let count_sf=Math.floor(30*Math.random()+1),count_jf=300;const countdown_sf=setInterval(btnStartFight,100),countdown_jf=setInterval(btnJoinFight,100);function btnStartFight(){const t=$("[class^='btn_']");t.text().includes("Start fight")&&(t.prop("hidden",!0),t.parent().parent().children(":first").text("Wait ("+(count_sf/10).toFixed(1)+")s To Start fight"),0==count_sf&&(clearInterval(countdown_sf),t.parent().parent().children(":first").text(""),t.removeAttr("hidden")),count_sf--)}function btnJoinFight(){const t=$("[class^='btn_']");t.text().includes("Join fight")&&(t.prop("hidden",!0),t.parent().parent().children(":first").text("Wait ("+(count_jf/10).toFixed(1)+")s To Join fight 已有其他人进入此战斗"),0==count_jf&&(clearInterval(countdown_jf),t.parent().parent().children(":first").text(""),t.removeAttr("hidden")),count_jf--)}}if(0<=window.location.href.indexOf("loader.php?sid=attack&user2ID")){let cache=100;const stealthInterval=setInterval(updateStealthUI,500);function updateStealthUI(){var t,e,a,n;0<$("[class^=level]").length&&0<$("#log-header").length&&(n=$("[class^=level]").attr("style").replace("height: ","").replace("%",""),(t=parseFloat(n))>cache||(e=66<=(cache=t)?"green":"red",a=66<=t?"高":"低",$("#stealth-value").remove(),n=$("#log-header").children(":first").attr("class"),$("#log-header").children(":first").after(`
            <span id="stealth-value" class="${n}">隐身几率:&nbsp;
                <span class="t-${e}">${a}</span>
                &nbsp;Stealth:&nbsp;
                <span class="t-${e}">${t}%</span>
            </span>`)))}}if(0<=window.location.href.indexOf("loader.php?sid=attack&user2ID")){const attackInterval=setInterval(updateAttackingStatus,500);function updateAttackingStatus(){0<$("[class^=labelsContainer]").length&&$("[class^=titleContainer]").empty(),0<$("[class^=modal___]").length&&$("#upper-layer").length<1?getChainAPI($("[class^=modal___]"),"upper-layer"):0<$("[class^=playerWindow___]").length&&$("#lower-layer").length<1&&getChainAPI($("[class^=playerWindow___]"),"lower-layer")}const userId=window.location.href.substr(51);function getChainAPI(t,o){t.last().append(`
                <div id="${o}" style="width:200px; height:16px; position: absolute; right: 1px; top: 2px; z-index: 1; color: white ;background-color: ${bingwa_color_pool.blue}; border: 2px solid darkgray; padding-top: 3px; margin: 5px; text-align: center;">
                    <span>当前Chain状态读取中...</span>
                </div>
            `);t=`https://api.torn.com/faction/?selections=chain&key=${APIKey}`;fetch(t).then(t=>t.json()).then(e=>{if("chain"in e){var a=parseInt(e.chain.timeout/60),n=e.chain.timeout%60,a="0"+a,n=9<n?n:"0"+n;let t=bingwa_color_pool.blue;100<=e.chain.max&&e.chain.max-e.chain.current<=20&&(t=bingwa_color_pool.red),$("#"+o).css("background-color",t).text(`当前Chain: ${e.chain.current}/${e.chain.max} 超时: ${a}:${n}`),console.log(o)}else"error"in e&&$("#"+o).text("当前Chain状态读取失败")}).catch(t=>console.log("fetch error",t))}$("[class^=titleContainer]").empty(),$("[class^=titleContainer]").append(`<span id="online-status" class="border-round" style="color:white;background-color:${bingwa_color_pool.red};padding:5px;font-size:18px;" title="在线状态"></span>`),$("[class^=titleContainer]").append(`<span id="last-action" class="border-round" style="color:white;background-color:${bingwa_color_pool.red};padding:5px;font-size:18px;" title="离线时间"></span>`),$("[class^=titleContainer]").append(`<span id="refresh-btn" class="border-round" style="cursor:pointer;color:white;background-color:${bingwa_color_pool.blue};padding:5px;font-size:18px;">刷新</span>`),$("#refresh-btn").click(()=>{location.reload()}),wawaDetect(userId,function(t){var e;null!=t&&"last_action"in t&&("Online"==(e=t.last_action.status)?$("#online-status").css("background-color",bingwa_color_pool.green):"Idle"==e?$("#online-status").css("background-color",bingwa_color_pool.yellow):$("#online-status").css("background-color",bingwa_color_pool.gray),$("#online-status").text(e),$("#last-action").text(t.last_action_details))},function(t){$("#online-status").text("蛙蛙探测 "+userId+" 失败 "+t)})}if(nurse_suggestion&&0<=window.location.href.indexOf("item.php")&&nurse(".tutorial-cont"),0<=window.location.href.indexOf("factions.php?step=your")){let observer_controls=new MutationObserver(function(t,e){console.log("changed"),nurse("#faction-armoury-tabs")});observer_controls.observe(document.getElementById("faction-armoury"),{childList:!0,subtree:!0})}if(taking_off_reminder&&0<=window.location.href.indexOf("travelagency.php")&&(0<$("#icon86-sidebar").length&&($("#tab-menu4").after(`<div><div id='oc-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:NavajoWhite;text-align:center;'>OC准备就绪 点击前往执行</div></div>`),$("#oc-btn").click(function(){$(this).text("蛙蛙正在前往……"),window.location.href="https://www.torn.com/factions.php?step=your#/tab=crimes"})),0<$("#icon49-sidebar").length?$("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#c0542f;text-align:center;'>DRUG CD 小于10分钟 先不要飞了哦</div></div>`):0<$("#icon50-sidebar").length?$("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#DAA520;text-align:center;'>DRUG CD 不足1小时 先不要飞了哦</div></div>`):0<$("#icon51-sidebar").length?$("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#5d9525;text-align:center;'>DRUG CD 为1-2小时之间 可尽情飞翔</div></div>`):0<$("#icon52-sidebar").length?$("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#5d9525;text-align:center;'>DRUG CD 为2-5小时之间 可尽情飞翔</div></div>`):0<$("#icon53-sidebar").length?$("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#5d9525;text-align:center;'>DRUG CD 大于5小时 可尽情飞翔</div></div>`):$("#tab-menu4").after(`<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;
    background-color:#5d9525;text-align:center;'>DRUG CD 为零 是不是忘吃药了</div></div>`)),0<=window.location.href.indexOf("factions.php?step=your")){const wallInterval=setInterval(updateBSonWall,3e3);function updateBSonWall(){$("div.title").children("div.id").text("BS");const t=$("li.enemy").children("div.id");0<t.length&&t.each(function(t,e){const a=$(this).siblings("span").children("div.member").children("a.user.name"),n=a?a.attr("href"):void 0;var o=n?n.substr(18):void 0;o&&((o=getLocalStorage("battlestats",o))?$(this).text(bsConvert(o)):$(this).text("nil"))});const e=$("li[class^='enemy enemy___']").parent(),a=$("li[class^='enemy enemy___']").children("div.attack").children();0<a.length&&a.each(function(){if("1"!=$(this).attr("detected")){const e=$(this).parent().siblings("div.member").children().children("[class^=userWrap___]").children(),a=e?e.attr("href"):void 0;var t=a?a.substr(18):void 0;console.log(t),t&&((t=getLocalStorage("battlestats",t))?($(this).text(bsConvert(t)),$(this).attr("bs",t)):$(this).attr("bs",0))}$(this).attr("detected","1")}),0<e.length&&"1"!=e.attr("hasdone")&&(e.attr("hasdone","1"),rwClickSort(e.siblings().children("div[class^='attack left attack___']"),rwGetBS))}function rwGetBS(t){return $(t).find("[bs]").attr("bs")}function rwClickSort(t,a){const e=t.parent().siblings(),n=t.parent().siblings().children();t.click(function(){"decend"==$(this).attr("sort")?(n.sort(function(t,e){return a(t)-a(e)}),n.detach().appendTo(e),$(this).attr("sort","ascend")):(n.sort(function(t,e){return a(e)-a(t)}),n.detach().appendTo(e),$(this).attr("sort","decend"))})}function bsConvert(t){return 1e15<=t?"max":1e13<=t?parseInt(t/1e12)+"t":1e12<=t?(t/1e12).toFixed(1)+"t":1e10<=t?parseInt(t/1e9)+"b":1e9<=t?(t/1e9).toFixed(1)+"b":1e7<=t?parseInt(t/1e6)+"m":1e6<=t?(t/1e6).toFixed(1)+"m":1e4<=t?parseInt(t/1e3)+"k":1e3<=t?(t/1e3).toFixed(1)+"k":t}}if(0<=window.location.href.indexOf("page.php?sid=log")){const intervalID=setInterval(updateLogUI,1e3);function updateLogUI(){const t=$(".panel > div[class^=title]");0!==t.length&&(clearInterval(intervalID),t.prepend('<button id="log-export-btn" class="torn-btn" style="margin:5px;">导出所选日志</button>'),$("#log-export-btn").click(async function(){const t=new Proxy(new URLSearchParams(window.location.search),{get:(t,e)=>t.get(e)});var a=t.cat?t.cat.split(","):[];const n=t.log&&0===a.length?t.log.split(","):[];if(0!==a.length||0!==n.length){alert("注意：\n* 请勿同时使用其他频繁请求 API 的功能（例如：冰蛙目标、阅兵、犯罪经验）\n* 导出需要很长时间，请耐心等待\n* 若要取消，请刷新或关闭页面\n");try{$(this).prop("disabled",!0),$(this).text("正在导出，请耐心等待");var e=await(await fetch(`https://api.torn.com/user/?selections=basic&key=${APIKey}`)).json();if("error"in e)throw new Error(e.error.error);const s=Math.max(Math.ceil(n.length/10),1),l=[];for(let e=0;e<s;e++){var o=t=>{$(this).text(`正在导出，请耐心等待 (第 ${e+1}/${s} 批 ${new Date(1e3*t).format("yyyy-MM-dd")})`)};for await(const d of fetchAllLogGenerator(a,n.slice(10*e,10*(e+1)),t.from,t.to,o))l.push(d)}l.sort((t,e)=>e.timestamp-t.timestamp);var i={user_id:e.player_id,user_name:e.name,timestamp:Math.floor((new Date).getTime()/1e3),categories:a,types:n,logs:l},r=`data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(i))}`;$(this).replaceWith(`<a download="torn-log-${i.user_id}-${i.timestamp}.json" href="${r}"
                            class="torn-btn" style="color: #333; margin:5px; display:inline-block;">导出完毕，点击保存</a>`)}catch(t){console.trace(t),"Access level of this key is not high enough"===t.message?$(this).replaceWith('<a href="/preferences.php#tab=api">权限不足！请使用 Full Access 类型的 API Key</a>'):($(this).text("出错啦！请刷新重试"),alert(`出错啦！${t}`))}}else alert("请选择日志类型")}))}}if(0<=window.location.href.indexOf("preferences.php")){const apikeyInterval=setInterval(updateAPIKey,500);function updateAPIKey(){var t=$("[class^=api___]"),e=$("#name").attr("aria-expanded"),a=$("#name").attr("aria-hidden");if(0<t.length&&"false"==e&&"false"==a){$("#bingwa-apikey-setting").length<1&&$(".content-title").after(`
                <div id="bingwa-apikey-setting">
                    <div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">冰蛙APIKey设置</div>
                    <div id="bingwa-apikey-setting-wrapper" class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">
                        <div style="margin:5px;padding:5px;">你拥有的APIKey个数为 <span id="apikey-number" style="padding:3px;color:${bingwa_color_pool.yellowgreen};font-size:18px;"></span> 个</div>
                        <div style="margin:5px;padding:5px;">冰蛙当前使用的APIKey为 <span id="apikey-current" style="padding:3px;color:${bingwa_color_pool.red};font-size:18px;"></span></div>
                        <div id= "apikey-wrapper"style="margin:5px;padding:5px;"></div>
                    </div>
                </div>`);const n=$("[class^=keyRow]");$("#apikey-number").text(`${n.length}`),$("#apikey-current").text(`${window.localStorage.getItem("APIKey")}`),$("#apikey-wrapper").empty(),0<n.length&&n.each(function(){var t=$(this).children("[class^=key]").val(),e=$(this).children("[class^=blockTablet]").children("[class^=type]").val();$("#"+t).length<1&&(t==window.localStorage.getItem("APIKey")?$("#apikey-wrapper").append(`
                                <div id="${t}" style="">
                                    <button class="torn-btn" style="margin:5px;" disabled>已使用</button>
                                    <span style="padding:3px;color:white;background-color:${bingwa_color_pool.purple};font-size:12px;">${e}</span>
                                    <span style="padding:3px;color:white;background-color:${bingwa_color_pool.purple};font-size:16px;">${t}</span>
                                </div>`):($("#apikey-wrapper").append(`
                                <div id="${t}" style="">
                                    <button class="torn-btn" style="margin:5px;">未使用</button>
                                    <span style="padding:3px;color:white;background-color:${bingwa_color_pool.gray};font-size:12px;">${e}</span>
                                    <span style="padding:3px;color:white;background-color:${bingwa_color_pool.gray};font-size:16px;">${t}</span>
                                </div>`),$(".torn-btn").click(function(){window.localStorage.setItem("APIKey",$(this).parent().attr("id"))})))})}else $("#bingwa-apikey-setting").remove()}}else if(null==APIKey||""==APIKey)alert("宝鉴需要一个有效的APIKey，将前往设置页面，待载入后选择你的APIKey。"),window.location.href="https://www.torn.com/preferences.php#tab=api";else{const $sidebar_icons_wrapper=$("#sidebarroot").find("[class^='status-icons___']"),$top_links=$("#top-page-links-list").children("a");if(0<$top_links.length||0<$sidebar_icons_wrapper.length){console.log("当前页面有按钮，可以宝鉴");let api_types_and_fields={user:["ammo","attacks","attacksfull","bars","basic","battlestats","bazaar","cooldowns","crimes","discord","display","education","events","gym","hof","honors","icons","inventory","jobpoints","log","medals","merits","messages","missions","money","networth","newevents","newmessages","notifications","perks","personalstats","profile","properties","receivedevents","refills","reports","revives","revivesfull","skills","stocks","timestamp","travel","weaponexp","workstats"],property:["property","timestamp"],faction:["applications","armor","armorynews","attacknews","attacks","attacksfull","basic","boosters","cesium","chain","chainreport","chains","contributors","crimenews","crimes","currency","donations","drugs","fundsnews","mainnews","medical","membershipnews","positions","reports","revives","revivesfull","stats","temporary","territory","territorynews","timestamp","upgrades","weapons"],company:["applications","companies","detailed","employees","news","newsfull","profile","stock","timestamp"],market:["bazaar","itemmarket","pointsmarket","timestamp"],torn:["bank","cards","chainreport","companies","competition","education","factiontree","gyms","honors","items","logcategories","logtypes","medals","organisedcrimes","pawnshop","pokertables","properties","rackets","raids","rankedwarreport","rankedwars","stats","stocks","territory","territorywars","timestamp"],key:["info"]},api_type="",api_result_object="",display_title="";const bingwa_icon='<li class="a_click_view_api_info icon6___XChW2" title="冰蛙宝鉴 呱" style="cursor: pointer; background-image:url(/images/v2/editor/emoticons.svg); background-position: -470px -42px;"></li>';$sidebar_icons_wrapper.prepend(bingwa_icon);const bingwa_button='<a role="button" style="cursor: pointer" aria-labelledby="events" class="a_click_view_api_info events t-clear h c-pointer  m-icon line-h24 right last"><span class="icon-wrap svg-icon-wrap"><span class="link-icon-svg events "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17"><defs><style>.cls-1{opacity:0.35;}.cls-2{fill:#fff;}.cls-3{fill:#777;}</style></defs><g id="Ð¡Ð»Ð¾Ð¹_2" data-name="Ð¡Ð»Ð¾Ð¹ 2"><g id="icons"><g class="cls-1"><path class="cls-2" d="M8,1a8,8,0,1,0,8,8A8,8,0,0,0,8,1ZM6.47,3.87H9.53l-.77,7.18H7.24ZM8,14.55A1.15,1.15,0,1,1,9.15,13.4,1.14,1.14,0,0,1,8,14.55Z"></path></g><path class="cls-3" d="M8,0a8,8,0,1,0,8,8A8,8,0,0,0,8,0ZM6.47,2.87H9.53l-.77,7.18H7.24ZM8,13.55A1.15,1.15,0,1,1,9.15,12.4,1.14,1.14,0,0,1,8,13.55Z"></path></g></g></svg></span></span><span id="a_click_view_api_info_text">宝鉴</span></a>';$top_links.last().after(bingwa_button),$(".a_click_view_api_info").click(function(){if($("#bwm").length<1){var t=`
                <div id="bwm">
                    <div id="bwm-nav">
                        <ul style="list-style-type: none;margin: 10px 0px;padding: 0;overflow: hidden;background-color: #333;">
                            <li style="float: left">
                                <a id="bwm-version" role="button" style="cursor: pointer;display: block;color: black;background-color: #4CAF50;text-align: center;padding: 14px 16px;text-decoration: none;" >版本记录</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-api" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >查看API</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-company" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >我的公司</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-faction" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >帮派详情</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-target" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >冰蛙目标</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-mug" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >抢劫历史</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-warroom" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >世界局势</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-revive" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >复活助手</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-rankedwar" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >近期RW</a>
                            </li>
                            <li style="float: left">
                                <a id="bwm-crimeexp" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >犯罪经验</a>
                            </li>
                            ${userScriptEngine!=UserScriptEngineEnums.other?`
                            <li style="float: left">
                            <a id="bwm-extcenter" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >插件</a>
                            </li>`:""}
                            <li style="float: left">
                                <a id="bwm-settings" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >设置</a>
                            </li>
                            <li style="float: right">
                                <a id="bwm-return" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >返回</a>
                            </li>
                        </ul>
                    </div>
                </div>`;$("#mainContainer").prepend(t);function s(t){const e=$("#bwm-nav [id^=bwm-]");e.attr("style","cursor: pointer; display: block; color: white; text-align: center; padding: 14px 16px; text-decoration: none;"),$(t).attr("style","cursor: pointer; display: block; color: black; background-color: #4CAF50; text-align: center; padding: 14px 16px; text-decoration: none;")}function e(){var t=getVersion();return`
                    <div id="version_container" style="width: inherit">
                        <div style="text-align:center; margin-bottom: 10px;">
                            <a role="button" style="cursor: pointer; font-size: large; color: #777;">冰蛙当前版本为 ${t[0]}</a>
                        </div>
                        <div style="text-align:center;">
                            <textarea  style="height:800px;width:100%;background-color: lightgray; font-family:\'Lucida Console\', Monaco, monospace; font-size: 0.8rem;line-height: 1.3;" readonly="readonly">${t[1]}</textarea>
                        </div>
                    </div>`}window.localStorage.setItem("BINGWA_TARGET_FLAG",""),$("#bwm").append(e()),$("#bwm-version").click(function(){$("#bwm").children(":last").remove(),$("#bwm").append(e()),s("#bwm-version")}),$("#bwm-api").click(function(){$("#bwm").children(":last").remove(),$("#bwm").append(function(){let t="";for(var e in api_types_and_fields)t+='<a role="button" style="cursor: pointer; font-size: large; color: #777;" class="a_click_api_type">'+e+"</a>&nbsp;&nbsp;";t+='<br /><br /><input type="text" id="api_input_id" name="api_input_id" placeholder="ID (当前用户不用填)" size="25" style="font-size: larger; padding: 3px;" />&nbsp;&nbsp;<input type="text" id="api_input_from_time" name="api_input_from_time" placeholder="From (Eg: 2019/10/25 23:00:00)" size="29" style="font-size: larger; padding: 3px;" />&nbsp;&nbsp;<input type="text" id="api_input_to_time" name="api_input_to_time" placeholder="To (Eg: 2019/10/26 08:00:00)" size="28" style="font-size: larger; padding: 3px;" />';let a='<div id="api_container"><div id="api_types_container" style="text-align:center; margin-bottom: 10px;">'+t+'</div><div id="api_fields_container" style="text-align:center; margin-bottom: 10px;"></div><div id="api_result_header" style="text-align:center; margin-bottom: 3px; font-size: large;"></div><div style="text-align:center;"><textarea id="api_result_container" rows="40" style="width:100%; background-color: lightgray; font-family:\'Lucida Console\', Monaco, monospace; font-size: 0.8rem;line-height: 1.3;" readonly="readonly" /><br /><a id="api_result_download_csv" role="button" style="cursor: pointer; font-size: large; color: #777;">导出为CSV文件</a>';return foo?a+='&nbsp;&nbsp;&nbsp;&nbsp;<a id="a_faction_parade" role="button" style="cursor: pointer; font-size: large; color: #777;">帮派大阅兵</a><a id="a_faction_parade_download" role="button" style="display:none">帮派大阅兵下载</a>&nbsp;&nbsp;&nbsp;&nbsp;<a id="a_faction_attacks" role="button" style="cursor: pointer; font-size: large; color: #777;">帮战统计</a><a id="a_faction_attacks_download" role="button" style="display:none">帮战统计下载</a></div></div>':a+="</div></div>",a}()),s("#bwm-api"),$(".a_click_api_type").click(function(){$("#api_fields_container").empty(),api_type=$(this).text(),console.log("click: "+api_type);var t,e=api_types_and_fields[api_type].sort();for(t in e){var a=e[t];$("#api_fields_container").append('<a role="button" style="cursor: pointer; font-size: large; color: #777;" class="a_click_api_field">'+a+"</a>&nbsp;&nbsp;"),t%10==8&&$("#api_fields_container").append("<br />")}$(".a_click_api_field").click(function(){$("#api_result_container").val("");var t=$(this).text(),e=$("#api_input_id").val(),a=$("#api_input_from_time").val(),n=new Date(a).getTime()/1e3,o=$("#api_input_to_time").val(),i=new Date(o).getTime()/1e3;let r=`https://api.torn.com/${api_type}/${e}?selections=${t}&key=${APIKey}&from=${n}&to=${i}`;(isNaN(n)||isNaN(i))&&(r=`https://api.torn.com/${api_type}/${e}?selections=${t}&key=${APIKey}`),console.log(`Request: ${r}`),display_title=api_type+" - "+e+" - "+t+" - "+a+" - "+o,$("#api_result_header").text(`探测中: ${display_title}`),$("#api_result_download_csv").removeAttr("href"),$("#api_result_download_csv").removeAttr("download"),api_result_object="",fetch(r).then(t=>t.ok?t.json():void $("#api_result_header").text(`探测失败: ${display_title}`),t=>{$("#api_result_header").text(`网络异常: ${display_title}`)}).then(t=>{console.log(`Response: ${r}`),console.log(t),void 0!==t&&($("#api_result_header").text(`探测完成: ${display_title}`),api_result_object=t,$("#api_result_container").val(JSON.stringify(t,null,4)))})})}),$("#api_result_download_csv").click(function(){var t;null==api_result_object||""==api_result_object||null==display_title||""==display_title||"object"!=typeof api_result_object||api_result_object.length<1?alert("没有可导出的数据"):null!=(t=findDataSet(api_result_object))?(t=dataSetToCsv(t),$(this).attr("href","data:text/csv;charset=utf-8,\ufeff"+t),$(this).attr("download",display_title+".csv")):alert("没找到有效的数据集")}),$("#a_faction_parade").click(function(){$("#api_result_container").val("");const l=$("#api_input_id").val();appendResultMessage("开始帮派大阅兵，将拉取帮派成员列表，然后逐个查询该成员的详细信息，再使用蛙蛙探测器增加分析结果，最后导出为csv文件。"),appendResultMessage("请注意："),appendResultMessage("1、此功能会调用很多次API接口，所以不要太频繁使用。"),appendResultMessage("2、为了避免太频繁被封接口，每次查询做了延时，所以运行时间较久，请耐心等待。"),appendResultMessage("3、如果想中途放弃，请直接关掉本网页窗口。");let a=`https://api.torn.com/faction/${l}?selections=basic&key=${APIKey}`;$("#api_result_header").text(`帮派大阅兵 ${l}`),console.log(`Request: ${a}`),appendResultMessage("\n开始获取帮派成员列表"),fetch(a).then(t=>t.ok?t.json():void appendResultMessage("阅兵失败"),t=>{appendResultMessage("阅兵失败，网络异常")}).then(t=>{console.log(`Response: ${a}`),console.log(t);const n=Object.keys(t.members),e=n.length;appendResultMessage(`获取帮派成员列表完成，共有 ${e} 个成员`);let o=new Array,i=0;function r(){const e=n[i];let a=t.members[e];a.userId=e,o.push(a),wawaDetect(e,function(t){appendResultMessage(`蛙蛙探测 userId: ${e} 成功`),Object.assign(a,t),s()},function(t){appendResultMessage(`蛙蛙探测 userId: ${e} 失败`),s()})}function s(){if(i<e-1)++i,setTimeout(r,1e3);else{appendResultMessage("蛙蛙探测完成"),appendResultMessage("\n开始转换为csv格式...");var a=dataSetToCsv(o);const n=$("#a_faction_parade_download");n.attr("href","data:text/csv;charset=utf-8,\ufeff"+a);let t=new Date;n.attr("download",`FactionParade_${l}_${t.format("yyyyMMdd_hhmm")}.csv`),appendResultMessage("转换为csv格式完成"),appendResultMessage("\n开始下载");let e=document.createEvent("MouseEvents");e.initEvent("click",!0,!0),document.getElementById("a_faction_parade_download").dispatchEvent(e)}}appendResultMessage("\n开始启动蛙蛙探测..."),r()})}),$("#a_faction_attacks").click(function(){var t=$("#api_input_from_time").val();const d=new Date(t);let c=d.getTime()/1e3;var e=$("#api_input_to_time").val();const p=new Date(e),g=p.getTime()/1e3;if(isNaN(c)||isNaN(c))alert("此功能必须输入起止时间（你的电脑本地时间，不要转为TCT）");else{$("#api_result_container").val(""),appendResultMessage("开始帮战统计，将自动切分时间段，拉取帮派attacks记录（每次最多100条），然后拼接，最后导出为csv文件。"),appendResultMessage("请注意："),appendResultMessage("1、此功能需要帮派API权限。"),appendResultMessage("2、此功能会调用很多次API接口，所以不要太频繁使用。"),appendResultMessage("3、每30秒才访问一次（因为测试发现数据有缓存），所以运行时间较久，请耐心等待。"),appendResultMessage("4、如果想中途放弃，请直接关掉本网页窗口。"),appendResultMessage(`\n开始时间：${t} 时间戳 ${c} ，结束时间：${e} 时间戳 ${g} \n`);let l=new Object;!function r(){const s=`https://api.torn.com/faction/?selections=attacks&key=${APIKey}&from=${c}&to=${g}`;console.log(`Request: ${s}`),$("#api_result_header").text("帮战统计"),fetch(s).then(t=>t.ok?t.json():(appendResultMessage("抓取失败，将1秒后重试"),void setTimeout(r,1e3)),t=>{appendResultMessage("抓取失败，将1秒后重试"),setTimeout(r,1e3)}).then(t=>{function e(){appendResultMessage("\n攻击记录抓取完成，开始转换为csv格式...");var t=dataSetToCsv(getValues(l));const e=$("#a_faction_attacks_download");e.attr("href","data:text/csv;charset=utf-8,\ufeff"+t),e.attr("download",`FactionAttacks_${d.format("yyyyMMddhhmmss")}_${p.format("yyyyMMddhhmmss")}.csv`),appendResultMessage("转换为csv格式完成"),appendResultMessage("\n开始下载");let a=document.createEvent("MouseEvents");a.initEvent("click",!0,!0),document.getElementById("a_faction_attacks_download").dispatchEvent(a)}console.log(`Response: ${s}`),console.log(t),Object.assign(l,t.attacks);var a=getValues(t.attacks);if(0<a.length){var n=a[0].timestamp_started;const o=new Date(1e3*n);t=a[a.length-1].timestamp_started;const i=new Date(1e3*t);appendResultMessage(`抓取 ${c} - ${g} 有 ${a.length} 条，第一条 ${n} ${o.format("yyyy/MM/dd hh:mm:ss")}，最后一条 ${t} ${i.format("yyyy/MM/dd hh:mm:ss")}，累计 ${Object.keys(l).length} 条`),t<c||t>g?1<a.length?(appendResultMessage("抓取的数据没有更新，准备重试"),setTimeout(r,1e4)):(appendResultMessage("系统会莫名其妙的卡在最后一条，直接完成"),e()):(c=t+2,setTimeout(r,30500))}else e()})}()}})}),$("#bwm-company").click(function(){$("#bwm").children(":last").remove(),$("#bwm").append(`
                    <div id="mycompany_container" style="width: inherit">
                        <div id="mycompany-head" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                            <span id="companyname" role="button" style="font-size: large; color:#777;" >我的公司</span>
                        </div>
                        <div id="tips-view-company" style="text-align:center; margin-bottom: 3px; font-size: 4px;"></div>
                        <div id="mycompany-content" style="min-height:400px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>
                    </div>`),s("#bwm-company");var t=getMyId();console.log("userId "+t),userId2otherIds(t).then(function(t){console.log(t);t=t[3];"Employee"==t?arbeitDemo($("#mycompany-content")):"Director"==t&&employeesDemo($("#mycompany-content"))}).catch(t=>console.log("userId2otherIds "+t))}),$("#bwm-faction").click(function(){function r(){var t=window.localStorage.getItem("faction_compare_history");if(null!=t){var e,a=JSON.parse(t);for(e in a)$("#bwm_faction_history").append(`
                                <div class="wrapper-history" style="width:135px;float:left;border:1px solid darkgray;margin:5px 10px;">
                                    <div class="head-history" style="background-color:black;color:white;padding:5px;overflow:hidden;">
                                        <div class="id-history" style="width:30%;float:left;margin-left:50%;position:relative;left:-15%;">${e}</div>
                                        <div style="float:right;cursor:pointer;background-color:white;color:black;padding:0px 2px;">
                                            <a class="delete-history" role="button" >X</a>
                                        </div>
                                    </div>
                                    <div class="content-history" style="background-color:white;padding:5px;">
                                        <a style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" class="user faction" href="/factions.php?step=profile&amp;ID=${e}" target="_blank">${a[e]}</a>
                                    </div>
                                </div>`);$(".delete-history").click(function(){var t=$(this).parent().parent().children(".id-history").text();deleteLocalStorage("faction_compare_history",t),$(this).parent().parent().parent().remove(),console.log("删除成功: "+t)}),$(".head-history").click(function(){const t=$(this).siblings(".content-history");var e;"selected"==t.attr("selected")?(t.css("background-color","white"),t.removeAttr("selected"),$("#faction-input-id").val("")):($(".content-history").css("background-color","white"),$(".content-history").removeAttr("selected"),t.css("background-color","navajowhite"),t.attr("selected","selected"),e=$(this).children(".id-history").text(),$("#faction-input-id").val(e))})}}$("#bwm").children(":last").remove(),$("#bwm").append(`
                    <div id="bwm_faction_container" style="width: inherit">
                        <div id="bwm_faction_header" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                            <input type="text" id="faction-input-id" name="faction-input-id" placeholder="帮派 ID" size="10" style="font-size: larger; padding: 5px; margin: 5px;" />
                            <button id="faction-load-btn" class="torn-btn" style="margin:5px;">读取帮派</button>
                            <button id="faction-parade-start-btn" class="torn-btn" style="margin:5px;">开始阅兵</button>
                            <button id="faction-parade-stop-btn" class="torn-btn" style="margin:5px;" disabled>停止阅兵</button>
                        </div>
                        <div id="bmw_faction_tips" style="text-align:center; margin-bottom: 3px; font-size: 4px;"></div>
                        <div id="bwm_faction_history" style="margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden;"></div>
                        <div id="bmw_faction_wrapper" style="min-height:700px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>
                    </div>`),s("#bwm-faction"),r();let t=window.localStorage.getItem("MY_FACTION_ID");void 0!==t&&null!==t||(t="20465"),$("#faction-load-btn").click(function(){$("#faction-input-id").val()||$("#faction-input-id").val(t),function(o,t){t.empty(),t.append(`
                        <div id="name-faction" style="font-size: 20px; margin: 4px;"><img id="tag-faction" style="margin-right: 4px;"><span></span></div>
                        <div id="rank-faction" style="margin: 2px;"></div>
                        <div id="detail-faction" style="margin: 2px;"></div>
                        <div id="table-faction">
                            <table class="table-faction-table" style="margin:auto;background-color:white;font-size:12px;">
                                <tr class="head">
                                    <th class="table-online">Online</th>
                                    <th class="table-level">Lvl</th>
                                    <th>Name</th>
                                    <th>ID</th>
                                    <th class="table-last">Last</th>
                                    <th class="table-status">Status</th>
                                    <th class="table-position">Position</th>
                                    <th class="table-days">Days</th>
                                    <th>Attack</th>
                                    <th class="table-bs">BS</th>
                                    <th class="table-networth">Networth</th>
                                    <th>Description</th>
                                </tr>
                            </table>
                        </div>`),$("#table-faction").find(".table-faction-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),t=`https://api.torn.com/faction/${o}?selections=basic&key=${APIKey}`;const i=$("#bmw_faction_tips");i.text("---探测中 "+o+"---"),fetch(t).then(t=>t.ok?t.json():void i.text("---探测失败 "+o+"---"),t=>{i.text("---网络异常 "+o+"---")}).then(t=>{console.log("API fetched: "+o),null!=t&&i.text("---探测完成 "+o+"---"),$("#name-faction").children("span").text(`${t.name} - ${o}`),$("#tag-faction").attr("src",`https://factiontags.torn.com/${t.tag_image}`),$("#rank-faction").text(`Rank: ${t.rank.name} - ${t.rank.division}`),updateLocalStorage("faction_compare_history",o,t.name),$("#bwm_faction_history").empty(),r(),$(".id-history").each(function(){$(this).text()==o&&$(this).parent().parent().children(".content-history").css("background-color","NavajoWhite")});var e=Object.keys(t.members).length;const a=t.respect;var n=a.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","});$("#detail-faction").text(`Members: ${e} | Resp: ${n} | Best Chain: ${t.best_chain}`),$.each(t.members,function(t,e){var a=t,n=colBattleStats(a),o=colLastAction(e.last_action.timestamp),i=e.status.state,r=e.status.description,s=e.status.until,t=e.status.color,i=colHospitalTime(r,i,s),s=colNetworth(a);let l="white";"Leader"!=e.position&&"Co-leader"!=e.position||(l="NavajoWhite");let d="grey",c=1;"Online"==e.last_action.status?(d="DarkSeaGreen",c=3):"Idle"==e.last_action.status&&(d="Orange",c=2);e=`
                                    <tr class="content">
                                        <td class="table-online" code="${c}" style="border: 1px solid darkgray;padding:5px;color:white;background-color:${d}">${e.last_action.status}</td>
                                        <td class="table-level" style="border: 1px solid darkgray;padding:5px;">${e.level}</td>
                                        <td style="border: 1px solid darkgray;padding:5px;"><a class="user name" href="/profiles.php?XID=${a}" target="_blank">${e.name}</a></td>
                                        <td style="border: 1px solid darkgray;padding:5px;text-align:right;">${a}</td>
                                        <td class="table-last" style="border: 1px solid darkgray;padding:5px;" last-action-minutes="${o[0]}">${o[1]}</td>
                                        <td class="table-status t-${t}" style="border: 1px solid darkgray;padding:5px;" hospital-minutes="${i[1]}">${i[0]}</td>
                                        <td class="table-position" style="border:1px solid darkgray;padding:5px;background-color:${l}">${e.position}</td>
                                        <td class="table-days" style="border: 1px solid darkgray;padding:5px;">${e.days_in_faction}</td>
                                        <td style="border: 1px solid darkgray;padding:5px;"><a style="color:#006699;text-decoration:none;" href="/loader.php?sid=attack&user2ID=${a}" target="_blank">Attack</a></td>
                                        <td class="table-bs" style="border: 1px solid darkgray;padding:5px;" estimate-bs="${n[0]}">${n[2]}</td>
                                        <td class="table-networth" style="border: 1px solid darkgray;padding:5px;" networth="${s[0]}">${s[1]}</td>
                                        <td style="border: 1px solid darkgray;padding:5px;">${e.status.details}</td>
                                    </tr>`;$("#table-faction").children(".table-faction-table").children().append(e)})}).catch(t=>console.log("fetch error",t))}($("#faction-input-id").val(),$("#bmw_faction_wrapper")),clickTableHeadSort($("th.table-bs"),flyEstimateBS),clickTableHeadSort($("th.table-last"),flyLastActionMinutes),clickTableHeadSort($("th.table-status"),flyHospitalMinutes),clickTableHeadSort($("th.table-online"),flyOnline),clickTableHeadSort($("th.table-level"),flyLevel),clickTableHeadSort($("th.table-position"),flyPosition),clickTableHeadSort($("th.table-days"),flyDays),clickTableHeadSort($("th.table-networth"),flyNetworth)});let o=!0;$("#faction-parade-start-btn").click(function(){o=!0,$("#faction-load-btn").prop("disabled",!0),$("#faction-parade-start-btn").prop("disabled",!0),$("#faction-parade-stop-btn").removeAttr("disabled"),$("tr.head").attr("style","pointer-events: none;");const t=$(".table-faction-table").children().children("tr.content").first();t.length<=0?($("#bmw_faction_tips").text("未找到用户列表"),$("#faction-load-btn").removeAttr("disabled"),$("#faction-parade-start-btn").removeAttr("disabled"),$("#faction-parade-stop-btn").prop("disabled",!0),$("tr.head").removeAttr("style")):($("#bmw_faction_tips").text("阅兵开始"),setTimeout(()=>{!function e(a){if("1"==a.attr("detected"))$("#bmw_faction_tips").text("用户已完成"),setTimeout(()=>{e(a.next())},0);else if(a.length<=0||0==o)$("#bmw_faction_tips").text("阅兵已结束"),$("#faction-load-btn").removeAttr("disabled"),$("#faction-parade-start-btn").removeAttr("disabled"),$("#faction-parade-stop-btn").prop("disabled",!0),$("tr.head").removeAttr("style");else{a.attr("detected","1");const n=a.find("a.user.name").attr("href").replace(/[^0-9|-]/gi,"");$("#bmw_faction_tips").text("正在阅兵: "+n),wawaDetect(n,function(t){a.children("td.table-bs").text(formatNumber(t.estimate_bs)),a.children("td.table-bs").attr("estimate-bs",t.estimate_bs),updateLocalStorage("battlestats",n,t.estimate_bs),a.children("td.table-networth").attr("networth",t.personalstats.networth),a.children("td.table-networth").text(formatNumber(t.personalstats.networth)),updateLocalStorage("networths",n,t.personalstats.networth),setTimeout(()=>{e(a.next())},1e3)},function(t){$("#bmw_faction_tips").text("蛙蛙探测 "+n+" 失败 "+t),setTimeout(()=>{e(a.next())},1e3)})}}(t)},1e3))}),$("#faction-parade-stop-btn").click(function(){o=!1})}),$("#bwm-target").click(function(){$("#bwm").children(":last").remove(),$("#bwm").append(`
                    <div id="bwm_target_container" style="width: inherit">
                        <div id="bwm_target_header" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                            <button id="target-load-excel" class="torn-btn" style="margin:5px;">加载本地excel文件</button>
                            <button id="target-clear-cache" class="torn-btn" style="margin:5px;" disabled>清除缓存</button>
                        </div>
                        <input type="file" id="file" style="display: none;" accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>
                        <div id="bmw_target_tips" style="text-align:center; margin-bottom: 3px; font-size: 4px;">请按以下模板来导入表格 仅限xlsx或csv格式</div>
                        <div id="bmw_target_wrapper" style="min-height:700px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;">
                            <table style="margin: auto;">
                                <tr>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: white;"></th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">A</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">B</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">C</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">D</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">E</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">F</th>
                                    <th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">G</th>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">1</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">Name</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">ID</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">STR</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">DEF</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">SPD</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">DEX</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">TOTAL</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">2</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">GoodLuck</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">2356929</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>
                                    <td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">800,000,000</td>
                                </tr>
                            </table>
                        </div>

                    </div>`),s("#bwm-target");var t=window.localStorage.getItem("BINGWA_TARGET");let i=t?JSON.parse(t):{};function n(t){0==t.length||"ID"in(t=Object.values(t)[0])&&(t=t.ID,console.log(t),userId2otherIds(t).then(function(t){console.log("arr "+t),function e(a,n){window.localStorage.setItem("BINGWA_TARGET_FLAG","refreshing");var t=`https://api.torn.com/faction/${a}?selections=basic&key=${APIKey}`;const o=$("#bmw_target_tips");o.text("---第 "+n+" 次刷新---频率每3秒一次---");fetch(t).then(t=>t.ok?t.json():void o.text("---探测失败 "+a+"---"),t=>{o.text("---网络异常 "+a+"---")}).then(t=>{console.log("faction api refreshed"),$.each(t.members,function(t,p){$(".target-id").each(function(){if(t==$(this).text()){var a=p.last_action.status;let t=bingwa_color_pool.yellow;"Online"==a?t=bingwa_color_pool.yellowgreen:"Offline"==a&&(t=bingwa_color_pool.gray),$(this).siblings(".target-online").css({"background-color":t,color:"white"}).text(a);var n=colLastAction(p.last_action.timestamp);$(this).siblings(".target-last").attr("last-action-minutes",n[0]).text(n[1]);var o,i=p.status.description,r=p.status.state,s=p.status.until,l=colHospitalTime(i,r,s);let e=bingwa_color_pool.green;"red"==p.status.color?(o=Math.min(l[1]/600,.8)+.2,e="rgba(255, 115, 115, "+o+")"):"blue"==p.status.color&&(e=bingwa_color_pool.blue),$(this).siblings(".target-status").attr("hospital-minutes",l[1]).css({"background-color":e,color:"white"}).text(l[0]),$(this).siblings(".target-level").text(p.level);var d=$(this).siblings(".target-fairfight").text();if(d!=isNaN){const c=.25*d*(Math.log(p.level)+1);$(this).siblings(".target-flatrespect").text(c.toFixed(2))}}})}),0<i.length&&0<$(".target-id").length?setTimeout(()=>{e(a,n+1)},3e3):(window.localStorage.setItem("BINGWA_TARGET_FLAG",""),console.log("faction api refreshing ended"))}).catch(t=>console.log("fetch error",t))}(t[0],1)}).catch(t=>console.log("startRefreshing "+t)))}function o(){var t=`https://api.torn.com/user/?selections=battlestats&key=${APIKey}`;const e=$("#bmw_target_tips");e.text("---BS探测中---"),fetch(t).then(t=>t.ok?t.json():void e.text("---BS探测失败---"),t=>{e.text("---BS网络异常---")}).then(t=>{if(null!=t)if("error"in t)e.text(t.error);else{const i=Math.sqrt(t.strength)+Math.sqrt(t.defense)+Math.sqrt(t.speed)+Math.sqrt(t.dexterity);console.log("My score:"+i),$(".target-fairfight").each(function(){var t=toThousands($(this).siblings(".target-str").text()),e=toThousands($(this).siblings(".target-def").text()),a=toThousands($(this).siblings(".target-spd").text()),n=toThousands($(this).siblings(".target-dex").text());let o=((Math.sqrt(t)+Math.sqrt(e)+Math.sqrt(a)+Math.sqrt(n))/i*8/3+1).toFixed(2);3<=o&&(o=3..toFixed(2)),$(this).text(o)})}else e.text("error")}).catch(t=>console.log("fetch error",t))}function r(t){let e=`
                        <table style="margin: auto;">
                            <tr>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Online</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Lvl</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Name</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">ID</th>
                                <th class="head-last" style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">Last</th>
                                <th class="head-status" style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">Status</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;" title="Fair fight 系数">FF</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;" title="基础面子系数">FR</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">Attack</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">TOTAL</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">Hint</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #458994; color: white; font-weight: bold; text-align: center;">STR</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #458994; color: white; font-weight: bold; text-align: center;">DEF</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #458994; color: white; font-weight: bold; text-align: center;">SPD</th>
                                <th style="border: 1px solid darkgray; padding: 5px; background-color: #458994; color: white; font-weight: bold; text-align: center;">DEX</th>
                            </tr>
                        `;for(var a in t){var n=function(t,e,a){let n="",o=["#FFF5F7","#FFF5F7","#FFF5F7","#FFF5F7"];return e+a<.33*t?(n="玻璃",o[0]="#FE9B9A",o[2]="#FE9B9A"):.15*t<e-a?(n="def党",o[1]="#FE9B9A"):.15*t<a-e?(n="dex党",o[3]="#FE9B9A"):.67*t<e+a&&(n="乌龟",o[1]="#FE9B9A",o[3]="#FE9B9A"),[n].concat(o)}(t[a].TOTAL,t[a].DEF,t[a].DEX);e+=`
                            <tr>
                                <td class="target-online" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-level" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-name" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;">
                                    <a class="user name" href="/profiles.php?XID=${t[a].ID}" target="_blank">${t[a].Name}</a>
                                </td>
                                <td class="target-id" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: right;">${t[a].ID||""}</td>
                                <td class="target-last" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-status" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-fairfight" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-flatrespect" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;"></td>
                                <td class="target-attack" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;">
                                    <a href="/loader.php?sid=attack&user2ID=${t[a].ID}" style="color: #006699; text-decoration: none;" target="_blank">Attack</a>
                                </td>
                                <td class="target-total" style="border: 1px solid darkgray; padding: 5px; background-color: #FFD8A9; color: black; text-align: center;">${toThousands(t[a].TOTAL)||0}</td>
                                <td class="target-total" style="border: 1px solid darkgray; padding: 5px; background-color: #FFF5F7; color: black; text-align: center;">${n[0]}</td>
                                <td class="target-str" style="border: 1px solid darkgray; padding: 5px; background-color: ${n[1]}; color: black; text-align: center;">${toThousands(t[a].STR)||0}</td>
                                <td class="target-def" style="border: 1px solid darkgray; padding: 5px; background-color: ${n[2]}; color: black; text-align: center;">${toThousands(t[a].DEF)||0}</td>
                                <td class="target-spd" style="border: 1px solid darkgray; padding: 5px; background-color: ${n[3]}; color: black; text-align: center;">${toThousands(t[a].SPD)||0}</td>
                                <td class="target-dex" style="border: 1px solid darkgray; padding: 5px; background-color: ${n[4]}; color: black; text-align: center;">${toThousands(t[a].DEX)||0}</td>
                            </tr>
                            `}return e+="</table>",e}0<i.length&&($("#target-load-excel").prop("disabled",!0),$("#file").prop("disabled",!0),$("#target-clear-cache").removeAttr("disabled"),$("#bmw_target_tips").text("加载成功"),$("#bmw_target_wrapper").html(r(i)),o(),"refreshing"!=window.localStorage.getItem("BINGWA_TARGET_FLAG")&&n(i)),$("#target-load-excel").click(function(){document.getElementById("file").click()}),$("#file").change(function(a){var t,e=a.target.files;0!=e.length&&(t=e[0],(e=/\.(xlsx|csv)$/g.exec(t.name))?function(t,i,r){const e=new FileReader;e.onload=function(t){var e,a=t.target.result;let n;function o(t){return"string"==typeof t?toThousands(t):t}"xlsx"===i?n=(e=a,t=XLSX.read(e,{type:"binary"}),e=t.SheetNames,e=t.Sheets[e[0]],XLSX.utils.sheet_to_json(e)):"csv"===i&&(n=function(t,e){function a(t){let e=0,a="";for(const n of t)'"'===n&&0===e?e=1:'"'===n&&1==e&&(e=0),","===n&&0===e?a+="|":'"'!==n&&(a+=n);return a.split("|")}const n=t.split(/\r?\n/),o=a(n[0]),i=[];for(let t=1;t<n.length-1;t++){var r=a(n[t]);const l={};for(const d in o){var s=o[d];e[s]?l[s]=e[s].call(null,r[d]):l[s]=r[d]}i.push(l)}return i}(a,{STR:o,DEF:o,SPD:o,DEX:o,TOTAL:o})),r&&r(n)},e.readAsBinaryString(t)}(t,e[1],function(t){for(var e in t)t[e].Name&&"string"!=typeof t[e].Name&&(t[e].Name=t[e].Name.toString());$("#target-load-excel").prop("disabled",!0),$("#file").prop("disabled",!0),$("#target-clear-cache").removeAttr("disabled"),console.log(t),a.target.value="",$("#bmw_target_tips").text("加载成功"),$("#bmw_target_wrapper").html(r(t)),window.localStorage.setItem("BINGWA_TARGET",JSON.stringify(t)),o(),"refreshing"!=window.localStorage.getItem("BINGWA_TARGET_FLAG")&&n(t)}):alert("仅支持读取xlsx或csv格式！"))}),$("#target-clear-cache").click(function(){1==confirm("确定清除缓存吗？")?($("#target-load-excel").removeAttr("disabled"),$("#file").removeAttr("disabled"),$("#target-clear-cache").prop("disabled",!0),$("#bmw_target_wrapper").empty(),$("#bmw_target_tips").text("无数据"),window.localStorage.removeItem("BINGWA_TARGET"),i={}):console.log("clear cancelled")})}),$("#bwm-settings").click(function(){$("#bwm").children(":last").remove(),$("#bwm").append(function(){let e="";return settings.forEach(t=>{e+=`
                        <tr style="height: 32px;">
                            <td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">${t.title}</td>
                            <td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">${t.desc}</td>
                            <td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">
                                <select id="bwm_settings_${t.name}">
                                    <option value="false">关闭</option>
                                    <option value="true">打开</option>
                                </select>
                            </td>
                        </tr>
                    `}),`
                    <div id="bwm_settings_container" style="width: inherit">
                        <div id="bwm_settings_header" style="text-align:center; margin-bottom: 10px;">
                            <table style="margin: auto">
                                <tr>
                                    <td style="padding: 10px;">
                                        <span class="border-round" style="font-size: large; color: #333; background-color:#ccc; padding:5px;border:3px solid #333;">设置</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div id="bwm_settings_table" style="text-align:center; margin-bottom: 10px;">
                            <table style="border:1px solid darkgray; padding: 5px; margin: auto">
                                <tr style="height: 32px;">
                                    <th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能名称</th>
                                    <th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能描述</th>
                                    <th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能状态</th>
                                </tr>
                                ${e}
                            </table>
                        </div>
                    </div>
                `}()),s("#bwm-settings"),settings.forEach(t=>{$(`#bwm_settings_${t.name}`).val(getLocalStorage("BWM_SETTINGS",t.name)),$(`#bwm_settings_${t.name}`).change(function(){updateLocalStorage("BWM_SETTINGS",t.name,$(this).val())}),window[t.name]="true"==getLocalStorage("BWM_SETTINGS",t.name)})}),$("#bwm-mug").click(function(){$("#bwm").children(":last").remove(),$("#bwm").append(`
                    <div id="mug_container" style="width: inherit">
                        <div id="mug-head" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                            <input type="text" id="mug-watchlist-id-input" placeholder="肥羊 ID" size="10" style="font-size: larger; padding: 5px; margin: 5px;" />
                            <button id="mug-watchlist-add-input" class="torn-btn" style="margin: 5px;">加入监视</button>
                        </div>
                        <div id="mug-watchlist" style="margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden;"></div>
                        <div id="mug-loglist" style="min-height:400px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>
                    </div>`),s("#bwm-mug");let i={};function a(){var t=window.localStorage.getItem("muglog-watchlist");if(null!=t){var a,n=JSON.parse(t);let e=`
                        <table id="mug-watchlist-table" style=" background-color: white; font-size:12px; margin:auto;"><tr class="mug-watchlist-table-head"><th>Victim ID</th><th>Victim Name</th><th>Total Mugged</th><th>删除</th></tr>`;for(a in n){let t="$0";a in i&&(t=formatMoney(i[a].amount)),e+=`
                                <tr class="mug-watchlist-table-content">
                                    <td class="mug-watchlsit-victimid">${a}</td>
                                    <td><a class="user name" href="/profiles.php?XID=${a}" target="_blank">${n[a].name}</a></td>
                                    <td>${t}</td>
                                    <td><a class="mug-watchlist-delete" role="button" style="cursor: pointer; color: darkblue;">删除</a></td>
                                </tr>`}e+="</table>",$("#mug-watchlist").append(e),$("#mug-watchlist-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),$("#mug-watchlist-table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;")}$(".mug-watchlist-delete").click(function(){var t=$(this).parent().parent().children(".mug-watchlsit-victimid").text();deleteLocalStorage("muglog-watchlist",t),$(this).parent().parent().remove(),console.log("删除成功 "+t)})}!function(){var e=window.localStorage.getItem("muglog");if(null!=e){var a,n=JSON.parse(e);let t="</table>";for(a in n){var o=n[a].victim_id;o in i?i[o].amount+=formatMoney(n[a].money_mugged):i[o]={name:n[a].victim_name,amount:formatMoney(n[a].money_mugged)},t=`
                                <tr class="mug-loglist-table-content">
                                    <td class="mug-loglist-ts">${a}</td>
                                    <td class="mug-loglist-time">${n[a].timestring}</td>
                                    <td class="mug-loglist-victimid">${n[a].victim_id}</td>
                                    <td class="mug-loglist-victimname"><a class="user name" href="/profiles.php?XID=${n[a].victim_id}" target="_blank">${n[a].victim_name}</a></td>
                                    <td class="mug-loglist-amount" title="${n[a].timestring}">${n[a].money_mugged}</td>
                                    <td><a class="mug-loglist-watch" role="button" style="cursor: pointer; color: darkblue;">监视</a></td>
                                    <td><a class="mug-loglist-delete" role="button" style="cursor: pointer; color: darkblue;">删除</a></td>
                                </tr>`+t}t=`
                            <table id="mug-loglist-table" style=" background-color: white; font-size:12px; margin: auto;">
                                <tr class="mug-loglist-table-head">
                                    <th class="mug-loglist-ts">Timestamp</th>
                                    <th class="mug-loglist-time">Time</th>
                                    <th class="mug-loglist-victimid">Victim ID</th>
                                    <th class="mug-loglist-victimname">Victim Name</th>
                                    <th class="mug-loglist-amount">Money Mugged</th>
                                    <th>监视</th><th>删除</th>
                                </tr>`+t,$("#mug-loglist").append(t)}$("#mug-loglist-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),$("#mug-loglist-table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),$("#mug_container")[0].clientWidth<400&&($(".mug-loglist-ts").hide(),$(".mug-loglist-victimid").hide(),$(".mug-loglist-time").hide())}(),a(),$(".mug-loglist-delete").click(function(){var t=$(this).parent().parent().children(".mug-loglist-ts").text();deleteLocalStorage("muglog",t),$(this).parent().parent().remove(),console.log("删除成功 "+t)}),$(".mug-loglist-watch").click(function(){var t=$(this).parent().parent().children(".mug-loglist-victimid").text();updateLocalStorage("muglog-watchlist",t,{name:$(this).parent().parent().children(".mug-loglist-victimname").text()}),$("#mug-watchlist-table").remove(),a(),console.log("监视成功 "+t)}),$("#mug-watchlist-add-input").click(function(){const e=$("#mug-watchlist-id-input").val();var t;isNaN(e)||0==e||""==e?alert("无效ID"):(t=`https://api.torn.com/user/${e}?selections=profile&key=${APIKey}`,fetch(t).then(t=>t.json()).then(t=>{if(console.log("API fetched"),null!=t.error&&6==t.error.code)throw alert("无效ID "+e),new Error("Incorrect ID");updateLocalStorage("muglog-watchlist",e,{name:t.name}),$("#mug-watchlist-table").remove(),a(),alert("监视成功 "+t.name+"["+e+"]"),console.log("监视成功 "+t.name+"["+e+"]")}).catch(t=>console.log("fetch error: ",t.message)))})}),$("#bwm-return").click(function(){$("#bwm").slideUp("slow",function(){$("#bwm").remove()})}),$("#bwm-warroom").click(function(){$("#bwm").children(":last").remove(),$("#bwm").append(`
                    <div id="bwm_warroom_container" style="width:inherit;">
                        <div id="bwm_warroom_header" style="margin:10px 0px; border:1px solid darkgray;text-align:center;">
                            <span id="bwm_warroom_counter" style="margin:5px;padding:5px;"></span>
                            <span style="font-size: large;">WAR ROOM</span>
                            <button class="torn-btn" id="warroom-btn" style="margin:5px;padding:5px;">更多详情</button>
                        </div>
                        <div id="bwm_warroom_filter" style="margin:10px 0px; border:1px solid darkgray; padding: 5px; text-align:center;">
                        </div>
                        <div id="bwm_warroom_wrapper" style="margin:10px 0px; overflow:hidden;">
                        </div>
                    </div>`),s("#bwm-warroom");let e=[];!function(){const t=`https://api.torn.com/torn/?selections=territorywars&key=${APIKey}`,e=$("#bwm_warroom_filter");e.text("---探测中---"),fetch(t).then(t=>t.ok?t.json():void e.text("---探测失败---"),t=>{e.text("---网络异常---")}).then(t=>{null!=t&&e.text("---探测完成---"),$("#bwm_warroom_counter").text("(当前存在 "+Object.keys(t.territorywars).length+" 场战斗)"),$.each(t.territorywars,function(t,e){var a=function(t,e){let a=Math.abs(parseInt((new Date).getTime()/1e3)-t);e=parseInt(100*a/e);let n="";86400<=a&&(n+=parseInt(a/86400)+"天",a%=86400);3600<=a&&(n+=parseInt(a/3600)+"时",a%=3600);60<=a&&(n+=parseInt(a/60)+"分",a%=60);return n+=a+"秒",[n,e]}(e.started,259200);$("#bwm_warroom_wrapper").append(`
                                    <div class="ttwar" style="width:279px; float:left; border:1px solid darkgray; padding: 5px 2px;margin:5px 2px;background-color:white;background-image: linear-gradient(rgba(192,84,47,0.8),rgba(192,84,47,0.5));">
                                        <div class="ttwar-title" style="overflow:hidden;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><button class="torn-btn">${t}</button></div>
                                            <div style="width:100px; float:left; text-align:center; margin:11px 3px;"><b>进攻方</b></div>
                                            <div style="width:100px; float:left; text-align:center; margin:11px 3px;"><b>防守方</b></div>
                                        </div>
                                        <div class="ttwar-faction" style="overflow:hidden;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>帮派ID</b></div>
                                            <div class="factionid" style="width:100px; float:left; text-align:center; margin:5px 3px;"><a href="/factions.php?step=profile&ID=${e.assaulting_faction}">${e.assaulting_faction}</a></div>
                                            <div class="factionid" style="width:100px; float:left; text-align:center; margin:5px 3px;"><a href="/factions.php?step=profile&ID=${e.defending_faction}">${e.defending_faction}</a></div>
                                        </div>
                                        <div class="ttwar-factionname" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>帮派名称</b></div>
                                            <div class="faction-${e.assaulting_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px; overflow:hidden; text-overflow:ellipsis;     white-space:nowrap;"></div> 
                                            <div class="faction-${e.defending_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px; overflow:hidden; text-overflow:ellipsis;  white-space:nowrap;"></div>  
                                        </div>
                                        <div class="ttwar-factiontag" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>帮派缩写</b></div>
                                            <div class="faction-${e.assaulting_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                            <div class="faction-${e.defending_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                        </div>
                                        <div class="ttwar-factionresp" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>帮派声望</b></div>
                                            <div class="faction-${e.assaulting_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                            <div class="faction-${e.defending_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                        </div>
                                        <div class="ttwar-hospitalcount" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>医院人数</b></div>
                                            <div class="faction-${e.assaulting_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                            <div class="faction-${e.defending_faction}" style="width:100px; float:left; text-align:center; margin:5px 3px;"></div>
                                        </div>
                                        <div class="ttwar-score" style="overflow:hidden; display:none;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>当前分数</b></div>
                                            <div class="territory-${t}" style="width:206px; float:left; text-align:center; margin:5px 3px;"></div>
                                        </div>
                                        <div class="ttwar-score-pbar" style="overflow:hidden; display:none;">
                                            <div class="faction-${e.assaulting_faction}" style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>分数进度</b></div>
                                            <div class="territory-${t}" style="width:212px; height:16px; margin:3px; float:left; text-align:center; overflow:hidden; background-color:#ddd;"></div>
                                        </div>
                                        <div class="ttwar-time" style="overflow:hidden;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>时间已过</b></div>
                                            <div style="width:206px; float:left; text-align:center; margin:5px 3px;">${a[0]}</div>
                                        </div>
                                        <div class="ttwar-time-pbar" style="overflow:hidden;">
                                            <div style="width:55px; float:left; text-align:center; margin:5px 3px;"><b>时间进度</b></div>
                                            <div style="width:212px; height:16px; margin:3px; float:left; text-align:center; overflow:hidden; background-color:#ddd;">${percentHtml(16,a[1],"#5580a0","white",a[1]+"%")}</div>
                                        </div>
                                    </div>`)})}).catch(t=>console.log("fetch error: ",t.message))}(),$("#warroom-btn").click(function(){$(".factionid").each(function(){var t=$(this).text();-1==e.indexOf(t)&&e.push(t)}),90<e.length&&(e=e.slice(0,90)),$.each(e,function(t,e){!function(t,e){const a=`https://api.torn.com/faction/${t}?selections=basic&key=${APIKey}`,n=$("#bwm_warroom_filter");n.text("---探测中---"),fetch(a).then(t=>t.ok?t.json():void n.text("---探测失败---"),t=>{n.text("---网络异常---")}).then(t=>{null!=t&&n.text("---探测完成---");let a=0;$.each(t.members,function(t,e){"Hospital"==e.status.state&&(a+=1)}),t.hospital_count=a,e(t)}).catch(t=>console.log("fetch error: ",t.message))}(e,function(i){console.log("api fetched"),$.each(i.territory_wars,function(t,e){var a=e.territory,n=e.score+" / "+e.required_score;$(".ttwar-score").children(".territory-"+a).text(n);n=parseInt(100*e.score/e.required_score),e=percentHtml(16,n,"#499360","white",n+"%");$(".ttwar-score-pbar").children(".territory-"+a).html(e);n=(i.hospital_count/500).toFixed(2);const o=$(".territory-"+a).parent().parent().css("background-image");e=o.split(",")[3].replace(")",""),n=Number(e)+Number(n);$(".territory-"+a).parent().parent().css("background-image","linear-gradient(rgba(192,84,47,"+n+"),rgba(192,84,47,0.5))")}),$(".ttwar-factionname").children(".faction-"+e).text(i.name),$(".ttwar-factiontag").children(".faction-"+e).text(i.tag),$(".ttwar-factionresp").children(".faction-"+e).text(toThousands(i.respect)),$(".ttwar-hospitalcount").children(".faction-"+e).text(i.hospital_count)})}),$("[class*='ttwar'][style*='none']").attr("style","overflow:hidden"),$(this).attr("disabled","true")})}),$("#bwm-revive").click(function(){$("#bwm").children(":last").remove(),$("#bwm").append(`
                    <div id="bwm_revive_container" style="width: inherit">
                        <div id="bwm_revive_header" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                                <input type="text" id="faction-input-id" name="faction-input-id" placeholder="多个帮派ID可以使用逗号分隔" size="30" style="font-size: larger; padding: 5px; margin: 5px;" />
                                <button id="revive-start-btn" class="torn-btn" style="margin:5px;">开始复活</button>
                                <button id="revive-stop-btn" class="torn-btn" style="margin:5px;" disabled>停止复活</button>
                        </div>
                        <div id="bwm_revive_filter" style="margin:10px 0px; border:1px solid darkgray; text-align:center; overflow: hidden;">
                            <div style="display: inline; margin:0px 15px;">
                                <span>每次刷新间隔</span>
                                <select id="bwm_revive_delay" style="padding:1px 0px;margin:8px 3px;">
                                    <option value="1" selected>1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                </select>
                                <span>秒</span>
                            </div>
                            <div style="display: inline; margin:0px 15px;">
                                <span>只显示Online</span>
                                <select id="bwm_revive_online_only" style="padding:1px 0px;margin:8px 3px;">
                                    <option value="false" selected>否</option>
                                    <option value="true">是</option>
                                </select>
                            </div>
                            <div style="display: inline; margin:0px 15px;">
                                <span>只显示Hospitalized</span>
                                <select id="bwm_revive_hosp_only" style="padding:1px 0px;margin:8px 3px;">
                                    <option value="false" selected>否</option>
                                    <option value="true">是</option>
                                </select>
                            </div>
                            <div style="display: inline; margin:0px 15px;">
                                <span>只显示在城内</span>
                                <select id="bwm_revive_town_only" style="padding:1px 0px;margin:8px 3px;">
                                    <option value="false">否</option>
                                    <option value="true" selected>是</option>
                                </select>
                            </div>
                        </div>
                        <div id="bmw_revive_tips" style="text-align:center; margin-bottom: 3px; font-size: 4px;"></div>
                        <div id="bmw_revive_wrapper" style="min-height:700px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden;">
                        </div>
                    </div>`),s("#bwm-revive");let d=!0,c=0,b=1;$("#revive-start-btn").click(function(){$("#bmw_revive_wrapper").empty(),$("#revive-start-btn").prop("disabled",!0),$("#revive-stop-btn").removeAttr("disabled"),$("#faction-input-id").prop("disabled",!0),$("#bwm_revive_delay").prop("disabled",!0),$("#bwm_revive_online_only").prop("disabled",!0),$("#bwm_revive_hosp_only").prop("disabled",!0),$("#bwm_revive_town_only").prop("disabled",!0),$("#bmw_revive_tips").text("即将开始刷新......"),d=!0,b=1;const t=$("#faction-input-id").val().trim().split(/,|，/).map(function(t,e,a){return t.trim()}),s=t.length||1;let e=new Array(s).fill(null);const l=1e3*$("#bwm_revive_delay").val();let m="";"true"==$("#bwm_revive_online_only").val()&&(m="Online");let f="";"true"==$("#bwm_revive_hosp_only").val()&&(f="Hospitalized");let u="";"true"==$("#bwm_revive_town_only").val()&&(u="town"),c=setTimeout(()=>{!function e(a,n,o){if(0==d||0==$("#bmw_revive_wrapper").length)$("#bmw_revive_wrapper").children(":last").remove(),$("#bmw_revive_wrapper").append(`<div style="overflow: hidden;"><div class="border-round" style="float: left; width:200px; padding: 2px 4px; margin: 2px 4px; background-color: ${bingwa_color_pool.purple}; color: white;">刷新结束 本次共完成了 ${b-1} 次刷新</div></div>`);else{const g=a[o];let t=0;o<a.length-1&&(t=o+1);const h=n[o];var i=`https://api.torn.com/faction/${g}?selections=basic&key=${APIKey}`;const r=$("#bmw_revive_tips");r.text("---探测中 "+g+"---"),fetch(i).then(t=>t.ok?t.json():void r.text("---探测失败 "+g+"---"),t=>{r.text("---网络异常 "+g+"---")}).then(p=>{console.log(`faction: ${g} | delay: ${l/1e3}s | online: ${$("#bwm_revive_online_only").val()} | hosp: ${$("#bwm_revive_hosp_only").val()} | town: ${$("#bwm_revive_town_only").val()}`),n[o]=p,$("#bmw_revive_wrapper").children(":last").remove(),$.each(p.members,function(t,e){const a=e.last_action.status;let n=bingwa_color_pool.yellow;"Online"==a?n=bingwa_color_pool.green:"Offline"==a&&(n=bingwa_color_pool.gray);var o=colLastAction(e.last_action.timestamp),i=e.status.description;const r=e.status.details,s=e.status.state;var l=e.status.until,d=e.status.color;const c=colHospitalTime(i,s,l);var o=`
                                            <div style="overflow: hidden;">
                                                <div class="border-round" style="float: left; width:80px; padding: 2px 4px; margin: 2px 4px; background-color: ${bingwa_color_pool.purple}; color: white;">第${b}次刷新</div>
                                                <div class="border-round" style="float: left; width:35px; padding: 2px 4px; margin: 2px 4px; background-color: ${n}; color: white;">${a}</div>
                                                <div class="border-round" style="float: left; width:35px; padding: 2px 4px; margin: 2px 4px; background-color: ${bingwa_color_pool.pink};">
                                                    <a href="/factions.php?step=profile&ID=${g}" style="text-decoration: none; color: white;" target="_blank">${p.tag}</a>
                                                </div>                       
                                                <div class="border-round" style="float: left; width:90px; padding: 2px 4px; margin: 2px 4px; background-color: ${bingwa_color_pool.blue};">
                                                    <a href="/profiles.php?XID=${t}" style="text-decoration: none; color: white;" target="_blank">${e.name}</a>
                                                </div>                        
                                                <div class="border-round" style="float: left; width:100px; padding: 2px 4px; margin: 2px 4px; background-color: ${bingwa_color_pool.green}; color: white;">上次在线 ${o[1]}</div>                     
                                                <div class="border-round" style="float: left; width:100px; padding: 2px 4px; margin: 2px 4px; background-color: ${bingwa_color_pool.red}; color: white;">入院时间 ${c[0]}</div>                     
                                                <div class="border-round" style="float: left; width:300px; padding: 2px 4px; margin: 2px 4px; color:#ccc;background-color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${r}</div>
                                            </div>`;0==s.indexOf("Hospital")&&(0!=a.indexOf(m)||0!=r.indexOf(f)||0!=c[2].indexOf(u)||null!=h&&h.members[t].status.until==l||$("#bmw_revive_wrapper").append(o))}),b+=1,$("#bmw_revive_wrapper").append(`<div style="overflow: hidden;"><div class="border-round" style="float: left; width:80px; padding: 2px 4px; margin: 2px 4px; background-color: ${bingwa_color_pool.purple}; color: white;">第${b}次刷新</div></div>`),c=setTimeout(()=>{e(a,n,t)},l*s)}).catch(t=>console.log("fetch error",t))}}(t,e,0)},l*s)}),$("#revive-stop-btn").click(function(){d=!1,clearTimeout(c),$("#revive-stop-btn").prop("disabled",!0),setTimeout(()=>{$("#revive-start-btn").removeAttr("disabled"),$("#faction-input-id").removeAttr("disabled"),$("#bwm_revive_delay").removeAttr("disabled"),$("#bwm_revive_online_only").removeAttr("disabled"),$("#bwm_revive_hosp_only").removeAttr("disabled"),$("#bwm_revive_town_only").removeAttr("disabled"),$("#bmw_revive_wrapper").children(":last").remove(),$("#bmw_revive_wrapper").append(`<div style="overflow: hidden;"><div class="border-round" style="float: left; width:200px; padding: 2px 4px; margin: 2px 4px; background-color: ${bingwa_color_pool.purple}; color: white;">刷新结束 本次共完成了 ${b-1} 次刷新</div></div>`)},1e3)})}),$("#bwm-rankedwar").click(function(){function g(t){t=Math.abs(parseInt((new Date).getTime()/1e3)-t);let e="";return e=86400<=t?parseInt(t/86400)+"天"+parseInt(t%86400/3600)+"小时":3600<=t?parseInt(t/3600)+"小时":60<=t?parseInt(t/60)+"分钟":t+"秒",e}$("#bwm").children(":last").remove(),$("#bwm").append(`
                    <div id="bwm_rw_container" style="width:inherit;">
                        <div id="bwm_rw_header" style="margin: 10px 0px; border: 1px solid darkgray; text-align: center;">
                            <span style="font-size: large;">RANKED WAR</span>
                        </div>
                        <div id="bwm_rw_filter" style="margin:10px 0px; padding: 5px; text-align: center;">
                        </div>
                        <div id="bwm_rw_wrapper" style="margin:10px 0px; text-align: center; overflow: hidden; overflow-x: auto;">
                        </div>
                    </div>`),s("#bwm-rankedwar"),function(){const t=`https://api.torn.com/torn/?selections=rankedwars&key=${APIKey}`,e=$("#bwm_rw_filter");e.text("---探测中---"),fetch(t).then(t=>t.ok?t.json():void e.text("---探测失败---"),t=>{e.text("---网络异常---")}).then(t=>{null!=t&&("error"in t?e.text(`--- API错误 --- code: ${t.error.code} error: ${t.error.error}`):"rankedwars"in t&&(e.text("---探测成功---"),$("#bwm_rw_wrapper").append(`
                                    <table class="rankedwar-records" style="width: 100%; margin: auto;">
                                        <tr class="head">
                                            <th class="war">ID</th>
                                            <th class="team">获胜 / 领先方</th>
                                            <th class="team">分数</th>
                                            <th class="team">分数</th>
                                            <th class="team">失败 / 落后方</th>
                                            <th class="war">分差 / 目标</th>
                                            <th class="war">进度</th>
                                            <th class="war">状态</th>
                                            <th class="war">描述</th>
                                        </tr>
                                    </table>`),$(".rankedwar-records").find("th.war").attr("style","border: 1px solid #333;padding: 5px;background-color: #757947;color: white;font-weight: bold;text-align:center;"),$(".rankedwar-records").find("th.team").attr("style","border: 1px solid #333;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;"),$.each(t.rankedwars,function(t,e){var a=parseInt((new Date).getTime()/1e3);const n=Object.keys(e.factions),o=e.war.winner;let i=0,r=0,s="",l="",d="";var c=e.factions[n[0]].score,p=e.factions[n[1]].score;r=0<=n.indexOf(o.toString())?(s="已结束",l=`结束于 ${g(e.war.end)}前`,d="over",n[0]==o.toString()?(i=n[0],n[1]):(i=n[1],n[0])):a>=e.war.start?(s="战斗中",l=`战斗已持续${g(e.war.start)}`,d="warring",p<=c?(i=n[0],n[1]):(i=n[1],n[0])):(s="未开始",l=`即将开始于${g(e.war.start)}后`,d="notyet",i=n[0],n[1]);c=Math.abs(c-p),p=parseInt(100*c/e.war.target);$(".rankedwar-records").children().append(`
                                        <tr class="content">
                                            <td class="${d}"><a class="war-id" href="/war.php?step=rankreport&rankID=${t}" target="_blank">${t}</a></td>
                                            <td><a class="faction winning" href="/factions.php?step=profile&ID=${i}" target="_blank">${e.factions[i].name}</a></td>
                                            <td class="${d} score">${toThousands(e.factions[i].score)}</td>
                                            <td class="${d} score">${toThousands(e.factions[r].score)}</td>
                                            <td><a class="faction losing" href="/factions.php?step=profile&ID=${r}" target="_blank">${e.factions[r].name}</a></td>
                                            <td class="${d} score">${toThousands(c)} / ${toThousands(e.war.target)}</td>
                                            <td class="${d}">${p}%</td>
                                            <td class="${d}">${s}</td>
                                            <td class="${d}">${l}</td>
                                        </tr>
                                        `)}),$(".rankedwar-records").find("td").attr("style","border: 1px solid #333; padding: 5px; text-align: center; color: white; text-decoration: none;"),$(".rankedwar-records").find("a.faction").attr("style","color: white; text-decoration: none;"),$(".rankedwar-records").find("a.war-id").attr("style","color: #333; text-decoration: none;"),$(".rankedwar-records").find("td.over").css("background-color","#FFF5F7").css("color","#333"),$(".rankedwar-records").find("td.warring").css("background-color",bingwa_color_pool.yellow),$(".rankedwar-records").find("td.notyet").css("background-color",bingwa_color_pool.blue),$(".rankedwar-records").find("a.winning").parent().css("background-color",bingwa_color_pool.green),$(".rankedwar-records").find("a.losing").parent().css("background-color",bingwa_color_pool.red),$(".rankedwar-records").find("td.score").css("font-size","large")))})}()}),$("#bwm-crimeexp").click(function(){function c(t,e){$("#crimeexp-status").text(t),$("#crimeexp-status").css("color",e?"red":"")}$("#bwm").children(":last").remove(),$("#bwm").append(`
                        <div style="width: inherit">
                            <div style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                                <button id="crimeexp-start-btn" class="torn-btn" style="margin:5px;">读取日志 (很慢, 请耐心等待)</button>
                                <a id="crimeexp-export-btn" download="crimeexp.json" class="torn-btn disabled" style="margin:5px; display:inline-block;">导出原始数据</a>
                            </div>
                            <div style="min-height: 300px; margin:10px 0px; border:1px solid darkgray; text-align:center; overflow:hidden; overflow-x: auto;">
                                <table id="crimeexp-table" style="margin: 5px auto; background-color: white; font-size: 12px; text-align: right;">
                                </table>
                                <div id="crimeexp-status" style="text-align: center; margin: 5px;"></div>
                            </div>
                            <div style="margin:10px 0px; padding: 10px; font-size: 100%; line-height: 1.6; color: #333; border:1px solid darkgray; overflow:hidden; overflow-x: auto;">
                                <p style="font-size: larger"><b>帮助冰蛙改进犯罪经验算法</b></p>
                                <p>1. <a href="/page.php?sid=log&log=5700,5710,5705,5715,5735,5725,5720,5730,6791,5360,5362,8965,6531,8842,8843,6253,6720,6722,6723,6243,6260,6262,6275,5100,4955">点这里跳转至日志页面</a></p>
                                <p>2. 点击日志页面的 "<b>导出所选日志</b>" 按钮，并耐心等待，完成后再次点击该按钮，将数据保存至文件</p>
                                <p>3. 将导出的文件通过 QQ 发送给 tobytorn [1617955]</p>
                                <br />
                                <p style="font-size: larger"><b>这份日志里包含了哪些数据？</b></p>
                                <p title="日志类型: 5700, 5710, 5705, 5715, 5735, 5725, 5720, 5730">* 犯罪记录</p>
                                <p title="日志类型: 6791">* OC 记录</p>
                                <p title="日志类型: 5360, 5362">* Bust 记录</p>
                                <p title="日志类型: 8965">* 复活节彩蛋活动中黑蛋拾取记录</p>
                                <p title="日志类型: 6531">* 工作特技获取犯罪经验记录</p>
                                <p title="日志类型: 8842, 8843">* Nerve Bar 上限变化记录</p>
                                <p title="日志类型: 6253, 6720, 6722, 6723">* 帮派进出记录</p>
                                <p title="日志类型: 6243, 6260, 6262, 6275">* 公司进出记录</p>
                                <p title="日志类型: 5100, 4955">* Merit 使用及重置</p>
                            </div>
                        </div>`),s("#bwm-crimeexp"),$("#crimeexp-start-btn").click(async function(){$("#crimeexp-start-btn").prop("disabled",!0),$("#crimeexp-export-btn").addClass("disabled"),$("#crimeexp-export-btn").attr("href","javascript:;"),$("#crimeexp-table").html(`<tbody>
                                    <tr><th>当前 NNB</th><td id="crimeexp-curr-nnb">-</td></tr>
                                    <tr><th>当前经验</th><td id="crimeexp-curr-ce">-</td></tr>
                                    <tr><th>当前时间</th><td id="crimeexp-curr-time">-</td></tr>
                                    <tr><th>上次<span class="crimeexp-last-upgrade-type">升级</span>时间</th><td id="crimeexp-last-upgrade-time">-</td></tr>
                                    <tr><th>升级进度</th><td id="crimeexp-upgrade-progress">-</td></tr>
                                    <tr title="最近三日平均, OC 除外"><th>每日经验</th><td id="crimeexp-daily-ce">-</td></tr>
                                    <tr><th>预估<span class="crimeexp-next-upgrade-type">升级</span>天数</th><td id="crimeexp-upgrade-est">-</td></tr>
                                </tbody>`),$("#crimeexp-table").tooltip({tooltipClass:"white-tooltip"}),$("#crimeexp-table th").attr("style","border: 1px solid darkgray; padding: 5px; font-weight: bold;"),$("#crimeexp-table td").attr("style","border: 1px solid darkgray; padding: 5px; min-width: 6em");const e={};try{var a=Math.floor((new Date).getTime()/1e3);$("#crimeexp-curr-time").text(new Date(1e3*a).format("yyyy-MM-dd")),c("正在读取当前 NNB");var n=await async function(){var t=await(await fetch(`https://api.torn.com/user/?selections=perks&key=${APIKey}`)).json();if("error"in t)throw new Error(t.error.error);var e=Object.values(t).flat().filter(t=>t.match(/[Mm]aximum nerve/)).map(t=>parseInt(t.match(/\d+/)[0])).reduce((t,e)=>t+e,0),t=await(await fetch(`https://api.torn.com/user/?selections=bars&key=${APIKey}`)).json();if("error"in t)throw new Error(t.error.error);t=t.nerve.maximum;return t-e}();e.nnb=n,$("#crimeexp-curr-nnb").text(n);var o=await async function(t){const e=await fetchAllLog([],[8842,8843],null,null,t);return e.map(t=>({timestamp:t.timestamp,diff:t.data.maximum_nerve_after-t.data.maximum_nerve_before})).filter(t=>5===Math.abs(t.diff))}(t=>{c(`正在读取 NNB 变化日志 (${new Date(1e3*t).format("yyyy-MM-dd")})`)});e.nnb_changes=[...o];var i,r,s=await async function(a,t,e){const n=new Set([5720,5725,5730,5735]),o=[],i=fetchAllLogGenerator([],[5700,5705,5710,5715,5720,5725,5730,5735,6791],null,t,e);for await(const l of i){let t="unknown";if(6791===l.log)t={1:"OC-Blackmail",2:"OC-Kidnapping",3:"OC-Bomb",4:"OC-PR",5:"OC-MT",6:"OC-CL",7:"OC-PH",8:"OC-PA"}[l.data.crime];else{const d=[1,7,17,29,34,39,47,53,58,62,69,72,74,77,81,83,85];var r=d.findIndex(t=>t>l.data.crime)+1,s=l.data.crime-d[r-2]+1;t=`${r}-${s}`}let e="unknown";5700===l.log?e="fail":5705===l.log?e="jail":5710===l.log?e="hospital":5715===l.log?e="money_loss":n.has(l.log)?e="success":6791===l.log&&(e="success"===l.data.result?"success":"fail");s={timestamp:l.timestamp,crime_name:t,result:e};if(o.push(s),Math.abs(l.timestamp-a[0].timestamp)<=2){s=g(s);if(0<s&&0<a[0].diff||s<0&&a[0].diff<0)break}for(;0<a.length&&l.timestamp<a[0].timestamp-1;)a.shift();if(0===a.length)break}return o}(o,a,t=>{c(`正在读取犯罪日志 (${new Date(1e3*t).format("yyyy-MM-dd")})`)});if(e.crime_records=s,0===o.length)return void c("糟糕！找不到最近一次 NNB 变化的时间，无法计算当前经验",!0);$("#crimeexp-last-upgrade-time").text(new Date(1e3*o[0].timestamp).format("yyyy-MM-dd"));let t=p[n];o[0].diff<0&&(t=p[n+5],$(".crimeexp-last-upgrade-type").text("降级"),$(".crimeexp-last-upgrade-type").css("color","red"));const{ce:l,daily_ce:d}=function(t,e,a){let n=t,o=0;for(const i of e){let t=g(i);t<0&&(t=i.timestamp<=1603152e3?-.01*n:Math.max(t,-.01*n)),n+=t,i.timestamp>=a-259200&&!i.crime_name.startsWith("OC")&&(o+=t)}return{ce:n,daily_ce:o/3}}(t,s,a);e.ce=l,$("#crimeexp-curr-ce").text(Math.floor(l)),n<60&&(i=(l-p[n])/(p[n+5]-p[n]),r=p[n+5]-l,$("#crimeexp-upgrade-progress").text(`${Math.floor(100*i)}%`),$("#crimeexp-upgrade-progress").attr("title",`还差 ${Math.floor(r)} 经验`)),$("#crimeexp-daily-ce").text(d.toFixed(1)),0<=d?n<60&&$("#crimeexp-upgrade-est").text(Math.floor((p[n+5]-l)/d)):($("#crimeexp-daily-ce").css("color","red"),10<n&&($(".crimeexp-next-upgrade-type").text("降级"),$(".crimeexp-next-upgrade-type").css("color","red"),$("#crimeexp-upgrade-est").text(Math.floor((p[n]-l)/d)))),c("完成！")}catch(t){console.trace(t),"Access level of this key is not high enough"===t.message?(c("权限不足！",!0),$("#crimeexp-status").append('<a href="/preferences.php#tab=api">请使用 Full Access 类型的 API Key</a>')):c(`出错啦！${t}`,!0)}finally{$("#crimeexp-start-btn").prop("disabled",!1),$("#crimeexp-export-btn").removeClass("disabled");n=`data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(e))}`;$("#crimeexp-export-btn").attr("href",n)}});const p={10:0,15:150,20:500,25:900,30:1500,35:2300,40:3500,45:5e3,50:6666,55:1e4,60:15e3};function g(t){let e=0;const{crime_name:a,result:n}=t;return e=a.startsWith("OC")?{"OC-PR":4,"OC-MT":12,"OC-CL":73,"OC-PH":144,"OC-PA":652}[a]||0:a.startsWith("2-")?.025:a.startsWith("3-")?.05:a.startsWith("4-")?.111:(e={"7-2":.333,"8-1":.2,"8-2":.3,"8-3":.3,"8-4":.3,"8-5":.2,"8-6":.3,"9-5":.5,"10-4":.666,"11-5":1,"11-6":1,"12-1":.666,"12-2":.3,"12-3":.3,"13-1":.6,"13-2":.7,"14-1":.6,"14-2":.8,"14-3":.7,"15-1":1.7,"15-2":2,"15-3":1.9,"15-4":1.9,"16-1":1.7,"16-2":2.6,"17-1":2.8,"17-2":2.9,"18-1":.7,"18-2":1.9}[a],void 0===e?.2:e),"success"===n?e:"jail"===n||"hospital"===n&&a.startsWith("15-")?-20*e:0}}),$("#bwm-extcenter").click(function(){function l(t){console.log(t),$("#extcenter-status").prepend(`<span style="display:block; margin:2px">${t}</span>`)}function d(t){console.log(t),$("#extcenter-status").prepend(`<span style="display:block; color:red; margin:2px">${t}</span>`)}function c(){function i(e,a){for(let t=0;t<e.length;t++)if(a===e[t].name)return t;return-1}let r=getLocalStorage("extcenter","installedSpecs")||[],s=getLocalStorage("extcenter","specs")??[],a="";r.forEach(t=>{var e=i(s,t.name);0<=e&&t.version!==s[e].version?a+=`<tr><td class="extcenter-name">${s[e].name}</td>
                                        <td>${s[e].author}</td><td>${t.version}(<span style="color:red">${s[e].version}</span>)</td>
                                        <td${s[e].detail?` title="${s[e].detail}"`:""}>${s[e].description}</td>
                                        <td><button class="extcenter-update-source" spec="${s[e].name}" style="margin:5px;">更新</button></td>
                                        </tr>`:a+=`<tr><td class="extcenter-name">${t.name}</td>
                                    <td>${t.author}</td><td>${t.version}</td>
                                    <td${t.detail?` title="${t.detail}"`:""}>${t.description}</td>
                                    <td><button class="extcenter-uninstall" spec="${t.name}" style="margin:5px;">卸载</button></td>
                                    </tr>`}),s.forEach(t=>{0<=i(r,t.name)||(a+=`<tr><td class="extcenter-name">${t.name}</td>
                                    <td>${t.author}</td><td>${t.version}</td>
                                    <td${t.detail?` title="${t.detail}"`:""}>${t.description}</td>
                                    <td><button class="extcenter-install" spec="${t.name}" style="margin:5px;">安装</button></td>
                                    </tr>`)}),$("#extcenter-table").html(a),$("#extcenter-table td").attr("style","border: 1px solid darkgray;padding: 5px"),$(".extcenter-install").attr("style",`background-color: ${bingwa_color_pool.blue}; color: white; border-radius:5px; cursor:pointer; padding:3px;`),$(".extcenter-update-source").attr("style",`background-color: ${bingwa_color_pool.green}; color: white; border-radius:5px; cursor:pointer; padding:3px;`),$(".extcenter-uninstall").attr("style",`background-color: ${bingwa_color_pool.orange}; color: #002152; border-radius:5px; cursor:pointer; padding:3px;`),$("#extcenter-table .extcenter-name").css("font-weight","bold"),$("#extcenter-table .extcenter-desc").css("min-width","200px"),$(".extcenter-install").click(async function(){try{var t=s[i(s,$(this).attr("spec"))],e=`https://gitee.com/ameto_kasao/BWExtensions/raw/master/extensions/${t.file}?${(new Date).getTime()}`;l(`${t.name} - ${t.version} 开始下载`);var a=await corsGet(e);if(console.log(a),l(`${t.name} - ${t.version} 下载完成`),userScriptEngine==UserScriptEngineEnums.PDA)return await navigator.clipboard.writeText(a),void l(`${t.name} - ${t.version} 源代码已复制到粘贴板, 请手动添加至PDA`);t.match&&!window.location.href.match(new RegExp(t.match))?l(`${t.name} - ${t.version} 在下次进入指定页面时会自动加载`):l(loadScript(t.name,t.version,a)?`${t.name} - ${t.version} 加载成功`:`${t.name} - ${t.version} 已经加载`),updateLocalStorage("extcenter-source",t.name,a),r.push(t),updateLocalStorage("extcenter","installedSpecs",r),c()}catch(t){d(t)}}),$(".extcenter-update-source").click(async function(){try{var t=i(r,$(this).attr("spec")),e=r[t],a=s[i(s,$(this).attr("spec"))],n=`https://gitee.com/ameto_kasao/BWExtensions/raw/master/extensions/${a.file}?${(new Date).getTime()}`;l(`${a.name} - ${a.version} 开始下载`);var o=await corsGet(n);console.log(o),l(`${a.name} - ${e.version} => ${a.version} 更新完成, 刷新后加载`),updateLocalStorage("extcenter-source",a.name,o),r[t]=a,updateLocalStorage("extcenter","installedSpecs",r),c()}catch(t){d(t)}}),$(".extcenter-uninstall").click(async function(){try{var t=i(r,$(this).attr("spec")),e=r[t];r.splice(t,1),deleteLocalStorage("extcenter-source",e.name),updateLocalStorage("extcenter","installedSpecs",r),c(),l(`${e.name} - ${e.version} 已删除`)}catch(t){d(t)}})}$("#bwm").children(":last").remove(),$("#bwm").append(`
                        <div style="width: inherit">
                            <div style="margin:10px 0px; border:1px solid darkgray; text-align:center;">
                                <button id="extcenter-update" class="torn-btn" style="margin:5px;">检查更新</button>
                                <button id="extcenter-clear" class="torn-btn" style="margin:5px;">清除缓存</button>
                                <a href="https://github.com/mirrorsysu/BWExtensions"><button id="extcenter-submit-code" class="torn-btn" style="margin:5px; float:right;">提交代码</button></a>
                            </div>
                            <div style="height:400px; margin:10px 0px; border:1px solid darkgray; text-align:center; overflow:hidden;">
                                <div style="height:300px; overflow:auto;">    
                                    <table id="extcenter-table" style="width:95%; margin: 5px auto; background-color: white; text-align: center;"></table>
                                </div>
                                <div id="extcenter-status" style="border-top:1px solid darkgray; text-align:center; margin:5px; padding:5px; max-height:100px; overflow:auto"></div>
                            </div>
                        </div>`),s("#bwm-extcenter"),c(),$("#extcenter-update").click(function(){l("开始更新"),corsGet(`https://gitee.com/ameto_kasao/BWExtensions/raw/master/specs.json?${(new Date).getTime()}`).then(t=>{console.log(t),l("更新完成");try{updateLocalStorage("extcenter","specs",JSON.parse(t)),c()}catch(t){d(t)}}).catch(t=>{d(t)})}),$("#extcenter-clear").click(function(){l("开始清理缓存"),deleteLocalStorageRootNode("extcenter"),l("已清除 extcenter"),deleteLocalStorageRootNode("extcenter-source"),l("已清除 extcenter-source"),c()})})}})}if(0<=window.location.href.indexOf("profiles.php")){const intervalID=setInterval(updateUI,500);function updateUI(){const c=$("div.profile-buttons div.profile-container div.empty-block");if(0<c.length){c.hasClass("profile-container-description")||c.addClass("profile-container-description"),clearInterval(intervalID),c.css({height:"75","padding-top":"5px","overflow-x":"auto"}),c.siblings(".buttons-wrap").css("padding","0px"),c.html("蛙蛙探测器工作中...");const t=$(".basic-information").find(".info-table").children(":first").children(".user-info-value").children().text();console.log(`user: ${t}`);const e=t?t.split("[")[0].trim():"",a=t?t.split("[")[1].replace("]","").trim():"",n=`/loader.php?sid=attack&user2ID=${a}`;$(".profile-status").children().children(".title-black").empty().append(`
                    <span class="border-round" style="color:white;background-color:#DAA520;padding:3px;text-shadow:none;">
                        <a href="${n}" style="color: white; text-decoration: none;">攻击</a></span>`);const o=isChatted(e);o?$(".profile-status").children().children(".title-black").append(`
                    <span class="border-round" style="color:white;background-color:${o[0]};padding:3px;margin-left:5px;">上次唠嗑: ${o[1]}</span>`):console.log("没唠过");const i=isMugged(a);if(console.log("mug_display_arr "+i),i){const r=i.split(",")[0],s=i.split(",")[1],l=i.split(",")[2];$(".profile-status").children().children(".title-black").append(`
                    <span class="border-round" style="color:white;background-color:${r};padding:3px;margin-left:5px;">上次mug: ${l} - ${s}</span>`)}else console.log("没mug过");wawaDetect(a,function(t){let e=parseInt(100*t.life.current/t.life.maximum);const a=t.life.current+"/"+t.life.maximum+" ("+e+"%)";let n="";n=e<=66?`
                        <div style="height:20px; overflow:hidden;">
                            ${percentHtml(20,e,"#c0542f","#FFF5F7",a)}
                        </div>`:(100<e&&(e=100),`
                        <div style="height:20px; overflow:hidden;">
                            ${percentHtml(20,e,"#5d9525","#FFF5F7",a)}
                        </div>`),c.html(`
                        <table style="width:100%; background-color: #FFF5F7;">
                            <tr>
                                <td class="bw-bs">战力</td>
                                <td colspan="3">${t.estimate_bs_display}</td>
                                <td class="bw-stat">XAN</td>
                                <td>${t.personalstats.xantaken||0}</td>
                                <td class="bw-other">活跃天数</td>
                                <td>${parseInt(t.estimate_active_days)||0}</td>
                            </tr>
                            <tr>
                                <td class="bw-bs">血量</td>
                                <td class="bw-hp" colspan="3">${n}</td>
                                <td class="bw-stat">LSD</td>
                                <td>${t.personalstats.lsdtaken||0}</td>
                                <td class="bw-other">估算WS</td>
                                <td>${formatNumber(t.estimate_ws)||0}</td>
                            </tr>
                            <tr>
                                <td class="bw-nw">资产</td>
                                <td>${formatNumber(t.personalstats.networth)}</td>
                                <td class="bw-nw">估算NNB</td>
                                <td>${t.estimate_nnb||10}</td>
                                <td class="bw-stat">SE</td>
                                <td>${t.personalstats.statenhancersused||0}</td>
                                <td colspan="2"><a class="t-blue" role="button" id="a_click_start_wawa" style="cursor: pointer">更多&gt;&gt;</a></td>
                            </tr>
                        </table>
                    `),c.find("td").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;"),c.find(".bw-bs").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #033649;color: white;font-weight: bold;"),c.find(".bw-nw").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #757947;color: white;font-weight: bold;"),c.find(".bw-other").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #725334;color: white;font-weight: bold;"),c.find(".bw-stat").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #458994;color: white;font-weight: bold;"),c.find(".bw-hp").attr("style","border: 2px solid darkgray; text-align:center;"),$("div.user-information-section:contains('Last action')").next().children("span").text(t.last_action_details);const o=$("div.profile-buttons.profile-action").html(),i=`
                <div>
                    <div class="title-black top-round">蛙蛙探测器&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <a class="t-white" role="button" id="a_click_start_wawa_back" style="cursor: pointer">返回</a>
                    </div>
                    <div class="cont bottom-round ">
                        <div class="profile-container basic-info bottom-round">
                            <table style="width:100%; min-height: 320px;">
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">估算战力</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.estimate_bs_display}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">Xanax数量</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.xantaken||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">SE数量</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.statenhancersused||0}</span></td>
                                </tr>
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">攻击胜率</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${formatNumber(t.attackWinRatio)||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">防守胜率</td>
                                    <td style="vertical-align:middle"><span class="bold">${formatNumber(t.defendWinRatio)||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">防守胜场</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.defendswon||0}</span></td>
                                </tr>
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">能量续满</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.refills||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">LSD数量</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.personalstats.lsdtaken||0}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">DP占比</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${formatNumber(t.donator_percent)}</span></td>
                                </tr>
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">活跃天数</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.estimate_active_days}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">日均嗑药</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.average_drugs}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">Booster</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${formatNumber(t.personalstats.boostersused)}</span></td>
                                </tr>
                                <tr>
                                    <td style="vertical-align:middle"><span class="bold">估算ACE</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.estimate_ace}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">估算NNB</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${t.estimate_nnb}</span></td>
                                    <td style="vertical-align:middle"><span class="bold">总资产</span></td>
                                    <td style="vertical-align:middle"><span class="bold">${formatNumber(t.personalstats.networth)}</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>`,r=function(){$("div.profile-buttons.profile-action").html(i),$("div.profile-status").hide(),$("#a_click_start_wawa_back").click(function(){$("div.profile-buttons.profile-action").html(o),$("div.profile-status").show(),$("#a_click_start_wawa").click(r)})};$("#a_click_start_wawa").click(r);let s=0;s+=t.enemies/10,s-=t.friends/20,s+=t.personalstats.moneymugged/2e8,s+=t.personalstats.bountiesreceived/50,s=parseInt(s);let l="",d="";d=s<=0?(l="大善人",bingwa_color_pool.yellowgreen):s<=10?(l="好人",bingwa_color_pool.blue):s<=100?(l="坏人",bingwa_color_pool.yellow):(l="大恶人",bingwa_color_pool.red),$("div.basic-information").find("ul.info-table").children("li:eq(9)").children("div.user-info-value").append(`
                &nbsp;<span class="border-round" style="padding:2px;background-color:${d};color:white;" title="0分及以下：大善人<br>1-10分：好人<br>11-100分：坏人<br>100分以上：大恶人">${l}</span>
                &nbsp;<span title="每有10个敌人加1分<br>每有20个朋友减1分<br>每mug200m加1分<br>每收到50次悬赏加1分"><b>坏比指数: ${s}</b></span>
                `)},function(t){c.html(t)})}}}function userListParade(n,t){let o=!0;if($("#parade_filter").length<=0){$(n).before('<div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">阅兵</div><div id="parade_filter" class="cont-gray bottom-rounded content" style="overflow:hidden"><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Level" checked="checked">Level</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="BS" checked="checked">BS</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Mugged" checked="checked">Mugged</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Rehab" checked="checked">Rehab</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Rank" checked="checked">Rank</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Job" checked="checked">Job</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Networth" checked="checked">Networth</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Bazaar">Bazaar</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Defendslost">Defendslost</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Property">Property</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Elimination">Elimination</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Signup">Signup</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Last" checked="checked">Last</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Status" checked="checked">Status</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Life">Life</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="input-wrap" style="margin:5px 10px;"><label for="nw">Bazaar价值 大于 </label><input id="parade_bazaar_value" type="text" style="margin:1px 5px; width:50px" value="10">M</div><div class="btn-wrap" style="margin:5px 10px;"><span class="btn"><button id="parade_start" class="torn-btn" style="margin:1px 5px;">开始阅兵</button></span><span class="btn"><button id="parade_stop" class="torn-btn" style="margin:1px 5px;">暂停阅兵</button></span></div></div></div>'),$("#parade_stop").prop("disabled",!0);const a=getLocalStorage("parade_option","checkbox_vals");var e=getLocalStorage("parade_option","text_vals");null!=a&&null!=a&&($("#parade_bazaar_value").val(e),$("#parade_filter input:checkbox").removeAttr("checked"),$("#parade_filter input:checkbox").each(function(t,e){0<=a.indexOf($(this).val())&&$(this).attr("checked","checked")}))}$("#parade_start").click(function(){o=!0;let e=$(t).children("li").first();if(e.length<=0)alert("未找到用户列表");else{const g=$("#parade_bazaar_value").val().replace(/[^\d]/g,"");let c=[];$("#parade_filter input:checkbox:checked").each(function(t,e){c.push($(this).val())}),console.log(c),$("#parade_filter input[type='checkbox']").prop("disabled",!0),$("#parade_filter input[type='text']").prop("disabled",!0),$(this).prop("disabled",!0),$("#parade_stop").removeAttr("disabled"),$("#parade_filter").css("background-color",bingwa_color_pool.blue);let t={};if(t.checkbox_vals=c,t.text_vals=g,window.localStorage.setItem("parade_option",JSON.stringify(t)),$("#search_parade_table").length<1){let e='<p id="search_parade_progress">阅兵进度</p><table id="search_parade_table" style="width:100%;background-color: white;font-size:12px;"><tr><th>Name</th>';for(let t=0;t<c.length;t++)e+=`<th>${c[t]}</th>`;e+="<th>Attack</th></tr></table>",$(n).before(e),$("#search_parade_table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;")}function a(){if("1"==e.attr("detected"))console.log("user detected"),p(0);else{e.attr("detected","1");const d=e.find("a[href^='/profiles.php?XID=']").attr("href").replace(/[^0-9|-]/gi,"");$("#search_parade_progress").text(`正在阅兵：${d}`),wawaDetect(d,function(t){let n="Closed",o=0,i=0;if(t.basicicons.icon35){n="Opened";const e=t.bazaar;null!=e&&e.map(function(t,e,a){o+=t.quantity*t.market_price,i+=t.quantity*t.price})}if("Federal"==t.status.state||"Fallen"==t.status.state)console.log("被封/去世，跳过"),$("#search_parade_progress").text(`阅兵：${d} 被封/去世，跳过`),p(1e3);else if(g&&o<1e6*g)console.log("太穷，跳过"),$("#search_parade_progress").text(`阅兵：${d} 太穷，跳过`),updateLocalStorage("battlestats",d,t.estimate_bs),p(1e3);else{let e={};e.Level=t.level,e.BS=formatNumber(t.estimate_bs),e.Mugged=formatNumber(t.personalstats.moneymugged),e.Rehab=formatNumber(t.personalstats.rehabcost||0),e.Rank=t.rank_title,e.Networth=formatNumber(t.personalstats.networth),e.Defendslost=t.personalstats.defendslost,e.Property=t.property,e.Signup=t.signup,e.Last=t.last_action_brief,e.Status=t.status.state,e.Elimination=null==t.competition?"":t.competition.team;const l=t.job.company_type;var r,s=t.job.position;0==l?e.Job=s:null!=(r=getLocalStorage("APICache_companies","companies"))&&null!=r?(e.Job=r[l.toString()].name,e.Job+="Director"==s?"(D)":"(E)"):e.Job=l,e.Life=parseInt(t.life.current/t.life.maximum*100)+"%",e.Bazaar='<span class="t-red">Closed</span>',"Opened"==n&&(e.Bazaar=`<a href="/bazaar.php?userId=${d}"><span class="t-green">${formatNumber(o)}</span><span class="t-red">/${formatNumber(i)}</span></a>`);let a=`<tr><td><a class="user name" href="/profiles.php?XID=${d}" target="_blank">${t.name}</a></td>`;for(let t=0;t<c.length;t++)a+=`<td>${e[c[t]]}</td>`;a+=`<td><a class="t-blue c-pointer h attack-act" href="/loader2.php?sid=getInAttack&user2ID=${d}" target="_blank">Attack</a></td></tr>`,console.log(`蛙蛙探测 userId ${d} 成功: ${a}`),$("#search_parade_table").append(a),$("#search_parade_table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),updateLocalStorage("battlestats",d,t.estimate_bs),p(1e3)}},function(t){console.log(`蛙蛙探测 userId: ${d} 失败`),p(1e3)})}}function p(t){e=$(e.nextAll(e[0].tagName)[0]),0<e.length&&1==o?(console.log(o),setTimeout(a,t)):(console.log("阅兵完成"),$("#search_parade_progress").text("阅兵完成"),$("#parade_filter input[type='checkbox']").removeAttr("disabled"),$("#parade_filter input[type='text']").removeAttr("disabled"),$("#parade_start").removeAttr("disabled"),$("#parade_stop").prop("disabled",!0),$("#parade_start").text("继续阅兵"),$("#parade_filter").css("background-color","#f2f2f2"))}console.log("阅兵开始"),a()}}),$("#parade_stop").click(function(){o=!1,console.log("阅兵暂停"),$("#search_parade_progress").text("阅兵暂停"),$("#parade_filter input[type='checkbox']").removeAttr("disabled"),$("#parade_filter input[type='text']").removeAttr("disabled"),$("#parade_start").removeAttr("disabled"),$("#parade_filter").css("background-color","#f2f2f2")})}if(foo&&0<=window.location.href.indexOf("page.php?sid=UserList")){userListParade("div.userlist-wrapper","ul.user-info-list-wrap");const userListInterval=setInterval(updateAdvanceSearchPage,500);function updateAdvanceSearchPage(){const t=$(".user-info-list-wrap").find(".user-icons");0<t.length&&t.each(function(){if("1"!=$(this).attr("hasdone")){$(this).attr("hasdone","1");const e=$(this).parent().siblings().children("a.user.name").find("[title]").attr("title");if(e){var t=isChatted(e.split("[")[0].trim());if(t){const a=$(this).children(".icons-wrap");a.width(a.width()-70),$(this).children(".icons-wrap").after(`
                                    <span class= "border-round" title="<strong>上次唠嗑: </strong>${t[1]}" style="float:left;width:54px;height:18px;padding:2px;margin:0px 3px;background-color:${t[0]};text-align:center;">
                                        <span style="font-size:12px;display:inline-block;vertical-align:middle;color:white;padding:2px;">${t[1]}</span>
                                    </span>`)}}}})}}if(foo&&0<=window.location.href.indexOf("index.php?page=people")){userListParade("div.travel-people","ul.users-list");let enemylist={};const watchlist=window.localStorage.getItem("muglog-watchlist");function getFactionID(t){const e=t.find("a.faction").attr("href");return e?e.substring(30):0}null!==watchlist&&void 0!==watchlist&&(enemylist=JSON.parse(watchlist));const intervalID=setInterval(updateUI,1e3);function updateUI(){const t=$("ul.users-list").children("li");0<t.length&&t.each(function(t,e){if("1"!=$(this).attr("oversea")){const a=getFactionID($(this)),n=$(this).find("a.name").attr("href").substring(18).trim();a in enemy_faction&&$(this).css("background-color","NavajoWhite"),a in friendly_faction&&$(this).css("background-color","DarkSeaGreen"),n in enemylist&&$(this).css("background-color",bingwa_color_pool.purple),$(this).attr("oversea","1")}})}}const tornDestination={Mexico:{name:"墨西",time:18},Cayman:{name:"开曼",time:25},Canada:{name:"加拿",time:29},Hawaii:{name:"夏威",time:94},Argentina:{name:"阿根",time:117},United:{name:"英国",time:111},Switzerland:{name:"瑞士",time:123},Japan:{name:"日本",time:158},China:{name:"中国",time:169},UAE:{name:"迪拜",time:190},South:{name:"南非",time:208}};function getLastActionMinutes(t){return $(t).find("div.days").attr("last-action-minutes")}function getHospitalMinutes(t){return $(t).find("div.status").attr("sort_score")}function getEstimateBS(t){return $(t).find("div.position").attr("estimate-bs")}function getLevel(t){return $(t).find("div.lvl").text()}function flyLevel(t){return $(t).find("td.table-level").text()}function flyOnline(t){return $(t).find("td.table-online").attr("code")}function flyNetworth(t){return $(t).find("td.table-networth").attr("networth")}function flyPosition(t){return $(t).find("td.table-position").text()}function flyDays(t){return $(t).find("td.table-days").text()}function flyLastActionMinutes(t){return $(t).find("td.table-last").attr("last-action-minutes")}function flyHospitalMinutes(t){return $(t).find("td.table-status").attr("hospital-minutes")}function flyEstimateBS(t){return $(t).find("td.table-bs").attr("estimate-bs")}function colBattleStats(t){let e=getLocalStorage("battlestats",t),a="",n="";return null!=e&&null!=e?(a=toThousands(e),n=formatNumber(e)):e=0,[e,a,n]}function colNetworth(t){let e=getLocalStorage("networths",t),a="";return null!=e&&null!=e?a=formatNumber(e):e=0,[e,a]}function colLastAction(t){const e=new Date;t=parseInt(parseInt(e.getTime()/1e3)-t);let a="";return a=60<=t&&t<3600?parseInt(t/60)+"m":3600<=t&&t<86400?parseInt(t/3600)+"h":86400<=t?parseInt(t/86400)+"d":t+"s",[t,a]}function colHospitalTime(n,o,i){let r=0,s="town";const l=new Date;n=n.split(" ");if("Abroad"==o)o="="+tornDestination[n[1]].name,r=0-tornDestination[n[1]].time;else if("Traveling"==o)1<n.length&&("Traveling"==n[0]?(o=">"+tornDestination[n[2]].name,r=0-tornDestination[n[2]].time):"Returning"==n[0]&&(o="<"+tornDestination[n[4]].name,r=0-tornDestination[n[4]].time));else if("Hospital"==o){i=parseInt(i-parseInt(l.getTime()/1e3));let t=parseInt(i/3600);t=t<10?"0"+t:t;let e=parseInt(i%3600/60);e=e<10?"0"+e:e;let a=i%60;a=a<10?"0"+a:a,"hospital"==n[1]?o=t+":"+e+":"+a:(o="海"+t+":"+e+":"+a,s="oversea"),r=i}return[o,r,s]}function facPageEnhanced(t){$("li.days").text("Last"),$("li.position").text("BattleStats");let i=200;0<$("li.position").length&&(i=window.getComputedStyle($("li.position")[0]).width.replace(/px$/g,""),console.log(i));var e=`https://api.torn.com/faction/${t}?selections=basic&key=${APIKey}`;fetch(e).then(t=>t.json()).then(o=>{console.log("facPageEnhanced "+t),$("li.table-row").each(function(){var t=$($(this).find("[class^=userWrap]")).children().attr("href").substring(18),e=colBattleStats(t);100<Number(i)?$($(this).find("div.position")).attr("estimate-bs",e[0]).children(":first").text(e[1]):$($(this).find("div.position")).attr("estimate-bs",e[0]).children(":first").text(e[2]);var a=colLastAction(o.members[t].last_action.timestamp);$($(this).find("div.days")).attr("last-action-minutes",a[0]).text(a[1]);var n=o.members[t].status.state,e=o.members[t].status.description,a=o.members[t].status.until,t=o.members[t].status.color,a=colHospitalTime(e,n,a);$($(this).find("div.status")).attr("sort_score",a[1]).html(`<span class="t-${t}">${a[0]}</span>`)})}).catch(t=>console.log("fetch error",t))}function tornStatsEffectiveness(t,e,a){let n=[0,0,0];var o=getLocalStorage("APICache_companies","companies");function i(t){return t[0]+t[1]<t[2]?2:t[0]>t[1]?0:1}function r(t){return 0<(t[0]-t[1])*(t[1]-t[2])?1:0<(t[0]-t[2])*(t[2]-t[1])?2:0}function s(t,e){return e/t<=1?e/t:1+(e-t)/t*.5}function l(t,e){if(0==t)return"";t=1.2*e/t;return t<1?"eff-red":t<2?"eff-yellow":"eff-green"}"unassigned"!=e&&null!=o&&null!=o&&(c=o[t].positions[e].man_required,p=o[t].positions[e].int_required,g=o[t].positions[e].end_required,n=[c,p,g]);var d,e=n[i(n)],c=a[i(n)],p=n[r(n)],g=a[r(n)];const h=.67*s(e,c)+.33*s(p,g),m=(d=h)<1?"eff-red":d<1.5?"eff-yellow":"eff-green",f=l(n[0],a[0]),u=l(n[1],a[1]),b=l(n[2],a[2]);p=Math.floor(Math.min(45,c/e*45*1.2)+Math.floor(Math.min(45,g/p*45*1.2)+Math.floor(Math.max(0,5*Math.log2(1.2*c/e)))+Math.floor(Math.max(0,5*Math.log2(1.2*g/p)))));return[h,m,f,u,b].concat(n).concat(p)}function getPositionValue(t){let e=0;t=getLocalStorage("EMPLOYEE_RANK",t);return null!=t&&null!=t&&(e=t),e}function arbeitDemo(t){var e=`https://api.torn.com/company/?selections=profile,employees&key=${APIKey}`;const a=$("#tips-view-company");a.text("---探测中---"),fetch(e).then(t=>t.ok?t.json():void a.text("---探测失败---"),t=>{a.text("---网络异常---")}).then(c=>{if(a.text("---探测完成---"),"error"in c)a.text(`---错误代码：${c.error.code} 错误：${c.error.error}---`);else if("company_employees"in c){$("#companyname").text(c.company.name),t.prepend(`
                    <table class="company-effectiveness" style="background-color: #FFF5F7;font-size:12px;margin:auto;">
                        <tr class="head">
                            <th class="employee-basic table-position">岗位</th>
                            <th class="employee-basic table-days">天</th>
                            <th class="employee-ws table-man">MAN</th>
                            <th class="employee-ws table-int">INT</th>
                            <th class="employee-ws table-end">END</th>
                            <th class="employee-effectiveness table-ws" title="Working Stats">属</th>
                            <th class="employee-effectiveness table-ep" title="Effectiveness Prediction">估</th>
                            <th class="employee-basic table-last">登</th>
                            <th class="employee-basic table-username">名字</th>
                            <th class="employee-effectiveness table-settled" title="Settled In">天</th>
                            <th class="employee-effectiveness table-merits" title="Merits">点</th>
                            <th class="employee-effectiveness table-education" title="Director Education">课</th>
                            <th class="employee-effectiveness table-management" title="Management">理</th>
                            <th class="employee-effectiveness table-addiction" title="Addiction">药</th>
                            <th class="employee-effectiveness table-total" title="Total">总</th>
                            <th class="employee-status table-tornstats">参</th>
                        </tr>
                    </table>`);const p=t.children(".company-effectiveness");p.find("th.employee-basic").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),p.find("th.employee-ws").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;"),p.find("th.employee-effectiveness").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #757947;color: white;font-weight: bold;text-align:center;"),p.find("th.employee-status").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #725334;color: white;font-weight: bold;text-align:center;");let a=[];$.each(c.company_employees,function(t,e){e.userid=t,e.position_rank=getPositionValue(t),a.push(e)}),a.sort(function(t,e){return t.position_rank-e.position_rank});const g={0:"",1:"eff-yellow",3:"eff-red"};$.each(a,function(t,e){var a=colLastAction(e.last_action.timestamp),n=172800<=a[0]?3:86400<=a[0]?1:0,o=e.effectiveness.addiction||0,i=o<=-10?3:o<=-5?1:0,r=e.effectiveness.merits||0,s=r<=2?3:r<=4?1:0,l=n+i+s,d=3<=l?3:1<=l?1:0,l=tornStatsEffectiveness(c.company.company_type,e.position,[e.manual_labor,e.intelligence,e.endurance]);p.children().append(`
                        <tr class="content">
                            <td class="table-position tleft" position-value="${e.position_rank}">${e.position}</td>
                            <td class="table-days">${e.days_in_company}</td>
                            <td class="table-man tright ${l[2]}" man="${e.manual_labor}" title="MAN Required: ${toThousands(l[5])}">${formatWS(e.manual_labor)}</td>
                            <td class="table-int tright ${l[3]}" int="${e.intelligence}" title="INT Required: ${toThousands(l[6])}">${formatWS(e.intelligence)}</td>
                            <td class="table-end tright ${l[4]}" end="${e.endurance}" title="END Required: ${toThousands(l[7])}">${formatWS(e.endurance)}</td>
                            <td class="table-ws">${e.effectiveness.working_stats||0}</td>
                            <td class="table-ep">${l[8]}</td>
                            <td class="table-last ${g[n]}" last-action-minutes="${a[0]}">${a[1]}</td>
                            <td class="table-username ${g[d]}"><a class="user name" href="/profiles.php?XID=${e.userid}" target="_blank">${e.name}</a></td>
                            <td class="table-settled">${e.effectiveness.settled_in||0}</td>
                            <td class="table-merits ${g[s]}">${r}</td>
                            <td class="table-education">${e.effectiveness.director_education||0}</td>
                            <td class="table-management">${e.effectiveness.management||0}</td>
                            <td class="table-addiction ${g[i]}">${o}</td>
                            <td class="table-total"><b>${e.effectiveness.total||0}</b></td>
                            <td class="table-tornstats tright ${l[1]}" effectiveness="${l[0]}"><span>${(100*l[0]).toFixed(0)}%</span></td>
                        </tr>`)}),p.find("th").css("cursor","pointer"),p.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),p.find("td.tright").css("text-align","right"),p.find("td.tleft").css("text-align","left"),p.find("td.eff-green").css("background-color","#D0E9C6"),p.find("td.eff-yellow").css("background-color","#FAF2CC"),p.find("td.eff-red").css("background-color","#EBCCCC"),clickTableHeadSort(p.find("th.table-position"),getEmployeesPosition),clickTableHeadSort(p.find("th.table-days"),getEmployeesDays),clickTableHeadSort(p.find("th.table-man"),getEmployeesMan),clickTableHeadSort(p.find("th.table-int"),getEmployeesInt),clickTableHeadSort(p.find("th.table-end"),getEmployeesEnd),clickTableHeadSort(p.find("th.table-ws"),getEmployeesWs),clickTableHeadSort(p.find("th.table-settled"),getEmployeesSi),clickTableHeadSort(p.find("th.table-merits"),getEmployeesMe),clickTableHeadSort(p.find("th.table-education"),getEmployeesDe),clickTableHeadSort(p.find("th.table-management"),getEmployeesMa),clickTableHeadSort(p.find("th.table-addiction"),getEmployeesAd),clickTableHeadSort(p.find("th.table-total"),getEmployeesTo),clickTableHeadSort(p.find("th.table-last"),flyLastActionMinutes),clickTableHeadSort(p.find("th.table-tornstats"),getEmployeesTornstats)}}).catch(t=>console.log("fetch error",t))}function employeesDemo(P){let N=getLocalStorageRootNode("company-history-items"),O=0;N&&(O=Object.keys(N).length);const t=new Date,C=new Date(new Date(t.setDate(t.getDate()-1)).setHours(t.getHours()-2)).format("yyyy-MM-dd"),L=getLocalStorage("company-history-items",C);const R=getLocalStorage("company-history-items",new Date(t.setDate(t.getDate()-1)).format("yyyy-MM-dd"));if(null===P){if(O<=0)return void console.log("没有历史数据，跳过自动获取公司产量数据");if(L)return void console.log("本次产量数据已存过，跳过自动获取公司产量数据");console.log("本次产量数据还没存过，将自动获取公司产量数据")}var e=`https://api.torn.com/company/?selections=profile,employees,stock,detailed,news&key=${APIKey}`;const z=$("#tips-view-company");z.text("---探测中---"),fetch(e).then(t=>t.ok?t.json():void z.text("---探测失败---"),t=>{z.text("---网络异常---")}).then(h=>{console.log(h);var t=h.company_detailed.trains_available,{rating:e,company_type:a}=h.company;let n=0;var o=getLocalStorage("APICache_companies","companies");if(o&&o[a]&&o[a].positions)for(const F in h.company_employees){var i=h.company_employees[F];"Trainer"===o[a].positions[i.position].special_ability&&n++}var r=t+e+3*n;let s=`${t}(当前)+${e}(星级)`;if(0<n&&(s+=`+0~${3*n}(Trainer)`),20<r&&$("#bingwa-top-warn").append(`
                            <div class="info-msg border-round">
                                <i class="info-icon"></i>
                                <div class="delimiter">
                                <div class="msg right-round" tabindex="0" role="alert">
                                    trains即将溢出。
                                    ${s}
                                </div>
                                </div>
                            </div>`),P){if(null!=h.error&&7==h.error.code)throw z.text("---员工无权限查看---"),new Error("not a director");null!=h&&z.text("---探测完成---"),$("#companyname").text(h.company.name),P.append(`
                    <table class="company-effectiveness" style="width:100%;background-color: #FFF5F7;font-size:12px;">
                        <tr class="head">
                            <th class="employee-basic table-position">岗位</th>
                            <th class="employee-basic table-days">天</th>
                            <th class="employee-ws table-man">MAN</th>
                            <th class="employee-ws table-int">INT</th>
                            <th class="employee-ws table-end">END</th>
                            <th class="employee-effectiveness table-ws" title="Working Stats">属</th>
                            <th class="employee-effectiveness table-ep" title="Effectiveness Prediction">估</th>
                            <th class="employee-basic table-last">登</th>
                            <th class="employee-basic table-username">名字</th>
                            <th class="employee-effectiveness table-settled" title="Settled In">天</th>
                            <th class="employee-effectiveness table-merits" title="Merits">点</th>
                            <th class="employee-effectiveness table-education" title="Director Education">课</th>
                            <th class="employee-effectiveness table-management" title="Management">理</th>
                            <th class="employee-effectiveness table-addiction" title="Addiction">药</th>
                            <th class="employee-effectiveness table-inactivity" title="Inactivity">离</th>
                            <th class="employee-effectiveness table-total" title="Total">总</th>
                            <th class="employee-effectiveness table-wage" title="Wage">薪</th>
                            <th class="employee-status table-tornstats">参</th>
                        </tr>
                    </table><br /><br />
                    <table class="company-history" style="width:100%;background-color: #FFF5F7;font-size:12px;">
                        <tr class="head">
                            <th colspan=2>生产日期</th>
                            <th>收入</th>
                            <th>工资</th>
                            <th>广告费</th>
                            <th>利润</th>
                            <th>总效率</th>
                            <th>产量</th>
                            <th>销量</th>
                            <th>库存</th>
                            <th>单价</th>
                            <th>成本</th>
                            <th>记录时间</th>
                        </tr>
                    </table>`);const I=P.find(".company-effectiveness");I.find("th.employee-basic").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),I.find("th.employee-ws").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;"),I.find("th.employee-effectiveness").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #757947;color: white;font-weight: bold;text-align:center;"),I.find("th.employee-status").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #725334;color: white;font-weight: bold;text-align:center;")}let l='<br /><table class="company-stock" style="width:100%;background-color: #FFF5F7;font-size:12px;"><tr class="head"><th>库存种类</th>';$.each(h.company_stock,function(t,e){l+=`<th>${t}</th>`}),l+='</tr><tr class="content"><td class="stock-title">单价</td>',$.each(h.company_stock,function(t,e){l+=`<td class="stock-content">${toThousands(e.price)}</td>`}),l+='</tr><tr class="content"><td class="stock-title">SOLD WORTH</td>',$.each(h.company_stock,function(t,e){l+=`<td class="stock-content">${toThousands(e.sold_worth)}</td>`}),l+='</tr><tr class="content"><td class="stock-title">SOLD AMOUNT</td>',$.each(h.company_stock,function(t,e){l+=`<td class="stock-content">${toThousands(e.sold_amount)}</td>`}),l+="</tr></table>",$(".company-effectiveness").after(l),$(".company-stock").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),$(".company-stock").find("td.stock-content").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),$(".company-stock").find("td.stock-title").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;");let d=[];$.each(h.company_employees,function(t,e){e.userid=t,e.position_rank=getPositionValue(t),d.push(e)}),d.sort(function(t,e){return t.position_rank-e.position_rank});const m={0:"",1:"eff-yellow",3:"eff-red"};let f=0,u=0;$.each(d,function(t,e){if(f+=e.wage||0,u+=e.effectiveness.total||0,null===P)return!0;var a=colLastAction(e.last_action.timestamp),n=172800<=a[0]?3:86400<=a[0]?1:0,o=e.effectiveness.addiction||0,i=o<=-10?3:o<=-5?1:0,r=e.effectiveness.inactivity||0,s=r<0?3:0,l=e.effectiveness.merits||0,d=l<=2?3:l<=4?1:0,c=n+i+d,p=3<=c?3:1<=c?1:0,c=tornStatsEffectiveness(h.company.company_type,e.position,[e.manual_labor,e.intelligence,e.endurance]),c=`
                    <tr class="content">
                        <td class="table-position tleft" position-value="${e.position_rank}">${e.position}</td>
                        <td class="table-days">${e.days_in_company}</td>
                        <td class="table-man tright ${c[2]}" man="${e.manual_labor}" title="MAN Required: ${toThousands(c[5])}">${formatWS(e.manual_labor)}</td>
                        <td class="table-int tright ${c[3]}" int="${e.intelligence}" title="INT Required: ${toThousands(c[6])}">${formatWS(e.intelligence)}</td>
                        <td class="table-end tright ${c[4]}" end="${e.endurance}" title="END Required: ${toThousands(c[7])}">${formatWS(e.endurance)}</td>
                        <td class="table-ws">${e.effectiveness.working_stats||0}</td>
                        <td class="table-ep">${c[8]}</td>
                        <td class="table-last ${m[n]}" last-action-minutes="${a[0]}">${a[1]}</td>
                        <td class="table-username ${m[p]}"><a class="user name" href="/profiles.php?XID=${e.userid}" target="_blank">${e.name}</a></td>
                        <td class="table-settled">${e.effectiveness.settled_in||0}</td>
                        <td class="table-merits ${m[d]}">${l}</td>
                        <td class="table-education">${e.effectiveness.director_education||0}</td>
                        <td class="table-management">${e.effectiveness.management||0}</td>
                        <td class="table-addiction ${m[i]}">${o}</td>
                        <td class="table-inactivity ${m[s]}">${r}</td>
                        <td class="table-total"><b>${e.effectiveness.total||0}</b></td>
                        <td class="table-wage" wage="${e.wage}"><b>$${toThousands(e.wage||0)}</b></td>
                        <td class="table-tornstats tright ${c[1]}" effectiveness="${c[0]}"><span>${(100*c[0]).toFixed(0)}%</span></td>
                    </tr>`;const g=P.find(".company-effectiveness");g.children().append(c)});var c=parseInt(h.company.daily_income||0),t=parseInt(h.company_detailed.advertising_budget||0);let p=0,g=0,b=0,y=0,x=0;$.each(h.company_stock,function(t,e){p+=e.sold_amount*e.cost,g+=e.sold_amount,b+=e.in_stock,y+=e.sold_worth}),0<g&&(x=parseInt(y/g));let v=b;R?(console.log("有上一次的产量数据"),console.log(R),v=R.Stock||b):console.log("没有上一次的产量数据，本次的产量将设置为与销量相等");e=b+g-v,r=c-f-t-p,e={Date:C,Income:c,Wages:f,Ad:t,Profit:r,Effectiveness:u,Produced:e,Sold:g,Stock:b,Price:x,Cost:p,RecordTime:(new Date).format("MM-dd hh:mm:ss")};console.log(e);let w=!1;var _,k=h.news;for(_ in k){const E=k[_];if(0<=E.news.indexOf("report"))if(new Date(1e3*(E.timestamp-86400)).format("yyyy-MM-dd")==C){w=!0;break}}if(L||!w?console.log("本次产量数据已存过，不再覆盖"):(console.log("本次产量数据未保存，现在保存"),updateLocalStorage("company-history-items",C,e),N=getLocalStorageRootNode("company-history-items")),console.log(N),null===P)return!0;const I=P.find(".company-effectiveness");I.find("th").css("cursor","pointer"),I.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),I.find("td.tright").css("text-align","right"),I.find("td.tleft").css("text-align","left"),I.find("td.eff-green").css("background-color","#D0E9C6"),I.find("td.eff-yellow").css("background-color","#FAF2CC"),I.find("td.eff-red").css("background-color","#EBCCCC"),clickTableHeadSort(I.find("th.table-position"),getEmployeesPosition),clickTableHeadSort(I.find("th.table-days"),getEmployeesDays),clickTableHeadSort(I.find("th.table-man"),getEmployeesMan),clickTableHeadSort(I.find("th.table-int"),getEmployeesInt),clickTableHeadSort(I.find("th.table-end"),getEmployeesEnd),clickTableHeadSort(I.find("th.table-ws"),getEmployeesWs),clickTableHeadSort(I.find("th.table-si"),getEmployeesSi),clickTableHeadSort(I.find("th.table-me"),getEmployeesMe),clickTableHeadSort(I.find("th.table-de"),getEmployeesDe),clickTableHeadSort(I.find("th.table-ma"),getEmployeesMa),clickTableHeadSort(I.find("th.table-ad"),getEmployeesAd),clickTableHeadSort(I.find("th.table-ia"),getEmployeesIa),clickTableHeadSort(I.find("th.table-to"),getEmployeesTo),clickTableHeadSort(I.find("th.table-wg"),getEmployeesWg),clickTableHeadSort(I.find("th.table-last"),flyLastActionMinutes),clickTableHeadSort(I.find("th.table-tornstats"),getEmployeesTornstats),I.after(`<br /><b>实时人数：${Object.keys(h.company_employees).length}，总工资：$${toThousands(e.Wages)}，广告费：$${toThousands(e.Ad)}，周销售：$${toThousands(h.company.weekly_income)}</b><br />`);let S={Income:0,Wages:0,Ad:0,Profit:0,Effectiveness:0,Produced:0,Sold:0,Stock:0,Price:0,Cost:0};const D=P.find(".company-history");let A=0,T=0,M=0;$.each(N,function(t,e){var a=parseInt(((new Date).getTime()-new Date(t).getTime())/864e5);if(31<a)return console.log(`删除过期数据：${t}`),deleteLocalStorage("company-history-items",t),delete N[t],!0;M++;t=`
                    <tr class="content">
                        <td>${M}</td>
                        <td>${t}</td>
                        <td>$${toThousands(e.Income)}</td>
                        <td>$${toThousands(e.Wages)}</td>
                        <td>$${toThousands(e.Ad)}</td>
                        <td>$${toThousands(e.Profit)}</td>
                        <td>${toThousands(e.Effectiveness)}</td>
                        <td>${toThousands(e.Produced)}</td>
                        <td>${toThousands(e.Sold)}</td>
                        <td>${toThousands(e.Stock)}</td>
                        <td>$${toThousands(e.Price)}</td>
                        <td>$${toThousands(e.Cost)}</td>
                        <td>${e.RecordTime||"-"}</td>
                    </tr>`;D.children().append(t),S.Income+=parseInt(e.Income),S.Wages+=parseInt(e.Wages),S.Ad+=parseInt(e.Ad),S.Profit+=parseInt(e.Profit),S.Effectiveness+=parseInt(e.Effectiveness),S.Produced+=parseInt(e.Produced),S.Sold+=parseInt(e.Sold),S.Stock+=parseInt(e.Stock),S.Price+=parseInt(e.Price),S.Cost+=parseInt(e.Cost||0),a<=7&&(A+=parseInt(e.Profit),T++)}),O=Object.keys(N).length;e=`
                <tr class="content">
                    <td colspan=2><b>平均值</b></td>
                    <td>$${toThousands((S.Income/O).toFixed(0))}</td>
                    <td>$${toThousands((S.Wages/O).toFixed(0))}</td>
                    <td>$${toThousands((S.Ad/O).toFixed(0))}</td>
                    <td>$${toThousands((S.Profit/O).toFixed(0))}</td>
                    <td>${toThousands((S.Effectiveness/O).toFixed(0))}</td>
                    <td>${toThousands((S.Produced/O).toFixed(0))}</td>
                    <td>${toThousands((S.Sold/O).toFixed(0))}</td>
                    <td>${toThousands((S.Stock/O).toFixed(0))}</td>
                    <td>$${toThousands((S.Price/O).toFixed(0))}</td>
                    <td>$${toThousands((S.Cost/O).toFixed(0))}</td>
                    <td>${(new Date).format("MM-dd hh:mm:ss")}</td>
                </tr>`;D.children().append(e),D.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),D.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),D.after(`<br /><b>共 ${O} 天数据，总利润：$${toThousands(S.Profit)}，近一周(${T}天)利润：$${toThousands(A)}</b>`)}).catch(t=>console.log("fetch error: ",t.message))}function getEmployeesPosition(t){return $(t).find("td.table-position").attr("position-value")}function getEmployeesDays(t){return $(t).find("td.table-days").text()}function getEmployeesMan(t){return $(t).find("td.table-man").attr("man")}function getEmployeesInt(t){return $(t).find("td.table-int").attr("int")}function getEmployeesEnd(t){return $(t).find("td.table-end").attr("end")}function getEmployeesWs(t){return $(t).find("td.table-ws").text()}function getEmployeesSi(t){return $(t).find("td.table-settled").text()}function getEmployeesMe(t){return $(t).find("td.table-merits").text()}function getEmployeesDe(t){return $(t).find("td.table-education").text()}function getEmployeesMa(t){return $(t).find("td.table-management").text()}function getEmployeesAd(t){return $(t).find("td.table-addiction").text()}function getEmployeesIa(t){return $(t).find("td.table-inactivity").text()}function getEmployeesTo(t){return $(t).find("td.table-total").text()}function getEmployeesWg(t){return $(t).find("td.table-wage").attr("wage")}function getEmployeesTornstats(t){return $(t).find("td.table-tornstats").attr("effectiveness")}function formatWS(t){return t<1e4?t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","}):parseInt(t/1e3)+"k"}function userId2otherIds(n){return new Promise((e,a)=>{var t=`https://api.torn.com/user/${n}?selections=profile&key=${APIKey}`;fetch(t).then(t=>t.ok?t.json():void console.log("---探测失败 "+n+"---"),t=>{console.log("---网络异常 "+n+"---")}).then(t=>{null!=t?"error"in t?a(t.error):(console.log(`userId2otherIds: ${n} => (${t.faction.faction_id} - ${t.faction.position}) (${t.job.company_id} - ${t.job.position})`),e([t.faction.faction_id,t.faction.position,t.job.company_id,t.job.position])):a()}).catch(t=>a(t))})}function factionPageRedraw(i){return new Promise((e,n)=>{const o=$("#mainContainer").find("div:contains('unavailable')").last();o.text("蛙蛙探测器工作中...");var t=`https://api.torn.com/faction/${i}?selections=basic,chain&key=${APIKey}`;fetch(t).then(t=>t.ok?t.json():void o.text("---探测失败 "+i+"---"),t=>{o.text("---网络异常 "+i+"---")}).then(t=>{if(null!=t)if("error"in t)n(t.error);else{$("#skip-to-content").text(`帮派: ${t.name}`),o.html(`<b>声望:</b> ${toThousands(t.respect)}&nbsp;&nbsp;&nbsp;&nbsp;<b>天数:</b> ${toThousands(t.age)}&nbsp;&nbsp;&nbsp;&nbsp;<b>最大连击:</b> ${toThousands(t.best_chain)}&nbsp;&nbsp;&nbsp;&nbsp;<b>成员数:</b> ${Object.keys(t.members).length}`),0<t.chain.current&&o.append(`</br /></br /><b>正在连击:</b> ${toThousands(t.chain.current)}/${toThousands(t.chain.max)}&nbsp;&nbsp;&nbsp;&nbsp;<b>开始时间:</b> ${new Date(1e3*t.chain.start).format("yyyy-MM-dd hh:mm:ss")}&nbsp;&nbsp;&nbsp;&nbsp;<b>连击超时:</b> ${t.chain.timeout}(秒)&nbsp;&nbsp;&nbsp;&nbsp;<b>声望系数:</b> ${t.chain.modifier}&nbsp;&nbsp;&nbsp;&nbsp;<b>冷却时间:</b> ${t.chain.cooldown}`),t.territory_wars&&0<Object.keys(t.territory_wars).length&&(o.append("</br />"),$.each(t.territory_wars,function(t,e){e.assaulting_faction==i?o.append(`</br /><b>正在进攻地盘:</b> ${e.territory}&nbsp;&nbsp;&nbsp;&nbsp;<b>防守方:</b> <a href='/factions.php?step=profile&ID=${e.defending_faction}' target='_blank'>${e.defending_faction}</a>`):o.append(`</br /><b>正在防守地盘:</b> ${e.territory}&nbsp;&nbsp;&nbsp;&nbsp;<b>进攻方:</b> <a href='/factions.php?step=profile&ID=${e.assaulting_faction}' target='_blank'>${e.assaulting_faction}</a>`),o.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>推墙进度:</b> ${toThousands(e.score)}/${toThousands(e.required_score)}&nbsp;&nbsp;&nbsp;&nbsp;<b>最迟结束时间:</b> ${new Date(1e3*e.end_time).format("yyyy-MM-dd hh:mm:ss")}`)})),t.peace&&0<Object.keys(t.peace).length&&(o.append("</br />"),$.each(t.peace,function(t,e){o.append(`</br /><b>和平条约:</b> <a href='/factions.php?step=profile&ID=${t}' target='_blank'>${t}</a>&nbsp;&nbsp;&nbsp;&nbsp;<b>到期时间:</b> ${new Date(1e3*e).format("yyyy-MM-dd hh:mm:ss")}`)})),t.raid_wars&&0<Object.keys(t.raid_wars).length&&(o.append("</br />"),$.each(t.raid_wars,function(t,e){e.raiding_faction==i?o.append(`</br /><b>正在突击:</b> <a href='/factions.php?step=profile&ID=${e.defending_faction}' target='_blank'>${e.defending_faction}</a>`):o.append(`</br /><b>正在被</b> <a href='/factions.php?step=profile&ID=${e.raiding_faction}' target='_blank'>${e.raiding_faction}</a> 突击`),o.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>突击进度(攻/守):</b> ${e.raider_score}/${e.defender_score}&nbsp;&nbsp;&nbsp;&nbsp;<b>开始时间:</b> ${new Date(1e3*e.start_time).format("yyyy-MM-dd hh:mm:ss")}`)})),$(".content-wrapper").last().append(`
                        <table id="faction-members" style="width:100%;background-color: #FFF5F7;font-size:12px;">
                            <tr class="head">
                                <th>名字</th>
                                <th>天数</th>
                                <th>上次活动</th>
                                <th>状态</th>
                                <th>角色</th>
                            </tr>
                        </table>`);const a=$("#faction-members");$.each(t.members,function(t,e){e=`
                            <tr class="content">
                                <td><a href='/profiles.php?XID=${t}' target='_blank'>${e.name}</a></td>
                                <td>${e.days_in_faction}</td>
                                <td>${e.last_action.relative}</td>
                                <td>${e.status.description}</td>
                                <td>${e.position}</td>
                            </tr>`;a.children().append(e)}),a.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),a.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),e()}else n()}).catch(t=>o.text(t))})}function companyPageRedraw(a){return new Promise((t,o)=>{const i=$("#mainContainer").find("div:contains('unavailable')").last();i.text("蛙蛙探测器工作中...");var e=`https://api.torn.com/company/${a}?selections=profile&key=${APIKey}`;fetch(e).then(t=>t.ok?t.json():void i.text("---探测失败 "+a+"---"),t=>{i.text("---网络异常 "+a+"---")}).then(e=>{if(null!=e)if("error"in e)o(e.error);else{var a,t={1:"Hair Salon",2:"Law Firm",3:"Flower Shop",4:"Car Dealership",5:"Clothing Store",6:"Gun Shop",7:"Game Shop",8:"Candle Shop",9:"Toy Shop",10:"Adult Novelties",11:"Cyber Cafe",12:"Grocery Store",13:"Theater",14:"Sweet Shop",15:"Cruise Line",16:"Television Network",18:"Zoo",19:"Firework Stand",20:"Property Broker",21:"Furniture Store",22:"Gas Station",23:"Music Store",24:"Nightclub",25:"Pub",26:"Gents Strip Club",27:"Restaurant",28:"Oil Rig",29:"Fitness Center",30:"Mechanic Shop",31:"Amusement Park",32:"Lingerie Store",33:"Meat Warehouse",34:"Farm",35:"Software Corporation",36:"Ladies Strip Club",37:"Private Security Firm",38:"Mining Corporation",39:"Detective Agency",40:"Logistics Management"};if($("#skip-to-content").html(`公司: ${e.company.name}`),i.html(`<b>类型:</b> ${t[e.company.company_type]}&nbsp;&nbsp;&nbsp;&nbsp;<b>星级:</b> ${e.company.rating}&nbsp;&nbsp;&nbsp;&nbsp;<b>员工数:</b> ${e.company.employees_hired}/${e.company.employees_capacity}&nbsp;&nbsp;&nbsp;&nbsp;<b>日销售:</b> $${toThousands(e.company.daily_income)}&nbsp;&nbsp;&nbsp;&nbsp;<b>周销售:</b> $${toThousands(e.company.weekly_income)}&nbsp;&nbsp;&nbsp;&nbsp;<b>天数:</b> ${toThousands(e.company.days_old)}`),28==e.company.company_type){i.append("&nbsp;&nbsp;&nbsp;&nbsp;<b>估算单价x销量:</b>");for(let t=200;120<=t;--t)e.company.daily_income%t==0&&(a=parseInt(e.company.daily_income/t),i.append(` ${t}x${toThousands(a)}`))}else 16==e.company.company_type&&(t=parseInt(e.company.daily_income/e.company.daily_customers),i.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>单价x销量:</b> ${toThousands(t)}x${toThousands(e.company.daily_customers)}`));$(".content-wrapper").last().append(`
                            <table id="company-members" style="width:100%;background-color: #FFF5F7;font-size:12px;">
                                <tr class="head">
                                    <th>名字</th>
                                    <th>天数</th>
                                    <th>上次活动</th>
                                    <th>状态</th>
                                    <th>职位</th>
                                </tr>
                        </table>`);const n=$("#company-members");$.each(e.company.employees,function(t,e){e=`
                            <tr class="content">
                                <td><a href='/profiles.php?XID=${t}' target='_blank'>${e.name}</a></td>
                                <td>${e.days_in_company}</td>
                                <td>${e.last_action.relative}</td>
                                <td>${e.status.description}</td>
                                <td>${e.position}</td>
                            </tr>`;n.children().append(e)}),n.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),n.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;")}else o()}).catch(t=>i.text(t))})}if(0<=window.location.href.indexOf("factions.php?step=your")){const fhref=$("[href^='/forums.php#!p=forums&f=999&b=1&a=']").attr("href");let fID=0;if(null!=fhref&&(fID=fhref.substring(34),window.localStorage.setItem("MY_FACTION_ID",fID)),foo){let faction_temp_interval=setInterval(updateFactionPage,1e3),faction_href_interval=0;function updateFactionPage(){if(console.log("faction other"),0<=window.location.href.indexOf("factions.php?step=your#/tab=info")&&0<$("li.position").length){clearInterval(faction_temp_interval),faction_href_interval=setInterval(updateFactionHref,1e3),console.log("li position"),userListParade("div.f-war-list","ul.table-body");const t=$("div[data-faction]").attr("data-faction");facPageEnhanced(t)}}function updateFactionHref(){console.log("faction info"),window.location.href.indexOf("factions.php?step=your#/tab=info")<0&&(clearInterval(faction_href_interval),faction_temp_interval=setInterval(updateFactionPage,1e3))}}}if(0<=window.location.href.indexOf("factions.php?step=profile&")){const div_info=$("#mainContainer").find("div:contains('unavailable')").last();if(0<div_info.length){if(0<=window.location.href.indexOf("profile&ID=")){const fID=/profile&ID=(\d+)/.exec(window.location.href)[1];console.log("fID "+fID),factionPageRedraw(fID).catch(t=>console.log("factionPageRedraw "+t))}else if(0<=window.location.href.indexOf("profile&userID=")){const userId=/userID=(\d+)/.exec(window.location.href)[1];console.log("userId "+userId),userId2otherIds(userId).then(function(t){console.log(t),factionPageRedraw(t[0]).catch(t=>console.log("factionPageRedraw "+t))}).catch(t=>console.log("userId2otherIds "+t))}}else if(foo){const faction_temp_interval=setInterval(updateFactionPage,1e3);function updateFactionPage(){if(0<$("li.position").length){clearInterval(faction_temp_interval),console.log("li position"),userListParade("div.f-war-list","ul.table-body");const t=$("div[data-faction]").attr("data-faction");facPageEnhanced(t)}}}}if(0<=window.location.href.indexOf("p=corpinfo&")){const div_info=$("#mainContainer").find("div:contains('unavailable')").last();if(0<div_info.length){if(0<=window.location.href.indexOf("corpinfo&ID=")){const companyID=/corpinfo&ID=(\d+)/.exec(window.location.href)[1];console.log("companyID "+companyID),new Promise(function(t,e){setTimeout(function(){console.log("2 Seconds"),t()},2e3)}).then(function(){companyPageRedraw(companyID).catch(t=>console.log("companyPageRedraw "+t))}).catch(t=>console.log("companyPageRedraw "+t))}else if(0<=window.location.href.indexOf("corpinfo&userID=")){const userId=/userID=(\d+)/.exec(window.location.href)[1];console.log("userId "+userId),userId2otherIds(userId).then(function(a){return new Promise(function(t,e){setTimeout(function(){console.log("2 Seconds"),t(a)},2e3)})}).then(function(t){console.log(t),companyPageRedraw(t[2]).catch(t=>console.log("companyPageRedraw "+t))}).catch(t=>console.log("userId2otherIds "+t))}}else{let detectInerval=setInterval(updateUI,500);function updateUI(){if(0<=$("div.company-details").children("div.title-black").text().indexOf("Oil Rig")){clearInterval(detectInerval);const e=$("div.company-details").find("li:contains('Daily income')").text().replace(/[^\d]/g,"");for(let t=250;120<=t;--t)if(e%t==0){const a=parseInt(e/t);$("div.company-details").children("div.title-black").append(`<span class="m-hide"> - 估算单价: ${t}，估算销量: ${toThousands(a)} </span>`)}}}}}if(bounty_parade&&window.location.href.indexOf("bounties.php#!p=main")){const intervalBounty=setInterval(updateBountyParadeUI,2e3);function updateBountyParadeUI(){const t=$("ul.bounties-list").children(),e=t.first();e.length<=0?$("div.bounties-total").text("未找到用户列表"):"1"==e.attr("detected")||($("div.bounties-total").text("阅兵开始"),setTimeout(()=>{!function e(a){a.attr("detected","1");const n=a.find("div.status");if(0<n.children(".t-red").length)$("div.bounties-total").text("本条已阅兵完毕"),setTimeout(()=>{e(a.next())},0);else if(null==a.attr("data-id"))$("div.bounties-total").text("本页阅兵结束");else{const o=a.find("div.target").children("a"),i=o.attr("href").replace(/[^0-9]/gi,"");var t=o.text();$("div.bounties-total").text("正在阅兵: "+i+" "+t),wawaDetect(i,function(t){n.children(".t-green").text(formatNumber(t.estimate_bs)),updateLocalStorage("battlestats",i,t.estimate_bs),setTimeout(()=>{e(a.next())},0)},function(t){$("div.bounties-total").text("蛙蛙探测 "+i+" 失败 "+t),setTimeout(()=>{e(a.next())},0)})}}(e)},0))}}if(mugoo&&0<=window.location.href.indexOf("imarket.php")){let last_href=window.location.href,detectInerval=setInterval(updateUI,500),hrefIntercal=0;const header_link_items=["Donator Pack","Xanax","Erotic DVD","Drug Pack","Feathery Hotel Coupon","Anti Tank","Large Suitcase","Wind Proof Lighter","Six Pack of Energy Drink","Sierra Cosworth"],flower_items=["Tribulus Omanense","Peony","African Violet","Cherry Blossom","Heather","Ceibo Flower","Edelweiss"],plushie_items=["Camel Plushie","Lion Plushie","Panda Plushie","Monkey Plushie","Chamois Plushie","Red Fox Plushie","Nessie Plushie"],can_items=["Can of X-MASS","Can of Taurine Elite","Can of Rockstar Rudolph","Can of Red Cow","Can of Munster","Can of Santa Shooters"];function updateUI(){const t=$(".guns-list.cont-gray");if(t&&0<t.length){clearInterval(detectInerval),clearInterval(hrefIntercal),last_href=window.location.href,hrefIntercal=setInterval(updateHref,500);const a=$(".msg.right-round");a.html(`
                <div id="important" style="margin:6px 0px; overflow:hidden;"><div style="float:left; padding:2px; margin:3px; background-color:${bingwa_color_pool.gray}; color:white;">重要</div></div>
                <div id="flower" style="margin:6px 0px; overflow:hidden;"><div style="float:left; padding:2px; margin:3px; background-color:${bingwa_color_pool.gray}; color:white;">花花</div></div>
                <div id="plushie" style="margin:6px 0px; overflow:hidden;"><div style="float:left; padding:2px; margin:3px; background-color:${bingwa_color_pool.gray}; color:white;">玩偶</div></div>
                <div id="can" style="margin:6px 0px; overflow:hidden;"><div style="float:left; padding:2px; margin:3px; background-color:${bingwa_color_pool.gray}; color:white;">能饮</div></div>
            `);for(let t=0;t<header_link_items.length;t++){const i=header_link_items[t].split(" ")[0];$("#important").append(`<div class="border-round header-link" style="float:left; cursor:pointer; padding:2px; margin:3px; background-color:${bingwa_color_pool.yellowgreen}; color:white;" name="${header_link_items[t]}">${i}</div>`)}for(let t=0;t<flower_items.length;t++){const r=flower_items[t].split(" ")[0];$("#flower").append(`<div class="border-round header-link" style="float:left; cursor:pointer; padding:2px; margin:3px; background-color:${bingwa_color_pool.pink}; color:white;" name="${flower_items[t]}">${r}</div>`)}for(let t=0;t<plushie_items.length;t++){const s=plushie_items[t].replace(/ Plushie/g,"");$("#plushie").append(`<div class="border-round header-link" style="float:left; cursor:pointer; padding:2px; margin:3px; background-color:${bingwa_color_pool.blue}; color:white;" name="${plushie_items[t]}">${s}</div>`)}for(let t=0;t<can_items.length;t++){const l=can_items[t].replace(/Can of /g,"");$("#can").append(`<div class="border-round header-link" style="float:left; cursor:pointer; padding:2px; margin:3px; background-color:${bingwa_color_pool.yellow}; color:white;" name="${can_items[t]}">${l}</div>`)}$(".header-link").click(function(){const t=$(this).attr("name"),e="/imarket.php#/p=shop&step=shop&type=&searchname="+t.replace(/ /g,"+");console.log(e),window.location.href=e});let S=$(".items").children(":first").find("[itemid]").attr("itemid");S=S||t.children(":first").find("img.torn-item.item-plate").attr("src").replace(/[^\d]/g,"");const n=t.children(":first").find(".name.t-gray-6").text();if(0<=header_link_items.indexOf(n)||0<=flower_items.indexOf(n)||0<=plushie_items.indexOf(n)||0<=can_items.indexOf(n)){let d={};const p=getLocalStorage("bazaar_cache",n);let c=0;const g=$(".desc.t-blue-cont.t-overflow");if(g.each(function(t,e){const a=$(this).find(".price.t-gray-6"),n=$(this).find(".user.t-overflow").children("a"),o=n.attr("href"),i=o?o.replace(/[^\d]/g,""):0,r=a.text().split("(")[0].trim(),s=formatMoney(r),l=a.text().split("(")[1].replace(/\)/g,"").trim();d[i]={price:s,price_formal:r,amount:l},s>c&&(c=s)}),!$.isEmptyObject(p))for(var e in p)if(null==d[e]&&p[e].price>=c){const h=`
                                <li>
                                    <span class="item-desc">
                                        <span class="item">
                                            <img class="img___3jDmV" src="/images/items/${S}/large.png?v=1528808940574" alt="${n}">
                                            <a class="item-hover" href="/bazaar.php?userID=${e}"></a>
                                        </span>
                                        <span class="desc t-blue-cont t-overflow">
                                            <span class="user t-overflow">
                                                <a href="/bazaar.php?userID=${e}">Pampa's bazaar</a>
                                            </span>
                                            <span class="name t-gray-6">${n}</span>
                                            <span class="price t-gray-6"> ${p[e].price_formal}
                                                <span class="stock t-gray-9">(${p[e].amount})</span>
                                            </span>
                                        </span>
                                    </span>
                                </li>`;t.children(":last").before(h)}matchBazaarAPI(S,n,d,p)}const o=$(".desc.t-blue-cont.t-overflow");o.each(function(t,e){const v=$(this).find(".price.t-gray-6"),w=$(this).find(".user.t-overflow").children("a"),a=w.attr("href"),_=a?a.replace(/[^\d]/g,""):0;v.prev().remove();const n=v.text().split("(")[0].trim(),k=formatMoney(n),I=v.text().split("(")[1].replace(/\)/g,"").trim();wawaDetect(_,function(t){const e=colLastAction(t.last_action.timestamp),a=t.status.color,n=colHospitalTime(t.status.description,t.status.state,t.status.until),o=t.job.company_type,i=t.basicicons.icon72,r=t.last_action.status,s=t.bazaar,l=t.faction.faction_id;let d={};if(s.map(function(t,e,a){d[t.ID]={name:t.name,quantity:t.quantity,price:t.price}}),!(S in d))return v.parent().parent().parent().remove(),!0;{const y=d[S].quantity,x=d[S].price;y==I&&x==k||v.html(`${formatMoney(x)} <span class="stock t-gray-9">(${y})</span>`)}l in friendly_faction&&w.parent().parent().css("background-color",bingwa_color_pool.green);let c="";c="Online"==r?'<span title="<b>Online</b>" style="width:16px;height:16px;margin:0px 2px;vertical-align:bottom; display:inline-block; background-position:0px 0; background-image:url(/images/v2/svg_icons/sprites/user_status_icons_sprite.svg)"></span>':"Offline"==r?'<span title="<b>Offline</b>" style="width:16px;height:16px;margin:0px 2px;vertical-align:bottom; display:inline-block; background-position:-18px 0;   background-image:url(/images/v2/svg_icons/sprites/user_status_icons_sprite.svg)"></span>':'<span title="<b>Idle</b>" style="width:16px;height:16px;margin:0px 2px;vertical-align:bottom; display:inline-block; background-position:-1098px 0;  background-image:url(/images/v2/svg_icons/sprites/user_status_icons_sprite.svg)"></span>';let p="打",g=bingwa_color_pool.purple;5==o&&(p="衣",g=bingwa_color_pool.gray),null!=i&&(p="新",g=bingwa_color_pool.gray),w.text("");const h=`${c}<a href="/profiles.php?XID=${_}">${t.name}</a>`,m=`<a class= "border-round" style="padding:1px 2px;background-color:${g};color:white;" href="/loader.php?sid=attack&user2ID=${_}">${p}</a>`;w.before(m),w.after(h);let f=0;null!=s&&s.map(function(t,e,a){f+=t.quantity*t.market_price}),v.parent().siblings(".item").css("margin","2px 10px"),v.parent().siblings(".item").append(`<div style="font-size: 13px; line-height: 17px; text-align: center;"><span class="border-round" style="background-color: ${bingwa_color_pool.purple}; color: white; padding: 1px 3px;">全店 ${formatNumber(f)}</span></div>`);let u="";"blue"==a&&(u=bingwa_color_pool.blue),"green"==a&&(u=bingwa_color_pool.green),"red"==a&&(u=bingwa_color_pool.red);let b=`
                        <span class="left" style="">
                            <span class= "border-round" style="padding: 1px 3px; background-color: ${u}; color: white;" title="Status: ${t.status.description}">${n[0]}</span>
                            <span style="padding: 1px 3px;" title="Last Action: ${t.last_action.relative}">${e[1]}</span>
                            <span style="padding: 1px 3px;" title="BattleStats: ${formatNumber(t.estimate_bs)}">${formatNumber(t.estimate_bs)}</span>
                        </span>`;v.after(b)})})}}function updateHref(){last_href!=window.location.href&&(clearInterval(detectInerval),clearInterval(hrefIntercal),last_href=window.location.href,detectInerval=setInterval(updateUI,500))}function matchBazaarAPI(i,r,s,l){var t=`https://api.torn.com/market/${i}?selections=bazaar&key=${APIKey}`;fetch(t).then(t=>t.json()).then(t=>{console.log(i+" bazaar API fetched");var e=t.bazaar;let a={};for(let t=0;t<e.length;t++){if(!$.isEmptyObject(l))for(var n in l)l[n].apiid==e[t].ID&&(a[n]={apiid:e[t].ID,price:e[t].cost,price_formal:formatMoney(e[t].cost),amount:e[t].quantity});if(!$.isEmptyObject(s))for(var o in s)s[o].price==e[t].cost&&s[o].amount==e[t].quantity&&(a[o]={apiid:e[t].ID,price:e[t].cost,price_formal:formatMoney(e[t].cost),amount:e[t].quantity})}updateLocalStorage("bazaar_cache",r,a)}).catch(t=>console.log("fetch error",t))}}if(mugoo&&0<=window.location.href.indexOf("pmarket.php")){const intervalID=setInterval(updateUI,500);function updateUI(){const t=$(".users-point-sell").children("li");if(t&&0<t.length){clearInterval(intervalID);let r=[];$("li.total-price").attr("id","total-price");const e=document.getElementById("total-price"),s=window.getComputedStyle(e).width.replace(/px$/g,"");t.each(function(t,e){const c=$(this).find(".total-price"),a=$(this).find(".user.name").attr("href"),n=a?a.replace(/[^\d]/g,""):0,o=$(this).find(".user.faction").attr("href"),i=o?o.replace(/[^\d]/g,""):0;i in friendly_faction&&$(this).css("background-color",bingwa_color_pool.green),-1==r.indexOf(n)&&(r.push(n),Number(s)<200&&c.text(""),wawaDetect(n,function(t){const e=colLastAction(t.last_action.timestamp),a=t.status.color,n=colHospitalTime(t.status.description,t.status.state,t.status.until),o=t.job.company_type,i=t.basicicons.icon72;let r="打",s=bingwa_color_pool.purple;5==o&&(r="衣",s=bingwa_color_pool.gray),null!=i&&(r="新",s=bingwa_color_pool.gray);let l="";"blue"==a&&(l=bingwa_color_pool.blue),"green"==a&&(l=bingwa_color_pool.green),"red"==a&&(l=bingwa_color_pool.red);let d="<span class='left'>";d+=`<span style="padding:1px;margin:1px;background-color:${s};color:white;">${r}</span>`,d+=`<span style="padding:1px;margin:1px;background-color:${l};color:white;" title="Status: ${t.status.description}">${n[0]}</span>`,d+=`<span style="padding:1px;margin:1px;background-color:${bingwa_color_pool.gray};color:white;" title="Last Action: ${t.last_action.relative}">${e[1]}</span>`,d+=`<span style="padding:1px;margin:1px;background-color:${bingwa_color_pool.blue};color:white;" title="BattleStats: ${formatNumber(t.estimate_bs)}">${formatNumber(t.estimate_bs)}</span></span>`,c.prepend(d)}))})}}}if(mugoo&&0<=window.location.href.indexOf("bazaar.php")){let item_selected={};const div_info=$("#mainContainer").find("div:contains('unavailable')").last();if(0<div_info.length){const uID=window.location.href.replace(/[^\d]/g,"");div_info.text("蛙蛙探测器工作中...");const API=`https://api.torn.com/user/${uID}?selections=basic,bazaar&key=${APIKey}`;fetch(API).then(t=>t.ok?t.json():void div_info.text("---探测失败 "+fID+"---"),t=>{div_info.text("---网络异常 "+fID+"---")}).then(a=>{if(div_info.html(`蛙蛙探测成功^_^ [ <a class="t-blue" href="/profiles.php?XID=${a.player_id}">${a.name}</a>的小店 ]`),null==a.bazaar)div_info.html(`货物卖光了:( [ <a class="t-blue" href="/profiles.php?XID=${a.player_id}">${a.name}</a>的小店 ]`),console.log("no item in bazaar");else{$(".content-wrapper").last().append('<div class="bazaar-wrapper" style="margin-top:10px;"><div class="bazaar-content" style="width:inherit; overflow:hidden; background-color:white;"></div></div>');for(let e=0;e<a.bazaar.length;e++){var n=((a.bazaar[e].price-a.bazaar[e].market_price)/a.bazaar[e].market_price*100).toFixed(2);let t="";t=0<n?`&nbsp;&nbsp;<span class="change up"><i class="arrow-change-icon" role="img" aria-label="stock price is up"></i><span class="t-green">${n}%</span></span>`:`&nbsp;&nbsp;<span class="change down"><i class="arrow-change-icon" role="img" aria-label="stock price is down"></i><span class="t-red">${n}%</span></span>`,$(".bazaar-content").append(`
                            <div class="item-wrapper" style="width:288px; float:left; overflow:hidden;">
                                <div style="width:100px; height:50px; margin:7px; padding:3px; float:left; border:1px solid darkgray;">
                                    <img src="/images/items/${a.bazaar[e].ID}/large.png">
                                </div>
                                <div class="item-description" style="width:150px; margin:7px; float:left; border:1px solid darkgray;overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                    <p class="item-name" style="margin:5px">${a.bazaar[e].name}</p>
                                    <p class="item-price" style="margin:5px">${formatMoney(a.bazaar[e].price)}${t}</p>
                                    <p class="item-quantity" style="margin:5px">(${a.bazaar[e].quantity} in stock)
                                        <span class="t-blue">&nbsp;&nbsp;${formatNumber(a.bazaar[e].price*a.bazaar[e].quantity)}</span>
                                    </p>
                                </div>
                            </div>`)}}}).catch(t=>div_info.text(t))}else{checkTime();const intervalID=setInterval(updateUI,500)}function checkTime(){var e=getLocalStorage("ITEMS","last-updated");if(null!=e&&null!=e){var a=new Date;let t=new Date(e);t.setDate(t.getDate()+1),t<a&&getBazaarAPI()}else getBazaarAPI()}function getBazaarAPI(){var t=`https://api.torn.com/torn/?selections=items&key=${APIKey}`;fetch(t).then(t=>t.json()).then(t=>{console.log("API fetched");let e={};const a=new Date;for(var n in e["last-updated"]=a.toString(),t.items)e[n]=t.items[n].market_value;window.localStorage.setItem("ITEMS",JSON.stringify(e))}).catch(t=>console.log("fetch error",t))}function updateUI(){const h=$("[class*='messageContent___']");if("1"!=h.attr("hasdone")){h.attr("hasdone","1"),$("#sum").remove();let t='<div id="sum">',e=0;for(var a in item_selected)t+=" (<span class='t-green'> "+item_selected[a].name+" "+item_selected[a].total_formal+" </span>) ",e+=item_selected[a].total;t+="<span class='t-red'><b> Total Selected: "+formatNumber(e)+" </b></span></div>",h.append(t)}const t=getLocalStorage("ITEMS","last-updated"),e=$("[class^='rowItems___']").children();t&&e&&0<e.length&&e.each(function(t,e){const a=$(this).find("[class^='name___']").text(),n=$(this).find("[class^='price___']");let o=0;""!=n.text()&&(o=n.text().replace(/[^\d]/g,""));const i=$(this).find("img").attr("src");let r=0,s=0;null!=i&&(s=i.split("/")[3],0<s&&(r=getLocalStorage("ITEMS",s)));const l=$(this).find("[class^='amount___']");let d=0;if(""!=l.text()&&(d=l.text().replace(/[^\d]/g,"")),0<r&&0<o&&0<d&&"1"!=$(this).attr("hasdone")){$(this).attr("hasdone","1");const c=((o-r)/r*100).toFixed(1),p=formatNumber(o*d);l.append(`&nbsp;&nbsp;<span><span class="t-blue">${p}</span></span>`),0<=c?n.append(`&nbsp;&nbsp;<span class="change up"><i class="arrow-change-icon" role="img" aria-label="stock price is up"></i><span class="t-green">${c}%</span></span>`):n.append(`&nbsp;&nbsp;<span class="change down"><i class="arrow-change-icon" role="img" aria-label="stock price is down"></i><span class="t-red">${c}%</span></span>`);const g=$(this).find("[class^='description___']");null!=item_selected[s]&&g.css("background-color","NavajoWhite"),g.click(function(){$(this).attr("selected")?(delete item_selected[s],$(this).removeAttr("selected"),h.removeAttr("hasdone"),$(this).css("background-color","")):(item_selected[s]={name:a,price:o,amount:d,total:o*d,total_formal:formatNumber(o*d)},$(this).attr("selected","selected"),h.removeAttr("hasdone"),$(this).css("background-color","NavajoWhite"))})}})}}if(mugoo&&0<=window.location.href.indexOf("imarket.php")){const intervalID=setInterval(updateUI,500);function updateUI(){const o=$(".buy-item-info").find(".private-bazaar");0<o.length&&o.each(function(t,e){if("1"!=$(this).attr("hasdone")){$(this).attr("hasdone","1");const a=$(this).find('[href^="bazaar"]').attr("href").replace(/[^\d]/g,""),n=$(this);wawaDetect(a,function(t){n.attr("user_id",a),n.attr("user_name",t.name),n.attr("user_level",t.level),n.attr("user_bs",formatNumber(t.estimate_bs)),n.attr("user_last",t.last_action.relative),n.attr("user_stat",t.status.description),n.attr("user_job_type",t.job.company_type),n.attr("newbie",t.basicicons.icon72)})}});const t=$(".buy-item-info-wrap").find(".private-bazaar");0<t.length&&t.each(function(t,e){if("1"!=$(this).attr("hasdone")){const c=$(this).find('[href^="bazaar"]').attr("href").replace(/[^\d]/g,""),a=$(this).find(".user.faction").attr("href"),n=a?a.replace(/[^\d]/g,""):0;n in friendly_faction&&$(this).css("background-color",bingwa_color_pool.green);const p=$(this);o.each(function(t,e){if($(this).attr("user_id")==c){console.log($(this).attr("user_name"));const a=$(this).attr("user_name"),n=$(this).attr("user_level"),o=$(this).attr("user_bs"),i=$(this).attr("user_last"),r=$(this).attr("user_stat"),s=$(this).attr("user_job_type"),l=$(this).attr("newbie");let t="打";5==s?t="衣":null!=l&&(t="新");const d=`
                                <li class="private-bazaar wawa-bazaar" hasdone="1">
                                    <ul class="item t-blue-cont h">
                                        <li class="item-name">
                                            <div class="item-t right t-gray-9">${r}</div>
                                            <div class="name-t icons left">
                                                <span class="t-gray-9">Lv:${n}</span>
                                            <a class="user name" href="/profiles.php?XID=${c} ">
                                                <span title="${a} [${c}]"><b>BS: ${o}</b><span></span></span>
                                            </a>
                                            </div>
                                            <div class="name-t name-mobile left">
                                                <span class="t-gray-9 italic">sold by</span>
                                                <a class="t-blue" href="profiles.php?XID=${c}">BS: ${o}</a>
                                            </div>
                                            <div class="clear"></div>
                                        </li>
                                        <li class="cost">
                                            <span class="t-gray-9" title="${r}">${i}</span>
                                        </li>
                                        <li class="view">
                                            <a href="/loader.php?sid=attack&user2ID=${c}"><b>${t}</b></a>
                                        </li>
                                        <li class="clear"></li>
                                    </ul>
                                </li>`;return p.after(d),p.attr("hasdone","1"),!1}})}})}}if(0<=window.location.href.indexOf("loader.php?sid=attack&user2ID")){const victim_id=window.location.href.match(/loader\.php\?sid=attack\&user2ID=(\d+)/)[1],intervalID=setInterval(updateUI,300);function updateUI(){const t=$("[class^='btn___']");if(0<t.length){const e=t[0];if($(e).text().includes("CONTINUE")){const a=$(e).parent().parent().children(":first").text().split(" ");clearInterval(intervalID),console.log(a);const n=a[2],o=a[1],i=new Date,r=parseInt(i.getTime()/1e3),s=i.format("yyyy-MM-dd hh:mm:ss");if("mugged"==o){let t=a[5];console.log(t),"wallet"==t&&(t="$0");const l={timestring:s,victim_id:victim_id,victim_name:n,money_mugged:t};updateLocalStorage("muglog",r,l)}}}}}if(0<=window.location.href.indexOf("companies.php")){$(".info-msg-cont").after("<div id='effectiveness-wrap' style='margin-top:10px; overflow-x: auto;'></div>"),$(".info-msg-cont").after('<div id="bingwa-top-warn" class="info-msg-cont red border-round m-top10">');const userId=getMyId();console.log("userId "+userId),userId2otherIds(userId).then(function(t){console.log(t);t=t[3];"Employee"==t?arbeitDemo($("#effectiveness-wrap")):"Director"==t&&employeesDemo($("#effectiveness-wrap"))}).catch(t=>console.log("userId2otherIds "+t));const intervalEmployee=setInterval(updateEmployeeUI,1e3);function updateEmployeeUI(){const t=$(".employee-list-wrap").children("ul.employee-list").children("li");if(0<t.length){clearInterval(intervalEmployee);let n={},o=0;t.each(function(t,e){var a=$(this).attr("data-user");n[a]=o,o+=1}),window.localStorage.setItem("EMPLOYEE_RANK",JSON.stringify(n))}}}else employeesDemo(null);if(0<=window.location.href.indexOf("joblist.php")){const joblistInterval=setInterval(updateJoblist,500);function updateJoblist(){const t=$("ul.rank-list");if(0<t.length&&"1"!=t.attr("hasdone")){t.attr("hasdone","1");t.after(`
                <div id="company_parade">
                    <div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">公司阅兵</div>
                    <div class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">
                        <button id="company_parade_start_btn" class="torn-btn" style="margin:5px;">开始阅兵</button>
                        <button id="company_parade_stop_btn" class="torn-btn" style="margin:5px;">暂停阅兵</button>
                        <span id="company_parade_tip" style="margin:5px;"></span>
                    </div>
                </div>`);let a=!0;$("#company_parade_start_btn").click(function(){a=!0,$("#company_parade_start_btn").prop("disabled",!0),$("#company_parade_stop_btn").removeAttr("disabled");const t=$("ul.company-list").children().first();t.length<=0?($("#company_parade_tip").text("未找到公司列表"),$("#company_parade_start_btn").removeAttr("disabled"),$("#company_parade_stop_btn").prop("disabled",!0)):($("#company_parade_tip").text("阅兵开始"),$("#company_parade_table").length<=0&&($("#company_parade").after(`
                            <div id="company_parade_table">
                                <table style="margin:auto;background-color:white;font-size:12px;">
                                    <tr class="head">
                                        <th>星级</th>
                                        <th>名称</th>
                                        <th>老板</th>
                                        <th>天数</th>
                                        <th>员工数</th>
                                        <th title="24h未上线">不活跃</th>
                                        <th title="入职不到10天">新员工</th>
                                        <th>日收入</th>
                                        <th>日单价</th>
                                        <th>周收入</th>
                                        <th>周单价</th>
                                    </tr>
                                </table>
                            </div>`),$("#company_parade_table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;")),setTimeout(()=>{!function d(c){if("1"==c.attr("detected"))$("#company_parade_tip").text("公司已完成"),setTimeout(()=>{d(c.next())},0);else if(c.length<=0||0==a)$("#company_parade_tip").text("阅兵已结束"),$("#company_parade_start_btn").removeAttr("disabled"),$("#company_parade_stop_btn").prop("disabled",!0);else{c.attr("detected","1");const e=c.children().children("li.view").children().attr("href"),p=e?e.replace(/[^\d]/g,""):0,g=c.children().children("li.company").text();var t=`https://api.torn.com/company/${p}?selections=profile&key=${APIKey}`;$("#company_parade_tip").text(`正在阅兵：${p} ${g}`),fetch(t).then(t=>t.json()).then(a=>{if("company"in a){var n=a.company.director,o=a.company.employees[n].name;let t=0,e=0;var i,r=parseInt((new Date).getTime()/1e3);for(i in a.company.employees){var s=a.company.employees[i].last_action.timestamp;86400<=r-s&&(t+=1);var l=a.company.employees[i].days_in_company;l<10&&(e+=1)}$("#company_parade_table").children().append(`
                                    <tr class="content">
                                        <td>${a.company.rating}</td>
                                        <td><a href="#!p=corpinfo&ID=${p}" target="_blank">${a.company.name}</a></td>
                                        <td><a class="user name" href="/profiles.php?XID=${n}" target="_blank">${o}</a></td>
                                        <td>${a.company.days_old}</td>
                                        <td>${a.company.employees_hired}/${a.company.employees_capacity}</td>
                                        <td>${t}</td>
                                        <td>${e}</td>
                                        <td>${formatNumber(a.company.daily_income)}</td>
                                        <td>${formatNumber(a.company.daily_income/a.company.daily_customers)}</td>
                                        <td>${formatNumber(a.company.weekly_income)}</td>
                                        <td>${formatNumber(a.company.weekly_income/a.company.weekly_customers)}</td>
                                    </tr>`),$("#company_parade_table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),setTimeout(()=>{d(c.next())},1e3)}else"error"in a&&$("#company_parade_tip").text(`蛙蛙探测失败：${p} ${g} ${a.error.error}`)}).catch(t=>console.log(t))}}(t)},1e3))}),$("#company_parade_stop_btn").click(function(){a=!1})}}}}const installedSpecs=getLocalStorage("extcenter","installedSpecs")||[];function toThousands(t){return 0<=t.toString().indexOf(",")?Number(t.replace(/,/g,"")):Number.isNaN(Number(t))?0:t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","})}function formatMoney(t){return 0<=t.toString().indexOf("$")?Number(t.replace(/\$|,/g,"")):Number.isNaN(Number(t))?0:t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","}).replace(/^[^\$]\S+/,function(t){return"$"+t})}function formatNumber(t){return t<0?"-"+formatNumber(-t):0==t?"0":t<=1?(100*t).toFixed(2)+"%":t<1e3?""+parseInt(t):1e3<=t&&t<1e6?(t/1e3).toFixed(2)+"k":1e6<=t&&t<1e9?(t/1e6).toFixed(2)+"m":1e9<=t&&t<1e12?(t/1e9).toFixed(2)+"b":1e12<=t&&t<1e15?(t/1e12).toFixed(2)+"t":1e15<=t?"MAX":void 0}function formatNumber2(t){return t<0?"-"+formatNumber2(-t):0==t?"0":t<=1?parseFloat((100*t).toFixed(2))+"%":t<1e3?""+parseInt(t):1e3<=t&&t<1e6?parseFloat((t/1e3).toFixed(2))+"k":1e6<=t&&t<1e9?parseFloat((t/1e6).toFixed(2))+"m":1e9<=t&&t<1e12?parseFloat((t/1e9).toFixed(2))+"b":1e12<=t&&t<1e15?parseFloat((t/1e12).toFixed(2))+"t":1e15<=t?"MAX":"error"}function secondsToDay(t){return(t/86400).toFixed(2),1}function getValues(t){return"[object Array]"===Object.prototype.toString.call(t)?t:"[object Object]"===Object.prototype.toString.call(t)?Object.values(t):null}function isValidDataArray(t){return"[object Array]"===Object.prototype.toString.call(t)&&(!(t.length<=1)&&("[object Object]"===Object.prototype.toString.call(t[0])&&0<Object.keys(t[0]).length))}function findDataSet(t){var e=getValues(t);if(null==e||e.length<=0)return null;if(isValidDataArray(e))return e;for(let t=0;t<e.length;++t){var a=findDataSet(e[t]);if(null!=a)return console.log(`在第 ${t} 个节点发现有效数据集`),a}return null}function unfoldDictionaryNode(t,e){var a=t[e];if("object"==typeof a){for(var n in a){var o=a[n];"object"==typeof o?unfoldDictionary(a,n):t[n+"_"+e]=o}delete t[e]}}function unfoldDictionary(t){for(var e in t)unfoldDictionaryNode(t,e)}function dataSetToCsv(e){var t=e[0];unfoldDictionary(t);let a=Object.keys(t);console.log(`item_keys: ${a}`);for(let t=1;t<e.length;++t){var n=e[t];unfoldDictionary(n);var o=Object.keys(n);for(let t=0;t<o.length;t++){var i=o[t];console.log(`add item_key: ${i}`),-1==a.indexOf(i)&&a.push(i)}}let r=a.sort().join(",");for(let t=0;t<e.length;++t){r+="\n";var s=e[t];unfoldDictionary(s);for(let e=0;e<a.length;++e){let t=s[a[e]]+"";"object"==typeof t&&(t=JSON.stringify(t)),t='"'+t.replace(/<[^>]+>/g,"").trim().replace(/\"/g,'""')+'"',0<e&&(r+=","),r+=t}}return encodeURIComponent(r)}function getLocalStorageRootNode(t){if(void 0!==window.localStorage)return null===window.localStorage.getItem(t)?null:JSON.parse(window.localStorage.getItem(t))}function getLocalStorage(t,e){t=getLocalStorageRootNode(t);if(void 0!==t)return null===t?null:void 0!==t[e]?t[e]:void 0}function updateLocalStorage(e,a,n){if(void 0!==window.localStorage)if(null===window.localStorage.getItem(e)){let t={};t[a]=n,window.localStorage.setItem(e,JSON.stringify(t))}else{let t=JSON.parse(window.localStorage.getItem(e));t[a]=n,window.localStorage.setItem(e,JSON.stringify(t))}}function deleteLocalStorage(t,e){if(void 0!==window.localStorage&&null!==window.localStorage.getItem(t)){const a=JSON.parse(window.localStorage.getItem(t));void 0===a[e]||(delete a[e],window.localStorage.setItem(t,JSON.stringify(a)))}}function deleteLocalStorageRootNode(t){void 0===window.localStorage||null===window.localStorage.getItem(t)||window.localStorage.removeItem(t)}function clickTableHeadSort(o,i){o.click(function(){const t=$(this).siblings();t.each(function(){var t=$(this).text().replace(/[↑↓]/,"");$(this).text(t)});var e=$(this).text().replace(/[↑↓]/,"");let a="",n="";n="TH"==o[0].tagName?(a=o.parent().siblings(),o.parent().parent()):(a=o.parent().next().children(),o.parent().next()),"descend"==$(this).attr("sort")?(a.sort(function(t,e){const a=i(t);e=i(e);return isNaN(a)?a.localeCompare(e):a-e}),a.detach().appendTo(n),$(this).attr("sort","ascend").text(e+"↑")):(a.sort(function(t,e){t=i(t);const a=i(e);return isNaN(t)?a.localeCompare(t):a-t}),a.detach().appendTo(n),$(this).attr("sort","descend").text(e+"↓"))})}function percentHtml(t,e,a,n,o){return`
        <div style="position:relative; top:0; width:100%; height:${t-4}px; color:${a}; background-color:${n}; padding:2px 0px; text-align:center;">${o}</div>
        <div style="position:relative; top:-${t}px; width:100%; left:${e-100}%; height:${t-4}px; padding:2px 0px; z-index:2; overflow:hidden;">
            <div style="position:absolute; top:0; width:100%; left:${100-e}%; height:${t-4}px; color:${n}; background-color:${a}; padding:2px 0px; text-align:center;">${o}</div>
        </div>`}function wawaDetect(t,ft,e){let a=`https://api.torn.com/user/${t}?selections=profile,crimes,personalstats,bazaar&key=${APIKey}`;console.log(`Request: ${a}`),fetch(a).then(t=>t.ok?t.json():void e("蛙蛙探测失败，请刷新重试"),t=>{e("蛙蛙探测失败，网络异常，请刷新重试")}).then(g=>{if(console.log(`Response: ${a}`),console.log(g),null!=g)if(g.hasOwnProperty("error"))e(`蛙蛙探测失败：${JSON.stringify(g,null,4)}`);else{var h=g.personalstats,m=h.defendslost||0,f=h.defendsstalemated||0,u=h.defendswon||0,b=h.attackswon||0,y=h.attacksdraw||0,x=h.attackslost||0,$=h.cantaken||0,v=h.exttaken||0,w=h.kettaken||0,_=h.lsdtaken||0,k=h.opitaken||0,I=h.pcptaken||0,S=h.shrtaken||0,D=h.spetaken||0,A=h.victaken||0,T=h.xantaken||0,M=g.age||1,F=h.trainsreceived||0,E=v+_+T,P=((g.xan_lsd_ecs=E)/M).toFixed(2);g.average_drugs=P;var N=h.refills||0,O=h.statenhancersused||0,C=h.useractivity||0,L=h.traveltime||0,R=(h.logins,h.dumpsearches||0),z=h.energydrinkused||0,j=h.boostersused||0,E=h.revives||0,P=b+y+x,y=h.daysbeendonator||0,x=Math.min(M,parseInt((new Date-new Date("2011/11/22"))/864e5));const tt=Math.min(y/x,1);g.donator_percent=tt.toFixed(2);const et=480+240*tt;const at=611255/et;console.log(`统计DP时间 ${y}d，最多 ${x}d，DP比例：${formatNumber(tt)}，一天完整能量：${et.toFixed(2)}，实现CAP需要活跃：${at.toFixed(2)}天`);x=g.last_action.timestamp||0;let t=parseInt((new Date).getTime()/1e3)-x,e="";86400<t&&(e+=parseInt(t/86400)+"天",t%=86400),3600<t&&(e+=parseInt(t/3600)+"时",t%=3600),60<t&&(e+=parseInt(t/60)+"分",t%=60),e+=t+"秒",g.last_action_details=e;const nt=g.last_action.relative;g.last_action_brief=nt.replace(" minute ago","m").replace(" minutes ago","m").replace(" hours ago","h").replace(" hour ago","h").replace(" days ago","d").replace(" day ago","d");let a=0;nt.includes("d")&&(a=parseInt(nt.replace(/[^0-9|-]/gi,"")));const ot=Math.max(1,21*(M-a)/24);console.log(`年龄${M}天，上次登录${a}天前，最大活跃天数${ot.toFixed(2)}`);const it=C/86400,rt=L/86400,st=3*it+rt;console.log(`ched_active_days: 3*${it.toFixed(2)}(activity) + ${rt.toFixed(2)}(travel) = ${st.toFixed(2)}`);const lt=(75*$+210*v+52.5*w+425*_+215*k+430*I+209.5*S+301*D+300*A+420*T)/1440;console.log(`drug_active_days: ${lt.toFixed(2)}`);$=g.criminalrecord.other||0,v=g.criminalrecord.selling_illegal_products||0,w=g.criminalrecord.theft||0,k=g.criminalrecord.drug_deals||0,I=g.criminalrecord.computer_crimes||0,S=g.criminalrecord.murder||0,D=g.criminalrecord.fraud_crimes||0,A=g.criminalrecord.auto_theft||0;let n=.11*w+.5*I+.66*S+D+.66*A+.05*k;n<0&&(n=0),g.estimate_ace=parseInt(n),12862<n?g.estimate_nnb=60:9171<n?g.estimate_nnb=55:5950<n?g.estimate_nnb=50:4324<n?g.estimate_nnb=45:2750<n?g.estimate_nnb=40:1198<n?g.estimate_nnb=35:450<n?g.estimate_nnb=30:250<n?g.estimate_nnb=25:100<n?g.estimate_nnb=20:50<n?g.estimate_nnb=15:g.estimate_nnb=10;let o=5*(2*$+3*v+5*w+8*k/.8+9*I/.75+10*S/.75+11*D/.95+12*A/.7)/1440;o<at&&(B=Math.min(at/o,3),console.log(`新手 crime_active_days 补偿系数：${B}`),o*=B),console.log(`crime_active_days: ${o.toFixed(2)}`);var B=Math.min(ot,Math.max(st,lt,o)).toFixed(2);console.log(`估算活跃天数: ${B}`),g.estimate_active_days=B;M=parseInt(75*F+30*B+70*M);console.log(`估算WS: ${M}`),g.estimate_ws=M;const dt=parseInt(et*B);console.log(`估算的自然恢复能量: ${dt}`);B=parseInt(150*N),N=250*T+50*_,z=20*z,j=150*j;const ct=B+N+z+j;console.log(`物品能量：${B}(refill) + ${N}(drug) + ${z}(can) + ${j}(FHC) = ${ct}`);j=25*P,E=25*E,R=5*R;const pt=j+E+R;console.log(`消耗能量：${j}(attack) + ${E}(revive) + ${R}(dump) = ${pt}`);let i=dt+ct-pt;i<0&&(i=0),console.log(`总锻炼能量：${dt}(自然) + ${ct}(物品) - ${pt}(消耗) = ${i}`),g.total_energy=i.toFixed(0),g.nature_energy=dt.toFixed(0),g.item_energy=ct.toFixed(0),g.expend_energy=pt.toFixed(0);let r=40;var H=[2,2.8,3.2,3.2,3.6,3.8,3.7,4,4.8,4.8,5.2,5.2,5.4,5.8,5.8,6,6.4,6.6,6.8,7,7,7,7,7.3],W=[200,500,1e3,2e3,2750,3e3,3500,4e3,6e3,7e3,8e3,11e3,12420,18e3,18100,24140,31260,36610,46640,56520,67775,84535,106305,Number.MAX_SAFE_INTEGER];let s=0,l=i,d=W[0];for(;0<l&&r<2e8;){var G=Math.min(W[s],l,d,1e3),U=H[s];const gt=1.122*1.02*U*G*((348e-9*Math.log(4750)+31e-7)*r/4+.32433-.0301431777);r+=gt,l-=G,d-=G,l<=0?console.log(`能量已用光，最近这次在系数为 ${U} 的健身房锻炼了 ${G} 能量，属性 +${gt.toFixed(2)} 变为 ${r.toFixed(2)}`):2e8<=r?console.log(`已达到CAP，最近这次在系数为 ${U} 的健身房锻炼了 ${G} 能量，属性 +${gt.toFixed(2)} 变为 ${r.toFixed(2)}，剩余 ${l} 能量`):s<H.length-1&&d<=0&&(console.log(`要换健身房了，最近这次在系数为 ${U} 的健身房锻炼了 ${G} 能量，属性 +${gt.toFixed(2)} 变为 ${r.toFixed(2)}，剩余 ${l} 能量`),++s,d=W[s])}if(0<l)if(console.log(`实现CAP消耗的能量：${i-l}`),T<_&&T<=100){const ht=3240*l;r+=ht,console.log(`LSD青年，剩余能量还能再 +${ht.toFixed(2)} 属性，变为 ${r.toFixed(2)}`)}else{const mt=2510*l;r+=mt,console.log(`普通青年，剩余能量还能再 +${mt.toFixed(2)} 属性，变为 ${r.toFixed(2)}`)}else console.log("未达CAP");0<O&&(r=.5*r+.5*r*(1+.9*(Math.pow(1.01,.5*O)-1)),console.log(`再用上 +${O} 个SE，属性变为 ${r.toFixed(2)}`)),r=parseInt(r);let c=formatNumber(r);console.log(`估算bs为：${c}`);var K,J=[2,6,11,26,31,50,71,100],q=[100,5e3,1e4,2e4,3e4,5e4],X=[5e6,5e7,5e8,5e9,5e10],_=[2e3,2e4,2e5,2e6,2e7,2e8],T=[2500,25e3,25e4,25e5,35e6,25e7],V={"Absolute beginner":1,Beginner:2,Inexperienced:3,Rookie:4,Novice:5,"Below average":6,Average:7,Reasonable:8,"Above average":9,Competent:10,"Highly competent":11,Veteran:12,Distinguished:13,"Highly distinguished":14,Professional:15,Star:16,Master:17,Outstanding:18,Celebrity:19,Supreme:20,Idolised:21,Champion:22,Heroic:23,Legendary:24,Elite:25,Invincible:26};let p=0;for(K in V)if(0==g.rank.indexOf(K)){p=V[K],g.rank_value=p,g.rank_name=K;break}O=g.rank.split(" ");if(g.rank_title=O[O.length-1],console.log(`Rank: value = #${p}, name = ${g.rank_name}, title = ${g.rank_title}, full = ${g.rank}`),0<p&&r<Number.MAX_SAFE_INTEGER){--p;var Y=g.level||0;for(let t=0;t<J.length;++t)Y>=J[t]&&--p;console.log(`Rank 减掉 level trigger 还剩下 ${p}`);var Q=g.criminalrecord.total||0;for(let t=0;t<q.length;++t)Q>=q[t]&&--p;console.log(`Rank 减掉 crimes trigger 还剩下 ${p}`);var Z=h.networth||0;for(let t=0;t<X.length;++t)Z>=X[t]&&--p;console.log(`Rank 减掉 networth trigger 还剩下 ${p}`);let t=0,e=Number.MAX_SAFE_INTEGER;p<=0?e=T[0]:p>=_.length?t=_[_.length-1]:(t=_[p-1],e=T[p]),console.log(`根据Rank推算bs区间：[${t}, ${e})`),r<t?(c=`${c} ~ ${formatNumber(t)}`,console.log(`估算总bs小于按Rank推算的下限值：${formatNumber(t)}`)):r>e?(c=`${formatNumber(e)} ~ ${c}`,console.log(`估算总bs高于按Rank推算的上限值：${formatNumber(e)}`)):console.log("估算总bs符合按Rank推算的区间")}g.estimate_bs=r,g.estimate_bs_display=c,g.attackWinRatio=b/P,g.defendWinRatio=(u+f)/(u+f+m),ft(g)}})}function loadScript(name,version,source){let extIdentifier=`extcenter_${name}`;return!window[extIdentifier]&&(eval(source),window[extIdentifier]=!0,!0)}installedSpecs.forEach(t=>{try{var e;t.match&&!window.location.href.match(new RegExp(t.match))?console.log(`${t.name} - ${t.version} 不在指定页面`):(e=getLocalStorage("extcenter-source",t.name),loadScript(t.name,t.version,e)?console.log(`${t.name} - ${t.version} 加载成功`):console.log(`${t.name} - ${t.version} 已经加载`))}catch(t){console.log(t)}});async function corsGet(t){switch(console.log(`[cors] get ${t}`),userScriptEngine){case UserScriptEngineEnums.GM:return new Promise((e,a)=>{GM_xmlhttpRequest({method:"get",url:t,ontimeout:t=>a(`timeout: ${t}`),onload:t=>e(t.response),onerror:t=>a(`error: ${t}`)})});case UserScriptEngineEnums.PDA:return new Promise((e,a)=>{PDA_httpGet(`${t}`).then(t=>{e(t.responseText)}).catch(t=>{a(`error: ${t}`)})});case UserScriptEngineEnums.OTHER:default:return new Promise((t,e)=>{e("error：当前不支持Cors操作")})}}async function fetchLog(t,e,a,n){let o=`https://api.torn.com/user/?selections=log&key=${APIKey}`;0<t.length&&(o+=`&cat=${t.join(",")}`),0<e.length&&(o+=`&log=${e.join(",")}`),a&&(o+=`&from=${a}`),n&&(o+=`&to=${n}`);const i=await fetch(o);if(!i.ok)throw new Error(i.statusText);n=await i.json();if("error"in n)throw new Error(n.error.error);return null===n.log?[]:Object.values(n.log).sort((t,e)=>e.timestamp-t.timestamp)}async function*fetchAllLogGenerator(t,e,a,n,o){for(n=n||Math.floor((new Date).getTime()/1e3);;){o&&o(n);var i=await fetchLog(t,e,a,n);if(0===i.length)break;var r=i[i.length-1].timestamp;if(i[0].timestamp==r){for(const s of i)yield s;break}for(const l of i){if(l.timestamp<=r)break;yield l}n=r+1,await new Promise(t=>setTimeout(t,1e3))}}async function fetchAllLog(t,e,a,n,o){const i=[];for await(const r of fetchAllLogGenerator(t,e,a,n,o))i.push(r);return i}function appendResultMessage(t){$("#api_result_container").val($("#api_result_container").val()+"\n"+t)}function tct2timestamp(t){var e=t.split("-")[0].trim();const a=t.split("-")[1].replace("TCT","").trim();var n="20"+a.split("/")[2].trim(),o=a.split("/")[1].trim(),t=a.split("/")[0].trim();const i=new Date(n+"/"+o+"/"+t+" "+e);return i.setHours(i.getHours()-(new Date).getTimezoneOffset()/60),parseInt(i.getTime()/1e3)}function isChatted(a){a=getLocalStorage("CHAT_LAST_MESSAGE",a);if(a){a=tct2timestamp(a),a=parseInt((new Date).getTime()/1e3)-a;let t="",e="";return a<3600?(t=parseInt(a/60)+"m ago",e="#5d9525"):3600<=a&&a<86400?(t=parseInt(a/3600)+"h ago",e="#DAA520"):86400<=a&&a<3024e3?(t=parseInt(a/86400)+"d ago",e="#c0542f"):3024e3<=a&&(t=parseInt(a/86400)+"d ago",e="#777"),[e,t]}}function isMugged(t){var e=window.localStorage.getItem("muglog");if(e){var e=JSON.parse(e),n=Object.entries(e);for(let a=n.length-1;0<=a;a--)if(n[a][1].victim_id==t){var o=n[a][0],i="$"+formatNumber(formatMoney(n[a][1].money_mugged)),o=parseInt((new Date).getTime()/1e3)-o;let t="",e="";return o<3600?(t=parseInt(o/60)+"m ago",e="#5d9525"):3600<=o&&o<86400?(t=parseInt(o/3600)+"h ago",e="#DAA520"):86400<=o&&(t=parseInt(o/86400)+"d ago",e="#c0542f"),e+","+t+","+i}}}function getMyId(){return $("script[uid]").attr("uid")}function APICache(){function n(){var t=`https://api.torn.com/torn/?selections=companies&key=${APIKey}`;fetch(t).then(t=>t.json()).then(e=>{const a=new Date;if("companies"in e){let t={};for(var n in t["last-updated"]=a.toString(),t.companies={},e.companies)t.companies[n]={name:e.companies[n].name,positions:e.companies[n].positions};window.localStorage.setItem("APICache_companies",JSON.stringify(t))}else"error"in e&&updateLocalStorage("APICache_companies","last-updated",a.toString())}).catch(t=>console.log("fetch error",t))}!function(){var e=getLocalStorage("APICache_companies","last-updated");if(null!=e&&null!=e){var a=new Date;let t=new Date(e);t.setDate(t.getDate()+1),t<a&&n()}else n()}()}function filterTravelItems(){const r={186:"绵羊",187:"泰迪熊",215:"猫咪",258:"美洲豹",261:"貂熊",266:"尼斯湖水怪",268:"赤狐",269:"猴子",273:"岩羚羊",274:"大熊猫",281:"狮子",384:"骆驼",618:"黄貂鱼",260:"大丽花",263:"番红花",264:"兰花",267:"帚石楠",271:"木棉花",272:"雪绒花",276:"牡丹花",277:"樱花",282:"非洲堇",385:"蒺藜花",617:"香蕉兰",256:"催泪弹",226:"烟雾弹",222:"闪光弹",616:"鳟鱼"},t=$(".travel-agency-market ul.users-list li");const s=[260,263,264,267,271,272,276,277,282,385,617].concat([186,187,215,258,261,266,268,269,273,274,281,384,618]).concat([206,616,222,226,256]);if(0<t.length&&"filtered"!=t.attr("filtered")){let i=parseInt($("div.delimiter div.msg:contains(You have purchased) span.bold").last().text());var e=parseInt($($("div.delimiter div.msg:contains(You have purchased) span.bold").get(-2)).text());i-=e,(isNaN(i)||i<=0)&&(i=1),t.each((t,e)=>{var a=parseInt($(e).find("div.details").attr("itemid"));if(isNaN(a)||!(0<a))return!1;if(s.indexOf(a)<0)$(e).addClass("hide");else{const n=$(e).find("input#item-"+a)[0];if(n.value=i,n.dispatchEvent(new Event("blur")),r[a]){a=r[a];const o=$(e).find("span.name");o.html(o.html()+"<span style='float:right;padding-right:10px;'>"+a+"</span>")}}}),t.attr("filtered","filtered")}$("#show_more").length<1&&($(".travel-agency-market").after("<div><div id='show_more' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;background-color:#c0542f;text-align:center;'>点击显示全部</div></div>"),$("#show_more").click(function(){$(this).parent().remove(),t.removeClass("hide")}))}function headerLinks(){const n={"中文Wiki":"<a href='https://torn.huijiwiki.com/' target='_blank'>",YATA:"<a href='https://yata.yt/' target='_blank'>",NGA:"<a href='https://nga.178.com/thread.php?stid=30081562' target='_blank'>","赛车":"<a href='/loader.php?sid=racing'>","啤酒":"<a href='/shops.php?step=bitsnbobs'>","飞行":"<a href='/travelagency.php'>","库存":"<a href='https://yata.yt/bazaar/abroad/' target='_blank'>","市场":"<a href='/imarket.php'>","点市":"<a href='/pmarket.php'>","股市":"<a href='/page.php?sid=stocks'>","巴扎":"<a href='/bazaar.php'>"};setInterval(function(){const t=$("ul.menu-items");if("1"!=t.attr("hasdone")){if(0<t.siblings().length)for(var e in n)t.append('<li class="menu-item-link">'+n[e]+e+"</a></li>");else for(var a in t.attr("style","width:295px; margin-top:6px; line-height:16px;"),t.children(":last").remove(),t.children(":last").remove(),t.children(":last").remove(),n)t.append('<li class="menu-item-link">'+n[a]+a+"</a></li>");t.attr("hasdone","1")}},1e3)}function factionChatEnhanced(){setInterval(function(){const t=$("[class*='chat-active_']"),e=new Date,r=parseInt(e.getTime()/1e3),a=t.children("[class*='chat-box-content_']").children("[class*='viewport_']").children().children("[class*='chat-last-message-label_']");a.each(function(t,e){updateLocalStorage("CHAT_LAST_MESSAGE",$(this).parent().parent().parent().siblings("[class^='chat-box-head_']").children().attr("title"),$(this).children("span").text())});const n=t.children("[class*='chat-box-content_']").children("[class*='viewport_']").children().children("[class*='message_']");n.each(function(t,e){const a=$(this).attr("name");var n=a.split("-")[0],n=r-n;let o="",i="";n<3600?(o="["+parseInt(n/60)+"m ago]",i="#5d9525"):3600<=n&&n<86400?(o="["+parseInt(n/3600)+"h ago]",i="#DAA520"):86400<=n&&(o="["+parseInt(n/86400)+"d ago]",i="#c0542f"),$(this).children(".fac-ts").remove(),$(this).prepend('<span class="fac-ts" style="color:'+i+'">'+o+"&nbsp;</span>")})},1e3)}function chatQuickWithdrawEnhance(){setInterval(function(){const t=$("[class*='chat-active_']").children("[class*='chat-box-content_']").children("[class*='viewport_']").children().children("[class*='message_'][fac-wdcheck!='true']");t.each(function(t,e){$(this).attr("fac-wdcheck","true");const a=$(this).text().match(/取.*?([\.0-9]+)([k|m|b]?)/i);if(a){var n=a[1],o=a[2].toLowerCase();let t=1;"k"==o?t=1e3:"m"==o?t=1e6:"b"==o&&(t=1e9);const i=toThousands(parseInt(parseFloat(n)*t)),r=$(this).children("a").text(),s=$(this).children("a").attr("href");n=s.substr(s.indexOf("XID=")+4);const l=`${r.substr(0,r.length-2)} [${n}]`;$(this).append(`<span class="fac-wd border-round" style="background-color:${bingwa_color_pool.green}; color: white; cursor: pointer; float: right; padding: 0 3px 0 3px">取钱</span>`),$(this).children("span[class*='fac-wd']").click(function(){console.log(`${l} ${i}`);const t=window.location.href;t.indexOf("#/tab=controls")<0||0<=t.indexOf("option")&&t.indexOf("give-to-user")<0?(window.location.href=`https://www.torn.com/factions.php?step=your#/tab=controls&option=give-to-user&wdname=${encodeURI(l)}&wdmoney=${encodeURI(i)}`,0<=t.indexOf("factions.php")&&setTimeout(()=>{location.reload()},500)):withdraw_giveMoney(l,i)})}})},1e3)}function withdraw_giveMoney(t,e){const a=$(".money-wrap").children(".give-block");$("input#money-user").val(t).addClass("chosen"),a.children(".inputs-wrap").children(".input-money-group").addClass("success").children("input").attr("value",e),a.children(".inputs-wrap").children(".btn-wrap").children().children().attr("disabled",!1).removeClass("disabled")}function miniProfileBattleStats(){setInterval(function(){if(0<$("#profile-mini-root").children().children("[class^=profile-mini-_userImageWrapper]").length&&!$("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").attr("hasdone")){$("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").attr("hasdone","1");const t=$("#profile-mini-root").children().children("[class^=profile-mini-_userImageWrapper]").children("a"),e=t?t.attr("href"):void 0,a=e?e.substr(20):void 0;a&&wawaDetect(a,function(t){updateLocalStorage("battlestats",a,t.estimate_bs),$("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").append(`
                        <div id="bingwa-estimate-bs" style="width:165px; height:16px; position: absolute; left: 1px; top: 2px; z-index: 1; color: white ;background-color: ${bingwa_color_pool.blue}; border: 2px solid darkgray; padding-top: 3px; margin: 5px; text-align: center;">
                            <span>估算战力: ${t.estimate_bs_display}</span>
                        </div>
                    `);let e=parseInt(100*t.life.current/t.life.maximum);t="血量: "+t.life.current+"/"+t.life.maximum+" ("+e+"%)";e<=66?$("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").append(`
                        <div id="hp-bar" style="width:165px; height:16px; overflow:hidden; position: absolute; left: 1px; top: 28px; z-index: 1; color: white ;background-color: #eee; border: 2px solid darkgray; padding: 0px; margin: 5px; text-align: center;">
                            ${percentHtml(16,e,"#c0542f","#eee",t)}
                        </div>
                        `):(100<e&&(e=100),$("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").append(`
                        <div id="hp-bar" style="width:165px; height:16px; overflow:hidden; position: absolute; left: 1px; top: 28px; z-index: 1; color: white ;background-color: #eee; border: 2px solid darkgray; padding: 0px; margin: 5px; text-align: center;">
                            ${percentHtml(16,e,"#5d9525","#eee",t)}
                        </div>
                        `))})}},500)}function withdrawalHelper(){const r={20465:["Leader","Co-leader","WEIYUAN","CHANGWEI"],36134:["Leader","Co-leader","Paladin","Minister"],16335:["Leader","Co-leader","Karajan","Haydn","Chopin","Schubert"],9356:["Leader","Co-leader","Lion","Tiger","Wolf"],10741:["Leader","Co-leader","General","Marshal"]};setInterval(function(){const t=$("[class*='type-list_']");if(0<t.length){const e=t.children("li:eq(3)").attr("class");if(0<=e.indexOf("active")){const a=$("[class*='people-list_']");"1"!=a.attr("hasDone")&&(a.attr("hasDone","1"),function(o){var t=`https://api.torn.com/faction/?selections=basic&key=${APIKey}`;fetch(t).then(t=>t.json()).then(t=>{if("members"in t){let i=[];for(const n in t.members){var e=t.members[n].position,a=t.members[n].status.state;0<=r[t.ID].indexOf(e)&&"Okay"==a&&i.push(n)}o.each(function(t,e){const a=$(this).attr("class"),n=$(this).children("a").attr("href");var o=n?n.substring(18):0;0<=i.indexOf(o)&&0<=a.indexOf("online")&&($(this).children("a").append("<span style='color:white'><b> 可取钱 在城内</b></span>"),$(this).css("background-color","Darkseagreen"))})}else"error"in t&&console.log(t.error.error)}).catch(t=>console.log("fetch error",t))}(a.children("li")))}}},3e3)}function cloudFilter(){0<$("#plane").length&&($("#clouds-1").remove(),$("#clouds-2").remove(),$("#clouds-3").remove(),$("#plane").children().remove())}function laptopScreen(){0<$(".computer-wrap").length&&($(".computer-navigation").insertBefore(".computer-wrap"),$("#computer-content-wrapper").insertBefore(".computer-wrap"),$(".computer-wrap").css("visibility","hidden"),$(".computer-navigation").attr("style","position: unset; margin-bottom: 10px;"),$("#computer-content-wrapper").removeClass("left"),$("#computer-content-wrapper").css("margin","auto"))}function nurse(t){0<$("#icon15-sidebar").length&&$("#nurse").length<1&&($(t).before(`
            <div style="margin-bottom:5px;">
                <div id='nurse' style='color:#333;width:inherit;margin:auto;padding:10px;border:5px solid gray;background-color:#ccc;text-align:center;'>
                    <div id='nurse-eff' style='font-size:12px;padding:2px;'></div>
                    <div id='nurse-cd' style='font-size:24px;padding:2px;'>小护士竭诚为你服务</div>    
                    <div id='nurse-item' style='font-size:12px;padding:2px;'></div>
                    <div id='nurse-suggestion' style='font-size:24px;padding:2px;'></div>
                    <div id='nurse-item-life' style='font-size:12px;padding:2px;'></div>
                    <div id='nurse-suggestion-life' style='font-size:24px;padding:2px;'></div>
                </div>
            </div>`),t=`https://api.torn.com/user/?selections=profile,cooldowns,perks&key=${APIKey}`,fetch(t).then(t=>t.ok?t.json():void $("#nurse-cd").text("--- 小护士探测失败 ---"),t=>{$("#nurse-cd").text("--- 小护士网络异常 ---")}).then(m=>{if(null!=m)if("error"in m)$("#nurse-cd").text(`--- API错误 --- code: ${m.error.code} error: ${m.error.error}`);else if("basicicons"in m&&"icon15"in m.basicicons){function f(t){let e=parseInt(t/3600);e=e<10?"0"+e:e;let a=parseInt(t/60)%60;a=a<10?"0"+a:a;let n=t%60;return n=n<10?"0"+n:n,e+":"+a+":"+n}var u=m.states.hospital_timestamp,b=u?u-parseInt((new Date).getTime()/1e3):0,y=f(b),x=parseInt(b/60),v=100-(m.life.current||0)/(m.life.maximum||7500)*100,w=f(m.cooldowns.medical||0);let a=!1,t=0,e=0,n=0;if("education_perks"in m){const M=m.education_perks;0<=M.indexOf("+ Withdraw and deliver blood")&&(a=!0),0<=M.indexOf("+ 20% Medical item effectiveness")&&(t=20),0<=M.indexOf("+ 10% Medical item effectiveness")&&(t=10)}if("faction_perks"in m){const F=m.faction_perks;F.forEach(function(t){0<=t.indexOf("medical item effectiveness")&&(e=t.replace("+ Gain","").replace("% medical item effectiveness","").trim()),0<=t.indexOf("minutes of maximum medical cooldown")&&(n=t.replace("+ Adds","").replace("minutes of maximum medical cooldown","").trim())})}let o=6+parseInt(n/60);o=o<10?"0"+o:o;let i=n%60;i=i<10?"0"+i:i;var _=o+":"+i+":00";const T=parseInt(t)+parseInt(e)+100;console.log(T);let r=0,s=0,l=0,d=0;console.log(x);var k=function t(e){return a&&e>.7*T?(r+=1,t(e-1.2*T)):e>.4*T?(s+=1,t(e-.7*T)):e>.2*T?(l+=1,t(e-.4*T)):0<e?(d+=1,t(e-.2*T)):e}(x);console.log(k);var I=0==r?"":"大血包*"+r,S=0==s?"":"吗啡*"+s,D=0==l?"":"小蓝包*"+l,A=0==d?"":"小红包*"+d,u=30*r+20*s+15*l+10*d;let c=0,p=0,g=0,h=0;b=function t(e){return a&&e>.15*T?(c+=1,t(e-.3*T)):e>.1*T?(p+=1,t(e-.15*T)):e>.05*T?(g+=1,t(e-.1*T)):0<e?(h+=1,t(e-.05*T)):e}(v);console.log(b);m=0==c?"":"大血包*"+c,x=0==p?"":"吗啡*"+p,k=0==g?"":"小蓝包*"+g,v=0==h?"":"小红包*"+h,b=30*c+20*p+15*g+10*h;$("#nurse-cd").text(`住院时间 ${y} 医疗冷却 ${w}/${_}`),$("#nurse-eff").text(`抽血: ${a} 教育加成: +${t}% 帮派加成: +${e}%`),$("#nurse-item").text(`大血包: -${parseInt(1.2*T)}分钟 吗啡: -${parseInt(.7*T)}分钟 小蓝包: -${parseInt(.4*T)}分钟 小红包: -${parseInt(.2*T)}分钟`),$("#nurse-suggestion").text(`【出院模式】 ${I} ${S} ${D} ${A} (冷却 +${u}分钟)`),$("#nurse-item-life").text(`大血包: 回血+${parseInt(.3*T)}% 吗啡: 回血+${parseInt(.15*T)}% 小蓝包: 回血+${parseInt(.1*T)}% 小红包: 回血+${parseInt(.05*T)}%`),$("#nurse-suggestion-life").text(`【满血模式】 ${m} ${x} ${k} ${v} (冷却 +${b}分钟)`)}}).catch(t=>$("#nurse-cd").text(t)))}function getVersion(){var e,a={"3.0.2":{date:"2022.05.13",notes:["新功能: 插件中心 by mirror","新功能: 查询bust惩罚 by toby","修改: 犯罪经验 - 日志页面增加导出按钮 by toby","修改: 犯罪经验 - 增加犯罪经验数据收集说明 by toby","修改: 冰蛙目标支持导入csv格式文件 by microdust","修复: gym页面加成数字不显示的问题 by htys","修复: home页面perks显示错位的问题 by htys","修复: market search页面有时会不显示bazaar的问题 by htys"]},"3.0.1":{date:"2022.04.29",notes:["修改: 公司效率估算公式 by microdust","修改: 聊天框取钱跳转优化 by mirror","修改: 放宽对 NNB 升降级事件的时间要求 by toby","修复: 阅兵 by mirror","修复: 替换空值合并运算符 by toby"]},"3.0.0":{date:"2022.04.07",notes:["新功能: 犯罪经验 by toby"]},"2.9.9":{date:"2022.04.05",notes:["新功能: 灵活配置快捷取钱按钮 by mirror","新功能: 聊天栏添加取钱按钮 by mirror","修改: 公司数据拉取时机 by mirror","修复: 修复在高级搜索界面时，打开honerbar的时候上次唠嗑不显示的问题 by mirror"]},"2.9.8":{date:"2022.03.31",notes:["修改: 冰蛙目标页面 - 添加bs提示","修改: 友好帮派增加pta新帮","修复: 唠嗑时间在转换时区时有多余空格的bug"]},"2.9.7":{date:"2022.02.27",notes:["新功能: attack页面 - 显示chain进度，防止bonus打偏","修改: 公司页面 - 新增效率估算","修改: 冰蛙目标页面 - 若出院时间小于10分钟，则根据出院时间逐渐降低背景色透明度","修改: 搜索页面 - 若与目标超过35天未有聊天行为，则最近唠嗑显示为灰色","修复: 无法阅兵的bug"]},"2.9.6":{date:"2022.02.22",notes:["新功能: profile页面和mini profile页面显示血条"]},"2.9.5":{date:"2022.02.15",notes:["新功能: 冰蛙目标，自动刷新的目标监视利器","新功能: 帮派详情增加level和id显示","修复: 小护士调整小数保留位数"]},"2.9.4":{date:"2022.01.24",notes:["修复: 部分顶部链接","修复: miniBS显示位置","修复: PTA取钱功能","修复: 帮派页面显示阅兵、BS、离线时间和住院时间，取消排序功能"]},"2.9.3":{date:"2022.01.08",notes:["新功能：近期RW显示服务器近期RW的记录"]},"2.9.2":{date:"2022.01.04",notes:["新功能：帮派取钱现在在更加明显的位置提示余额，并且新增加了全取按钮","新功能：侧边栏现在有冰蛙图标了","修复：修复了飞行时读取不到自己id导致的公司页面无法显示问题","修复：帮派详情页面增加了显示内容（帮派图标和rank等级）"]},"2.9.1":{date:"2021.12.30",notes:["修复：修正了某些API的匹配格式，使得小护士可以正常运行","修复：更新了profile页面的攻击链接，现在玩家在医院可以读取完整的战斗页面了","修复：为一部分表格增加横向拖动条，使其在超出手机屏幕宽度时也可以显示完整内容（感谢Woohoo）","修复：微调了profile页面BS显示相关内容"]},"2.9.0":{date:"2021.12.28",notes:["新功能：小护士现在可以分别按照【出院模式】和【满血模式】提供建议","新功能：profile页面新增估算WS","新功能：针对公司老板新增显示公司货物库存","修复：修复了mini profile上估算bs重复显示的问题","修复：修复了小护士有时获取不到住院时间的问题","修复：修复了帮派余额和准备金率显示错误的问题","修复：profile连续活跃天数重新修改为冰蛙活跃天数","修复：修改了某些配色以解决深色模式下看不清的问题","修复：现在飞行无云功能不再显示飞机图片了","修复：针对非东8区用户修改了唠嗑时间显示不正确的问题","修复：更新了key->info和rankedwarreport等API条目"]},"2.8.9":{date:"2021.12.09",notes:["新功能：自己帮派的Ranked War界面会显示敌人bs(需提前对该帮派阅兵)，并且可以按bs排序","修复：小护士读取不到API时的报错","修复：faction和company重绘读取不到API时的报错"]},"2.8.8":{date:"2021.11.24",notes:["修复：使用API重绘faction和company页面时匹配不同url","修复：一个神奇的bug"]},"2.8.7":{date:"2021.11.23",notes:["新功能：在个人profile页面显示上次聊天时间和上次mug时间金额","新功能：在高级搜索页面显示上次聊天时间"]},"2.8.6":{date:"2021.11.19",notes:["新功能：mini profile显示冰蛙估算战力","新功能：帮派仓库增加快捷取钱按钮","修改：使用帮派药品出院时也可以获得小护士建议了"]},"2.8.5":{date:"2021.11.08",notes:["新功能：战斗页面增加显示目标在线状态","修改：冰蛙APIKey读取页面UI","修改：阅兵可以按bazaar金额筛选目标，增加bazaar链接","修改：在飞行入院或入狱时也可以在company.php页面查看效率表格了"]},"2.8.4":{date:"2021.11.01",notes:["新功能：战斗页面增加量化显示stealth隐身概率","新功能：item页面增加小护士智能出院建议","新功能：在自己帮派的战斗中，会显示墙上敌人的bs(需提前对该帮派阅兵)","修复PDA会重复载入冰蛙的bug(感谢Woohoo-)"]},"2.8.3.1":{date:"2021.10.25",notes:["公司管理中增加显示本周销售额（实时数据）和近一周利润（缓存数据）","公司管理表格改为显示到公司页面的下方"]},"2.8.3":{date:"2021.10.23",notes:["起飞页面增加吃药cd和oc提醒功能","bounty页面增加自动阅兵功能，默认关闭需在设置中手动开启","个人页面的冰蛙检测增加显示活跃天数，删除ECS数量","在个人页面enemy数量右侧增加显示坏比指数","points市场目标提示现在可以显示新人和衣服店了"]},"2.8.2":{date:"2021.10.08",notes:["启用更精确的计算监狱分数公式并且显示分数提高到25000","修复阅兵bug"]},"2.8.1":{date:"2021.09.30",notes:["取消大乱斗功能","取消oc提醒功能"]},"2.8.0":{date:"2021.09.11",notes:["新增大乱斗阅兵","优化了大乱斗界面"]},"2.7.9":{date:"2021.09.09",notes:["新增了API条目","更新了顶部快捷链接","阅兵可以显示大乱斗所在队伍","在海外也可以查看大乱斗"]},"2.7.8":{date:"2021.08.18",notes:["阅兵可以显示目标bazaar内全部物品价值总和"]},"2.7.7":{date:"2021.06.20",notes:["公司排行页面可以进行公司阅兵了","增加新的快捷打劫链接","不再显示已售空的额外的bazaar","buymug时加入自己人防误伤提醒","OC即将开始时进入飞行界面将获得更加明显的提示","隐藏laptop边框","飞行时不显示云和飞机"]},"2.7.6":{date:"2021.05.29",notes:["不是老板也能查看我的公司表格了","新增帮派取钱助手"]},"2.7.5.2":{date:"2021.05.29",notes:["聊天框时间戳不显示秒","Jail界面增加显示更多按钮","海外库存界面增加显示更多按钮"]},"2.7.5.1":{date:"2021.05.27",notes:["修复聊天框时间戳"]},"2.7.5":{date:"2021.04.12",notes:["顶部链接、健身房、赛车界面UI微调"]},"2.7.4":{date:"2021.04.01",notes:["飞行时查看的公司页面增加TV和油厂的单价估算"]},"2.7.3":{date:"2021.03.30",notes:["我的公司页面UI微调"]},"2.7.2":{date:"2021.03.23",notes:["添加顶部链接和健身房的开关","在股票交易市场页面显示股票缩写"]},"2.7.1":{date:"2021.03.10",notes:["我的公司页面新增显示各员工工资和当前公司实时数据，修复保存31天显示32天的bug","飞行中的帮派信息页区分显示正在被突击和主动突击别人"]},"2.7.0":{date:"2021.02.14",notes:["修改imarket search页面，增加显示目标bazaar内全部物品价值总和","新增功能复活助手"]},"2.6.9":{date:"2021.02.11",notes:["帮派对比功能重做以显示更多数据","加入更多设置选项","index页面加入一键显示全部perks"]},"2.6.8":{date:"2021.02.02",notes:["新增世界局势功能，显示所有正在进行的地盘战，按战况激烈程度染色"]},"2.6.7":{date:"2021.01.24",notes:["在飞行/医院/监狱中也可以查看自己/他人Bazaar中物品"]},"2.6.6.3":{date:"2021.01.22",notes:["解决gym页面与torntools兼容问题"]},"2.6.6.2":{date:"2021.01.19",notes:["修改一些可能存在的bug","Gym页面提供Hank和Baldr属性比例参考","监视列表可以自由添加玩家ID，被监视的目标在海外被高亮（橙色）显示"]},"2.6.6.1":{date:"2021.01.19",notes:["查看个人profile页面的Last action显示为x天x时x分x秒"]},"2.6.6":{date:"2021.01.14",notes:["我的公司及飞行中看帮派、公司功能汉化。","飞行中看帮派信息增加chain、地盘战、raid战的信息。","产量数据支持多种库存的公司。"]},"2.6.5.1":{date:"2021.01.13",notes:["对使用过【我的公司】功能的，每天进游戏时自动检查抓取昨晚的公司运营数据。"]},"2.6.5":{date:"2021.01.11",notes:["公司效率表格微调：增加inactivy，调整列顺序","新增公司历史数据表格","飞行时也能看帮派和公司页面"]},"2.6.4.1":{date:"2021.01.05",notes:["优化公司效率表格显示，并且海外可查看"]},"2.6.4":{date:"2021.01.04",notes:["公司页面显示效率表格","聊天框显示时间戳"]},"2.6.3":{date:"2020.12.28",notes:["顶部增加简易导航条，从api.torn.com更新了API条目","优化阅兵功能，增加暂停和继续按钮","优化帮派对比功能，增加历史记录和高亮显示leader","增加抢劫历史功能，可以从历史记录中选择目标加入监视列表"]},"2.6.2":{date:"2020.11.11",notes:["修复顶部链接导致页面排版错乱的问题","payday功能只向leader和coleader提供"]},"2.6.1":{date:"2020.10.22",notes:["美化排版：pmarket、imarket(search)、imarket页面在显示bs时不再影响原始布局","市场显示超过3个bazaar：imarket(search)页面显示bazaar数量不再局限于3个","bazaar页面简易计算器：可以通过点击选中物品，页面顶部显示选中物品的总价值"]},"2.6.0":{date:"2020.09.28",notes:["itemmarket/pointmarket/bazaar界面增加3个mug相关脚本（感谢Mirror），使用mugoo=true开启","revivehelper重命名为facPageEnhanced，显示内容优化，使用foo=true开启","阅兵模块优化，增加阅兵内容选项，所有阅兵相关功能都使用foo=true开启","监狱置顶标记友帮成员，无视分数","海外people界面用颜色标记友帮和敌帮成员"]},"2.5.9":{date:"2020.09.16",notes:["修复飞花增强功能失效的bug"]},"2.5.8":{date:"2020.11.11",notes:["回滚上版本第一条，因为networth会变化，持续7天才触发rank","蛙蛙探测显示更多页面里的锻炼总能量换成Booster数量"]},"2.5.7":{date:"2020.08.14",notes:["当rank反推的bs上限低于估算值时，忽略估算值，使用rank反推的上下限区间","修复蛙蛙探测显示更多页面排版问题","帮派页面Revive增强功能默认关闭，需要时请将代码头部 reviveHelper 设为 true 手动开启"]},"2.5.6":{date:"2020.08.01",notes:["飞行中也可以方便的查看帮派成员状态，以及支持包括自己帮在内的最多3个帮派横向对比"]},"2.5.5.1":{date:"2020.07.30",notes:["修复一些取款小bug，给自己取款时，输入.或者?(英文标点)可自动替换为本人名字，减少输入时间"]},"2.5.5":{date:"2020.07.30",notes:["屏蔽全取按钮，选择取款目标时显示目标额度"]},"2.5.4":{date:"2020.07.27",notes:["增加帮派成员界面一系列功能：阅兵，显示bs、上次登录时间、旅行状态和住院时间，高亮标记住院成员，排序等"]},"2.5.3":{date:"2020.07.07",notes:["增加防打重功能，开关noAssisting = true"]},"2.5.2":{date:"2020.06.17",notes:["修复顶部链接导致页面排版错乱的问题"]},"2.5.1":{date:"2020.06.15",notes:["修复阅兵转换为csv有时丢失某些列的问题"]},"2.5.0":{date:"2020.06.05",notes:["搜索及海外用户列表阅兵功能优化：过滤5b以下，显示mugged, rehabcost, rank, job"]},"2.4.9":{date:"2020.06.05",notes:["飞行中也可以方便的查看帮派成员状态，以及支持包括自己帮在内的最多3个帮派横向对比"]},"2.4.8":{date:"2020.06.04",notes:["jailview 按 jailscore 排序，并优化体验","更新看库存的链接","用户搜索页面增加阅兵功能"]},"2.4.7":{date:"2020.04.26",notes:["左上角菜单中新增常用链接：市场","jailview页面增强：显示各目标的 分钟数*级别；过滤大于1万的；bust不需要二次确认（类似DN的quick bust功能）"]},"2.4.6":{date:"2020.04.26",notes:["左上角菜单中新增常用链接：赛车/啤酒/飞行/库存"]}};let n="",o=0,i="";for(e in a){i+=a[e].date+" --v"+e+"\n";for(let t=0;t<a[e].notes.length;t++)i+="    "+a[e].notes[t]+"\n";i+="\n";let t=e.split(".");t.splice(1,0,"."),t.join(""),parseFloat(t)>o&&(o=t,n=e)}return[n,i]}}}();
